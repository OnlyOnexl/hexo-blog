<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="kubernetesè°ƒåº¦å™¨, love">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>kubernetesè°ƒåº¦å™¨ | love</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">love</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>ç•™è¨€æ¿</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>å‹æƒ…é“¾æ¥</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">love</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			ç•™è¨€æ¿
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			å‹æƒ…é“¾æ¥
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">kubernetesè°ƒåº¦å™¨</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/">
                                <span class="chip bg-color">è°ƒåº¦å™¨</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/k8s/" class="post-category">
                                k8s
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2022-05-17
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220114165454.png" alt="scheduling framework extensions"></p>
<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><p>[TOC]</p>
<h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å®éªŒç¯å¢ƒï¼š</span><br><span class="line">1ã€win10,vmwrokstationè™šæœºï¼›</span><br><span class="line">2ã€k8sé›†ç¾¤ï¼š3å°centos7.6 1810è™šæœºï¼Œ1ä¸ªmasterèŠ‚ç‚¹,2ä¸ªnodeèŠ‚ç‚¹</span><br><span class="line">   k8s versionï¼šv1.22.2</span><br><span class="line">   containerd://1.5.5</span><br></pre></td></tr></table></figure>

<h2 id="å®éªŒè½¯ä»¶"><a href="#å®éªŒè½¯ä»¶" class="headerlink" title="å®éªŒè½¯ä»¶"></a>å®éªŒè½¯ä»¶</h2><p>é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1P3Z_ujk22dYDXzM37WI5FA?pwd=v01w">https://pan.baidu.com/s/1P3Z_ujk22dYDXzM37WI5FA?pwd=v01w</a><br>æå–ç ï¼šv01w </p>
<p><code>2022.2.18-39.äº²åˆæ€§è°ƒåº¦-å®éªŒä»£ç .zip</code></p>
<p>é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1Nbkwz0rvDris8F6qFegJtw?pwd=4dx5">https://pan.baidu.com/s/1Nbkwz0rvDris8F6qFegJtw?pwd=4dx5</a><br>æå–ç ï¼š4dx5<br><code>2022.2.20-42.æœåŠ¡è´¨é‡-å®éªŒä»£ç </code></p>
<p>é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1CAC9j5yU-sg-aDfLPYVflg?pwd=b3jp">https://pan.baidu.com/s/1CAC9j5yU-sg-aDfLPYVflg?pwd=b3jp</a><br>æå–ç ï¼šb3jp<br><code>2022.2.19-40.æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ-å®éªŒä»£ç </code></p>
<p>é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/19x43qNOI2oogXTcgEDCwgQ?pwd=0min">https://pan.baidu.com/s/19x43qNOI2oogXTcgEDCwgQ?pwd=0min</a><br>æå–ç ï¼š0min<br><code>2022.2.19-41.Descheduler-så®éªŒä»£ç </code></p>
<h2 id="æœ¬èŠ‚å®è·µ"><a href="#æœ¬èŠ‚å®è·µ" class="headerlink" title="æœ¬èŠ‚å®è·µ"></a>æœ¬èŠ‚å®è·µ</h2><ol>
<li>å®è·µï¼šnodeSelectoræµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.16</li>
<li>å®è·µï¼šèŠ‚ç‚¹äº²å’Œæ€§æµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.16</li>
<li>å®è·µï¼špodäº²å’Œæ€§(æµ‹è¯•æˆåŠŸ)-2022.5.16</li>
<li>å®è·µï¼špodåäº²å’Œæ€§(æµ‹è¯•æˆåŠŸ)-2022.5.16</li>
<li>å®è·µï¼šæ±¡ç‚¹ä¸å®¹å¿(æµ‹è¯•æˆåŠŸ)-2022.5.16</li>
<li>å®è·µï¼šnodeNameæµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.16</li>
<li>å®è·µï¼šresources.requestsæµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.17</li>
<li>å®è·µï¼šresources.limitsæµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.17</li>
<li>å®è·µï¼šQosè§£æ(æµ‹è¯•æˆåŠŸ)-2022.5.17</li>
<li>å®è·µï¼šç”¨æ‹“æ‰‘åˆ†å¸ƒçº¦æŸæ¥æ‰©å±•daemonsetåŠŸèƒ½(æµ‹è¯•æˆåŠŸ)-2022.5.17</li>
<li>å®è·µï¼šdeschedulerå®‰è£…(æµ‹è¯•æˆåŠŸ)-2022.5.17</li>
</ol>
<h2 id="1ã€è°ƒåº¦å™¨"><a href="#1ã€è°ƒåº¦å™¨" class="headerlink" title="1ã€è°ƒåº¦å™¨"></a>1ã€è°ƒåº¦å™¨</h2><p><code>kube-scheduler</code> æ˜¯ kubernetes çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œä¸»è¦è´Ÿè´£æ•´ä¸ªé›†ç¾¤èµ„æºçš„è°ƒåº¦åŠŸèƒ½ï¼Œæ ¹æ®<strong>ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œç­–ç•¥</strong>ï¼Œå°† Pod è°ƒåº¦åˆ°æœ€ä¼˜çš„å·¥ä½œèŠ‚ç‚¹ä¸Šé¢å»ï¼Œä»è€Œæ›´åŠ åˆç†ã€æ›´åŠ å……åˆ†çš„åˆ©ç”¨é›†ç¾¤çš„èµ„æºï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ kubernetes ä¸€ä¸ªéå¸¸é‡è¦çš„ç†ç”±ã€‚å¦‚æœä¸€é—¨æ–°çš„æŠ€æœ¯ä¸èƒ½å¸®åŠ©ä¼ä¸šèŠ‚çº¦æˆæœ¬ã€æä¾›æ•ˆç‡ï¼Œæˆ‘ç›¸ä¿¡æ˜¯å¾ˆéš¾æ¨è¿›çš„ã€‚</p>
<p>ğŸ‚ ä»€ä¹ˆæ˜¯è°ƒåº¦ï¼Ÿ</p>
<p>è°ƒåº¦ï¼Œå¯ä»¥è¯´æ˜¯Kubernetesæœ€æ ¸å¿ƒçš„åŠŸèƒ½ä¹‹ä¸€äº†ã€‚</p>
<p>Podæ˜¯Kubernetesä¸­æœ€å°çš„è°ƒåº¦å•å…ƒï¼Œè€ŒPodåˆæ˜¯è¿è¡Œåœ¨Nodeä¹‹ä¸Šçš„ã€‚æ‰€è°“è°ƒåº¦ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸ºä¸€ä¸ªæ–°åˆ›å»ºå‡ºæ¥çš„ Podï¼Œå¯»æ‰¾ä¸€ä¸ªæœ€é€‚åˆå®ƒè¿è¡Œçš„Nodeã€‚ </p>
<p>ğŸ‚ è°ƒåº¦æ¦‚è§ˆ</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514111718.png"></p>
<p>ğŸ‚ è°ƒåº¦å™¨åˆ†ç±»</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514220339.png"><br>1.å•ä½“è°ƒåº¦å™¨ï¼šå¯¹äºå¤§è§„æ¨¡æ‰¹é‡è°ƒåº¦è¯‰æ±‚åœºæ™¯ï¼Œä¸èƒ½èƒœä»»ï¼(åŸºäºpodçš„äº‹ä»¶è°ƒåº¦)ï¼<br>2.ä¸¤å±‚è°ƒåº¦å™¨ï¼šåº”ç”¨å¹³å°â€“hadoop,sparkï¼›èµ„æºè°ƒåº¦å™¨(è´Ÿè´£åº•å±‚è®¡ç®—èµ„æºçš„ç®¡ç†)ï¼Œåº”ç”¨è°ƒåº¦å™¨ï¼›resource offersï¼Œå­˜åœ¨çš„é—®é¢˜ï¼š1.èµ„æºäº‰æŠ¢å¦‚ä½•è§£å†³ï¼Ÿ2.åˆ†é…èµ„æºä¸åˆç†å¦‚ä½•å¤„ç†  è§£å†³åŠæ³•ï¼šæ‚²è§‚é” å…ˆé”å®šèµ„æºï¼Œå†è¿›è¡Œèµ„æºçš„è…¾æŒªå¤„ç†ã€‚â€“&gt;æ•ˆç‡ä¸é«˜<br>3.çŠ¶æ€å…±äº«è°ƒåº¦å™¨ï¼šåŸºäºç‰ˆæœ¬æ§åˆ¶/äº‹åŠ¡æ§åˆ¶çš„åŸºäºä¹è§‚é”çš„è°ƒåº¦ï¼ full state,æœ¬åœ°ç¼“å­˜ï¼Œå›å†™ï¼Œå†²çªåˆ¤æ–­ï¼Œé‡è¯•ã€‚</p>
<h2 id="2ã€è°ƒåº¦æµç¨‹"><a href="#2ã€è°ƒåº¦æµç¨‹" class="headerlink" title="2ã€è°ƒåº¦æµç¨‹"></a>2ã€è°ƒåº¦æµç¨‹</h2><h3 id="1-é»˜è®¤è°ƒåº¦å™¨"><a href="#1-é»˜è®¤è°ƒåº¦å™¨" class="headerlink" title="1.é»˜è®¤è°ƒåº¦å™¨"></a>1.é»˜è®¤è°ƒåº¦å™¨</h3><p><code>kube-scheduler</code></p>
<blockquote>
<p>kube-schedulerè´Ÿè´£åˆ†é…è°ƒåº¦Pod åˆ°é›†ç¾¤å†…çš„èŠ‚ç‚¹ä¸Šï¼Œå®ƒç›‘å¬kube-apiserverï¼ŒæŸ¥è¯¢è¿˜æœªåˆ†é…Nodeçš„Podï¼Œç„¶åæ ¹æ®è°ƒåº¦ç­–ç•¥ä¸ºè¿™äº›Podåˆ†é…èŠ‚ç‚¹ï¼ˆæ›´æ–°Pod çš„NodeNameå­—æ®µ)ã€‚(ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œplugin)</p>
</blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>kube-scheduler</code> æä¾›çš„é»˜è®¤è°ƒåº¦å™¨èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬ç»å¤§å¤šæ•°çš„è¦æ±‚ï¼Œæˆ‘ä»¬å‰é¢å’Œå¤§å®¶æ¥è§¦çš„ç¤ºä¾‹ä¹ŸåŸºæœ¬ä¸Šç”¨çš„<strong>é»˜è®¤çš„ç­–ç•¥</strong>ï¼Œéƒ½å¯ä»¥ä¿è¯æˆ‘ä»¬çš„ Pod å¯ä»¥è¢«åˆ†é…åˆ°èµ„æºå……è¶³çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä½†æ˜¯åœ¨å®é™…çš„çº¿ä¸Šé¡¹ç›®ä¸­ï¼Œå¯èƒ½æˆ‘ä»¬è‡ªå·±ä¼šæ¯” kubernetes æ›´åŠ äº†è§£æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ª Pod åªèƒ½è¿è¡Œåœ¨ç‰¹å®šçš„å‡ ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…è¿™å‡ ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æ¥è¿è¡Œç‰¹å®šç±»å‹çš„åº”ç”¨ï¼Œè¿™å°±<strong>éœ€è¦æˆ‘ä»¬çš„è°ƒåº¦å™¨èƒ½å¤Ÿå¯æ§</strong>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ä¾‹å¦‚ï¼šéšä¾¿å¯¼å‡ºä¸€ä¸ªpodçš„yamlæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å…¶é»˜è®¤è°ƒåº¦å™¨å°±æ˜¯`default-scheduler`.</span><br><span class="line">$ kubectl get po apisix-etcd-0 -napisix -oyaml</span><br><span class="line">â€¦â€¦</span><br><span class="line">schedulerName: default-scheduler</span><br><span class="line">â€¦â€¦</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¹Ÿå°±æ˜¯k8sé›†ç¾¤é»˜è®¤ä½¿ç”¨çš„ï¼š</span></span><br><span class="line">$ kubectl get po -A</span><br><span class="line">â€¦â€¦</span><br><span class="line">kube-system            kube-scheduler-master1                             1/1     Running    3 (27d ago)   108d</span><br></pre></td></tr></table></figure>



<p><code>kube-scheduler</code> çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®ç‰¹å®šçš„<strong>è°ƒåº¦ç®—æ³•å’Œè°ƒåº¦ç­–ç•¥</strong>å°† Pod è°ƒåº¦åˆ°åˆé€‚çš„ Node èŠ‚ç‚¹ä¸Šå»ï¼Œ<strong>æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶ç¨‹åº</strong>ï¼Œ<strong>å¯åŠ¨ä¹‹åä¼šä¸€ç›´ç›‘å¬ API Serverï¼Œè·å–åˆ° <code>PodSpec.NodeName</code> ä¸ºç©ºçš„ Podï¼Œå¯¹æ¯ä¸ª Pod éƒ½ä¼šåˆ›å»ºä¸€ä¸ª bindingã€‚</strong></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220114165101.png" alt="kube-scheduler structrue"></p>
<p>è¿™ä¸ªè¿‡ç¨‹åœ¨æˆ‘ä»¬çœ‹æ¥å¥½åƒæ¯”è¾ƒç®€å•ï¼Œä½†åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜å°±æœ‰å¾ˆå¤šäº†ï¼š</p>
<ul>
<li>å¦‚ä½•ä¿è¯å…¨éƒ¨çš„èŠ‚ç‚¹è°ƒåº¦çš„å…¬å¹³æ€§ï¼Ÿè¦çŸ¥é“å¹¶ä¸æ˜¯æ‰€æœ‰èŠ‚ç‚¹èµ„æºé…ç½®ä¸€å®šéƒ½æ˜¯ä¸€æ ·çš„</li>
<li>å¦‚ä½•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è¢«åˆ†é…èµ„æºï¼Ÿ</li>
<li>é›†ç¾¤èµ„æºå¦‚ä½•èƒ½å¤Ÿè¢«é«˜æ•ˆåˆ©ç”¨ï¼Ÿ</li>
<li>é›†ç¾¤èµ„æºå¦‚ä½•æ‰èƒ½è¢«æœ€å¤§åŒ–ä½¿ç”¨ï¼Ÿ</li>
<li><strong>å¦‚ä½•ä¿è¯ Pod è°ƒåº¦çš„æ€§èƒ½å’Œæ•ˆç‡ï¼Ÿ</strong>(å‡è®¾è¯´æœ‰1wä¸ªèŠ‚ç‚¹ï¼Œæˆ‘æ˜¯å¦å¯ä»¥åœ¨å…¶ä¸­1kä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œç­›é€‰å‘¢ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¹…åº¦æé«˜è°ƒåº¦æ•ˆç‡äº†ğŸ˜€)</li>
<li>ç”¨æˆ·æ˜¯å¦å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚å®šåˆ¶è‡ªå·±çš„è°ƒåº¦ç­–ç•¥ï¼Ÿ</li>
</ul>
<p>ğŸ‚ è°ƒåº¦ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>é¦–å…ˆæ˜¯<strong>é¢„é€‰è¿‡ç¨‹</strong>ï¼Œè¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º <code>Predicates</code>ï¼ˆè¿‡æ»¤ï¼‰</li>
<li>ç„¶åæ˜¯<strong>ä¼˜é€‰è¿‡ç¨‹</strong>ï¼Œå¯¹é€šè¿‡çš„èŠ‚ç‚¹æŒ‰ç…§ä¼˜å…ˆçº§æ’åºï¼Œç§°ä¹‹ä¸º <code>Priorities</code>ï¼ˆæ‰“åˆ†ï¼‰</li>
<li>æœ€åä»ä¸­é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹ï¼Œå¦‚æœä¸­é—´ä»»ä½•ä¸€æ­¥éª¤æœ‰é”™è¯¯ï¼Œå°±ç›´æ¥è¿”å›é”™è¯¯</li>
</ul>
<p><code>Predicates</code> é˜¶æ®µé¦–å…ˆéå†å…¨éƒ¨èŠ‚ç‚¹ï¼Œè¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå±äº<code>å¼ºåˆ¶æ€§</code>è§„åˆ™ï¼Œè¿™ä¸€é˜¶æ®µè¾“å‡ºçš„æ‰€æœ‰æ»¡è¶³è¦æ±‚çš„èŠ‚ç‚¹å°†è¢«è®°å½•å¹¶ä½œä¸ºç¬¬äºŒé˜¶æ®µçš„è¾“å…¥ï¼Œ<strong>å¦‚æœæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¸æ»¡è¶³æ¡ä»¶ï¼Œé‚£ä¹ˆ Pod å°†ä¼šä¸€ç›´å¤„äº Pending çŠ¶æ€ï¼Œç›´åˆ°æœ‰èŠ‚ç‚¹æ»¡è¶³æ¡ä»¶ï¼Œåœ¨è¿™æœŸé—´è°ƒåº¦å™¨ä¼šä¸æ–­çš„é‡è¯•ã€‚</strong></p>
<p><u>æ‰€ä»¥æˆ‘ä»¬åœ¨éƒ¨ç½²åº”ç”¨çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°æœ‰ Pod ä¸€ç›´å¤„äº Pending çŠ¶æ€ï¼Œé‚£ä¹ˆå°±æ˜¯æ²¡æœ‰æ»¡è¶³è°ƒåº¦æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å»æ£€æŸ¥ä¸‹èŠ‚ç‚¹èµ„æºæ˜¯å¦å¯ç”¨ã€‚</u></p>
<p><code>Priorities</code> é˜¶æ®µå³å†æ¬¡å¯¹èŠ‚ç‚¹è¿›è¡Œç­›é€‰ï¼Œå¦‚æœæœ‰å¤šä¸ªèŠ‚ç‚¹éƒ½æ»¡è¶³æ¡ä»¶çš„è¯ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šæŒ‰ç…§èŠ‚ç‚¹çš„ä¼˜å…ˆçº§(<code>priorites</code>)å¤§å°å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œæœ€åé€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹æ¥éƒ¨ç½² Pod åº”ç”¨ã€‚</p>
<blockquote>
<p>01ã€å¦‚æœä½ çš„podå¤„äºpendingçŠ¶æ€ï¼Œé‚£ä¹ˆä¸€å®šå°±æ˜¯è°ƒåº¦å™¨å‡ºç°äº†é—®é¢˜ï¼Œé‚£ä¹ˆåŸå› ä¼šå¾ˆå¤šï¼Œæœ‰å¯èƒ½æ˜¯ä½ çš„nodeèµ„æºä¸è¶³ï¼Œæœ‰å¯èƒ½æ˜¯ä½ çš„èŠ‚ç‚¹å·²ç»è¢«å ç”¨äº†â€¦â€¦(å› æ­¤éœ€è¦ä½¿ç”¨kubectl describle pod xxxæ¥æŸ¥çœ‹åŸå› )</p>
<p>02ã€æ‰€è°“çš„bingæ“ä½œå°±æ˜¯å¦‚ä¸‹ï¼š<br>$ kubectl get po apisix-etcd-0 -napisix -oyaml<br>â€¦â€¦<br>nodeName: node2 #å°†podçš„é…ç½®æ¸…å•çš„nodeNameå­—æ®µè¡¥å……å®Œæˆã€‚<br>â€¦â€¦</p>
</blockquote>
<p>ğŸ‚ ä¸‹é¢æ˜¯è°ƒåº¦è¿‡ç¨‹çš„ç®€å•ç¤ºæ„å›¾ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220114165333.png" alt="kube-scheduler filter"></p>
<p>æ›´è¯¦ç»†çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li><p>é¦–å…ˆï¼Œå®¢æˆ·ç«¯é€šè¿‡ API Server çš„ REST API æˆ–è€… kubectl å·¥å…·åˆ›å»º Pod èµ„æº</p>
</li>
<li><p>API Server æ”¶åˆ°ç”¨æˆ·è¯·æ±‚åï¼Œå­˜å‚¨ç›¸å…³æ•°æ®åˆ° etcd æ•°æ®åº“ä¸­</p>
</li>
<li><p>è°ƒåº¦å™¨ç›‘å¬ API Server æŸ¥çœ‹åˆ°è¿˜æœªè¢«è°ƒåº¦(bind)çš„ Pod åˆ—è¡¨ï¼Œå¾ªç¯éå†åœ°ä¸ºæ¯ä¸ª Pod å°è¯•åˆ†é…èŠ‚ç‚¹ï¼Œè¿™ä¸ªåˆ†é…è¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li><strong>é¢„é€‰é˜¶æ®µ(Predicates)<strong>ï¼Œè¿‡æ»¤èŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨ç”¨</strong>ä¸€ç»„è§„åˆ™</strong>è¿‡æ»¤æ‰ä¸ç¬¦åˆè¦æ±‚çš„ Node èŠ‚ç‚¹ï¼Œæ¯”å¦‚ Pod è®¾ç½®äº†èµ„æºçš„ requestï¼Œé‚£ä¹ˆå¯ç”¨èµ„æºæ¯” Pod éœ€è¦çš„èµ„æºå°‘çš„ä¸»æœºæ˜¾ç„¶å°±ä¼šè¢«è¿‡æ»¤æ‰ã€‚</li>
<li><strong>ä¼˜é€‰é˜¶æ®µ(Priorities)<strong>ï¼Œä¸ºèŠ‚ç‚¹çš„ä¼˜å…ˆçº§æ‰“åˆ†ï¼Œå°†ä¸Šä¸€é˜¶æ®µè¿‡æ»¤å‡ºæ¥çš„ Node åˆ—è¡¨è¿›è¡Œæ‰“åˆ†ï¼Œ</strong>è°ƒåº¦å™¨ä¼šè€ƒè™‘ä¸€äº›æ•´ä½“çš„ä¼˜åŒ–ç­–ç•¥</strong>ï¼Œæ¯”å¦‚æŠŠ Deployment æ§åˆ¶çš„å¤šä¸ª Pod å‰¯æœ¬å°½é‡åˆ†å¸ƒåˆ°ä¸åŒçš„ä¸»æœºä¸Šï¼Œä½¿ç”¨æœ€ä½è´Ÿè½½çš„ä¸»æœºç­‰ç­‰ç­–ç•¥ã€‚</li>
</ul>
</li>
<li><p>ç»è¿‡ä¸Šé¢çš„é˜¶æ®µè¿‡æ»¤åé€‰æ‹©æ‰“åˆ†æœ€é«˜çš„ Node èŠ‚ç‚¹å’Œ Pod è¿›è¡Œ <code>binding</code> æ“ä½œï¼Œç„¶åå°†ç»“æœå­˜å‚¨åˆ° etcd ä¸­ï¼Œ æœ€åè¢«é€‰æ‹©å‡ºæ¥çš„ Node èŠ‚ç‚¹å¯¹åº”çš„ kubelet å»æ‰§è¡Œåˆ›å»º Pod çš„ç›¸å…³æ“ä½œï¼ˆå½“ç„¶ä¹Ÿæ˜¯ watch APIServer å‘ç°çš„ï¼‰ã€‚</p>
</li>
</ul>
<p>ğŸ‚ Predicates pluginå·¥ä½œåŸç†</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514230119.png"><br>é“¾å¼è¿‡æ»¤å™¨</p>
<p>ğŸ‚ è°ƒåº¦æ’ä»¶</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514225924.png"><br>LeastAllocatedï¼šç©ºé—²èµ„æºå¤šçš„åˆ†é«˜  â€“ä½¿çš„nodeä¸Šçš„è´Ÿè½½æ¯”è¾ƒåˆç†ä¸€ç‚¹ï¼<br>MostAllocatedï¼šç©ºé—²èµ„æºå°‘çš„åˆ†é«˜  â€“ å¯ä»¥é€€å›Nodeèµ„æºï¼</p>
<h3 id="2-æ‰©å±•è°ƒåº¦å™¨"><a href="#2-æ‰©å±•è°ƒåº¦å™¨" class="headerlink" title="2.æ‰©å±•è°ƒåº¦å™¨"></a>2.æ‰©å±•è°ƒåº¦å™¨</h3><p>åŒ…æ‹¬å¾ˆå¤šæ—¶å€™ï¼Œé»˜è®¤çš„è°ƒåº¦å™¨å·²ç»ä¸èƒ½æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œéœ€è¦å¯¹å®ƒåš<strong>è‡ªå®šä¹‰çš„æ‰©å±•å’Œå®ç°</strong>ï¼Œå…·ä½“è¯¥æ€ä¹ˆåšï¼ŒèƒŒåçš„åŸç†åˆæ˜¯ä»€ä¹ˆæ ·çš„ï¼Œä¸šç•Œæœ‰æ²¡æœ‰ä¼˜ç§€æ¡ˆä¾‹å¯ä¾›å‚è€ƒï¼Œè¿™äº›éƒ½æ˜¯éå¸¸ä»¤äººå¤´ç–¼çš„é—®é¢˜ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514231649.png"></p>
<p>extenderæœ¬èº«å°±æ˜¯ä¸€ä¸ªæ‹‰ä½æ€§èƒ½çš„å› ç´ ã€‚</p>
<p>ğŸ‚ è€ƒè™‘åˆ°å®é™…ç¯å¢ƒä¸­çš„å„ç§å¤æ‚æƒ…å†µï¼Œ<strong>kubernetes çš„è°ƒåº¦å™¨é‡‡ç”¨æ’ä»¶åŒ–çš„å½¢å¼å®ç°</strong>ï¼Œå¯ä»¥æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œå®šåˆ¶æˆ–è€…äºŒæ¬¡å¼€å‘ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè°ƒåº¦å™¨å¹¶ä»¥æ’ä»¶å½¢å¼å’Œ kubernetes è¿›è¡Œé›†æˆã€‚</p>
<blockquote>
<p>å¼€å‘äººå‘˜æ³¨æ„å³å¯ï¼š</p>
<p>kubernetes è°ƒåº¦å™¨çš„æºç ä½äº <code>kubernetes/pkg/scheduler</code> ä¸­ï¼Œå…¶ä¸­ Scheduler åˆ›å»ºå’Œè¿è¡Œçš„æ ¸å¿ƒç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ <code>pkg/scheduler/scheduler.go</code>ï¼Œå¦‚æœè¦æŸ¥çœ‹ <code>kube-scheduler</code> çš„å…¥å£ç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ <code>cmd/kube-scheduler/scheduler.go</code>ã€‚</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github1s.com/kubernetes/kubernetes/tree/v1.22.5">https://github1s.com/kubernetes/kubernetes/tree/v1.22.5</a></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220216165230058.png" alt="image-20220216165230058"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220216165341841.png" alt="image-20220216165341841"></p>
<h3 id="3-è°ƒåº¦æ¡†æ¶"><a href="#3-è°ƒåº¦æ¡†æ¶" class="headerlink" title="3.è°ƒåº¦æ¡†æ¶"></a>3.è°ƒåº¦æ¡†æ¶</h3><p><strong>åŸºäºScheduler Frameworkå®ç°æ‰©å±•</strong></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514231731.png"></p>
<p>æœªæ¥ä¸»æµçš„æ–¹æ³•ã€‚</p>
<p>ğŸ‚ <strong>ç›®å‰è°ƒåº¦å™¨å·²ç»å…¨éƒ¨é€šè¿‡æ’ä»¶çš„æ–¹å¼å®ç°äº†è°ƒåº¦æ¡†æ¶</strong>ï¼Œé»˜è®¤å¼€å¯çš„è°ƒåº¦æ’ä»¶å¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pkg/scheduler/algorithmprovider/registry.go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDefaultConfig</span><span class="params">()</span> *<span class="title">schedulerapi</span>.<span class="title">Plugins</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;schedulerapi.Plugins&#123;</span><br><span class="line">        QueueSort: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: queuesort.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        PreFilter: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: noderesources.FitName&#125;,</span><br><span class="line">                &#123;Name: nodeports.Name&#125;,</span><br><span class="line">                &#123;Name: podtopologyspread.Name&#125;,</span><br><span class="line">                &#123;Name: interpodaffinity.Name&#125;,</span><br><span class="line">                &#123;Name: volumebinding.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        Filter: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: nodeunschedulable.Name&#125;,</span><br><span class="line">                &#123;Name: noderesources.FitName&#125;,</span><br><span class="line">                &#123;Name: nodename.Name&#125;,</span><br><span class="line">                &#123;Name: nodeports.Name&#125;,</span><br><span class="line">                &#123;Name: nodeaffinity.Name&#125;,</span><br><span class="line">                &#123;Name: volumerestrictions.Name&#125;,</span><br><span class="line">                &#123;Name: tainttoleration.Name&#125;,</span><br><span class="line">                &#123;Name: nodevolumelimits.EBSName&#125;,</span><br><span class="line">                &#123;Name: nodevolumelimits.GCEPDName&#125;,</span><br><span class="line">                &#123;Name: nodevolumelimits.CSIName&#125;,</span><br><span class="line">                &#123;Name: nodevolumelimits.AzureDiskName&#125;,</span><br><span class="line">                &#123;Name: volumebinding.Name&#125;,</span><br><span class="line">                &#123;Name: volumezone.Name&#125;,</span><br><span class="line">                &#123;Name: podtopologyspread.Name&#125;,</span><br><span class="line">                &#123;Name: interpodaffinity.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        PostFilter: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: defaultpreemption.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        PreScore: &amp;schedulerapi.PluginSet&#123; #æ‰“åˆ†</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: interpodaffinity.Name&#125;,</span><br><span class="line">                &#123;Name: podtopologyspread.Name&#125;,</span><br><span class="line">                &#123;Name: tainttoleration.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        Score: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: noderesources.BalancedAllocationName, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: imagelocality.Name, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: interpodaffinity.Name, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: noderesources.LeastAllocatedName, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: nodeaffinity.Name, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: nodepreferavoidpods.Name, Weight: <span class="number">10000</span>&#125;,</span><br><span class="line">                <span class="comment">// Weight is doubled because:</span></span><br><span class="line">                <span class="comment">// - This is a score coming from user preference.</span></span><br><span class="line">                <span class="comment">// - It makes its signal comparable to NodeResourcesLeastAllocated.</span></span><br><span class="line">                &#123;Name: podtopologyspread.Name, Weight: <span class="number">2</span>&#125;,</span><br><span class="line">                &#123;Name: tainttoleration.Name, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        Reserve: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: volumebinding.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        PreBind: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: volumebinding.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        Bind: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: defaultbinder.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè°ƒåº¦å™¨çš„ä¸€ç³»åˆ—ç®—æ³•ç”±å„ç§æ’ä»¶åœ¨è°ƒåº¦çš„ä¸åŒé˜¶æ®µæ¥å®Œæˆï¼Œä¸‹é¢æˆ‘ä»¬å°±å…ˆæ¥äº†è§£ä¸‹è°ƒåº¦æ¡†æ¶ã€‚</p>
<p>è°ƒåº¦æ¡†æ¶å®šä¹‰äº†ä¸€ç»„æ‰©å±•ç‚¹ï¼Œç”¨æˆ·å¯ä»¥å®ç°æ‰©å±•ç‚¹å®šä¹‰çš„æ¥å£æ¥å®šä¹‰è‡ªå·±çš„è°ƒåº¦é€»è¾‘ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>æ‰©å±•</strong>ï¼‰ï¼Œå¹¶å°†æ‰©å±•æ³¨å†Œåˆ°æ‰©å±•ç‚¹ä¸Šï¼Œè°ƒåº¦æ¡†æ¶åœ¨æ‰§è¡Œè°ƒåº¦å·¥ä½œæµæ—¶ï¼Œé‡åˆ°å¯¹åº”çš„æ‰©å±•ç‚¹æ—¶ï¼Œå°†è°ƒç”¨ç”¨æˆ·æ³¨å†Œçš„æ‰©å±•ã€‚è°ƒåº¦æ¡†æ¶åœ¨é¢„ç•™æ‰©å±•ç‚¹æ—¶ï¼Œéƒ½æ˜¯æœ‰ç‰¹å®šçš„ç›®çš„ï¼Œæœ‰äº›æ‰©å±•ç‚¹ä¸Šçš„æ‰©å±•å¯ä»¥æ”¹å˜è°ƒåº¦ç¨‹åºçš„å†³ç­–æ–¹æ³•ï¼Œæœ‰äº›æ‰©å±•ç‚¹ä¸Šçš„æ‰©å±•åªæ˜¯å‘é€ä¸€ä¸ªé€šçŸ¥ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“æ¯å½“è°ƒåº¦ä¸€ä¸ª Pod æ—¶ï¼Œéƒ½ä¼šæŒ‰ç…§ä¸¤ä¸ªè¿‡ç¨‹æ¥æ‰§è¡Œï¼š<strong>è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹</strong>ã€‚</p>
<p>è°ƒåº¦è¿‡ç¨‹ä¸º Pod é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„èŠ‚ç‚¹ï¼Œç»‘å®šè¿‡ç¨‹åˆ™å°†è°ƒåº¦è¿‡ç¨‹çš„å†³ç­–åº”ç”¨åˆ°é›†ç¾¤ä¸­ï¼ˆä¹Ÿå°±æ˜¯åœ¨è¢«é€‰å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡Œ Podï¼‰ï¼Œå°†è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹åˆåœ¨ä¸€èµ·ï¼Œç§°ä¹‹ä¸º<strong>è°ƒåº¦ä¸Šä¸‹æ–‡ï¼ˆscheduling contextï¼‰</strong>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯**<u>è°ƒåº¦è¿‡ç¨‹æ˜¯<code>åŒæ­¥</code>è¿è¡Œçš„ï¼ˆåŒä¸€æ—¶é—´ç‚¹åªä¸ºä¸€ä¸ª Pod è¿›è¡Œè°ƒåº¦ï¼‰</u>**ï¼Œç»‘å®šè¿‡ç¨‹å¯å¼‚æ­¥è¿è¡Œï¼ˆåŒä¸€æ—¶é—´ç‚¹å¯å¹¶å‘ä¸ºå¤šä¸ª Pod æ‰§è¡Œç»‘å®šï¼‰ã€‚</p>
<p>è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹é‡åˆ°å¦‚ä¸‹æƒ…å†µæ—¶ä¼šä¸­é€”é€€å‡ºï¼š</p>
<ul>
<li>è°ƒåº¦ç¨‹åºè®¤ä¸ºå½“å‰æ²¡æœ‰è¯¥ Pod çš„å¯é€‰èŠ‚ç‚¹</li>
<li>å†…éƒ¨é”™è¯¯</li>
</ul>
<p>è¿™ä¸ªæ—¶å€™ï¼Œè¯¥ Pod å°†è¢«æ”¾å›åˆ° <strong>å¾…è°ƒåº¦é˜Ÿåˆ—</strong>ï¼Œå¹¶ç­‰å¾…ä¸‹æ¬¡é‡è¯•ã€‚</p>
<h4 id="1-æ‰©å±•ç‚¹ï¼ˆExtension-Pointsï¼‰"><a href="#1-æ‰©å±•ç‚¹ï¼ˆExtension-Pointsï¼‰" class="headerlink" title="1.æ‰©å±•ç‚¹ï¼ˆExtension Pointsï¼‰"></a>1.æ‰©å±•ç‚¹ï¼ˆExtension Pointsï¼‰</h4><p>ä¸‹å›¾å±•ç¤ºäº†è°ƒåº¦æ¡†æ¶ä¸­çš„è°ƒåº¦ä¸Šä¸‹æ–‡åŠå…¶ä¸­çš„æ‰©å±•ç‚¹ï¼Œä¸€ä¸ªæ‰©å±•å¯ä»¥æ³¨å†Œå¤šä¸ªæ‰©å±•ç‚¹ï¼Œä»¥ä¾¿å¯ä»¥æ‰§è¡Œæ›´å¤æ‚çš„æœ‰çŠ¶æ€çš„ä»»åŠ¡ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220114165454.png" alt="scheduling framework extensions"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514222039.png"></p>
<p>è°ƒåº¦é˜¶æ®µï¼š<br>    1.predicate(é¢„é€‰)ï¼š<br>    2.priority/score(ä¼˜é€‰)ï¼š<br>ç»‘å®šé˜¶æ®µï¼š</p>
<p>ğŸ‚ è¯¦ç»†è¿‡ç¨‹ï¼š</p>
<ol>
<li><code>QueueSort</code> æ‰©å±•ç”¨äºå¯¹ Pod çš„å¾…è°ƒåº¦é˜Ÿåˆ—è¿›è¡Œæ’åºï¼Œä»¥å†³å®šå…ˆè°ƒåº¦å“ªä¸ª Podï¼Œ<code>QueueSort</code> æ‰©å±•æœ¬è´¨ä¸Šåªéœ€è¦å®ç°ä¸€ä¸ªæ–¹æ³• <code>Less(Pod1, Pod2)</code> ç”¨äºæ¯”è¾ƒä¸¤ä¸ª Pod è°æ›´ä¼˜å…ˆè·å¾—è°ƒåº¦å³å¯ï¼ŒåŒä¸€æ—¶é—´ç‚¹åªèƒ½æœ‰ä¸€ä¸ª <code>QueueSort</code> æ’ä»¶ç”Ÿæ•ˆã€‚</li>
<li><code>Pre-filter</code> æ‰©å±•ç”¨äº<strong>å¯¹ Pod çš„ä¿¡æ¯è¿›è¡Œé¢„å¤„ç†</strong>ï¼Œæˆ–è€…æ£€æŸ¥ä¸€äº›é›†ç¾¤æˆ– Pod å¿…é¡»æ»¡è¶³çš„å‰ææ¡ä»¶ï¼Œå¦‚æœ <code>pre-filter</code> è¿”å›äº† errorï¼Œåˆ™è°ƒåº¦è¿‡ç¨‹ç»ˆæ­¢ã€‚</li>
<li><code>Filter</code> æ‰©å±•ç”¨äºæ’é™¤é‚£äº›ä¸èƒ½è¿è¡Œè¯¥ Pod çš„èŠ‚ç‚¹ï¼Œå¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨å°†æŒ‰é¡ºåºæ‰§è¡Œ <code>filter</code> æ‰©å±•ï¼›å¦‚æœä»»ä½•ä¸€ä¸ª <code>filter</code> å°†èŠ‚ç‚¹æ ‡è®°ä¸ºä¸å¯é€‰ï¼Œåˆ™ä½™ä¸‹çš„ <code>filter</code> æ‰©å±•å°†ä¸ä¼šè¢«æ‰§è¡Œã€‚<strong>è°ƒåº¦å™¨å¯ä»¥åŒæ—¶å¯¹å¤šä¸ªèŠ‚ç‚¹æ‰§è¡Œ <code>filter</code> æ‰©å±•ã€‚</strong></li>
<li><code>Post-filter</code> <strong>æ˜¯ä¸€ä¸ªé€šçŸ¥ç±»å‹çš„æ‰©å±•ç‚¹</strong>ï¼Œè°ƒç”¨è¯¥æ‰©å±•çš„å‚æ•°æ˜¯ <code>filter</code> é˜¶æ®µç»“æŸåè¢«ç­›é€‰ä¸º<strong>å¯é€‰èŠ‚ç‚¹</strong>çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¯ä»¥åœ¨æ‰©å±•ä¸­ä½¿ç”¨è¿™äº›ä¿¡æ¯æ›´æ–°å†…éƒ¨çŠ¶æ€ï¼Œæˆ–è€…äº§ç”Ÿæ—¥å¿—æˆ– metrics ä¿¡æ¯ã€‚</li>
<li><code>Scoring</code> æ‰©å±•ç”¨äºä¸ºæ‰€æœ‰å¯é€‰èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ï¼Œè°ƒåº¦å™¨å°†é’ˆå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹è°ƒç”¨ <code>Soring</code> æ‰©å±•ï¼Œè¯„åˆ†ç»“æœæ˜¯ä¸€ä¸ªèŒƒå›´å†…çš„æ•´æ•°ã€‚åœ¨ <code>normalize scoring</code> é˜¶æ®µï¼Œè°ƒåº¦å™¨å°†ä¼šæŠŠæ¯ä¸ª <code>scoring</code> æ‰©å±•<strong>å¯¹å…·ä½“æŸä¸ªèŠ‚ç‚¹çš„è¯„åˆ†ç»“æœå’Œè¯¥æ‰©å±•çš„æƒé‡åˆå¹¶èµ·æ¥</strong>ï¼Œä½œä¸ºæœ€ç»ˆè¯„åˆ†ç»“æœã€‚</li>
<li><code>Normalize scoring</code> <strong>æ‰©å±•åœ¨è°ƒåº¦å™¨å¯¹èŠ‚ç‚¹è¿›è¡Œæœ€ç»ˆæ’åºä¹‹å‰ä¿®æ”¹æ¯ä¸ªèŠ‚ç‚¹çš„è¯„åˆ†ç»“æœ</strong>ï¼Œæ³¨å†Œåˆ°è¯¥æ‰©å±•ç‚¹çš„æ‰©å±•åœ¨è¢«è°ƒç”¨æ—¶ï¼Œå°†è·å¾—åŒä¸€ä¸ªæ’ä»¶ä¸­çš„ <code>scoring</code> æ‰©å±•çš„è¯„åˆ†ç»“æœä½œä¸ºå‚æ•°ï¼Œè°ƒåº¦æ¡†æ¶æ¯æ‰§è¡Œä¸€æ¬¡è°ƒåº¦ï¼Œéƒ½å°†è°ƒç”¨æ‰€æœ‰æ’ä»¶ä¸­çš„ä¸€ä¸ª <code>normalize scoring</code> æ‰©å±•ä¸€æ¬¡ã€‚</li>
<li><code>Reserve</code> æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ç‚¹ï¼Œæœ‰çŠ¶æ€çš„æ’ä»¶å¯ä»¥ä½¿ç”¨è¯¥æ‰©å±•ç‚¹æ¥è·å¾—èŠ‚ç‚¹ä¸Šä¸º Pod é¢„ç•™çš„èµ„æºï¼Œè¯¥äº‹ä»¶å‘ç”Ÿåœ¨è°ƒåº¦å™¨å°† Pod ç»‘å®šåˆ°èŠ‚ç‚¹ä¹‹å‰ï¼Œç›®çš„æ˜¯é¿å…è°ƒåº¦å™¨åœ¨ç­‰å¾… Pod ä¸èŠ‚ç‚¹ç»‘å®šçš„è¿‡ç¨‹ä¸­è°ƒåº¦æ–°çš„ Pod åˆ°èŠ‚ç‚¹ä¸Šæ—¶ï¼Œå‘ç”Ÿå®é™…ä½¿ç”¨èµ„æºè¶…å‡ºå¯ç”¨èµ„æºçš„æƒ…å†µï¼ˆ<strong>å› ä¸ºç»‘å®š Pod åˆ°èŠ‚ç‚¹ä¸Šæ˜¯å¼‚æ­¥å‘ç”Ÿçš„</strong>ï¼‰ã€‚è¿™æ˜¯è°ƒåº¦è¿‡ç¨‹çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼ŒPod è¿›å…¥ reserved çŠ¶æ€ä»¥åï¼Œè¦ä¹ˆåœ¨ç»‘å®šå¤±è´¥æ—¶è§¦å‘ Unreserve æ‰©å±•ï¼Œè¦ä¹ˆåœ¨ç»‘å®šæˆåŠŸæ—¶ï¼Œç”± Post-bind æ‰©å±•ç»“æŸç»‘å®šè¿‡ç¨‹ã€‚</li>
<li><code>Permit</code> æ‰©å±•ç”¨äºé˜»æ­¢æˆ–è€…å»¶è¿Ÿ Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šã€‚Permit æ‰©å±•å¯ä»¥åšä¸‹é¢ä¸‰ä»¶äº‹ä¸­çš„ä¸€é¡¹ï¼š<ul>
<li>approveï¼ˆæ‰¹å‡†ï¼‰ï¼šå½“æ‰€æœ‰çš„ permit æ‰©å±•éƒ½ approve äº† Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼Œè°ƒåº¦å™¨å°†ç»§ç»­æ‰§è¡Œç»‘å®šè¿‡ç¨‹</li>
<li>denyï¼ˆæ‹’ç»ï¼‰ï¼šå¦‚æœä»»ä½•ä¸€ä¸ª permit æ‰©å±• deny äº† Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ <code>Unreserve</code> æ‰©å±•ã€‚</li>
<li>waitï¼ˆç­‰å¾…ï¼‰ï¼šå¦‚æœä¸€ä¸ª permit æ‰©å±•è¿”å›äº† waitï¼Œåˆ™ Pod å°†ä¿æŒåœ¨ permit é˜¶æ®µï¼Œç›´åˆ°è¢«å…¶ä»–æ‰©å±• approveï¼Œå¦‚æœè¶…æ—¶äº‹ä»¶å‘ç”Ÿï¼Œwait çŠ¶æ€å˜æˆ denyï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ Unreserve æ‰©å±•</li>
</ul>
</li>
<li><code>Pre-bind</code> æ‰©å±•ç”¨äºåœ¨ Pod ç»‘å®šä¹‹å‰æ‰§è¡ŒæŸäº›é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œpre-bind æ‰©å±•å¯ä»¥å°†ä¸€ä¸ªåŸºäºç½‘ç»œçš„æ•°æ®å·æŒ‚è½½åˆ°èŠ‚ç‚¹ä¸Šï¼Œä»¥ä¾¿ Pod å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœä»»ä½•ä¸€ä¸ª <code>pre-bind</code> æ‰©å±•è¿”å›é”™è¯¯ï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ Unreserve æ‰©å±•ã€‚</li>
<li><code>Bind</code> æ‰©å±•ç”¨äºå°† Pod ç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šï¼š<ul>
<li>åªæœ‰æ‰€æœ‰çš„ pre-bind æ‰©å±•éƒ½æˆåŠŸæ‰§è¡Œäº†ï¼Œbind æ‰©å±•æ‰ä¼šæ‰§è¡Œ</li>
<li>è°ƒåº¦æ¡†æ¶æŒ‰ç…§ bind æ‰©å±•æ³¨å†Œçš„é¡ºåºé€ä¸ªè°ƒç”¨ bind æ‰©å±•</li>
<li>å…·ä½“æŸä¸ª bind æ‰©å±•å¯ä»¥é€‰æ‹©å¤„ç†æˆ–è€…ä¸å¤„ç†è¯¥ Pod</li>
<li>å¦‚æœæŸä¸ª bind æ‰©å±•å¤„ç†äº†è¯¥ Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼Œä½™ä¸‹çš„ bind æ‰©å±•å°†è¢«å¿½ç•¥</li>
</ul>
</li>
<li><code>Post-bind</code> æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ï¼š<ul>
<li>Post-bind æ‰©å±•åœ¨ Pod æˆåŠŸç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šä¹‹åè¢«åŠ¨è°ƒç”¨</li>
<li>Post-bind æ‰©å±•æ˜¯ç»‘å®šè¿‡ç¨‹çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œ<strong>èµ„æºæ¸…ç†</strong>çš„åŠ¨ä½œ</li>
</ul>
</li>
<li><code>Unreserve</code> æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ï¼Œå¦‚æœä¸º Pod é¢„ç•™äº†èµ„æºï¼ŒPod åˆåœ¨è¢«ç»‘å®šè¿‡ç¨‹ä¸­è¢«æ‹’ç»ç»‘å®šï¼Œåˆ™ unreserve æ‰©å±•å°†è¢«è°ƒç”¨ã€‚Unreserve æ‰©å±•åº”è¯¥é‡Šæ”¾å·²ç»ä¸º Pod é¢„ç•™çš„èŠ‚ç‚¹ä¸Šçš„è®¡ç®—èµ„æºã€‚<strong>åœ¨ä¸€ä¸ªæ’ä»¶ä¸­ï¼Œreserve æ‰©å±•å’Œ unreserve æ‰©å±•åº”è¯¥æˆå¯¹å‡ºç°</strong>ã€‚</li>
</ol>
<p>ğŸ‚ å¦‚æœæˆ‘ä»¬è¦å®ç°è‡ªå·±çš„æ’ä»¶ï¼Œå¿…é¡»å‘è°ƒåº¦æ¡†æ¶æ³¨å†Œæ’ä»¶å¹¶å®Œæˆé…ç½®ï¼Œå¦å¤–è¿˜å¿…é¡»å®ç°<strong>æ‰©å±•ç‚¹æ¥å£</strong>ï¼Œå¯¹åº”çš„æ‰©å±•ç‚¹æ¥å£æˆ‘ä»¬å¯ä»¥åœ¨æºç  <code>pkg/scheduler/framework/v1alpha1/interface.go</code> æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Plugin is the parent type for all the scheduling framework plugins.</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Name() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> QueueSortPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Less(*PodInfo, *PodInfo) <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PreFilterPlugin is an interface that must be implemented by &quot;prefilter&quot; plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called at the beginning of the scheduling cycle.</span></span><br><span class="line"><span class="keyword">type</span> PreFilterPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    PreFilter(pc *PluginContext, p *v1.Pod) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FilterPlugin is an interface for Filter plugins. These plugins are called at the</span></span><br><span class="line"><span class="comment">// filter extension point for filtering out hosts that cannot run a pod.</span></span><br><span class="line"><span class="comment">// This concept used to be called &#x27;predicate&#x27; in the original scheduler.</span></span><br><span class="line"><span class="comment">// These plugins should return &quot;Success&quot;, &quot;Unschedulable&quot; or &quot;Error&quot; in Status.code.</span></span><br><span class="line"><span class="comment">// However, the scheduler accepts other valid codes as well.</span></span><br><span class="line"><span class="comment">// Anything other than &quot;Success&quot; will lead to exclusion of the given host from</span></span><br><span class="line"><span class="comment">// running the pod.</span></span><br><span class="line"><span class="keyword">type</span> FilterPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Filter(pc *PluginContext, pod *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PostFilterPlugin is an interface for Post-filter plugin. Post-filter is an</span></span><br><span class="line"><span class="comment">// informational extension point. Plugins will be called with a list of nodes</span></span><br><span class="line"><span class="comment">// that passed the filtering phase. A plugin may use this data to update internal</span></span><br><span class="line"><span class="comment">// state or to generate logs/metrics.</span></span><br><span class="line"><span class="keyword">type</span> PostFilterPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    PostFilter(pc *PluginContext, pod *v1.Pod, nodes []*v1.Node, filteredNodesStatuses NodeToStatusMap) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ScorePlugin is an interface that must be implemented by &quot;score&quot; plugins to rank</span></span><br><span class="line"><span class="comment">// nodes that passed the filtering phase.</span></span><br><span class="line"><span class="keyword">type</span> ScorePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Score(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) (<span class="keyword">int</span>, *Status)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ScoreWithNormalizePlugin is an interface that must be implemented by &quot;score&quot;</span></span><br><span class="line"><span class="comment">// plugins that also need to normalize the node scoring results produced by the same</span></span><br><span class="line"><span class="comment">// plugin&#x27;s &quot;Score&quot; method.</span></span><br><span class="line"><span class="keyword">type</span> ScoreWithNormalizePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    ScorePlugin</span><br><span class="line">    NormalizeScore(pc *PluginContext, p *v1.Pod, scores NodeScoreList) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReservePlugin is an interface for Reserve plugins. These plugins are called</span></span><br><span class="line"><span class="comment">// at the reservation point. These are meant to update the state of the plugin.</span></span><br><span class="line"><span class="comment">// This concept used to be called &#x27;assume&#x27; in the original scheduler.</span></span><br><span class="line"><span class="comment">// These plugins should return only Success or Error in Status.code. However,</span></span><br><span class="line"><span class="comment">// the scheduler accepts other valid codes as well. Anything other than Success</span></span><br><span class="line"><span class="comment">// will lead to rejection of the pod.</span></span><br><span class="line"><span class="keyword">type</span> ReservePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Reserve(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PreBindPlugin is an interface that must be implemented by &quot;prebind&quot; plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called before a pod being scheduled.</span></span><br><span class="line"><span class="keyword">type</span> PreBindPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    PreBind(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PostBindPlugin is an interface that must be implemented by &quot;postbind&quot; plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called after a pod is successfully bound to a node.</span></span><br><span class="line"><span class="keyword">type</span> PostBindPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    PostBind(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnreservePlugin is an interface for Unreserve plugins. This is an informational</span></span><br><span class="line"><span class="comment">// extension point. If a pod was reserved and then rejected in a later phase, then</span></span><br><span class="line"><span class="comment">// un-reserve plugins will be notified. Un-reserve plugins should clean up state</span></span><br><span class="line"><span class="comment">// associated with the reserved Pod.</span></span><br><span class="line"><span class="keyword">type</span> UnreservePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Unreserve(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PermitPlugin is an interface that must be implemented by &quot;permit&quot; plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called before a pod is bound to a node.</span></span><br><span class="line"><span class="keyword">type</span> PermitPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Permit(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) (*Status, time.Duration)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BindPlugin is an interface that must be implemented by &quot;bind&quot; plugins. Bind</span></span><br><span class="line"><span class="comment">// plugins are used to bind a pod to a Node.</span></span><br><span class="line"><span class="keyword">type</span> BindPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Bind(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ğŸ‚ å¯¹äºè°ƒåº¦æ¡†æ¶æ’ä»¶çš„å¯ç”¨æˆ–è€…ç¦ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®‰è£…é›†ç¾¤æ—¶çš„ <a target="_blank" rel="noopener" href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#KubeSchedulerConfiguration">KubeSchedulerConfiguration</a> èµ„æºå¯¹è±¡æ¥è¿›è¡Œé…ç½®ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­çš„é…ç½®å¯ç”¨äº†ä¸€ä¸ªå®ç°äº† <code>reserve</code> å’Œ <code>preBind</code> æ‰©å±•ç‚¹çš„æ’ä»¶ï¼Œå¹¶ä¸”ç¦ç”¨äº†å¦å¤–ä¸€ä¸ªæ’ä»¶ï¼ŒåŒæ—¶ä¸ºæ’ä»¶ foo æä¾›äº†ä¸€äº›é…ç½®ä¿¡æ¯ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeSchedulerConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="attr">reserve:</span></span><br><span class="line">    <span class="attr">enabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">    <span class="attr">disabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">baz</span></span><br><span class="line">  <span class="attr">preBind:</span></span><br><span class="line">    <span class="attr">enabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">disabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">baz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pluginConfig:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">  <span class="attr">args:</span> <span class="string">&gt;</span></span><br><span class="line">    <span class="string">fooæ’ä»¶å¯ä»¥è§£æçš„ä»»æ„å†…å®¹</span></span><br></pre></td></tr></table></figure>



<p>ğŸ‚ æ‰©å±•çš„è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœæŸä¸ªæ‰©å±•ç‚¹æ²¡æœ‰é…ç½®å¯¹åº”çš„æ‰©å±•ï¼Œè°ƒåº¦æ¡†æ¶å°†ä½¿ç”¨é»˜è®¤æ’ä»¶ä¸­çš„æ‰©å±•</li>
<li>å¦‚æœä¸ºæŸä¸ªæ‰©å±•ç‚¹é…ç½®ä¸”æ¿€æ´»äº†æ‰©å±•ï¼Œåˆ™è°ƒåº¦æ¡†æ¶å°†å…ˆè°ƒç”¨é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œå†è°ƒç”¨é…ç½®ä¸­çš„æ‰©å±•</li>
<li>é»˜è®¤æ’ä»¶çš„æ‰©å±•å§‹ç»ˆè¢«æœ€å…ˆè°ƒç”¨ï¼Œç„¶åæŒ‰ç…§ <code>KubeSchedulerConfiguration</code> ä¸­æ‰©å±•çš„æ¿€æ´» <code>enabled</code> é¡ºåºé€ä¸ªè°ƒç”¨æ‰©å±•ç‚¹çš„æ‰©å±•</li>
<li>å¯ä»¥å…ˆç¦ç”¨é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œç„¶ååœ¨ <code>enabled</code> åˆ—è¡¨ä¸­çš„æŸä¸ªä½ç½®æ¿€æ´»é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œè¿™ç§åšæ³•å¯ä»¥æ”¹å˜é»˜è®¤æ’ä»¶çš„æ‰©å±•è¢«è°ƒç”¨æ—¶çš„é¡ºåº</li>
</ul>
<p>å‡è®¾é»˜è®¤æ’ä»¶ foo å®ç°äº† <code>reserve</code> æ‰©å±•ç‚¹ï¼Œæ­¤æ—¶æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªæ’ä»¶ barï¼Œæƒ³è¦åœ¨ foo ä¹‹å‰è¢«è°ƒç”¨ï¼Œåˆ™åº”è¯¥å…ˆç¦ç”¨ foo å†æŒ‰ç…§ bar foo çš„é¡ºåºæ¿€æ´»ã€‚ç¤ºä¾‹é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeSchedulerConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="attr">reserve:</span></span><br><span class="line">    <span class="attr">enabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">disabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br></pre></td></tr></table></figure>

<p>åœ¨æºç ç›®å½• <code>pkg/scheduler/framework/plugins/examples</code> ä¸­æœ‰å‡ ä¸ªç¤ºèŒƒæ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å‚ç…§å…¶å®ç°æ–¹å¼ã€‚</p>
<h4 id="2-ç¤ºä¾‹-ä»£ç éƒ¨åˆ†"><a href="#2-ç¤ºä¾‹-ä»£ç éƒ¨åˆ†" class="headerlink" title="2.ç¤ºä¾‹(ä»£ç éƒ¨åˆ†)"></a>2.ç¤ºä¾‹(ä»£ç éƒ¨åˆ†)</h4><blockquote>
<p>å› ä¸ºæ¶‰åŠåˆ°ä»£ç éƒ¨åˆ†ï¼Œæœ¬æ¬¡è¿™é‡Œä¸åšæ¼”ç¤ºï¼Œçœ‹ä¸‹å°±å¥½ã€‚</p>
</blockquote>
<p>å…¶å®è¦å®ç°ä¸€ä¸ªè°ƒåº¦æ¡†æ¶çš„æ’ä»¶ï¼Œå¹¶ä¸éš¾ï¼Œæˆ‘ä»¬åªè¦å®ç°å¯¹åº”çš„æ‰©å±•ç‚¹ï¼Œç„¶åå°†æ’ä»¶æ³¨å†Œåˆ°è°ƒåº¦å™¨ä¸­å³å¯ï¼Œä¸‹é¢æ˜¯é»˜è®¤è°ƒåº¦å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œçš„æ’ä»¶ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pkg/scheduler/algorithmprovider/registry.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRegistry</span><span class="params">()</span> <span class="title">Registry</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Registry&#123;</span><br><span class="line">        <span class="comment">// FactoryMap:</span></span><br><span class="line">        <span class="comment">// New plugins are registered here.</span></span><br><span class="line">        <span class="comment">// example:</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//  stateful_plugin.Name: stateful.NewStatefulMultipointExample,</span></span><br><span class="line">        <span class="comment">//  fooplugin.Name: fooplugin.New,</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¯ä»¥çœ‹åˆ°é»˜è®¤å¹¶æ²¡æœ‰æ³¨å†Œä¸€äº›æ’ä»¶ï¼Œæ‰€ä»¥è¦æƒ³è®©è°ƒåº¦å™¨èƒ½å¤Ÿè¯†åˆ«æˆ‘ä»¬çš„æ’ä»¶ä»£ç ï¼Œå°±éœ€è¦è‡ªå·±æ¥å®ç°ä¸€ä¸ªè°ƒåº¦å™¨äº†ï¼Œå½“ç„¶è¿™ä¸ªè°ƒåº¦å™¨æˆ‘ä»¬å®Œå…¨æ²¡å¿…è¦å®Œå…¨è‡ªå·±å®ç°ï¼Œç›´æ¥è°ƒç”¨é»˜è®¤çš„è°ƒåº¦å™¨ï¼Œç„¶ååœ¨ä¸Šé¢çš„ <code>NewRegistry()</code> å‡½æ•°ä¸­å°†æˆ‘ä»¬çš„æ’ä»¶æ³¨å†Œè¿›å»å³å¯ã€‚åœ¨ <code>kube-scheduler</code> çš„æºç æ–‡ä»¶ <code>kubernetes/cmd/kube-scheduler/app/server.go</code> ä¸­æœ‰ä¸€ä¸ª <code>NewSchedulerCommand</code> å…¥å£å‡½æ•°ï¼Œå…¶ä¸­çš„å‚æ•°æ˜¯ä¸€ä¸ªç±»å‹ä¸º <code>Option</code> çš„åˆ—è¡¨ï¼Œè€Œè¿™ä¸ª <code>Option</code> æ°å¥½å°±æ˜¯ä¸€ä¸ªæ’ä»¶é…ç½®çš„å®šä¹‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Option configures a framework.Registry.</span></span><br><span class="line"><span class="keyword">type</span> Option <span class="function"><span class="keyword">func</span><span class="params">(framework.Registry)</span> <span class="title">error</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NewSchedulerCommand creates a *cobra.Command object with default parameters and registryOptions</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSchedulerCommand</span><span class="params">(registryOptions ...Option)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬å®Œå…¨å°±å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥ä½œä¸ºæˆ‘ä»¬çš„å‡½æ•°å…¥å£ï¼Œå¹¶ä¸”ä¼ å…¥æˆ‘ä»¬è‡ªå·±å®ç°çš„æ’ä»¶ä½œä¸ºå‚æ•°å³å¯ï¼Œè€Œä¸”è¯¥æ–‡ä»¶ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªåä¸º <code>WithPlugin</code> çš„å‡½æ•°å¯ä»¥æ¥åˆ›å»ºä¸€ä¸ª <code>Option</code> å®ä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithPlugin creates an Option based on plugin name and factory.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithPlugin</span><span class="params">(name <span class="keyword">string</span>, factory framework.PluginFactory)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(registry framework.Registry)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> registry.Register(name, factory)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬çš„å…¥å£å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rand.Seed(time.Now().UTC().UnixNano())</span><br><span class="line"></span><br><span class="line">    command := app.NewSchedulerCommand(</span><br><span class="line">        app.WithPlugin(sample.Name, sample.New),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    logs.InitLogs()</span><br><span class="line">    <span class="keyword">defer</span> logs.FlushLogs()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := command.Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        _, _ = fmt.Fprintf(os.Stderr, <span class="string">&quot;%v\n&quot;</span>, err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>app.WithPlugin(sample.Name, sample.New)</code> å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦å®ç°çš„æ’ä»¶ï¼Œä» <code>WithPlugin</code> å‡½æ•°çš„å‚æ•°ä¹Ÿå¯ä»¥çœ‹å‡ºæˆ‘ä»¬è¿™é‡Œçš„ <code>sample.New</code> å¿…é¡»æ˜¯ä¸€ä¸ª <code>framework.PluginFactory</code> ç±»å‹çš„å€¼ï¼Œè€Œ <code>PluginFactory</code> çš„å®šä¹‰å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error)</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ <code>sample.New</code> å®é™…ä¸Šå°±æ˜¯ä¸Šé¢çš„è¿™ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è·å–åˆ°æ’ä»¶ä¸­çš„ä¸€äº›æ•°æ®ç„¶åè¿›è¡Œé€»è¾‘å¤„ç†å³å¯ï¼Œæ’ä»¶å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ç®€å•è·å–ä¸‹æ•°æ®æ‰“å°æ—¥å¿—ï¼Œå¦‚æœä½ æœ‰å®é™…éœ€æ±‚çš„å¯ä»¥æ ¹æ®è·å–çš„æ•°æ®å°±è¡Œå¤„ç†å³å¯ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯å®ç°äº† <code>PreFilter</code>ã€<code>Filter</code>ã€<code>PreBind</code> ä¸‰ä¸ªæ‰©å±•ç‚¹ï¼Œå…¶ä»–çš„å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼æ¥æ‰©å±•å³å¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ’ä»¶åç§°</span></span><br><span class="line"><span class="keyword">const</span> Name = <span class="string">&quot;sample-plugin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Args <span class="keyword">struct</span> &#123;</span><br><span class="line">    FavoriteColor  <span class="keyword">string</span> <span class="string">`json:&quot;favorite_color,omitempty&quot;`</span></span><br><span class="line">    FavoriteNumber <span class="keyword">int</span>    <span class="string">`json:&quot;favorite_number,omitempty&quot;`</span></span><br><span class="line">    ThanksTo       <span class="keyword">string</span> <span class="string">`json:&quot;thanks_to,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Sample <span class="keyword">struct</span> &#123;</span><br><span class="line">    args   *Args</span><br><span class="line">    handle framework.FrameworkHandle</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">Name</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">PreFilter</span><span class="params">(pc *framework.PluginContext, pod *v1.Pod)</span> *<span class="title">framework</span>.<span class="title">Status</span></span> &#123;</span><br><span class="line">    klog.V(<span class="number">3</span>).Infof(<span class="string">&quot;prefilter pod: %v&quot;</span>, pod.Name)</span><br><span class="line">    <span class="keyword">return</span> framework.NewStatus(framework.Success, <span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">Filter</span><span class="params">(pc *framework.PluginContext, pod *v1.Pod, nodeName <span class="keyword">string</span>)</span> *<span class="title">framework</span>.<span class="title">Status</span></span> &#123;</span><br><span class="line">    klog.V(<span class="number">3</span>).Infof(<span class="string">&quot;filter pod: %v, node: %v&quot;</span>, pod.Name, nodeName)</span><br><span class="line">    <span class="keyword">return</span> framework.NewStatus(framework.Success, <span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">PreBind</span><span class="params">(pc *framework.PluginContext, pod *v1.Pod, nodeName <span class="keyword">string</span>)</span> *<span class="title">framework</span>.<span class="title">Status</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> nodeInfo, ok := s.handle.NodeInfoSnapshot().NodeInfoMap[nodeName]; !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> framework.NewStatus(framework.Error, fmt.Sprintf(<span class="string">&quot;prebind get node info error: %+v&quot;</span>, nodeName))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        klog.V(<span class="number">3</span>).Infof(<span class="string">&quot;prebind node info: %+v&quot;</span>, nodeInfo.Node())</span><br><span class="line">        <span class="keyword">return</span> framework.NewStatus(framework.Success, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(configuration *runtime.Unknown, f framework.FrameworkHandle)</span> <span class="params">(framework.Plugin, error)</span></span> &#123;</span><br><span class="line">    args := &amp;Args&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> err := framework.DecodeInto(configuration, args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    klog.V(<span class="number">3</span>).Infof(<span class="string">&quot;get plugin config args: %+v&quot;</span>, args)</span><br><span class="line">    <span class="keyword">return</span> &amp;Sample&#123;</span><br><span class="line">        args: args,</span><br><span class="line">        handle: f,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®Œæ•´ä»£ç å¯ä»¥å‰å¾€ä»“åº“ <a target="_blank" rel="noopener" href="https://github.com/cnych/sample-scheduler-framework">https://github.com/cnych/sample-scheduler-framework</a> è·å–ã€‚</p>
</blockquote>
<p>å®ç°å®Œæˆåï¼Œç¼–è¯‘æ‰“åŒ…æˆé•œåƒå³å¯ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å½“æˆæ™®é€šçš„åº”ç”¨ç”¨ä¸€ä¸ª <code>Deployment</code> æ§åˆ¶å™¨æ¥éƒ¨ç½²å³å¯ï¼Œç”±äºæˆ‘ä»¬éœ€è¦å»è·å–é›†ç¾¤ä¸­çš„ä¸€äº›èµ„æºå¯¹è±¡ï¼Œæ‰€ä»¥å½“ç„¶éœ€è¦ç”³è¯· RBAC æƒé™ï¼Œç„¶ååŒæ ·é€šè¿‡ <code>--config</code> å‚æ•°æ¥é…ç½®æˆ‘ä»¬çš„è°ƒåº¦å™¨ï¼ŒåŒæ ·è¿˜æ˜¯ä½¿ç”¨ä¸€ä¸ª <code>KubeSchedulerConfiguration</code> èµ„æºå¯¹è±¡é…ç½®ï¼Œå¯ä»¥é€šè¿‡ <code>plugins</code> æ¥å¯ç”¨æˆ–è€…ç¦ç”¨æˆ‘ä»¬å®ç°çš„æ’ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>pluginConfig</code> æ¥ä¼ é€’ä¸€äº›å‚æ•°å€¼ç»™æ’ä»¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-clusterrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bindings</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods/binding</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">replicationcontrollers</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">statefulsets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">policy</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">persistentvolumes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;storage.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">storageclasses</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">csinodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;coordination.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;events.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-sa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-clusterrolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-sa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">scheduler-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">scheduler-config.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    apiVersion: kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">    kind: KubeSchedulerConfiguration</span></span><br><span class="line"><span class="string">    leaderElection:</span></span><br><span class="line"><span class="string">      leaderElect: true</span></span><br><span class="line"><span class="string">      leaseDuration: 15s</span></span><br><span class="line"><span class="string">      renewDeadline: 10s</span></span><br><span class="line"><span class="string">      resourceLock: endpointsleases</span></span><br><span class="line"><span class="string">      resourceName: sample-scheduler</span></span><br><span class="line"><span class="string">      resourceNamespace: kube-system</span></span><br><span class="line"><span class="string">      retryPeriod: 2s</span></span><br><span class="line"><span class="string">    profiles:</span></span><br><span class="line"><span class="string">      - schedulerName: sample-scheduler</span></span><br><span class="line"><span class="string">        plugins:</span></span><br><span class="line"><span class="string">          preFilter:</span></span><br><span class="line"><span class="string">            enabled:</span></span><br><span class="line"><span class="string">              - name: &quot;sample-plugin&quot;</span></span><br><span class="line"><span class="string">          filter:</span></span><br><span class="line"><span class="string">            enabled:</span></span><br><span class="line"><span class="string">              - name: &quot;sample-plugin&quot;</span></span><br><span class="line"><span class="string">        pluginConfig:</span></span><br><span class="line"><span class="string">          - name: sample-plugin</span></span><br><span class="line"><span class="string">            args:  # runtime.Object</span></span><br><span class="line"><span class="string">              favorColor: &quot;#326CE5&quot;</span></span><br><span class="line"><span class="string">              favorNumber: 7</span></span><br><span class="line"><span class="string">              thanksTo: &quot;Kubernetes&quot;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">sample-scheduler</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">sample-scheduler</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">sample-scheduler</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">sample-scheduler-sa</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">scheduler-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">scheduler-config</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">scheduler</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">cnych/sample-scheduler:v0.2.4</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sample-scheduler</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--config=/etc/kubernetes/scheduler-config.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--v=3</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">scheduler-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes</span></span><br><span class="line"><span class="comment">#          livenessProbe:</span></span><br><span class="line"><span class="comment">#            httpGet:</span></span><br><span class="line"><span class="comment">#              path: /healthz</span></span><br><span class="line"><span class="comment">#              port: 10251</span></span><br><span class="line"><span class="comment">#            initialDelaySeconds: 15</span></span><br><span class="line"><span class="comment">#          readinessProbe:</span></span><br><span class="line"><span class="comment">#            httpGet:</span></span><br><span class="line"><span class="comment">#              path: /healthz</span></span><br><span class="line"><span class="comment">#              port: 10251</span></span><br></pre></td></tr></table></figure>

<p>ç›´æ¥éƒ¨ç½²ä¸Šé¢çš„èµ„æºå¯¹è±¡å³å¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±éƒ¨ç½²äº†ä¸€ä¸ªåä¸º <code>sample-scheduler</code> çš„è°ƒåº¦å™¨äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥éƒ¨ç½²ä¸€ä¸ªåº”ç”¨æ¥ä½¿ç”¨è¿™ä¸ªè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-scheduler</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test-scheduler</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test-scheduler</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">sample-scheduler</span>  <span class="comment"># æŒ‡å®šä½¿ç”¨çš„è°ƒåº¦å™¨ï¼Œä¸æŒ‡å®šä½¿ç”¨é»˜è®¤çš„default-scheduler</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ç°åœ¨æ‰‹åŠ¨æŒ‡å®šäº†ä¸€ä¸ª <code>schedulerName</code> çš„å­—æ®µï¼Œå°†å…¶è®¾ç½®æˆä¸Šé¢æˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨åç§° <code>sample-scheduler</code>ã€‚</p>
<p>æˆ‘ä»¬ç›´æ¥åˆ›å»ºè¿™ä¸ªèµ„æºå¯¹è±¡ï¼Œåˆ›å»ºå®ŒæˆåæŸ¥çœ‹æˆ‘ä»¬è‡ªå®šä¹‰è°ƒåº¦å™¨çš„æ—¥å¿—ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get pods -n kube-system -l component=sample-scheduler</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">sample-scheduler-896658cd7-k7vcl   1/1     Running   0          57s</span><br><span class="line">âœ kubectl logs -f sample-scheduler-896658cd7-k7vcl -n kube-system</span><br><span class="line">I0114 09:14:18.878613       1 eventhandlers.go:173] add event <span class="keyword">for</span> unscheduled pod default/test-scheduler-6486fd49fc-zjhcx</span><br><span class="line">I0114 09:14:18.878670       1 scheduler.go:464] Attempting to schedule pod: default/test-scheduler-6486fd49fc-zjhcx</span><br><span class="line">I0114 09:14:18.878706       1 sample.go:77] <span class="string">&quot;Start PreFilter Pod&quot;</span> pod=<span class="string">&quot;test-scheduler-6486fd49fc-zjhcx&quot;</span></span><br><span class="line">I0114 09:14:18.878802       1 sample.go:93] <span class="string">&quot;Start Filter Pod&quot;</span> pod=<span class="string">&quot;test-scheduler-6486fd49fc-zjhcx&quot;</span> node=<span class="string">&quot;node2&quot;</span> preFilterState=&amp;&#123;Resource:&#123;MilliCPU:0 Memory:0 EphemeralStorage:0 AllowedPodNumber:0 ScalarResources:map[]&#125;&#125;</span><br><span class="line">I0114 09:14:18.878835       1 sample.go:93] <span class="string">&quot;Start Filter Pod&quot;</span> pod=<span class="string">&quot;test-scheduler-6486fd49fc-zjhcx&quot;</span> node=<span class="string">&quot;node1&quot;</span> preFilterState=&amp;&#123;Resource:&#123;MilliCPU:0 Memory:0 EphemeralStorage:0 AllowedPodNumber:0 ScalarResources:map[]&#125;&#125;</span><br><span class="line">I0114 09:14:18.879043       1 default_binder.go:51] Attempting to <span class="built_in">bind</span> default/test-scheduler-6486fd49fc-zjhcx to node1</span><br><span class="line">I0114 09:14:18.886360       1 scheduler.go:609] <span class="string">&quot;Successfully bound pod to node&quot;</span> pod=<span class="string">&quot;default/test-scheduler-6486fd49fc-zjhcx&quot;</span> node=<span class="string">&quot;node1&quot;</span> evaluatedNodes=3 feasibleNodes=2</span><br><span class="line">I0114 09:14:18.887426       1 eventhandlers.go:205] delete event <span class="keyword">for</span> unscheduled pod default/test-scheduler-6486fd49fc-zjhcx</span><br><span class="line">I0114 09:14:18.887475       1 eventhandlers.go:225] add event <span class="keyword">for</span> scheduled pod default/test-scheduler-6486fd49fc-zjhcx</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å½“æˆ‘ä»¬åˆ›å»ºå®Œ Pod åï¼Œåœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨ä¸­å°±å‡ºç°äº†å¯¹åº”çš„æ—¥å¿—ï¼Œå¹¶ä¸”åœ¨æˆ‘ä»¬å®šä¹‰çš„æ‰©å±•ç‚¹ä¸Šé¢éƒ½å‡ºç°äº†å¯¹åº”çš„æ—¥å¿—ï¼Œè¯æ˜æˆ‘ä»¬çš„ç¤ºä¾‹æˆåŠŸäº†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹ Pod çš„ <code>schedulerName</code> æ¥éªŒè¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get pods</span><br><span class="line">NAME                              READY   STATUS    RESTARTS       AGE</span><br><span class="line">test-scheduler-6486fd49fc-zjhcx   1/1     Running   0              35s</span><br><span class="line">âœ kubectl get pod test-scheduler-6486fd49fc-zjhcx -o yaml</span><br><span class="line">......</span><br><span class="line">restartPolicy: Always</span><br><span class="line">schedulerName: sample-scheduler</span><br><span class="line">securityContext: &#123;&#125;</span><br><span class="line">serviceAccount: default</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>ä» Kubernetes v1.17 ç‰ˆæœ¬å¼€å§‹ï¼Œ<code>Scheduler Framework</code> å†…ç½®çš„é¢„é€‰å’Œä¼˜é€‰å‡½æ•°å·²ç»å…¨éƒ¨æ’ä»¶åŒ–ï¼Œæ‰€ä»¥è¦æ‰©å±•è°ƒåº¦å™¨æˆ‘ä»¬åº”è¯¥æŒæ¡å¹¶ç†è§£è°ƒåº¦æ¡†æ¶è¿™ç§æ–¹å¼ã€‚</p>
<h2 id="3ã€è°ƒåº¦å™¨è°ƒä¼˜"><a href="#3ã€è°ƒåº¦å™¨è°ƒä¼˜" class="headerlink" title="3ã€è°ƒåº¦å™¨è°ƒä¼˜"></a>3ã€è°ƒåº¦å™¨è°ƒä¼˜</h2><p>ä½œä¸º kubernetes é›†ç¾¤çš„é»˜è®¤è°ƒåº¦å™¨ï¼Œkube-scheduler ä¸»è¦è´Ÿè´£å°† Pod è°ƒåº¦åˆ°é›†ç¾¤çš„ Node ä¸Šã€‚åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œæ»¡è¶³ä¸€ä¸ª Pod è°ƒåº¦è¯·æ±‚çš„æ‰€æœ‰èŠ‚ç‚¹ç§°ä¹‹ä¸º <code>å¯è°ƒåº¦ Node</code>ï¼Œè°ƒåº¦å™¨å…ˆåœ¨é›†ç¾¤ä¸­æ‰¾åˆ°ä¸€ä¸ª Pod çš„å¯è°ƒåº¦ Nodeï¼Œç„¶åæ ¹æ®ä¸€ç³»åˆ—å‡½æ•°å¯¹è¿™äº›å¯è°ƒåº¦ Node è¿›è¡Œæ‰“åˆ†ï¼Œä¹‹åé€‰å‡ºå…¶ä¸­å¾—åˆ†æœ€é«˜çš„ Node æ¥è¿è¡Œ Podï¼Œæœ€åï¼Œè°ƒåº¦å™¨å°†è¿™ä¸ªè°ƒåº¦å†³å®šå‘ŠçŸ¥ <code>kube-apiserver</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš<strong>ç»‘å®š</strong>ã€‚</p>
<p>åœ¨ Kubernetes 1.12 ç‰ˆæœ¬ä¹‹å‰ï¼Œkube-scheduler ä¼šæ£€æŸ¥é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„å¯è°ƒåº¦æ€§ï¼Œå¹¶ä¸”ç»™å¯è°ƒåº¦èŠ‚ç‚¹æ‰“åˆ†ã€‚Kubernetes 1.12 ç‰ˆæœ¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„åŠŸèƒ½ï¼Œ<strong>å…è®¸è°ƒåº¦å™¨åœ¨æ‰¾åˆ°ä¸€å®šæ•°é‡çš„å¯è°ƒåº¦èŠ‚ç‚¹ä¹‹åå°±åœæ­¢ç»§ç»­å¯»æ‰¾å¯è°ƒåº¦èŠ‚ç‚¹</strong>ã€‚è¯¥åŠŸèƒ½èƒ½æé«˜è°ƒåº¦å™¨åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸‹çš„è°ƒåº¦æ€§èƒ½ï¼Œè¿™ä¸ªæ•°å€¼æ˜¯é›†ç¾¤è§„æ¨¡çš„ç™¾åˆ†æ¯”ï¼Œè¿™ä¸ªç™¾åˆ†æ¯”é€šè¿‡ <code>percentageOfNodesToScore</code> å‚æ•°æ¥è¿›è¡Œé…ç½®ï¼Œå…¶å€¼çš„èŒƒå›´åœ¨ 1 åˆ° 100 ä¹‹é—´ï¼Œæœ€å¤§å€¼å°±æ˜¯ 100%ï¼Œå¦‚æœè®¾ç½®ä¸º 0 å°±ä»£è¡¨æ²¡æœ‰æä¾›è¿™ä¸ªå‚æ•°é…ç½®ã€‚</p>
<p>Kubernetes 1.14 ç‰ˆæœ¬åˆåŠ å…¥äº†ä¸€ä¸ªç‰¹æ€§ï¼Œåœ¨è¯¥å‚æ•°æ²¡æœ‰è¢«ç”¨æˆ·é…ç½®çš„æƒ…å†µä¸‹ï¼Œè°ƒåº¦å™¨ä¼šæ ¹æ®é›†ç¾¤çš„è§„æ¨¡è‡ªåŠ¨è®¾ç½®ä¸€ä¸ªé›†ç¾¤æ¯”ä¾‹ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæ¯”ä¾‹ç­›é€‰ä¸€å®šæ•°é‡çš„å¯è°ƒåº¦èŠ‚ç‚¹è¿›å…¥æ‰“åˆ†é˜¶æ®µã€‚è¯¥ç‰¹æ€§ä½¿ç”¨<strong>çº¿æ€§å…¬å¼</strong>è®¡ç®—å‡ºé›†ç¾¤æ¯”ä¾‹ï¼Œæ¯”å¦‚100ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸‹ä¼šå– 50%ï¼Œåœ¨ 5000èŠ‚ç‚¹çš„é›†ç¾¤ä¸‹å– 10%ï¼Œè¿™ä¸ªè‡ªåŠ¨è®¾ç½®çš„å‚æ•°çš„æœ€ä½å€¼æ˜¯ 5%ï¼Œæ¢å¥è¯è¯´ï¼Œ<strong>è°ƒåº¦å™¨è‡³å°‘ä¼šå¯¹é›†ç¾¤ä¸­ 5% çš„èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†</strong>ï¼Œé™¤éç”¨æˆ·å°†è¯¥å‚æ•°è®¾ç½®çš„ä½äº 5ã€‚</p>
<p>æ³¨æ„</p>
<blockquote>
<p>å½“é›†ç¾¤ä¸­çš„å¯è°ƒåº¦èŠ‚ç‚¹å°‘äº 50 ä¸ªæ—¶ï¼Œè°ƒåº¦å™¨ä»ç„¶ä¼šå»æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹ï¼Œå› ä¸ºå¯è°ƒåº¦èŠ‚ç‚¹å¤ªå°‘ï¼Œä¸è¶³ä»¥åœæ­¢è°ƒåº¦å™¨æœ€åˆçš„è¿‡æ»¤é€‰æ‹©ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å…³æ‰è¿™ä¸ªèŒƒå›´å‚æ•°ï¼Œå¯ä»¥å°† <code>percentageOfNodesToScore</code> å€¼è®¾ç½®æˆ 100ã€‚</p>
</blockquote>
<p><code>percentageOfNodesToScore</code> çš„å€¼å¿…é¡»åœ¨ 1 åˆ° 100 ä¹‹é—´ï¼Œè€Œä¸”å…¶é»˜è®¤å€¼æ˜¯é€šè¿‡é›†ç¾¤çš„è§„æ¨¡è®¡ç®—å¾—æ¥çš„ï¼Œå¦å¤– <strong>50</strong> ä¸ª Node çš„æ•°å€¼æ˜¯ç¡¬ç¼–ç åœ¨ç¨‹åºé‡Œé¢çš„ï¼Œè®¾ç½®è¿™ä¸ªå€¼çš„ä½œç”¨åœ¨äºï¼š<strong>å½“é›†ç¾¤çš„è§„æ¨¡æ˜¯æ•°ç™¾ä¸ªèŠ‚ç‚¹å¹¶ä¸” percentageOfNodesToScore å‚æ•°è®¾ç½®çš„è¿‡ä½çš„æ—¶å€™ï¼Œè°ƒåº¦å™¨ç­›é€‰åˆ°çš„å¯è°ƒåº¦èŠ‚ç‚¹æ•°ç›®åŸºæœ¬ä¸ä¼šå—åˆ°è¯¥å‚æ•°å½±å“</strong>ã€‚å½“é›†ç¾¤è§„æ¨¡è¾ƒå°æ—¶ï¼Œè¿™ä¸ªè®¾ç½®å¯¹è°ƒåº¦å™¨æ€§èƒ½æå‡å¹¶ä¸æ˜æ˜¾ï¼Œä½†æ˜¯åœ¨è¶…è¿‡ 1000 ä¸ª Node çš„é›†ç¾¤ä¸­ï¼Œå°†è°ƒä¼˜å‚æ•°è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒä½çš„å€¼å¯ä»¥å¾ˆæ˜æ˜¾çš„æå‡è°ƒåº¦å™¨æ€§èƒ½ã€‚</p>
<p>ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¯¥å‚æ•°è®¾ç½®åå¯èƒ½ä¼šå¯¼è‡´åªæœ‰é›†ç¾¤ä¸­å°‘æ•°èŠ‚ç‚¹è¢«é€‰ä¸ºå¯è°ƒåº¦èŠ‚ç‚¹ï¼Œå¾ˆå¤š Node éƒ½æ²¡æœ‰è¿›å…¥åˆ°æ‰“åˆ†é˜¶æ®µï¼Œè¿™æ ·å°±ä¼šé€ æˆä¸€ç§åæœï¼Œä¸€ä¸ªæœ¬æ¥å¯ä»¥åœ¨æ‰“åˆ†é˜¶æ®µå¾—åˆ†å¾ˆé«˜çš„ Node ç”šè‡³éƒ½ä¸èƒ½è¿›å…¥æ‰“åˆ†é˜¶æ®µã€‚ç”±äºè¿™ä¸ªåŸå› ï¼Œæ‰€ä»¥è¿™ä¸ªå‚æ•°ä¸åº”è¯¥è¢«è®¾ç½®æˆä¸€ä¸ªå¾ˆä½çš„å€¼ï¼Œ<strong>é€šå¸¸çš„åšæ³•æ˜¯ä¸ä¼šå°†è¿™ä¸ªå‚æ•°çš„å€¼è®¾ç½®çš„ä½äº 10</strong>ï¼Œå¾ˆä½çš„å‚æ•°å€¼ä¸€èˆ¬åœ¨è°ƒåº¦å™¨çš„ååé‡å¾ˆé«˜ä¸”å¯¹ Node çš„æ‰“åˆ†ä¸é‡è¦çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨ã€‚<strong>æ¢å¥è¯è¯´ï¼Œåªæœ‰å½“ä½ æ›´å€¾å‘äºåœ¨å¯è°ƒåº¦èŠ‚ç‚¹ä¸­ä»»æ„é€‰æ‹©ä¸€ä¸ª Node æ¥è¿è¡Œè¿™ä¸ª Pod æ—¶ï¼Œæ‰ä½¿ç”¨å¾ˆä½çš„å‚æ•°è®¾ç½®ã€‚</strong></p>
<p><strong>å¦‚æœä½ çš„é›†ç¾¤è§„æ¨¡åªæœ‰æ•°ç™¾ä¸ªèŠ‚ç‚¹æˆ–è€…æ›´å°‘ï¼Œå®é™…ä¸Šå¹¶ä¸æ¨èä½ å°†è¿™ä¸ªå‚æ•°è®¾ç½®å¾—æ¯”é»˜è®¤å€¼æ›´ä½ï¼Œå› ä¸ºè¿™ç§æƒ…å†µä¸‹ä¸å¤ªä¼šæœ‰æ•ˆçš„æé«˜è°ƒåº¦å™¨æ€§èƒ½ã€‚</strong></p>
<h2 id="4ã€åˆ›å»ºä¸€ä¸ªPodçš„å·¥ä½œæµç¨‹"><a href="#4ã€åˆ›å»ºä¸€ä¸ªPodçš„å·¥ä½œæµç¨‹" class="headerlink" title="4ã€åˆ›å»ºä¸€ä¸ªPodçš„å·¥ä½œæµç¨‹"></a>4ã€åˆ›å»ºä¸€ä¸ªPodçš„å·¥ä½œæµç¨‹</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ¨ç½²çš„ Pod æ˜¯é€šè¿‡<strong>é›†ç¾¤çš„è‡ªåŠ¨è°ƒåº¦ç­–ç•¥</strong>æ¥é€‰æ‹©èŠ‚ç‚¹çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹è°ƒåº¦å™¨è€ƒè™‘çš„æ˜¯èµ„æºè¶³å¤Ÿï¼Œå¹¶ä¸”è´Ÿè½½å°½é‡å¹³å‡ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦èƒ½å¤Ÿæ›´åŠ ç»†ç²’åº¦çš„å»æ§åˆ¶ Pod çš„è°ƒåº¦ï¼Œ<strong>æ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¸€äº›æœºå™¨å­¦ä¹ çš„åº”ç”¨åªè·‘åœ¨æœ‰ GPU çš„èŠ‚ç‚¹ä¸Š</strong>ï¼›<strong>ä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬çš„æœåŠ¡ä¹‹é—´äº¤æµæ¯”è¾ƒé¢‘ç¹ï¼Œåˆå¸Œæœ›èƒ½å¤Ÿå°†è¿™æœåŠ¡çš„ Pod éƒ½è°ƒåº¦åˆ°åŒä¸€ä¸ªçš„èŠ‚ç‚¹ä¸Š</strong>ã€‚è¿™å°±éœ€è¦ä½¿ç”¨ä¸€äº›è°ƒåº¦æ–¹å¼æ¥æ§åˆ¶ Pod çš„è°ƒåº¦äº†ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæ¦‚å¿µï¼š<strong>äº²å’Œæ€§å’Œåäº²å’Œæ€§</strong>ï¼Œäº²å’Œæ€§åˆåˆ†æˆ**èŠ‚ç‚¹äº²å’Œæ€§(nodeAffinity)å’Œ Pod äº²å’Œæ€§(podAffinity)**ã€‚</p>
<h3 id="1-æ¶æ„å›¾"><a href="#1-æ¶æ„å›¾" class="headerlink" title="1.æ¶æ„å›¾"></a>1.æ¶æ„å›¾</h3><p>KubernetesåŸºäº<code>list-watchæœºåˆ¶</code>çš„æ§åˆ¶å™¨æ¶æ„ï¼Œå®ç°ç»„ä»¶é—´äº¤äº’çš„è§£è€¦ã€‚<br>å…¶ä»–ç»„ä»¶ç›‘æ§è‡ªå·±è´Ÿè´£çš„èµ„æºï¼Œå½“è¿™äº›èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œkube-apiserverä¼šé€šçŸ¥è¿™äº›ç»„ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äº<code>å‘å¸ƒä¸è®¢é˜…</code>ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220309130416811.png" alt="image-20220309130416811"></p>
<h3 id="2-å‰–æè¿‡ç¨‹"><a href="#2-å‰–æè¿‡ç¨‹" class="headerlink" title="2.å‰–æè¿‡ç¨‹"></a>2.å‰–æè¿‡ç¨‹</h3><ul>
<li>æˆ‘ä»¬é€šè¿‡å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªpodï¼š</li>
</ul>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210614222733041.png" alt="image-20210614222733041"></p>
<ul>
<li>å½“æˆ‘ä»¬åœ¨æ‰§è¡Œå‘½ä»¤<code>kubectl run pod4 --image=nginx</code>åï¼Œå„ç»„ä»¶ä¹‹é—´çš„è°ƒç”¨æµç¨‹æ˜¯å¦‚ä½•çš„å‘¢ï¼Ÿ</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1ã€kubectlå‘apiserverå‘é€ä¸€ä¸ªåˆ›å»ºpodçš„è¯·æ±‚</span><br><span class="line">2ã€apiserveræ¥æ”¶åˆ°å¹¶å‘etcdå†™å…¥å­˜å‚¨ï¼Œå†™å…¥æˆåŠŸè¿”å›ä¸€ä¸ªæç¤º</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºè€æ¿å’Œé¡¾å®¢ä¹‹é—´çš„å…³ç³»:</span></span><br><span class="line">	api-server:å¼€åº—è€æ¿</span><br><span class="line">	etcdï¼šä»“åº“</span><br><span class="line">	å…¶ä»–ç»„ä»¶ï¼šé¡¾å®¢</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210615063729371-1623710250391.png" alt="image-20210615063729371"></p>
<ul>
<li>æ³¨æ„ï¼šå¦‚æœåœ¨æ‰§è¡Œå¦‚ä¸‹<code>kubectl run pod4 --image=nginx</code>å‘½ä»¤æ—¶ï¼Œå¡ç€äº†ï¼Œè¯´æ˜ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</li>
</ul>
<p>â€“&gt;è¯´æ˜ï¼š<br>etcdæ•°æ®åº“å†™å…¥æœ‰é—®é¢˜/è¾¾åˆ°æ€§èƒ½ç“¶é¢ˆï¼Œæˆ–è€…ï¼Œapi-serverå’Œetcd 2è€…æ€»æœ‰ä¸€ä¸ªæœ‰é—®é¢˜ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210615063918928.png" alt="image-20210615063918928"></p>
<ul>
<li>ç»§ç»­ï¼šschedulerå‘apiserveræŸ¥è¯¢æœªåˆ†é…çš„podèµ„æºï¼Œé€šè¿‡è‡ªèº«è°ƒåº¦ç®—æ³•é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„nodeè¿›è¡Œç»‘å®šï¼ˆç»™è¿™ä¸ªpodèµ„æºæ‰“ä¸€ä¸ªæ ‡è®°ï¼Œæ ‡è®°åˆ†é…åˆ°node1ï¼‰æ³¨æ„ï¼šå®ƒè¿™ä¸ªè°ƒåº¦ç®—æ³•è¿˜æ˜¯æ¯”è¾ƒå¤æ‚ã€å‡åŒ€ä¸€ç‚¹çš„ï¼Œå®ƒä¼šè€ƒè™‘åˆ°ä½ çš„æœºå™¨çš„ç¡¬ä»¶é…ç½®ï¼Œpodå±æ€§ç­‰ç­‰ä¸€äº›ç»¼åˆçš„å±æ€§ï¼›</li>
</ul>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210615065028529.png" alt="image-20210615065028529"></p>
<ul>
<li>==é—®é¢˜==ï¼šå¦‚æœschedulerç»„ä»¶æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆæ­¤æ—¶podä¼šå‡ºç°ä»€ä¹ˆçŠ¶æ€ï¼Ÿ</li>
</ul>
<p>ç­”ï¼špodä¼šå‡ºç°é€šè¿‡<code>kubectl get pod</code>æ ¹æœ¬çœ‹ä¸åˆ°ä½ åˆšåˆ›å»ºçš„podä¿¡æ¯çš„ï¼Œæ›´åˆ«è¯´å®ƒçš„çŠ¶æ€äº†ï¼Œå› ä¸ºå®ƒæ ¹æœ¬æ²¡åˆ†é…ã€‚</p>
<p>å› æ­¤ï¼Œå¦‚æœä½ åˆ›å»ºçš„podä¿¡æ¯æ ¹æœ¬çœ‹ä¸åˆ°ï¼Œé‚£ä¹ˆä¼šæ˜¯å“ªä¸ªç»„ä»¶å¯èƒ½æœ‰é—®é¢˜ï¼Ÿâ€“&gt;<code>schedulerç»„ä»¶</code>å¯èƒ½å‡ºåœ¨é—®é¢˜ã€‚</p>
<ul>
<li><strong>å¦‚æœæ˜¯pendingçŠ¶æ€ï¼špodæ˜¯å·²ç»ç»‘å®šåˆ°æŸä¸ªèŠ‚ç‚¹äº†</strong>ã€‚</li>
</ul>
<ul>
<li>ç»§ç»­æµç¨‹è®²è§£ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">4ã€kubeletå‘apiserveræŸ¥è¯¢åˆ†é…åˆ°è‡ªå·±èŠ‚ç‚¹çš„podï¼Œè°ƒç”¨docker apiï¼ˆ/var/run/docker.sockï¼‰åˆ›å»ºå®¹å™¨</span><br><span class="line">5ã€kubeletè·å–dockeråˆ›å»ºå®¹å™¨çš„çŠ¶æ€ï¼Œå¹¶æ±‡æŠ¥ç»™apiserverï¼Œapiserveræ›´æ–°çŠ¶æ€åˆ°etcdå­˜å‚¨</span><br><span class="line">6ã€kubectl get podså°±èƒ½æŸ¥çœ‹podçŠ¶æ€</span><br><span class="line"></span><br><span class="line">å¤‡æ³¨ï¼š</span><br><span class="line">kubeletçš„åŠŸèƒ½ä¸»è¦æ˜¯ç®¡ç†å®¹å™¨ï¼š</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªæ˜¯é»˜è®¤è°ƒç”¨çš„docker apiæ¥å£</span><br><span class="line">[root@k8s-master ~]<span class="comment">#ll /var/run/docker.sock</span></span><br><span class="line">srw-rw---- 1 root docker 0 Jun 14 11:46 /var/run/docker.sock</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210615070717425.png" alt="image-20210615070717425"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210615070800673.png" alt="image-20210615070800673"></p>
<ul>
<li>é—®é¢˜ï¼š==controller-managerä¸ºä»€ä¹ˆæ²¡ç”¨åˆ°?==</li>
</ul>
<p>controller-manageræ˜¯ç”¨äºç®¡ç†æ§åˆ¶å™¨ï¼Œä¾‹å¦‚deploymentï¼ˆrsï¼‰ã€serviceï¼Œå› ä¸ºåˆ›å»ºçš„æ˜¯ä¸€ä¸ªpodï¼Œä¸å—å®ƒç®¡ç†ã€‚</p>
<p>å¦‚æœcontroller-managerè¦æ”¾åœ¨è¿™é‡Œï¼Œ<strong>ä¸€èˆ¬æ˜¯æ”¾åœ¨etcdåé¢çš„</strong>ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210615071819565.png" alt="image-20210615071819565"></p>
<ul>
<li>==kube-proxyä¸ºä»€ä¹ˆæ²¡ç”¨åˆ°ï¼Ÿ==</li>
</ul>
<p>proxyæ˜¯ç”¨äºç®¡ç†podç½‘ç»œï¼Œä¾‹å¦‚serviceï¼Œå› ä¸ºæ²¡åˆ›å»ºserviceã€‚</p>
<p><strong>kube-proxyçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯ç»´æŠ¤å¥½service</strong>ï¼Œserviceæ˜¯k8sçš„æŠ½è±¡èµ„æºï¼›</p>
<ul>
<li>æ‰©å±•</li>
</ul>
<p>æ¯”å¦‚ï¼Œè¿™ä¸ªå®¹å™¨åˆ›å»ºçš„æ—¶å€™åˆ›å»ºå¤±è´¥äº†ï¼Œä¸æ˜¯ä¸€ä¸ªrunningçŠ¶æ€ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªpendingçŠ¶æ€ã€‚å¯èƒ½å°±æ˜¯dockeråœ¨å¯åŠ¨å®¹å™¨æ—¶ï¼Œç”¨ä½ é‚£ä¸ªé•œåƒå¯åŠ¨å®¹å™¨å¤±è´¥äº†ã€‚æ‰€ä»¥è¿™æ˜¯ä½ éœ€è¦ç”¨dockerå»runä¸€ä¸ªé•œåƒçœ‹èƒ½ä¸èƒ½èµ·æ¥ã€‚</p>
<h3 id="3-Podä¸­å½±å“è°ƒåº¦çš„ä¸»è¦å±æ€§"><a href="#3-Podä¸­å½±å“è°ƒåº¦çš„ä¸»è¦å±æ€§" class="headerlink" title="3.Podä¸­å½±å“è°ƒåº¦çš„ä¸»è¦å±æ€§"></a>3.Podä¸­å½±å“è°ƒåº¦çš„ä¸»è¦å±æ€§</h3><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210615073053200.png" alt="image-20210615073053200"></p>
<p>:warning: æ³¨æ„</p>
<blockquote>
<p>resources: {} èµ„æºè°ƒåº¦ä¾æ®è¿™ä¸ªï¼ŒæŒºé‡è¦çš„ï¼›<br>å¾ˆå¤šå¤§å‚éƒ½ä¼šå»äºŒå¼€â€schedulerName: default-schedulerâ€è¿™ä¸ªè°ƒåº¦å™¨çš„ï¼Œä¼šå»åŠ ä¸€äº›è°ƒåº¦ç­–ç•¥ï¼Œè¿›è€Œå®Œæˆä»–ä»¬çš„éœ€æ±‚ï¼›</p>
</blockquote>
<p>ğŸ‚ è°ƒåº¦åŸå› å¤±è´¥åˆ†æ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod &lt;NAME&gt; -o wide</span><br><span class="line"></span><br><span class="line">æŸ¥çœ‹è°ƒåº¦å¤±è´¥åŸå› ï¼škubectl describe pod &lt;NAME&gt;</span><br><span class="line">â€¢ èŠ‚ç‚¹CPU/å†…å­˜ä¸è¶³</span><br><span class="line">â€¢ æœ‰æ±¡ç‚¹ï¼Œæ²¡å®¹å¿ (tolerations)</span><br><span class="line">â€¢ æ²¡æœ‰åŒ¹é…åˆ°èŠ‚ç‚¹æ ‡ç­¾ ï¼ˆnï¼‰</span><br></pre></td></tr></table></figure>

<h3 id="4-è°ƒåº¦å™¨éœ€è¦å……åˆ†è€ƒè™‘è¯¸å¤šçš„å› ç´ "><a href="#4-è°ƒåº¦å™¨éœ€è¦å……åˆ†è€ƒè™‘è¯¸å¤šçš„å› ç´ " class="headerlink" title="4.è°ƒåº¦å™¨éœ€è¦å……åˆ†è€ƒè™‘è¯¸å¤šçš„å› ç´ "></a>4.è°ƒåº¦å™¨éœ€è¦å……åˆ†è€ƒè™‘è¯¸å¤šçš„å› ç´ </h3><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514221616.png"><br>èµ„æºé«˜æ•ˆåˆ©ç”¨ï¼šè£…ç®±ç‡è¦é«˜ï¼<br>afinityï¼šå¾®æœåŠ¡ï¼Œåˆ†æ­¥å¼ç³»ç»Ÿï¼Œç½‘ç»œè°ƒç”¨ï¼Œæœ¬æœºè°ƒç”¨ï¼Œæ’é™¤äº†ç½‘ç»œè°ƒç”¨ï¼Œé¢å¤–çš„ä¼ è¾“æ—¶é—´ï¼Œç‰©ç†ç½‘å¡å¸¦å®½é™åˆ¶ï¼<br>anti-affinityï¼šæŸä¸ªä¸šåŠ¡çš„ä¸åŒå‰¯æœ¬ï¼Œä¸èƒ½è®©å…¶è·‘åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œä¸€ä¸ªæœºæ¶ä¸Šï¼Œä¸€ä¸ªåœ°åŸŸé‡Œï¼Œä½¿å…¶åˆ†å¸ƒåœ¨ä¸åŒçš„æ•…éšœåŸŸã€‚<br>localityï¼šæ•°æ®æœ¬åœ°åŒ–ï¼Œæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œå“ªé‡Œæœ‰æ•°æ®ï¼Œæˆ‘çš„ä½œä¸šå°±å»å“ªé‡Œï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ•°æ®æ‹·è´çš„å¼€é”€ã€‚k8sé‡Œçš„æ‹‰å–é•œåƒã€‚</p>
<p>ğŸ‚</p>
<p>å¬èµ·æ¥å¾ˆç®€å•ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠ<strong>Predicateã€Priorityç­‰å„ç§è°ƒåº¦ç®—æ³•</strong>ï¼Œè¿˜æœ‰ä¼˜å…ˆçº§ï¼ˆPriority ï¼‰ã€<strong>æŠ¢å ï¼ˆPreemptionï¼‰</strong>ç­‰å„ç§æœºåˆ¶ã€‚åœ¨å®é™…çš„è°ƒåº¦è®¾è®¡ä¸­ï¼Œæœ‰éå¸¸å¤šéœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p>
<blockquote>
<p><strong>1. å…¬å¹³</strong>ï¼šå¦‚ä½•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è¢«åˆ†é…èµ„æº</p>
<p><strong>2. èµ„æºé«˜æ•ˆåˆ©ç”¨</strong>ï¼šæ€æ ·å‹æ¦¨é›†ç¾¤çš„èµ„æºèƒ½åŠ›ï¼Œè®©èµ„æºè¢«æœ€å¤§åŒ–ä½¿ç”¨</p>
<p><strong>3. æ•ˆç‡</strong>ï¼šè°ƒåº¦çš„æ€§èƒ½è¦å¥½ï¼Œèƒ½å¤Ÿå°½å¿«åœ°å¯¹å¤§æ‰¹é‡çš„ pod å®Œæˆè°ƒåº¦å·¥ä½œ</p>
<p><strong>4. çµæ´»</strong>ï¼šå…è®¸ç”¨æˆ·æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ§åˆ¶è°ƒåº¦çš„é€»è¾‘</p>
</blockquote>
<h3 id="5-Kubernetesä¸­çš„èµ„æºåˆ†é…"><a href="#5-Kubernetesä¸­çš„èµ„æºåˆ†é…" class="headerlink" title="5.Kubernetesä¸­çš„èµ„æºåˆ†é…"></a>5.Kubernetesä¸­çš„èµ„æºåˆ†é…</h3><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514230257.png"></p>
<p>1.limitsï¼šåœ¨Cgroupsé‡Œä½¿ç”¨ï¼›cpu.cfs_quota/cpu.cfs_period(10w)=1<br>2.requestsï¼šcpuè¿™ä¸ªrequestså…¶å®åœ¨Cgroupé‡Œä¹Ÿèµ·ä½œç”¨ã€‚å½“ä½ å¤šä¸ªåº”ç”¨å‘ç”Ÿèµ„æºæŠ¢å æ—¶ï¼Œä»–ä»¬æŠ¢å çš„cpuæ—¶é—´æ¯”è¾ƒæ˜¯å¤šå°‘å‘¢ï¼Ÿæ˜¯é€šè¿‡cpu.shareå»è°ƒèŠ‚çš„ã€‚k8sæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿè¿™é‡Œå¦‚æœè®¾ç½®çš„æ˜¯ä¸€ä¸ªcpuï¼Œrequestæ˜¯1çš„è¯ï¼Œé‚£ä¹ˆcpu.shareæ˜¯1024ã€‚ å¦‚æœä½ è®¾ç½®çš„æ˜¯100mï¼Œç›¸å½“äºæ˜¯0.1ä¸ªcpuï¼Œé‚£ä¹ˆcpu.shareå°±æ˜¯0.1*1024=102. ä¹Ÿå°±æ˜¯<strong>cpu.requestsä¹Ÿæ˜¯æœ€ç»ˆä¼šä½“ç°åˆ°Cgroupsé‡Œé¢å»çš„</strong>ã€‚</p>
<h3 id="6-Init-containerçš„èµ„æºéœ€æ±‚"><a href="#6-Init-containerçš„èµ„æºéœ€æ±‚" class="headerlink" title="6.Init containerçš„èµ„æºéœ€æ±‚"></a>6.Init containerçš„èµ„æºéœ€æ±‚</h3><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514230423.png"></p>
<h2 id="5ã€nodeSelector"><a href="#5ã€nodeSelector" class="headerlink" title="5ã€nodeSelector"></a>5ã€nodeSelector</h2><p>nodeSelectorï¼šç”¨äºå°†Podè°ƒåº¦åˆ°åŒ¹é…Labelçš„Nodeä¸Šï¼Œ<code>å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ ‡ç­¾ä¼šè°ƒåº¦å¤±è´¥</code>ã€‚</p>
<p>ä½œç”¨ï¼š </p>
<ul>
<li>çº¦æŸPodåˆ°ç‰¹å®šçš„èŠ‚ç‚¹è¿è¡Œ</li>
<li>å®Œå…¨åŒ¹é…èŠ‚ç‚¹æ ‡ç­¾</li>
</ul>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ä¸“ç”¨èŠ‚ç‚¹ï¼šæ ¹æ®ä¸šåŠ¡çº¿å°†Nodeåˆ†ç»„ç®¡ç†</li>
<li>é…å¤‡ç‰¹æ®Šç¡¬ä»¶ï¼šéƒ¨åˆ†Nodeé…æœ‰SSDç¡¬ç›˜ã€GPU</li>
</ul>
<table><tr><td bgcolor=yellow>ğŸ’˜ å®è·µï¼šnodeSelectoræµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.16</td></tr></table>

<p>åœ¨äº†è§£äº²å’Œæ€§ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„è°ƒåº¦æ–¹å¼ï¼š<code>nodeSelector</code>ã€‚æˆ‘ä»¬çŸ¥é“ label æ ‡ç­¾æ˜¯ kubernetes ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œç”¨æˆ·å¯ä»¥éå¸¸çµæ´»çš„åˆ©ç”¨ label æ¥ç®¡ç†é›†ç¾¤ä¸­çš„èµ„æºï¼Œæ¯”å¦‚æœ€å¸¸è§çš„ Service å¯¹è±¡é€šè¿‡ label å»åŒ¹é… Pod èµ„æºï¼Œè€Œ <strong>Pod çš„è°ƒåº¦ä¹Ÿå¯ä»¥æ ¹æ®èŠ‚ç‚¹çš„ label æ¥è¿›è¡Œè°ƒåº¦</strong>ã€‚</p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹æˆ‘ä»¬çš„ node çš„ labelï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get node --show-labels </span></span><br><span class="line">NAME      STATUS   ROLES                  AGE    VERSION   LABELS</span><br><span class="line">master1   Ready    control-plane,master   109d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master1,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">node1     Ready    &lt;none&gt;                 109d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node1,kubernetes.io/os=linux</span><br><span class="line">node2     Ready    &lt;none&gt;                 109d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node2,kubernetes.io/os=linux</span><br></pre></td></tr></table></figure>



<ul>
<li>ç°åœ¨æˆ‘ä»¬å…ˆç»™èŠ‚ç‚¹ node2 å¢åŠ ä¸€ä¸ª<code>com=youdianzhishi</code>çš„æ ‡ç­¾ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl label nodes node2 com=youdianzhishi</span></span><br><span class="line">node/node2 labeled</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢çš„ <code>--show-labels</code> å‚æ•°å¯ä»¥æŸ¥çœ‹ä¸Šè¿°æ ‡ç­¾æ˜¯å¦ç”Ÿæ•ˆã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get node node2 --show-labels </span></span><br><span class="line">NAME    STATUS   ROLES    AGE    VERSION   LABELS</span><br><span class="line">node2   Ready    &lt;none&gt;   109d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,com=youdianzhishi,kubernetes.io/arch=amd64,kubernetes.io/hostname=node2,kubernetes.io/os=linux</span><br></pre></td></tr></table></figure>



<ul>
<li>Podé‡Œé…ç½®nodeSelectorå­—æ®µï¼š</li>
</ul>
<p>å½“èŠ‚ç‚¹è¢«æ‰“ä¸Šäº†ç›¸å…³æ ‡ç­¾åï¼Œåœ¨è°ƒåº¦çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™äº›æ ‡ç­¾äº†ï¼Œåªéœ€è¦åœ¨ Pod çš„ spec å­—æ®µä¸­æ·»åŠ  <code>nodeSelector</code> å­—æ®µï¼Œé‡Œé¢æ˜¯æˆ‘ä»¬éœ€è¦è¢«è°ƒåº¦çš„èŠ‚ç‚¹çš„ label æ ‡ç­¾ï¼Œæ¯”å¦‚ï¼Œä¸‹é¢çš„ Pod æˆ‘ä»¬è¦å¼ºåˆ¶è°ƒåº¦åˆ° node2 è¿™ä¸ªèŠ‚ç‚¹ä¸Šå»ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ nodeSelector æ¥è¡¨ç¤ºäº†ï¼š</p>
<p>$ vim 01-node-selector-demo.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 01-node-selector-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">busybox-pod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-busybox</span></span><br><span class="line">  <span class="attr">nodeSelector:</span> <span class="comment">#æ³¨æ„ï¼šnodeSelectoræ˜¯å’ŒcontainersåŒçº§çš„ï¼›æ³¨æ„ï¼Œè¿™ä¸ªæ”¾çš„é¡ºåºä¸€å®šè¦æ”¾åœ¨containersåé¢ã€‚ä¸ç„¶ä¼šæŠ¥é”™çš„ï¼</span></span><br><span class="line">    <span class="attr">com:</span> <span class="string">youdianzhishi</span></span><br></pre></td></tr></table></figure>



<ul>
<li>éƒ¨ç½²åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ describe å‘½ä»¤æŸ¥çœ‹è°ƒåº¦ç»“æœï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">hg@LAPTOP-G8TUFE0T:/mnt/c/Users/hg/Desktop/yaml$ kubectl apply -f 01-node-selector-demo.yaml </span><br><span class="line">pod/test-busybox created</span><br><span class="line"></span><br><span class="line">hg@LAPTOP-G8TUFE0T:/mnt/c/Users/hg/Desktop/yaml$ kubectl get po  -owide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">test-busybox   1/1     Running   0          78s   10.244.2.210   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl describe po test-busybox  </span></span><br><span class="line">Name:         test-busybox</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         node2/172.29.9.53</span><br><span class="line">Start Time:   Thu, 17 Feb 2022 19:45:11 +0800</span><br><span class="line">Labels:       app=busybox-pod</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.244.2.210</span><br><span class="line">IPs:</span><br><span class="line">  IP:  10.244.2.210</span><br><span class="line">Containers:</span><br><span class="line">  test-busybox:</span><br><span class="line">    Container ID:  containerd://1b4d323942e6d305a4ea25f655eaced77f8cb8e4229eaf1972dc9dfb1246a0c0</span><br><span class="line">    Image:         busybox</span><br><span class="line">    Image ID:      docker.io/library/busybox@sha256:5acba83a746c7608ed544dc1533b87c737a0b0fb730301639a0179f9344b1678</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Command:</span><br><span class="line">      sleep</span><br><span class="line">      3600</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Thu, 17 Feb 2022 19:45:31 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-p5z6t (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True </span><br><span class="line">  Ready             True </span><br><span class="line">  ContainersReady   True </span><br><span class="line">  PodScheduled      True </span><br><span class="line">Volumes:</span><br><span class="line">  kube-api-access-p5z6t:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             <span class="literal">true</span></span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              com=youdianzhishi</span><br><span class="line">Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">                             node.kubernetes.io/unreachable:NoExecute op=Exists <span class="keyword">for</span> 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  2m45s  default-scheduler  Successfully assigned default/test-busybox to node2</span><br><span class="line">  Normal  Pulling    2m43s  kubelet            Pulling image <span class="string">&quot;busybox&quot;</span></span><br><span class="line">  Normal  Pulled     2m26s  kubelet            Successfully pulled image <span class="string">&quot;busybox&quot;</span> <span class="keyword">in</span> 17.583571931s</span><br><span class="line">  Normal  Created    2m26s  kubelet            Created container test-busybox</span><br><span class="line">  Normal  Started    2m25s  kubelet            Started container test-busybox</span><br><span class="line">[root@master1 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Events ä¸‹é¢çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬çš„ Pod é€šè¿‡é»˜è®¤çš„ <code>default-scheduler</code> è°ƒåº¦å™¨è¢«ç»‘å®šåˆ°äº† node2 èŠ‚ç‚¹ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯<code>nodeSelector</code> å±äºå¼ºåˆ¶æ€§çš„ï¼Œå¦‚æœæˆ‘ä»¬çš„ç›®æ ‡èŠ‚ç‚¹æ²¡æœ‰å¯ç”¨çš„èµ„æºï¼Œæˆ‘ä»¬çš„ Pod å°±ä¼šä¸€ç›´å¤„äº <code>Pending</code> çŠ¶æ€ã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥æ„Ÿå—åˆ° <code>nodeSelector</code> çš„æ–¹å¼æ¯”è¾ƒç›´è§‚ï¼Œä½†æ˜¯è¿˜ä¸å¤Ÿçµæ´»ï¼Œæ§åˆ¶ç²’åº¦åå¤§ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å†å’Œå¤§å®¶äº†è§£ä¸‹æ›´åŠ çµæ´»çš„æ–¹å¼ï¼šèŠ‚ç‚¹äº²å’Œæ€§(nodeAffinity)ã€‚</p>
<p>æµ‹è¯•ç»“æŸã€‚ğŸ˜˜</p>
<p>ğŸ‚ é—®é¢˜ï¼š</p>
<p>å› podä¸­nodeSelectoré‡Œçš„æ ‡ç­¾æœªå‡ºç°åœ¨all nodeèŠ‚ç‚¹ï¼Œä½†åç»­ç»™nodeæ‰“å¥½ç¬¦åˆè¦æ±‚çš„æ ‡ç­¾ï¼ŒåŸæ¥å¤„äºpendingçŠ¶æ€çš„podä¼šè‡ªåŠ¨è¿ç§»è¿‡å»çš„å—ï¼Ÿâ€“&gt;<code>ä¼šçš„</code>ã€‚</p>
<h2 id="6ã€äº²å’Œæ€§å’Œåäº²å’Œæ€§è°ƒåº¦"><a href="#6ã€äº²å’Œæ€§å’Œåäº²å’Œæ€§è°ƒåº¦" class="headerlink" title="6ã€äº²å’Œæ€§å’Œåäº²å’Œæ€§è°ƒåº¦"></a>6ã€äº²å’Œæ€§å’Œåäº²å’Œæ€§è°ƒåº¦</h2><p>å‰é¢æˆ‘ä»¬äº†è§£äº† kubernetes è°ƒåº¦å™¨çš„è°ƒåº¦æµç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“é»˜è®¤çš„è°ƒåº¦å™¨åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œç»è¿‡äº† <code>predicates</code> å’Œ <code>priorities</code> ä¸¤ä¸ªé˜¶æ®µï¼Œä½†æ˜¯åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¾€å¾€æˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå·±çš„ä¸€äº›å®é™…éœ€æ±‚æ¥æ§åˆ¶ Pod çš„è°ƒåº¦ï¼Œè¿™å°±éœ€è¦ç”¨åˆ° <code>nodeAffinity(èŠ‚ç‚¹äº²å’Œæ€§)</code>ã€<code>podAffinity(pod äº²å’Œæ€§)</code> ä»¥åŠ <code>podAntiAffinity(pod åäº²å’Œæ€§)</code>ã€‚</p>
<p>ğŸ‚ äº²å’Œæ€§è°ƒåº¦å¯ä»¥åˆ†æˆ<strong>è½¯ç­–ç•¥</strong>å’Œ<strong>ç¡¬ç­–ç•¥</strong>ä¸¤ç§æ–¹å¼:</p>
<ul>
<li><code>è½¯ç­–ç•¥</code>å°±æ˜¯å¦‚æœç°åœ¨æ²¡æœ‰æ»¡è¶³è°ƒåº¦è¦æ±‚çš„èŠ‚ç‚¹çš„è¯ï¼ŒPod å°±ä¼šå¿½ç•¥è¿™æ¡è§„åˆ™ï¼Œç»§ç»­å®Œæˆè°ƒåº¦è¿‡ç¨‹ï¼Œè¯´ç™½äº†å°±æ˜¯æ»¡è¶³æ¡ä»¶æœ€å¥½äº†ï¼Œæ²¡æœ‰çš„è¯ä¹Ÿæ— æ‰€è°“</li>
<li><code>ç¡¬ç­–ç•¥</code>å°±æ¯”è¾ƒå¼ºç¡¬äº†ï¼Œå¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹çš„è¯ï¼Œå°±ä¸æ–­é‡è¯•ç›´åˆ°æ»¡è¶³æ¡ä»¶ä¸ºæ­¢ï¼Œç®€å•è¯´å°±æ˜¯ä½ å¿…é¡»æ»¡è¶³æˆ‘çš„è¦æ±‚ï¼Œä¸ç„¶å°±ä¸å¹²äº†</li>
</ul>
<p>å¯¹äºäº²å’Œæ€§å’Œåäº²å’Œæ€§éƒ½æœ‰è¿™ä¸¤ç§è§„åˆ™å¯ä»¥è®¾ç½®ï¼š <code>preferredDuringSchedulingIgnoredDuringExecution</code> å’Œ<code>requiredDuringSchedulingIgnoredDuringExecution</code>ï¼Œå‰é¢çš„å°±æ˜¯è½¯ç­–ç•¥ï¼Œåé¢çš„å°±æ˜¯ç¡¬ç­–ç•¥ã€‚</p>
<h3 id="1-èŠ‚ç‚¹äº²å’Œæ€§"><a href="#1-èŠ‚ç‚¹äº²å’Œæ€§" class="headerlink" title="1.èŠ‚ç‚¹äº²å’Œæ€§"></a>1.èŠ‚ç‚¹äº²å’Œæ€§</h3><p>èŠ‚ç‚¹äº²å’Œæ€§ï¼ˆnodeAffinityï¼‰ä¸»è¦æ˜¯ç”¨æ¥æ§åˆ¶ Pod è¦éƒ¨ç½²åœ¨å“ªäº›èŠ‚ç‚¹ä¸Šï¼Œä»¥åŠä¸èƒ½éƒ¨ç½²åœ¨å“ªäº›èŠ‚ç‚¹ä¸Šçš„ï¼Œ<strong>å®ƒå¯ä»¥è¿›è¡Œä¸€äº›ç®€å•çš„é€»è¾‘ç»„åˆäº†</strong>ï¼Œä¸åªæ˜¯ç®€å•çš„ç›¸ç­‰åŒ¹é…(æ¯”å¦‚å‰é¢çš„<code>nodeSelector</code>å°±æ˜¯æ ‡ç­¾çš„=)ã€‚</p>
<p>nodeAffinityï¼šèŠ‚ç‚¹äº²å’Œç±»ä¼¼äºnodeSelectorï¼Œå¯ä»¥æ ¹æ®èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾æ¥çº¦æŸPodå¯ä»¥è°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ã€‚</p>
<p>ğŸ‚ ç›¸æ¯”nodeSelectorï¼š </p>
<ul>
<li>åŒ¹é…æœ‰æ›´å¤šçš„é€»è¾‘ç»„åˆï¼Œä¸åªæ˜¯å­—ç¬¦ä¸²çš„å®Œå…¨ç›¸ç­‰ï¼Œæ”¯æŒçš„æ“ä½œç¬¦æœ‰ï¼š<code>Inã€NotInã€Existsã€DoesNotExistã€Gtã€Lt</code></li>
<li>è°ƒåº¦åˆ†ä¸ºè½¯ç­–ç•¥å’Œç¡¬ç­–ç•¥ï¼Œè€Œä¸æ˜¯ç¡¬æ€§è¦æ±‚<ul>
<li>ç¡¬ï¼ˆrequiredï¼‰ï¼šå¿…é¡»æ»¡è¶³</li>
<li>è½¯ï¼ˆpreferredï¼‰ï¼šå°è¯•æ»¡è¶³ï¼Œä½†ä¸ä¿è¯</li>
</ul>
</li>
</ul>
<p>ğŸ‚ è¿™é‡Œçš„åŒ¹é…é€»è¾‘æ˜¯ label æ ‡ç­¾çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ï¼Œç°åœ¨ Kubernetes æä¾›çš„æ“ä½œç¬¦æœ‰ä¸‹é¢çš„å‡ ç§ï¼š</p>
<ul>
<li>Inï¼šlabel çš„å€¼åœ¨æŸä¸ªåˆ—è¡¨ä¸­ (è¿™é‡Œçš„æ“ä½œç¬¦ï¼Œæˆ‘ä»¬ä¸€èˆ¬åªç”¨åˆ°inå°±è¶³å¤Ÿäº†ï¼›)</li>
<li>NotInï¼šlabel çš„å€¼ä¸åœ¨æŸä¸ªåˆ—è¡¨ä¸­</li>
<li>Gtï¼šlabel çš„å€¼å¤§äºæŸä¸ªå€¼</li>
<li>Ltï¼šlabel çš„å€¼å°äºæŸä¸ªå€¼</li>
<li>Existsï¼šæŸä¸ª label å­˜åœ¨</li>
<li>DoesNotExistï¼šæŸä¸ª label ä¸å­˜åœ¨</li>
</ul>
<p>:warning: æ³¨æ„ï¼š</p>
<blockquote>
<p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœ <code>nodeSelectorTerms</code> ä¸‹é¢æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œæ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶å°±å¯ä»¥äº†ï¼›å¦‚æœ <code>matchExpressions</code>æœ‰å¤šä¸ªé€‰é¡¹çš„è¯ï¼Œåˆ™å¿…é¡»åŒæ—¶æ»¡è¶³è¿™äº›æ¡ä»¶æ‰èƒ½æ­£å¸¸è°ƒåº¦ Podã€‚</p>
</blockquote>
<p>ğŸ‚</p>
<p>æ¯”nodeSelectoræ›´é«˜çº§çš„ä¸€ä¸ªï¼<br>matchExpressionsæ¯”selectoræ›´åŠ çµæ´»ã€‚</p>
<table><tr><td bgcolor=yellow>ğŸ’˜ å®è·µï¼šèŠ‚ç‚¹äº²å’Œæ€§æµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.16</td></tr></table>

<ul>
<li>æ¯”å¦‚ç°åœ¨æˆ‘ä»¬ç”¨ä¸€ä¸ª Deployment æ¥ç®¡ç†8ä¸ª Pod å‰¯æœ¬ï¼Œç°åœ¨æˆ‘ä»¬æ¥æ§åˆ¶ä¸‹è¿™äº› Pod çš„è°ƒåº¦ï¼Œå¦‚ä¸‹ä¾‹å­ï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 02-node-affinity-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-affinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">8</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">node-affinity</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">node-affinity</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginxweb</span></span><br><span class="line">      <span class="attr">affinity:</span> <span class="comment">#å®šä¹‰äº²å’Œæ€§</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span> <span class="comment">#èŠ‚ç‚¹äº²å’Œæ€§ </span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># ç¡¬ç­–ç•¥</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">NotIn</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">master1</span> <span class="comment">#ç›¸å½“äºåªèƒ½è°ƒåº¦åˆ°node1å’Œnode2èŠ‚ç‚¹ã€‚é»˜è®¤å°±ä¸ä¼šè°ƒåº¦åˆ°master1èŠ‚ç‚¹</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># è½¯ç­–ç•¥(å°½å¯èƒ½è°ƒåº¦åˆ°node2èŠ‚ç‚¹)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">com</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">youdianzhishi</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™ä¸ª Pod é¦–å…ˆæ˜¯è¦æ±‚ä¸èƒ½è¿è¡Œåœ¨ master1 è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¦‚æœæœ‰ä¸ªèŠ‚ç‚¹æ»¡è¶³ <code>com=youdianzhishi</code> çš„è¯å°±ä¼˜å…ˆè°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šã€‚</p>
<p>ç”±äºä¸Šé¢ node02 èŠ‚ç‚¹æˆ‘ä»¬æ‰“ä¸Šäº† <code>com=youdianzhishi</code> è¿™æ ·çš„ label æ ‡ç­¾ï¼Œæ‰€ä»¥æŒ‰è¦æ±‚ä¼šä¼˜å…ˆè°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹æ¥çš„ã€‚</p>
<ul>
<li>ç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºè¿™ä¸ª Podï¼Œç„¶åæŸ¥çœ‹å…·ä½“çš„è°ƒåº¦æƒ…å†µæ˜¯å¦æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl apply -f node-affinty-demo.yaml</span><br><span class="line">deployment.apps/node-affinity created</span><br><span class="line">âœ kubectl get pods -l app=node-affinity -o wide <span class="comment">#è€å¸ˆè¿™ä¸ªæœ‰éƒ¨åˆ†podè¢«è°ƒåº¦åˆ°node1èŠ‚ç‚¹</span></span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">node-affinity-cdd9d54d9-bgbbh   1/1     Running   0          2m28s   10.244.2.247   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-affinity-cdd9d54d9-dlbck   1/1     Running   0          2m28s   10.244.4.16    node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-affinity-cdd9d54d9-g2jr6   1/1     Running   0          2m28s   10.244.4.17    node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-affinity-cdd9d54d9-gzr58   1/1     Running   0          2m28s   10.244.1.118   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-affinity-cdd9d54d9-hcv7r   1/1     Running   0          2m28s   10.244.2.246   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-affinity-cdd9d54d9-kvxw4   1/1     Running   0          2m28s   10.244.2.245   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-affinity-cdd9d54d9-p4mmk   1/1     Running   0          2m28s   10.244.2.244   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">node-affinity-cdd9d54d9-t5mff   1/1     Running   0          2m28s   10.244.1.117   node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>ä»ç»“æœå¯ä»¥çœ‹å‡ºæœ‰5ä¸ª Pod è¢«éƒ¨ç½²åˆ°äº† node2 èŠ‚ç‚¹ä¸Šï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰ä¸€ä¸ª Pod è¢«éƒ¨ç½²åˆ° master1 è¿™ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¡¬ç­–ç•¥å°±æ˜¯ä¸å…è®¸éƒ¨ç½²åˆ°è¯¥èŠ‚ç‚¹ä¸Šï¼Œè€Œ node2 æ˜¯è½¯ç­–ç•¥ï¼Œ<strong>æ‰€ä»¥ä¼šå°½é‡æ»¡è¶³</strong>ã€‚</p>
<p>æµ‹è¯•ç»“æŸã€‚ğŸ˜˜</p>
<h3 id="2-pod-äº²å’Œæ€§å’Œpod-åäº²å’Œæ€§"><a href="#2-pod-äº²å’Œæ€§å’Œpod-åäº²å’Œæ€§" class="headerlink" title="2.pod äº²å’Œæ€§å’Œpod åäº²å’Œæ€§"></a>2.pod äº²å’Œæ€§å’Œpod åäº²å’Œæ€§</h3><p>Pod äº²å’Œæ€§ï¼ˆpodAffinityï¼‰ä¸»è¦è§£å†³ Pod å¯ä»¥å’Œå“ªäº› Pod éƒ¨ç½²åœ¨<strong>åŒä¸€ä¸ªæ‹“æ‰‘åŸŸ</strong>ä¸­çš„é—®é¢˜ï¼ˆå…¶ä¸­<strong>æ‹“æ‰‘åŸŸç”¨ä¸»æœºæ ‡ç­¾å®ç°</strong>ï¼Œå¯ä»¥æ˜¯å•ä¸ªä¸»æœºï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªä¸»æœºç»„æˆçš„ clusterã€zone ç­‰ç­‰ï¼‰ï¼Œè€Œ Pod åäº²å’Œæ€§ä¸»è¦æ˜¯è§£å†³ Pod ä¸èƒ½å’Œå“ªäº› Pod éƒ¨ç½²åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­çš„é—®é¢˜ï¼Œå®ƒä»¬éƒ½æ˜¯å¤„ç†çš„ Pod ä¸ Pod ä¹‹é—´çš„å…³ç³»ã€‚æ¯”å¦‚ä¸€ä¸ª Pod åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šäº†ï¼Œé‚£ä¹ˆæˆ‘è¿™ä¸ªä¹Ÿå¾—åœ¨è¿™ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…ä½ è¿™ä¸ª Pod åœ¨èŠ‚ç‚¹ä¸Šäº†ï¼Œé‚£ä¹ˆæˆ‘å°±ä¸æƒ³å’Œä½ å¾…åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚</p>
<p>ğŸ‘‰ğŸ¼ è¿™ä¸ªæ˜¯å¾ˆé‡è¦çš„ï¼Œçº¿ä¸Šä¸šåŠ¡åŸºæœ¬è¦é…ç½®è¿™ç§podAntiAffinityã€‚</p>
<p>ğŸ‚ <code>æ‹“æ‰‘åŸŸ</code></p>
<blockquote>
<p>è¿™é‡Œè¦é‡ç‚¹ç†è§£ä¸‹ä»€ä¹ˆæ˜¯æ‹“æ‰‘åŸŸï¼Ÿâ€“&gt;ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸ºä¸€ä¸ªåˆ†ç»„ã€‚</p>
</blockquote>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220218131033136.png" alt="image-20220218131033136"></p>
<table><tr><td bgcolor=yellow>ğŸ’˜ å®éªŒï¼špodäº²å’Œæ€§(æµ‹è¯•æˆåŠŸ)-2022.5.16</td></tr></table>

<ul>
<li>ç”±äºæˆ‘ä»¬è¿™é‡Œåªæœ‰ä¸€ä¸ªé›†ç¾¤ï¼Œå¹¶æ²¡æœ‰åŒºåŸŸæˆ–è€…æœºæˆ¿çš„æ¦‚å¿µï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç›´æ¥ä½¿ç”¨ä¸»æœºåæ¥ä½œä¸ºæ‹“æ‰‘åŸŸï¼ŒæŠŠ Pod åˆ›å»ºåœ¨åŒä¸€ä¸ªä¸»æœºä¸Šé¢ã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl get node --show-labels </span></span><br><span class="line">NAME      STATUS   ROLES                  AGE    VERSION   LABELS</span><br><span class="line">master1   Ready    control-plane,master   110d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master1,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">node1     Ready    &lt;none&gt;                 110d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node1,kubernetes.io/os=linux</span><br><span class="line">node2     Ready    &lt;none&gt;                 110d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,com=youdianzhishi,kubernetes.io/arch=amd64,kubernetes.io/hostname=node2,kubernetes.io/os=linux</span><br></pre></td></tr></table></figure>



<ul>
<li>åŒæ ·ï¼Œè¿˜æ˜¯é’ˆå¯¹ä¸Šé¢çš„èµ„æºå¯¹è±¡ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸‹ Pod çš„äº²å’Œæ€§ï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 03-pod-affinity-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-affinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pod-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">pod-affinity</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pod-affinity</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginxweb</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># ç¡¬ç­–ç•¥</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labelSelector:</span> <span class="comment">#å»é€‰æ‹©å…·æœ‰app in [&quot;busybox-pod&quot;]çš„podæ‰€åœ¨çš„hostnameè¿™ä¸ªåŸŸã€‚</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">busybox-pod</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­çš„ Pod éœ€è¦è°ƒåº¦åˆ°æŸä¸ªæŒ‡å®šçš„èŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œäº†ä¸€ä¸ªå¸¦æœ‰ <code>app=busybox-pod</code> æ ‡ç­¾çš„ Podã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æœ‰æ ‡ç­¾ <code>app=busybox-pod</code> çš„ pod åˆ—è¡¨ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get pods -l app=busybox-pod -o wide</span></span><br><span class="line">NAME           READY   STATUS    RESTARTS      AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">test-busybox   1/1     Running   5 (23m ago)   18h   10.244.2.210   node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>



<ul>
<li>æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ª Pod è¿è¡Œåœ¨äº† node2 çš„èŠ‚ç‚¹ä¸Šé¢ï¼Œæ‰€ä»¥æŒ‰ç…§ä¸Šé¢çš„äº²å’Œæ€§æ¥è¯´ï¼Œä¸Šé¢æˆ‘ä»¬éƒ¨ç½²çš„3ä¸ª Pod å‰¯æœ¬ä¹Ÿåº”è¯¥è¿è¡Œåœ¨ node2 èŠ‚ç‚¹ä¸Šï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f 03-pod-affinity-demo.yaml </span><br><span class="line">deployment.apps/pod-affinity created</span><br><span class="line">$ kubectl get pods -o wide -l app=pod-affinity</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-affinity-785f687c5-52t54   1/1     Running   0          60s   10.244.2.228   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-affinity-785f687c5-g594p   1/1     Running   0          60s   10.244.2.229   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-affinity-785f687c5-s6j7h   1/1     Running   0          60s   10.244.2.227   node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>



<ul>
<li>å¦‚æœæˆ‘ä»¬æŠŠä¸Šé¢çš„ test-busybox å’Œ pod-affinity è¿™ä¸ª Deployment éƒ½åˆ é™¤ï¼Œç„¶åé‡æ–°åˆ›å»º pod-affinity è¿™ä¸ªèµ„æºï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ­£å¸¸è°ƒåº¦å‘¢ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f 01-node-selector-demo.yaml</span><br><span class="line">pod <span class="string">&quot;test-busybox&quot;</span> deleted</span><br><span class="line">$ kubectl delete -f 03-pod-affinity-demo.yaml</span><br><span class="line">deployment.apps <span class="string">&quot;pod-affinity&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f 03-pod-affinity-demo.yaml </span><br><span class="line">deployment.apps/pod-affinity created</span><br><span class="line">$ kubectl get po</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-affinity-785f687c5-2256q   0/1     Pending   0          80s</span><br><span class="line">pod-affinity-785f687c5-7gpz5   0/1     Pending   0          80s</span><br><span class="line">pod-affinity-785f687c5-97gpj   0/1     Pending   0          80s</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°éƒ½å¤„äº <code>Pending</code> çŠ¶æ€äº†ï¼Œè¿™æ˜¯å› ä¸ºç°åœ¨æ²¡æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¸Šé¢æ‹¥æœ‰ <code>app=busybox-pod</code> è¿™ä¸ªæ ‡ç­¾çš„ Podï¼Œè€Œä¸Šé¢æˆ‘ä»¬çš„è°ƒåº¦ä½¿ç”¨çš„æ˜¯ç¡¬ç­–ç•¥ï¼Œæ‰€ä»¥å°±æ²¡åŠæ³•è¿›è¡Œè°ƒåº¦äº†ï¼Œå¤§å®¶å¯ä»¥å»å°è¯•ä¸‹é‡æ–°å°† test-busybox è¿™ä¸ª Pod è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šï¼Œè§‚å¯Ÿä¸‹ä¸Šé¢çš„3ä¸ªå‰¯æœ¬ä¼šä¸ä¼šä¹Ÿè¢«è°ƒåº¦åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šå»ã€‚(è¿™é‡Œå¯ä»¥è‡ªå·±æµ‹è¯•ä¸‹ï¼Œå¯ä»¥åˆ©ç”¨node1çš„<code>kubernetes.io/hostname: node1</code>æ ‡ç­¾ç”¨nodeSelectoræ¥å®ç°)</p>
<ul>
<li>æˆ‘ä»¬è¿™ä¸ªåœ°æ–¹ä½¿ç”¨çš„æ˜¯ <code>kubernetes.io/hostname</code> è¿™ä¸ª<strong>æ‹“æ‰‘åŸŸ</strong>ï¼Œæ„æ€å°±æ˜¯æˆ‘ä»¬å½“å‰è°ƒåº¦çš„ Pod è¦å’Œç›®æ ‡çš„ Pod å¤„äºåŒä¸€ä¸ªä¸»æœºä¸Šé¢ï¼Œå› ä¸ºè¦å¤„äºåŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸‹é¢ã€‚ä¸ºäº†è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æŠŠæ‹“æ‰‘åŸŸæ”¹æˆ <code>beta.kubernetes.io/os</code>ï¼ŒåŒæ ·çš„æˆ‘ä»¬å½“å‰è°ƒåº¦çš„ Pod è¦å’Œç›®æ ‡çš„ Pod å¤„äºåŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­ï¼Œç›®æ ‡çš„ Pod æ˜¯æ‹¥æœ‰ <code>beta.kubernetes.io/os=linux</code> çš„æ ‡ç­¾ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰è¿™æ ·çš„æ ‡ç­¾ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬æ‰€æœ‰èŠ‚ç‚¹éƒ½åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçš„ Pod å¯ä»¥è¢«è°ƒåº¦åˆ°ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‡æ–°è¿è¡Œä¸Šé¢çš„ <code>app=busybox-pod</code> çš„ Podï¼Œç„¶åå†æ›´æ–°ä¸‹æˆ‘ä»¬è¿™é‡Œçš„èµ„æºå¯¹è±¡ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get po -owide</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE    IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-affinity-6bf5bb4fc4-j6ctw   1/1     Running   0          22s    10.244.2.230   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-affinity-6bf5bb4fc4-xb7tr   1/1     Running   0          22s    10.244.2.231   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-affinity-6bf5bb4fc4-xl6pn   1/1     Running   0          22s    10.244.1.97    node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220218145745621.png" alt="image-20220218145745621"></p>
<p>å¯ä»¥çœ‹åˆ°ç°åœ¨æ˜¯åˆ†åˆ«è¿è¡Œåœ¨2ä¸ªèŠ‚ç‚¹ä¸‹é¢çš„ï¼Œå› ä¸ºä»–ä»¬éƒ½å±äº <code>beta.kubernetes.io/os</code> è¿™ä¸ªæ‹“æ‰‘åŸŸ(è€Œ<code>busybox-pod</code>ä¹Ÿåˆšå¥½åœ¨è¿™ä¸ªåŸŸä¸‹ï¼Œå› æ­¤ç¬¦åˆç¡¬ç­–ç•¥è¦æ±‚)ã€‚</p>
<blockquote>
<p>:warning: è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹ï¼šé€šè¿‡ä¸Šé¢è¿™ä¸ªå®éªŒå¯ä»¥çœ‹åˆ°ï¼Œè¿™2ä¸ªnodeèŠ‚ç‚¹éƒ½å±äº<code>beta.kubernetes.io/os</code>è¿™ä¸ªæ‹“æ‰‘åŸŸï¼Œä½†åªæœ‰node1ä¸Šæœ‰<code>app=pod-affitity</code>è¿™ä¸ªæ ‡ç­¾çš„podï¼Œä»ç»“æœå¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯å¯ä»¥è°ƒåº¦åˆ°node2ä¸Šçš„ã€‚</p>
</blockquote>
<p>å®éªŒç»“æŸã€‚ğŸ˜˜</p>
<p>ğŸ‚ pod åäº²å’Œæ€§(podAntiAffinity)</p>
<p>Pod åäº²å’Œæ€§ï¼ˆpodAntiAffinityï¼‰åˆ™æ˜¯åç€æ¥çš„ï¼Œæ¯”å¦‚ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†æŸä¸ª Podï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æ¨¡æ¿ Pod åˆ™ä¸å¸Œæœ›è¢«è°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šé¢å»äº†ã€‚</p>
<table><tr><td bgcolor=yellow>ğŸ’˜ å®éªŒï¼špodåäº²å’Œæ€§(æµ‹è¯•æˆåŠŸ)-2022.5.16</td></tr></table>

<ul>
<li>æˆ‘ä»¬æŠŠä¸Šé¢çš„ <code>podAffinity</code> ç›´æ¥æ”¹æˆ <code>podAntiAffinity</code>ï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 04-pod-antiaffinity-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-antiaffinity</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pod-antiaffinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">pod-antiaffinity</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pod-antiaffinity</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginxweb</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># ç¡¬ç­–ç•¥</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labelSelector:</span> <span class="comment">#3ä¸ªpodå‰¯æœ¬ä¸ä¼šè°ƒåº¦åˆ°å…·æœ‰app=busybox-podæ‰€åœ¨çš„hostanmeè¿™ä¸ªåŸŸ(èŠ‚ç‚¹)ä¸Šé¢</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">busybox-pod</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span> <span class="comment">#æ³¨æ„ï¼špodåäº²å’Œæ€§æ˜¯ç›´æ¥ä¸å¾€è¿™ä¸ªåŸŸé‡Œç›´æ¥è°ƒåº¦podçš„ï¼ï¼ï¼</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„æ„æ€å°±æ˜¯å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä¸Šé¢æœ‰ä¸€ä¸ª <code>app=busybox-pod</code> è¿™æ ·çš„ Pod çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ Pod å°±åˆ«è°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šé¢æ¥ï¼Œä¸Šé¢æˆ‘ä»¬æŠŠ<code>app=busybox-pod</code> è¿™ä¸ª Pod å›ºå®šåˆ°äº† node2 è¿™ä¸ªèŠ‚ç‚¹ä¸Šé¢çš„ï¼Œæ‰€ä»¥æ­£å¸¸æ¥è¯´æˆ‘ä»¬è¿™é‡Œçš„ Pod ä¸ä¼šå‡ºç°åœ¨è¯¥èŠ‚ç‚¹ä¸Šï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f 04-pod-antiaffinity-demo.yaml </span><br><span class="line">deployment.apps/pod-antiaffinity created</span><br><span class="line">$ kubectl get po -owide</span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-antiaffinity-57c57dd9f7-jspkt   1/1     Running   0          25s   10.244.1.100   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-antiaffinity-57c57dd9f7-mm78w   1/1     Running   0          25s   10.244.1.99    node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-antiaffinity-57c57dd9f7-x9mft   1/1     Running   0          25s   10.244.1.98    node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ²¡æœ‰è¢«è°ƒåº¦åˆ° node2 èŠ‚ç‚¹ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ Pod åäº²å’Œæ€§ã€‚</p>
<ul>
<li>å¤§å®¶å¯ä»¥æ€è€ƒä¸‹ï¼Œå¦‚æœè¿™é‡Œæˆ‘ä»¬å°†æ‹“æ‰‘åŸŸæ›´æ”¹æˆ <code>beta.kubernetes.io/os</code> ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿå¯ä»¥è‡ªå·±å»æµ‹è¯•ä¸‹çœ‹çœ‹ã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f 04-pod-antiaffinity-demo.yaml </span><br><span class="line">deployment.apps/pod-antiaffinity created</span><br><span class="line">$ kubectl get po</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-antiaffinity-c5fb4db4d-jj5j7   0/1     Pending   0          4s</span><br><span class="line">pod-antiaffinity-c5fb4db4d-xxnhg   0/1     Pending   0          4s</span><br><span class="line">pod-antiaffinity-c5fb4db4d-zkbgp   0/1     Pending   0          4s</span><br></pre></td></tr></table></figure>

<p>å®éªŒç»“æŸã€‚ğŸ˜˜</p>
<h2 id="7ã€æ±¡ç‚¹ä¸å®¹å¿"><a href="#7ã€æ±¡ç‚¹ä¸å®¹å¿" class="headerlink" title="7ã€æ±¡ç‚¹ä¸å®¹å¿"></a>7ã€æ±¡ç‚¹ä¸å®¹å¿</h2><p>Taintï¼ˆæ±¡ç‚¹ï¼‰ä¸Tolerationsï¼ˆæ±¡ç‚¹å®¹å¿ï¼‰</p>
<p><strong>Taints</strong>ï¼šé¿å…Podè°ƒåº¦åˆ°ç‰¹å®šNodeä¸Š </p>
<p><strong>Tolerations</strong>ï¼šå…è®¸Podè°ƒåº¦åˆ°æŒæœ‰Taintsçš„Nodeä¸Š</p>
<p>åº”ç”¨åœºæ™¯ï¼š </p>
<ul>
<li>ä¸“ç”¨èŠ‚ç‚¹ï¼šæ ¹æ®ä¸šåŠ¡çº¿å°†Nodeåˆ†ç»„ç®¡ç†ï¼Œå¸Œæœ›åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸è°ƒåº¦è¯¥èŠ‚ç‚¹ï¼Œåªæœ‰é…ç½®äº†æ±¡ç‚¹å®¹å¿æ‰å…è®¸åˆ†é…</li>
<li>é…å¤‡ç‰¹æ®Šç¡¬ä»¶ï¼šéƒ¨åˆ†Nodeé…æœ‰SSDç¡¬ç›˜ã€GPUï¼Œå¸Œæœ›åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸è°ƒåº¦è¯¥èŠ‚ç‚¹ï¼Œåªæœ‰é…ç½®äº†æ±¡ç‚¹å®¹å¿æ‰å…è®¸åˆ†é…</li>
<li>åŸºäºTaintçš„é©±é€</li>
</ul>
<p>å¯¹äº <code>nodeAffinity</code> æ— è®ºæ˜¯ç¡¬ç­–ç•¥è¿˜æ˜¯è½¯ç­–ç•¥æ–¹å¼ï¼Œéƒ½æ˜¯<strong>è°ƒåº¦ Pod åˆ°é¢„æœŸèŠ‚ç‚¹ä¸Š</strong>ã€‚è€Œæ±¡ç‚¹ï¼ˆTaintsï¼‰æ°å¥½ä¸ä¹‹ç›¸åï¼Œ<strong>å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º Taints ï¼Œé™¤é Pod ä¹Ÿè¢«æ ‡è¯†ä¸ºå¯ä»¥å®¹å¿æ±¡ç‚¹èŠ‚ç‚¹ï¼Œå¦åˆ™è¯¥ Taints èŠ‚ç‚¹ä¸ä¼šè¢«è°ƒåº¦ Podã€‚</strong></p>
<p>æ¯”å¦‚ç”¨æˆ·å¸Œæœ›æŠŠ Master èŠ‚ç‚¹ä¿ç•™ç»™ Kubernetes ç³»ç»Ÿç»„ä»¶ä½¿ç”¨ï¼Œ<strong>æˆ–è€…æŠŠä¸€ç»„å…·æœ‰ç‰¹æ®Šèµ„æºé¢„ç•™ç»™æŸäº› Pod</strong>ï¼Œåˆ™æ±¡ç‚¹å°±å¾ˆæœ‰ç”¨äº†ï¼ŒPod ä¸ä¼šå†è¢«è°ƒåº¦åˆ° taint æ ‡è®°è¿‡çš„èŠ‚ç‚¹ã€‚<strong>æˆ‘ä»¬ä½¿ç”¨ kubeadm æ­å»ºçš„é›†ç¾¤é»˜è®¤å°±ç»™ master èŠ‚ç‚¹æ·»åŠ äº†ä¸€ä¸ªæ±¡ç‚¹æ ‡è®°</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å¹³æ—¶çš„ Pod éƒ½æ²¡æœ‰è¢«è°ƒåº¦åˆ° master ä¸Šå»ã€‚</p>
<blockquote>
<p>:warning: æ±¡ç‚¹ï¼šå…¶å®æ˜¯ä¸€ä¸ªlabelæ ‡ç­¾ï¼Œåªä¸è¿‡å®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„labelæ ‡ç­¾ã€‚</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get node master1 --show-labels </span></span><br><span class="line">NAME      STATUS   ROLES                  AGE    VERSION   LABELS</span><br><span class="line">master1   Ready    control-plane,master   110d   v1.22.2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master1,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=(æ³¨æ„ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªç©ºæ ‡ç­¾),node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl describe node master1</span></span><br><span class="line">Name:               master1</span><br><span class="line">Roles:              master</span><br><span class="line">Labels:             beta.kubernetes.io/arch=amd64</span><br><span class="line">                    beta.kubernetes.io/os=linux</span><br><span class="line">                    kubernetes.io/arch=amd64</span><br><span class="line">                    kubernetes.io/hostname=master1</span><br><span class="line">                    kubernetes.io/os=linux</span><br><span class="line">                    node-role.kubernetes.io/master=</span><br><span class="line">......</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">Unschedulable:      <span class="literal">false</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤æŸ¥çœ‹ master èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ä¸€æ¡å…³äº Taints çš„ä¿¡æ¯ï¼š<code>node-role.kubernetes.io/master:NoSchedule</code>ï¼Œå°±è¡¨ç¤ºmaster èŠ‚ç‚¹æ‰“äº†ä¸€ä¸ªæ±¡ç‚¹çš„æ ‡è®°ï¼Œå…¶ä¸­å½±å“çš„å‚æ•°æ˜¯ <code>NoSchedule</code>ï¼Œè¡¨ç¤º Pod ä¸ä¼šè¢«è°ƒåº¦åˆ°æ ‡è®°ä¸º taints çš„èŠ‚ç‚¹ã€‚é™¤äº† <code>NoSchedule</code> å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸¤ä¸ªé€‰é¡¹ï¼š</p>
<ul>
<li><strong>PreferNoSchedule</strong>ï¼šNoSchedule çš„è½¯ç­–ç•¥ç‰ˆæœ¬ï¼Œè¡¨ç¤ºå°½é‡ä¸è°ƒåº¦åˆ°æ±¡ç‚¹èŠ‚ç‚¹ä¸Šå»</li>
<li><strong>NoExecute</strong>ï¼šè¯¥é€‰é¡¹æ„å‘³ç€**ä¸€æ—¦ Taint ç”Ÿæ•ˆ(è¢«æ‰“ä¸Štaint)**ï¼Œå¦‚è¯¥èŠ‚ç‚¹å†…æ­£åœ¨è¿è¡Œçš„ Pod æ²¡æœ‰å¯¹åº”å®¹å¿ï¼ˆTolerateï¼‰è®¾ç½®ï¼Œåˆ™ä¼šç›´æ¥è¢«é€å‡ºã€‚ å“ˆå“ˆğŸ˜‚è¿™ä¸ªå‘½ä»¤ä¹Ÿæ˜¯å¤Ÿç‹ ã€‚ã€‚ã€‚<code>kubectl taint node k8s-node1 disktype=ssd:NoExecute</code></li>
</ul>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220516220902219.png" alt="image-20220516220902219"></p>
<p>ğŸ‚ æ±¡ç‚¹ taint æ ‡è®°èŠ‚ç‚¹çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl taint nodes node2 <span class="built_in">test</span>=node2:NoSchedule</span><br><span class="line">node <span class="string">&quot;node2&quot;</span> tainted</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„å‘½åå°† node2 èŠ‚ç‚¹æ ‡è®°ä¸ºäº†æ±¡ç‚¹ï¼Œå½±å“ç­–ç•¥æ˜¯ <code>NoSchedule</code>ï¼Œ**<font color=red>åªä¼šå½±å“æ–°çš„ Pod è°ƒåº¦</font>**ï¼Œå¦‚æœä»ç„¶å¸Œæœ›æŸä¸ª Pod è°ƒåº¦åˆ° taint èŠ‚ç‚¹ä¸Šï¼Œåˆ™å¿…é¡»åœ¨ Spec ä¸­åšå‡º Toleration å®šä¹‰ï¼Œæ‰èƒ½è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚</p>
<p>ğŸ‚ æœ€åå¦‚æœæˆ‘ä»¬è¦å–æ¶ˆèŠ‚ç‚¹çš„æ±¡ç‚¹æ ‡è®°ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl taint nodes node2 <span class="built_in">test</span>-</span><br><span class="line">node <span class="string">&quot;node2&quot;</span> untainted</span><br></pre></td></tr></table></figure>



<table><tr><td bgcolor=yellow>ğŸ’˜ å®è·µï¼šæ±¡ç‚¹ä¸å®¹å¿(æµ‹è¯•æˆåŠŸ)-2022.5.16</td></tr></table>

<ul>
<li>æ¯”å¦‚ç°åœ¨æˆ‘ä»¬æƒ³è¦å°†ä¸€ä¸ª Pod è°ƒåº¦åˆ° master èŠ‚ç‚¹ï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 05-taint-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">taint</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">taint</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">taint</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">taint</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/master&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>

<p>ç”±äº master èŠ‚ç‚¹è¢«æ ‡è®°ä¸ºäº†æ±¡ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè¦æƒ³ Pod èƒ½å¤Ÿè°ƒåº¦åˆ°æ”¹èŠ‚ç‚¹å»ï¼Œå°±éœ€è¦å¢åŠ å®¹å¿çš„å£°æ˜ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/master&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>ç„¶ååˆ›å»ºä¸Šé¢çš„èµ„æºï¼ŒæŸ¥çœ‹ç»“æœï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl apply -f taint-demo.yaml</span><br><span class="line">deployment.apps <span class="string">&quot;taint&quot;</span> created</span><br><span class="line"></span><br><span class="line">âœ kubectl get pods -o wide</span><br><span class="line">NAME                                      READY     STATUS             RESTARTS   AGE       IP             NODE</span><br><span class="line">......</span><br><span class="line">taint-845d8bb4fb-57mhm                    1/1       Running            0          1m        10.244.4.247   node2</span><br><span class="line">taint-845d8bb4fb-bbvmp                    1/1       Running            0          1m        10.244.0.33    master1</span><br><span class="line">taint-845d8bb4fb-zb78x                    1/1       Running            0          1m        10.244.4.246   node2</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª Pod å‰¯æœ¬è¢«è°ƒåº¦åˆ°äº† master èŠ‚ç‚¹ï¼Œè¿™å°±æ˜¯å®¹å¿çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<blockquote>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šæˆ‘è¿™ä¸ªpodå¯ä»¥è°ƒåº¦åˆ°æ²¡æ‰“è¿™ä¸ªæ±¡ç‚¹çš„nodeä¸Šå»å—ï¼Ÿè¿˜æ˜¯è¯´ä¼šä¼˜å…ˆè°ƒåº¦åˆ°è¿™ä¸ªæ‰“äº†æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šå»å‘¢ï¼Ÿã€‚ã€‚ã€‚</p>
<p>â€“&gt;ç»æµ‹è¯•ï¼šæ˜¯å¯ä»¥è°ƒåº¦ä¸Šå»çš„ã€‚podé…ç½®äº†å®¹å¿ä¹‹åï¼ŒåŸæ¥æ‰“äº†æ±¡ç‚¹çš„nodeå°±å¯ä»¥å’Œå…¶ä»–èŠ‚ç‚¹ä¸€æ ·å»è´Ÿè½½podäº†ï¼Œå…·ä½“è°ƒåº¦ç­–ç•¥æ˜¯çœ‹è°ƒåº¦å™¨çš„ã€‚</p>
</blockquote>
<ul>
<li>æœ€åå¦‚æœæˆ‘ä»¬è¦å–æ¶ˆèŠ‚ç‚¹çš„æ±¡ç‚¹æ ‡è®°ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl taint nodes node2 <span class="built_in">test</span>-</span><br><span class="line">node <span class="string">&quot;node2&quot;</span> untainted</span><br></pre></td></tr></table></figure>

<p>å®éªŒç»“æŸã€‚ğŸ˜˜</p>
<p>ğŸ‚ </p>
<p>Taintså’ŒTolerationsç”¨äºä¿è¯Pod ä¸è¢«è°ƒåº¦åˆ°ä¸åˆé€‚çš„Nodeä¸Šï¼Œå…¶ä¸­Taintåº”ç”¨äºNodeä¸Šï¼Œè€ŒTolerationåˆ™åº”ç”¨äºPodä¸Šã€‚</p>
<p>ğŸ‚ nodeSelector/nodeAffinityä¸Taint/TolerationsåŒºåˆ«</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nodeSelector/nodeAffinity--ä¸€ç§ä¸»è§‚æ„è¯†ï¼Œæˆ‘è¦åˆ†é…åœ¨å“ªä¸ªnodeèŠ‚ç‚¹ä¸Šå»ï¼›</span><br><span class="line">è€ŒTaint/Tolerationsï¼šæ˜¯ä¸€ç§æ’æ–¥è¡Œä¸ºï¼Œåœ¨nodeä¸Šæ’æ–¥podåˆ†é…åˆ°è‡ªå·±èº«ä¸Šï¼›</span><br><span class="line"></span><br><span class="line">nodeSelector/nodeAffinity--ç®¡ç†å‘˜å¼ºè¿«node</span><br><span class="line">taint/toleration--nodeä¸»åŠ¨çš„ä¸€è„¸å«Œå¼ƒ</span><br></pre></td></tr></table></figure>



<p>ğŸ‚</p>
<p>k8sçš„è‡ªæ„ˆèƒ½åŠ›/æ•…éšœè½¬ç§»èƒ½åŠ›ï¼šâ€“&gt;æ±¡ç‚¹å’Œå®¹å¿ï¼</p>
<p>ğŸ‚  <code>tolerations</code> å±æ€§çš„å†™æ³•</p>
<p>å¯¹äº <code>tolerations</code> å±æ€§çš„å†™æ³•ï¼Œ<strong>å…¶ä¸­çš„ keyã€valueã€effect ä¸ Node çš„ Taint è®¾ç½®éœ€ä¿æŒä¸€è‡´</strong>ï¼Œ è¿˜æœ‰ä»¥ä¸‹å‡ ç‚¹è¯´æ˜ï¼š</p>
<ul>
<li>å¦‚æœ operator çš„å€¼æ˜¯ <code>Exists</code>ï¼Œåˆ™ value å±æ€§å¯çœç•¥</li>
<li>å¦‚æœ operator çš„å€¼æ˜¯ <code>Equal</code>ï¼Œåˆ™è¡¨ç¤ºå…¶ key ä¸ value ä¹‹é—´çš„å…³ç³»æ˜¯ equal(ç­‰äº)</li>
<li>å¦‚æœä¸æŒ‡å®š operator å±æ€§ï¼Œåˆ™é»˜è®¤å€¼ä¸º <code>Equal</code></li>
</ul>
<p>å¦å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªç‰¹æ®Šå€¼ï¼š</p>
<ul>
<li><p><strong>ç©ºçš„ key å¦‚æœå†é…åˆ <code>Exists</code> å°±èƒ½åŒ¹é…æ‰€æœ‰çš„ key ä¸ valueï¼Œä¹Ÿå°±æ˜¯æ˜¯èƒ½å®¹å¿æ‰€æœ‰èŠ‚ç‚¹çš„æ‰€æœ‰ Taints</strong> ï¼ï¼ï¼ğŸ˜‹</p>
</li>
<li><p>ç©ºçš„ effect åŒ¹é…æ‰€æœ‰çš„ effect</p>
</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<p>masterèŠ‚ç‚¹ä¸Šï¼Œä¸ºä»€ä¹ˆé™¤äº†é™æ€podä¹‹å¤–ï¼Œä¸Šé¢è¿˜æœ‰calico/kube-proxyç»„ä»¶å¯ä»¥è¿è¡Œã€‚</p>
<p>ä¸ºä»€ä¹ˆå‘¢ï¼ŸåŸå› åœ¨è¿™é‡Œï¼š==æ±¡ç‚¹å®¹å¿æ˜¯å¯ä»¥ç›´æ¥æ”¾å®½æ¡ä»¶å†™çš„ï¼Œä¾‹å¦‚calicoï¼Œä¸åˆ†ä»€ä¹ˆkeyä»€ä¹ˆvalueï¼Œç¬¦åˆå¸¦æœ‰æ±¡ç‚¹æ˜¯NoScheduleéƒ½å¯ä»¥å…è®¸åˆ†é…ã€‚==</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220310074709618.png" alt="image-20220310074709618"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220310075310952.png" alt="image-20220310075310952"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220310075518987.png" alt="image-20220310075518987"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220310075606692.png" alt="image-20220310075606692"></p>
<h2 id="8ã€nodeName"><a href="#8ã€nodeName" class="headerlink" title="8ã€nodeName"></a>8ã€nodeName</h2><p>nodeNameï¼šæŒ‡å®šèŠ‚ç‚¹åç§°ï¼Œç”¨äºå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„Nodeä¸Šï¼Œä¸ç»è¿‡è°ƒåº¦å™¨ (nodeNameæŒ‡å“ªæ‰“å“ªğŸ˜‚,<code>nodeName</code>ä¸€èˆ¬åœ¨æµ‹è¯•ä¸­ç”¨ï¼Œä½†å·¥ä½œä¸­æ ¹æœ¬æ²¡æ€ä¹ˆç”¨åˆ°)</p>
<table><tr><td bgcolor=yellow>ğŸ’˜ å®è·µï¼šnodeNameæµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.16</td></tr></table>

<ul>
<li>åˆ›å»ºpodçš„yamlå¹¶ä¿®æ”¹</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#kubectl run pod6 --image=nginx --dry-run=client -o yaml &gt; pod6.yaml</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#vim pod6.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-example</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k8s-node1</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.15</span> </span><br></pre></td></tr></table></figure>



<ul>
<li>æ³¨æ„ï¼šåŸæ¥k8s-node1èŠ‚ç‚¹æ˜¯å·²ç»æ‰“å¥½æ±¡ç‚¹äº†çš„ã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment">#kubectl describe nodes |grep Taint</span></span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br><span class="line">Taints:             ssd=ok:NoSchedule</span><br><span class="line">Taints:             &lt;none&gt;</span><br><span class="line">[root@k8s-master ~]<span class="comment">#kubectl describe nodes k8s-node1 |grep Taint</span></span><br><span class="line">Taints:             ssd=ok:NoSchedule</span><br><span class="line">[root@k8s-master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>



<ul>
<li>applyå¹¶æŸ¥çœ‹æ•ˆæœ</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment">#kubectl apply -f pod6.yaml</span></span><br><span class="line">pod/pod6 created</span><br><span class="line">[root@k8s-master ~]<span class="comment">#kubectl get pod -o wide</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210618062414511.png" alt="image-20210618062414511"></p>
<ul>
<li>ç»“è®º</li>
</ul>
<blockquote>
<p>å¦‚æœåœ¨podé‡ŒæŒ‡å®šäº†<code>nodeName</code>å­—æ®µï¼Œé‚£ä¹ˆå³ä½¿è¯¥podæ²¡æœ‰é…ç½®<code>æ±¡ç‚¹å®¹å¿</code>ï¼Œä¹Ÿä¼šè¢«å¼ºåˆ¶å¼€é€šçš„æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šå»çš„ã€‚</p>
</blockquote>
<p>æµ‹è¯•ç»“æŸã€‚ğŸ˜˜</p>
<h2 id="9ã€ä¼˜å…ˆçº§è°ƒåº¦"><a href="#9ã€ä¼˜å…ˆçº§è°ƒåº¦" class="headerlink" title="9ã€ä¼˜å…ˆçº§è°ƒåº¦"></a>9ã€ä¼˜å…ˆçº§è°ƒåº¦</h2><p>ä¸å‰é¢æ‰€è®²çš„<strong>è°ƒåº¦ä¼˜é€‰ç­–ç•¥ä¸­çš„ä¼˜å…ˆçº§ï¼ˆPrioritiesï¼‰</strong>ä¸åŒï¼Œå‰é¢æ‰€è®²çš„ä¼˜å…ˆçº§æŒ‡çš„æ˜¯èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„ä¼˜å…ˆçº§æŒ‡çš„æ˜¯ <strong>Pod çš„ä¼˜å…ˆçº§</strong>ï¼Œé«˜ä¼˜å…ˆçº§çš„ Pod ä¼šä¼˜å…ˆè¢«è°ƒåº¦ï¼Œæˆ–è€…åœ¨èµ„æºä¸è¶³çš„æƒ…å†µç‰ºç‰²ä½ä¼˜å…ˆçº§çš„ Podï¼Œä»¥ä¾¿äºé‡è¦çš„ Pod èƒ½å¤Ÿå¾—åˆ°èµ„æºéƒ¨ç½²ã€‚</p>
<p>ğŸ‚ è¦å®šä¹‰ Pod ä¼˜å…ˆçº§ï¼Œå°±éœ€è¦å…ˆå®šä¹‰ <code>PriorityClass</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ²¡æœ‰ Namespace çš„é™åˆ¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">high-priority</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">&quot;This priority class should be used for XYZ service pods only.&quot;</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼š</p>
<ul>
<li>value ä¸º 32 ä½æ•´æ•°çš„ä¼˜å…ˆçº§ï¼Œè¯¥å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜</li>
<li>globalDefault ç”¨äºæœªé…ç½® PriorityClassName çš„ Podï¼Œæ•´ä¸ªé›†ç¾¤ä¸­åº”è¯¥åªæœ‰ä¸€ä¸ª <code>PriorityClass</code> å°†å…¶è®¾ç½®ä¸º true</li>
</ul>
<p>ğŸ‚ ç„¶åé€šè¿‡åœ¨ Pod çš„ <code>spec.priorityClassName</code> ä¸­æŒ‡å®šå·²å®šä¹‰çš„ <code>PriorityClass</code> åç§°å³å¯ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">high-priority</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¦å¤–ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ˜¯å½“èŠ‚ç‚¹æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºä¾›è°ƒåº¦å™¨è°ƒåº¦ Podï¼Œå¯¼è‡´ Pod å¤„äº pending æ—¶ï¼Œ<strong>æŠ¢å ï¼ˆpreemptionï¼‰é€»è¾‘å°±ä¼šè¢«è§¦å‘</strong>ï¼ŒæŠ¢å ä¼šå°è¯•ä»ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤ä½ä¼˜å…ˆçº§çš„ Podï¼Œä»è€Œé‡Šæ”¾èµ„æºä½¿é«˜ä¼˜å…ˆçº§çš„ Pod å¾—åˆ°èŠ‚ç‚¹èµ„æºè¿›è¡Œéƒ¨ç½²ã€‚</p>
</blockquote>
<h2 id="10ã€QOS"><a href="#10ã€QOS" class="headerlink" title="10ã€QOS"></a>10ã€QOS</h2><h3 id="1-æœåŠ¡è´¨é‡"><a href="#1-æœåŠ¡è´¨é‡" class="headerlink" title="1.æœåŠ¡è´¨é‡"></a>1.æœåŠ¡è´¨é‡</h3><p><code>QoS</code> æ˜¯ <code>Quality of Service</code> çš„ç¼©å†™ï¼Œå³æœåŠ¡è´¨é‡ï¼Œä¸ºäº†å®ç°èµ„æºè¢«æœ‰æ•ˆè°ƒåº¦å’Œåˆ†é…çš„åŒæ—¶æé«˜èµ„æºåˆ©ç”¨ç‡ï¼ŒKubernetes é’ˆå¯¹ä¸åŒæœåŠ¡è´¨é‡çš„é¢„æœŸï¼Œé€šè¿‡ QoS æ¥å¯¹ pod è¿›è¡ŒæœåŠ¡è´¨é‡ç®¡ç†ã€‚å¯¹äºä¸€ä¸ª pod æ¥è¯´ï¼ŒæœåŠ¡è´¨é‡ä½“ç°åœ¨ä¸¤ä¸ªå…·ä½“çš„æŒ‡æ ‡ï¼šCPU å’Œå†…å­˜ã€‚å½“èŠ‚ç‚¹ä¸Šå†…å­˜èµ„æºç´§å¼ æ—¶ï¼ŒKubernetes ä¼šæ ¹æ®é¢„å…ˆè®¾ç½®çš„ä¸åŒ QoS ç±»åˆ«è¿›è¡Œç›¸åº”å¤„ç†ã€‚</p>
<h3 id="2-èµ„æºé™åˆ¶"><a href="#2-èµ„æºé™åˆ¶" class="headerlink" title="2.èµ„æºé™åˆ¶"></a>2.èµ„æºé™åˆ¶</h3><p>å¦‚æœæœªåšè¿‡èŠ‚ç‚¹ nodeSelectorã€äº²å’Œæ€§ï¼ˆnode affinityï¼‰æˆ– pod äº²å’Œã€åäº²å’Œæ€§ç­‰é«˜çº§è°ƒåº¦ç­–ç•¥è®¾ç½®ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•æŒ‡å®šæœåŠ¡éƒ¨ç½²åˆ°æŒ‡å®šèŠ‚ç‚¹ä¸Šï¼Œè¿™æ ·å°±å¯èƒ½ä¼šé€ æˆ CPU æˆ–å†…å­˜ç­‰<strong>å¯†é›†å‹çš„ pod</strong> åŒæ—¶åˆ†é…åˆ°ç›¸åŒèŠ‚ç‚¹ä¸Šï¼Œ<strong>é€ æˆèµ„æºç«äº‰</strong>ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæœªå¯¹èµ„æºè¿›è¡Œé™åˆ¶ï¼Œä¸€äº›å…³é”®çš„æœåŠ¡å¯èƒ½ä¼šå› ä¸ºèµ„æºç«äº‰å›  <strong>OOM</strong> ç­‰åŸå› è¢« kill æ‰ï¼Œæˆ–è€…è¢«é™åˆ¶ CPU ä½¿ç”¨ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“å¯¹äºæ¯ä¸€ä¸ªèµ„æºï¼Œcontainer å¯ä»¥æŒ‡å®šå…·ä½“çš„èµ„æºéœ€æ±‚ï¼ˆrequestsï¼‰å’Œé™åˆ¶ï¼ˆlimitsï¼‰ï¼Œ<strong>requests ç”³è¯·èŒƒå›´æ˜¯0åˆ°èŠ‚ç‚¹çš„æœ€å¤§é…ç½®ï¼Œè€Œ limits ç”³è¯·èŒƒå›´æ˜¯ requests åˆ°æ— é™</strong>ï¼Œå³ <code>0 &lt;= requests &lt;= Node Allocatable</code>, <code>requests &lt;= limits &lt;= Infinity</code>ã€‚</p>
<p>å¯¹äº CPUï¼Œå¦‚æœ pod ä¸­æœåŠ¡ä½¿ç”¨çš„ CPU è¶…è¿‡è®¾ç½®çš„ limitsï¼Œ<strong>pod ä¸ä¼šè¢« kill æ‰ä½†ä¼šè¢«é™åˆ¶</strong>ï¼Œå› ä¸º CPU æ˜¯å¯å‹ç¼©èµ„æºï¼Œå¦‚æœæ²¡æœ‰è®¾ç½® limitsï¼Œpod å¯ä»¥ä½¿ç”¨å…¨éƒ¨ç©ºé—²çš„ CPU èµ„æºã€‚</p>
<p>å¯¹äºå†…å­˜ï¼Œå½“ä¸€ä¸ª pod ä½¿ç”¨å†…å­˜è¶…è¿‡äº†è®¾ç½®çš„ limitsï¼Œ<strong>pod ä¸­å®¹å™¨çš„è¿›ç¨‹ä¼šè¢« kernel å›  OOM kill æ‰</strong>ï¼Œå½“ container å› ä¸º OOM è¢« kill æ‰æ—¶ï¼Œ<strong>ç³»ç»Ÿå€¾å‘äºåœ¨å…¶åŸæ‰€åœ¨çš„æœºå™¨ä¸Šé‡å¯è¯¥ container æˆ–æœ¬æœºæˆ–å…¶ä»–é‡æ–°åˆ›å»ºä¸€ä¸ª pod</strong>ã€‚(åŒ…æ‹¬æˆ‘ä»¬çš„ç£ç›˜ä¹Ÿæ˜¯ä¸€ä¸ª<code>ä¸å¯å‹ç¼©èµ„æº</code>)</p>
<p>ğŸ‚ å…³é”®æ˜¯ä½ ä½œä¸ºè¿ç»´ï¼Œä½ è¦å¤§æ¦‚æ¸…æ¥šæ¯ä¸ªæœåŠ¡æ¶ˆè€—èµ„æºçš„æƒ…å†µ</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œ<strong>tomcatä¸€èˆ¬æ˜¯æ¯”è¾ƒè€—è´¹èµ„æºçš„ï¼Œèµ·ç éœ€è¦1cä»¥ä¸Š</strong>ï¼›(javaåº”ç”¨ç‰¹åˆ«æ¶ˆè€—cpuèµ„æºã€å†…å­˜èµ„æº)</p>
<p>å¦‚æœä½ çš„podé‡Œçš„requestsé…ç½®ä¸º0.5cï¼Œè€Œlimitså°±é…ç½®ä¸ºäº†0.8cï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä½ çš„å®¹å™¨éƒ½å¯åŠ¨ä¸èµ·æ¥ï¼›</p>
<p><strong>ä¸åƒnginxï¼Œä½ ç»™å®ƒä¸ª100mï¼Œ200mï¼Œå®ƒéƒ½èƒ½èµ·æ¥</strong>ã€‚</p>
<p>ğŸ‚ ä¸»æœºcpuèµ„æºåˆ©ç”¨ç‡æ»¡æ—¶ï¼Œæœºå™¨å‡ºç°çš„ç°è±¡â€“&gt;==å¡é¡¿==ã€‚</p>
<p>é—®é¢˜ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå®¿ä¸»æœºå’Œå®¹å™¨éƒ½æ²¡åšèµ„æºé™åˆ¶çš„è¯ï¼Œå®¹å™¨ç†è®ºä¸Šæ˜¯å¯ä»¥æ— é™åˆ¶è·å–åˆ°ä¸»æœºçš„è®¡ç®—èµ„æº(å¦‚cpuå’Œå†…å­˜)ã€‚å¦‚æœæŸä¸ªå®¹å™¨åº”ç”¨ç‰¹åˆ«è€—cpuï¼Œå½“å®ƒæŠŠä¸»æœºcpuè€—å°½æ—¶(èµ„æºåˆ©ç”¨ç‡è¶…é«˜ï¼Œè¾¾åˆ°98,99%ä»¥ä¸Š)ï¼Œé—®ä¸»æœºä¼šå‡ºç°ä»€ä¹ˆç°è±¡ï¼Ÿ</p>
<p>ç­”ï¼šä¼šå‡ºç°å¡é¡¿ç°è±¡ï¼Œæ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œè€åŠå¤©æ‰å‡ºæ¥ï¼Œåƒè€å¹´ç—´å‘†ä¸€æ ·ï¼›</p>
<p>æ˜¯å› ä¸ºcpuæ˜¯æŒ‰æ—¶é—´ç‰‡æ¥åˆ†é…çš„ï¼Œ<strong>cpuçš„åˆ†é…åŸåˆ™ï¼šä¸ºäº†å°½å¯èƒ½åœ°å…¬å¹³åœ°ç»™å¤§å®¶ä¸€ä¸ªåˆ†é…ï¼Œä½†cpuæ²¡æœ‰ç‰¹åˆ«ç¡¬æ€§çš„é™åˆ¶</strong>ï¼›</p>
<p>ğŸ‚ æ€»ç»“</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1ã€å®¿ä¸»æœºåªæœ‰2cï¼Œè¿™é‡Œçš„limitså¯ä»¥è®¾ç½®ä¸º100cï¼Œä½†æ˜¯æ¯«æ— æ„ä¹‰ï¼Œåªæ˜¯å¯ä»¥è¿™æ ·è®¾ç½®ã€‚limitsæ˜¯æœ€å¤§å¯ç”¨èµ„æºï¼Œä¸€èˆ¬æ˜¯requestsçš„20%å·¦å³ï¼Œä¸å¤ªè¶…å‡ºå¤ªå¤šï¼Œå¦åˆ™limitsé™åˆ¶å°±æ²¡å¤šå°‘æ„ä¹‰äº†;</span><br><span class="line">2ã€limitsä¸èƒ½å°äºrequests;</span><br><span class="line">3ã€reqeustsåªæ˜¯ä¸€ä¸ªé¢„ç•™æ€§è´¨ï¼Œä¸æ˜¯podé…ç½®å†™å¤šå°‘ï¼Œå®¿ä¸»æœºå°±ä¼šå ç”¨å¤šå°‘èµ„æº;</span><br><span class="line">4ã€k8sæ ¹æ®requestæ¥ç»Ÿè®¡æ¯ä¸ªèŠ‚ç‚¹é¢„åˆ†é…èµ„æºï¼Œæ¥åˆ¤æ–­ä¸‹ä¸€ä¸ªpodèƒ½ä¸èƒ½åˆ†é…æˆ‘è¿™ä¸ªèŠ‚ç‚¹;</span><br><span class="line">5ã€æ‰€ä»¥ï¼Œæˆ‘ä»¬å·¥ä½œä¸­ï¼Œä¸€å®šè¦é…ç½®requestså’Œlimitsï¼Œæ¥è§£å†³èµ„æºäº‰æŠ¢é—®é¢˜ï¼›</span><br><span class="line">6ã€limitsä¸é…ç½®çš„è¯ï¼Œé»˜è®¤å’Œrequestsé…ç½®ä¸€æ ·ï¼›</span><br></pre></td></tr></table></figure>

<h3 id="3-QoS-åˆ†ç±»"><a href="#3-QoS-åˆ†ç±»" class="headerlink" title="3.QoS åˆ†ç±»"></a>3.QoS åˆ†ç±»</h3><p><strong>Kubelet æä¾› QoS æœåŠ¡è´¨é‡ç®¡ç†ï¼Œæ”¯æŒç³»ç»Ÿçº§åˆ«çš„ OOM æ§åˆ¶ã€‚</strong>åœ¨ Kubernetes ä¸­ï¼ŒQoS ä¸»è¦åˆ†ä¸º <code>Guaranteed</code>ã€<code>Burstable</code> å’Œ <code>Best-Effort</code> ä¸‰ç±»ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ã€‚</p>
<p>QoS åˆ†ç±»å¹¶ä¸æ˜¯é€šè¿‡ä¸€ä¸ªé…ç½®é¡¹æ¥ç›´æ¥é…ç½®çš„ï¼Œè€Œæ˜¯é€šè¿‡é…ç½® CPU/å†…å­˜çš„ limits ä¸ requests å€¼çš„å¤§å°æ¥ç¡®è®¤æœåŠ¡è´¨é‡ç­‰çº§çš„ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨ <code>kubectl get pod xxx -o yaml</code> å¯ä»¥çœ‹åˆ° pod çš„é…ç½®è¾“å‡ºä¸­æœ‰ <code>qosClass</code> ä¸€é¡¹ï¼Œ<strong>è¯¥é…ç½®çš„ä½œç”¨æ˜¯ä¸ºäº†ç»™èµ„æºè°ƒåº¦æä¾›ç­–ç•¥æ”¯æŒ</strong>ï¼Œè°ƒåº¦ç®—æ³•æ ¹æ®ä¸åŒçš„æœåŠ¡è´¨é‡ç­‰çº§å¯ä»¥ç¡®å®šå°† pod è°ƒåº¦åˆ°å“ªäº›èŠ‚ç‚¹ä¸Šã€‚</p>
<h4 id="1ã€Guaranteed-æœ‰ä¿è¯çš„"><a href="#1ã€Guaranteed-æœ‰ä¿è¯çš„" class="headerlink" title="1ã€Guaranteed(æœ‰ä¿è¯çš„)"></a>1ã€Guaranteed(æœ‰ä¿è¯çš„)</h4><p>ç³»ç»Ÿç”¨å®Œäº†å…¨éƒ¨å†…å­˜ï¼Œä¸”æ²¡æœ‰å…¶ä»–ç±»å‹çš„å®¹å™¨å¯ä»¥è¢« kill æ—¶ï¼Œè¯¥ç±»å‹çš„ pods ä¼šè¢« kill æ‰ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€åæ‰ä¼šè¢«è€ƒè™‘ kill æ‰ï¼Œå±äºè¯¥çº§åˆ«çš„ pod æœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½ä¸”ä»…è®¾ç½®äº† CPU å’Œå†…å­˜çš„ limits</li>
<li>pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½è®¾ç½®äº† CPU å’Œå†…å­˜çš„ requests å’Œ limits ï¼Œä¸”å•ä¸ªå®¹å™¨å†…çš„ <code>requests==limits</code>ï¼ˆrequestsä¸ç­‰äº0ï¼‰</li>
</ul>
<p>1ï¸âƒ£ pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½ä¸”ä»…è®¾ç½®äº† limitsï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">100Mi</span></span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå¦‚æœä¸€ä¸ªå®¹å™¨åªæŒ‡æ˜ limit è€Œæœªè®¾å®š requestsï¼Œ<strong>åˆ™ requests çš„å€¼ç­‰äº limit å€¼</strong>ï¼Œæ‰€ä»¥ä¸Šé¢ pod çš„ QoS çº§åˆ«å±äº Guaranteedã€‚</p>
<blockquote>
<p>:warning: å¦å¤–éœ€è¦æ³¨æ„<strong>è‹¥å®¹å™¨æŒ‡å®šäº† requests è€ŒæœªæŒ‡å®š limitsï¼Œåˆ™ limits çš„å€¼ç­‰äºèŠ‚ç‚¹èµ„æºçš„æœ€å¤§å€¼ï¼›è‹¥å®¹å™¨æŒ‡å®šäº† limits è€ŒæœªæŒ‡å®š requestsï¼Œåˆ™ requests çš„å€¼ç­‰äº limitsã€‚</strong></p>
</blockquote>
<p>2ï¸âƒ£ å¦å¤–ä¸€ä¸ªå°±æ˜¯ pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½æ˜ç¡®è®¾ç½®äº† requests å’Œ limitsï¼Œä¸”å•ä¸ªå®¹å™¨å†…çš„ <code>requests==limits</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">100Mi</span></span><br></pre></td></tr></table></figure>

<p>å®¹å™¨ foo å’Œ bar å†… resources çš„ requests å’Œ limits å‡ç›¸ç­‰ï¼Œè¯¥ pod çš„ QoS çº§åˆ«å±äº Guaranteedã€‚</p>
<p>ğŸ‚ CPUå•ä½æ¢ç®—</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">å®¹å™¨èµ„æºé™åˆ¶ï¼š</span><br><span class="line">â€¢ resources.limits.cpu</span><br><span class="line">â€¢ resources.limits.memory</span><br><span class="line"></span><br><span class="line">å®¹å™¨ä½¿ç”¨çš„æœ€å°èµ„æºéœ€æ±‚ï¼Œä½œä¸ºå®¹å™¨è°ƒåº¦æ—¶èµ„æºåˆ†é…çš„ä¾æ®ï¼š</span><br><span class="line">â€¢ resources.requests.cpu</span><br><span class="line">â€¢ resources.requests.memory</span><br><span class="line"></span><br><span class="line">CPUå•ä½ï¼šå¯ä»¥å†™mä¹Ÿå¯ä»¥å†™æµ®ç‚¹æ•°ï¼Œä¾‹å¦‚0.5=500mï¼Œ1=1000m</span><br><span class="line">CPUå•ä½ï¼šm æ¯«æ ¸ï¼Œ1æ ¸=1000m=1ï¼Œ2æ ¸=2000m=2ï¼Œ0.5æ ¸=500m=0.5ï¼Œ0.2æ ¸=200m=0.2</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span> <span class="comment">#ç‰¹åˆ«æ³¨æ„ï¼šå†…å­˜çš„å•ä½æ˜¯Mi,cpuçš„å•ä½æ˜¯m</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span> </span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line"><span class="comment">#K8sä¼šæ ¹æ®Requestçš„å€¼å»æŸ¥æ‰¾æœ‰è¶³å¤Ÿèµ„æºçš„Nodeæ¥è°ƒåº¦æ­¤Pod</span></span><br></pre></td></tr></table></figure>

<h4 id="2ã€Burstable-ä¸ç¨³å®šçš„"><a href="#2ã€Burstable-ä¸ç¨³å®šçš„" class="headerlink" title="2ã€Burstable(ä¸ç¨³å®šçš„)"></a>2ã€Burstable(ä¸ç¨³å®šçš„)</h4><p>ç³»ç»Ÿç”¨å®Œäº†å…¨éƒ¨å†…å­˜ï¼Œä¸”æ²¡æœ‰ Best-Effort ç±»å‹çš„å®¹å™¨å¯ä»¥è¢« kill æ—¶ï¼Œè¯¥ç±»å‹çš„ pods ä¼šè¢« kill æ‰ã€‚pod ä¸­åªè¦æœ‰ä¸€ä¸ªå®¹å™¨çš„ requests å’Œ limits çš„è®¾ç½®ä¸ç›¸åŒï¼Œè¯¥ pod çš„ QoS å³ä¸º Burstableã€‚</p>
<p>1ï¸âƒ£ æ¯”å¦‚å®¹å™¨ foo æŒ‡å®šäº† resourceï¼Œè€Œå®¹å™¨ bar æœªæŒ‡å®šï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bar</span></span><br></pre></td></tr></table></figure>



<p>2ï¸âƒ£ æˆ–è€…å®¹å™¨ foo è®¾ç½®äº†å†…å­˜ limitsï¼Œè€Œå®¹å™¨ bar è®¾ç½®äº† CPU limitsï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä¸¤ç§æƒ…å†µå®šä¹‰çš„ pod éƒ½å±äº Burstable ç±»åˆ«çš„ QoSã€‚</p>
<h4 id="3ã€Best-Effort-å°½æœ€å¤§åŠªåŠ›"><a href="#3ã€Best-Effort-å°½æœ€å¤§åŠªåŠ›" class="headerlink" title="3ã€Best-Effort(å°½æœ€å¤§åŠªåŠ›)"></a>3ã€Best-Effort(å°½æœ€å¤§åŠªåŠ›)</h4><p>ç³»ç»Ÿç”¨å®Œäº†å…¨éƒ¨å†…å­˜æ—¶ï¼Œè¯¥ç±»å‹ pods ä¼šæœ€å…ˆè¢« kill æ‰ã€‚<strong>å¦‚æœ pod ä¸­æ‰€æœ‰å®¹å™¨çš„ resources å‡æœªè®¾ç½® requests ä¸ limits</strong>ï¼Œé‚£ä¹ˆè¯¥ pod çš„ QoS å³ä¸º Best-Effortã€‚</p>
<p>1ï¸âƒ£ æ¯”å¦‚å®¹å™¨ foo å’Œå®¹å™¨ bar å‡æœªè®¾ç½® requests å’Œ limitsï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">    <span class="attr">resources:</span></span><br></pre></td></tr></table></figure>

<h4 id="èµ„æºé™åˆ¶å¯¹Podè°ƒåº¦çš„å½±å“"><a href="#èµ„æºé™åˆ¶å¯¹Podè°ƒåº¦çš„å½±å“" class="headerlink" title="èµ„æºé™åˆ¶å¯¹Podè°ƒåº¦çš„å½±å“"></a>èµ„æºé™åˆ¶å¯¹Podè°ƒåº¦çš„å½±å“</h4><table><tr><td bgcolor=yellow>ğŸ’˜ å®è·µï¼šresources.requestsæµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.17</td></tr></table>

<ul>
<li>åˆ›å»ºyamlå¹¶ä¿®æ”¹</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#kubectl run pod6 --image=nginx --dry-run=client -o yaml &gt; resources.yaml</span></span><br><span class="line"><span class="string">root@k8s-master</span> <span class="string">~]#vim</span> <span class="string">resources.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">pod6</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod6</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="comment">#æœ€å°èµ„æº</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span></span><br></pre></td></tr></table></figure>



<ul>
<li>éƒ¨ç½²å¹¶æŸ¥çœ‹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment">#kubectl apply  -f resources.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment">#kubectl get pod</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616063348641.png" alt="image-20210616063348641"></p>
<ul>
<li>æ‹·è´åˆšæ‰åˆ›å»ºçš„é‚£ä¸ªyamlæ–‡ä»¶å¹¶ä¿®æ”¹é…ç½®</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#cp resources.yaml resources2.yaml</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#vim resources2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">resource-2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resource-2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">resource-2</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="comment">#æœ€å°èµ„æº</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">1500m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">512m</span> <span class="comment">#è¿™é‡Œçš„å•ä½å†™é”™äº†ï¼Œåº”è¯¥æ˜¯Miæ‰å¯¹çš„ã€‚ã€‚ã€‚</span></span><br></pre></td></tr></table></figure>



<ul>
<li>éƒ¨ç½²å¹¶æŸ¥çœ‹ï¼Œresource-2ä¹Ÿèµ·æ¥äº†ï¼š</li>
</ul>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616063948332.png" alt="image-20210616063948332"></p>
<ul>
<li>å†æ¬¡æ‹·è´åˆšæ‰åˆ›å»ºçš„é‚£ä¸ªyamlæ–‡ä»¶å¹¶ä¿®æ”¹é…ç½®</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment">#cp resources2.yaml resources3.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment">#vim resources3.yaml</span></span><br><span class="line">[root@k8s-master ~]<span class="comment">#kubectl apply -f resources3.yaml</span></span><br><span class="line">pod/resource-3 created</span><br><span class="line">[root@k8s-master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616064233338.png" alt="image-20210616064233338"></p>
<p>éƒ¨ç½²å¹¶æŸ¥çœ‹æ•ˆæœï¼š</p>
<p>æ­¤æ—¶å‘ç°æœ€ååˆ›å»ºçš„é‚£ä¸ªpod ä¸€ç›´æ˜¯pendingçŠ¶æ€ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616064551464.png" alt="image-20210616064551464"></p>
<ul>
<li>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹å®ƒçš„æè¿°ï¼š</li>
</ul>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616064727484.png" alt="image-20210616064727484"></p>
<p>==<strong>æ˜¯å› ä¸ºnodeèŠ‚ç‚¹çš„cpuä¸è¶³ï¼Œå¯¼è‡´podè°ƒåº¦å¤±è´¥çš„</strong>ï¼›==</p>
<p>sufficient adj.å……è¶³çš„ï¼Œè¶³å¤Ÿçš„  insufficient adj.ä¸å……è¶³çš„ï¼Œä¸è¶³å¤Ÿçš„</p>
<ul>
<li>è‡ªå·±æœºå™¨è®¡ç®—é…ç½®å¤§å°ï¼š</li>
</ul>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616072559721.png" alt="image-20210616072559721"></p>
<p>æŸ¥çœ‹å®¿ä¸»æœºçš„èµ„æºä½¿ç”¨ç‡æƒ…å†µï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment">#kubectl describe node  k8s-node1</span></span><br></pre></td></tr></table></figure>

<p>å¯åˆ†é…çš„ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616072242236.png" alt="image-20210616072242236"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616072411357.png" alt="image-20210616072411357"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616073215481.png" alt="image-20210616073215481"></p>
<ul>
<li>æ­¤æ—¶ï¼Œnode1å¯ç”¨cpuå®¹é‡ä¸ºï¼š8%m  node2å¯ç”¨æ€»é‡ä¸ºï¼š63%m </li>
</ul>
<p><strong>è€Œæ­¤æ—¶resource3.yamlé‡Œçš„podéœ€æ±‚ä¸º1900mï¼Œå¾ˆæ˜æ˜¾ä»¥ä¸Š2ä¸ªnodeå‡æ— æ³•æ»¡è¶³å…¶éœ€æ±‚ï¼Œå› æ­¤å’Œè¿™ä¸ªpodå°†æ— æ³•è¢«åˆ†é…ï¼Œä¸€ç›´å¤„äºpendingçŠ¶æ€</strong>ã€‚</p>
<ul>
<li>æ€»ç»“</li>
</ul>
<p><strong>K8sä¼šæ ¹æ®Requestçš„å€¼å»æŸ¥æ‰¾æœ‰è¶³å¤Ÿèµ„æºçš„Nodeæ¥è°ƒåº¦æ­¤Pod</strong>ï¼Œè¿™è¾¹çœ‹çš„å°±æ˜¯è¿™é‡Œçš„å€¼ã€‚</p>
<p><strong>é»˜è®¤ä½ ä¸é…ç½®è¿™ä¸ªrequestsçš„å€¼ï¼Œè¿™é‡Œresuestå€¼å°±æ˜¯0ï¼Œå³è¿™ä¸ªpodå¯ä»¥å®Œå…¨ä½¿ç”¨å®¿ä¸»æœºæ‰€æœ‰çš„cpu èµ„æºï¼Œå„ä¸ªpodå¯èƒ½ä¼šå‡ºç°äº‰æŠ¢cpuç°è±¡</strong>ã€‚</p>
<p>å®éªŒç»“æŸã€‚ğŸ˜˜</p>
<table><tr><td bgcolor=yellow>ğŸ’˜ å®è·µï¼šresources.limitsæµ‹è¯•(æµ‹è¯•æˆåŠŸ)-2022.5.17</td></tr></table>

<ul>
<li>åˆ›å»ºyamlå¹¶ä¿®æ”¹</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#cp resources3.yaml resources4.yaml</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#vim resources4.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">resource-4</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resource-4</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">resource-4</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="comment">#æœ€å°èµ„æº</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="comment">#æœ€å¤§èµ„æºï¼Œä¸€èˆ¬æ˜¯requests 20%å·¦å³</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">600m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">612Mi</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœ€å¤§èµ„æºï¼Œä¸€èˆ¬æ˜¯requests 20%å·¦å³</p>
</blockquote>
<ul>
<li>applyä¸‹å¹¶æŸ¥çœ‹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment">#kubectl apply -f resources4.yaml #è¿™ä¸ªæ˜¯ä¸ä¼šç”¨å½±å“è°ƒåº¦çš„</span></span><br><span class="line">pod/resource-4 created</span><br><span class="line">[root@k8s-master ~]<span class="comment">#kubectl get pod</span></span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod4                  1/1     Running   0          33h</span><br><span class="line">pod6                  1/1     Running   0          81m</span><br><span class="line">resource-2            1/1     Running   0          75m</span><br><span class="line">resource-3            0/1     Pending   0          70m</span><br><span class="line">resource-4            1/1     Running   0          6s <span class="comment">#å·²æˆåŠŸå¯åŠ¨pod</span></span><br><span class="line">web-96d5df5c8-wwc96   1/1     Running   0          41h</span><br><span class="line">[root@k8s-master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>



<ul>
<li>pod çš„æœ€å¤§ä½¿ç”¨ä¸Šçº¿æ˜¯å¯ä»¥æŸ¥çœ‹çš„</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment">#kubectl describe pod resource-4</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20210616075703778.png" alt="image-20210616075703778"></p>
<ul>
<li>æˆ‘ä»¬å†æ¬¡æµ‹è¯•ä¸‹ï¼šæŠŠlimitså¯¹åº”å€¼æ”¹å¤§ï¼Œä¼šä¸ä¼šå½±å“podå¼€é€šï¼Ÿ=&gt;ä¸ä¼šã€‚</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#cp resources4.yaml resources5.yaml</span></span><br><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#vim resources5.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">resource-5</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resource-5</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">resource-5</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="comment">#æœ€å°èµ„æº</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="comment">#æœ€å¤§èµ„æºï¼Œä¸€èˆ¬æ˜¯requests 20%å·¦å³</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">1900m</span> <span class="comment">#æŠŠè¿™ä¸ªæ”¹æˆ1900m,çœ‹ä¼šä¸ä¼šå½±å“å®ƒå¼€é€š</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">612Mi</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment">#kubectl apply -f resources5.yaml</span></span><br><span class="line">pod/resource-5 created</span><br><span class="line">[root@k8s-master ~]<span class="comment">#kubectl get pod</span></span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod4                  1/1     Running   0          33h</span><br><span class="line">pod6                  1/1     Running   0          88m</span><br><span class="line">resource-2            1/1     Running   0          81m</span><br><span class="line">resource-3            0/1     Pending   0          77m</span><br><span class="line">resource-4            1/1     Running   0          6m45s</span><br><span class="line">resource-5            1/1     Running   0          6s <span class="comment">#å¯æ­£å¸¸</span></span><br><span class="line">web-96d5df5c8-wwc96   1/1     Running   0          41h</span><br><span class="line">[root@k8s-master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>æ˜¯ä¸ä¼šå—å½±å“çš„ï¼Œå°±å¯ä»¥æ­£å¸¸å¼€é€šã€‚</p>
<ul>
<li>å› æ­¤ï¼Œæœ€ç»ˆyamlæ–‡ä»¶æ ‡å‡†è¾“å‡ºï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@k8s-master</span> <span class="string">~</span>]<span class="comment">#vim resources5.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">resource-5</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resource-5</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">resource-5</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="comment">#æœ€å°èµ„æº</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="comment">#æœ€å¤§èµ„æºï¼Œä¸€èˆ¬æ˜¯requests 20%å·¦å³</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">600m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">612Mi</span></span><br></pre></td></tr></table></figure>

<p>å®éªŒç»“æŸã€‚ğŸ˜˜</p>
<h3 id="4-QoS-è§£æ"><a href="#4-QoS-è§£æ" class="headerlink" title="4.QoS è§£æ"></a>4.QoS è§£æ</h3><p><strong>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®åœ¨è°ƒåº¦æ—¶è°ƒåº¦å™¨åªä¼šæ ¹æ® requests å€¼è¿›è¡Œè°ƒåº¦ã€‚</strong>å½“ç³»ç»Ÿ OOM ä¸Šæ—¶å¯¹äºå¤„ç†ä¸åŒ OOMScore çš„è¿›ç¨‹è¡¨ç°ä¸åŒï¼Œ<strong>OOMScore</strong> æ˜¯é’ˆå¯¹ memory çš„ï¼Œ<strong>å½“å®¿ä¸»ä¸Š memory ä¸è¶³æ—¶ç³»ç»Ÿä¼šä¼˜å…ˆ kill æ‰ OOMScore å€¼é«˜çš„è¿›ç¨‹</strong>ï¼Œå¯ä»¥ä½¿ç”¨ <code>cat /proc/$PID/oom_score</code> å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹çš„ OOMScoreã€‚OOMScore çš„å–å€¼èŒƒå›´ä¸º <code>[-1000, 1000]</code>ï¼ŒGuaranteed ç±»å‹çš„ pod çš„é»˜è®¤å€¼ä¸º -998ï¼ŒBurstable pod çš„å€¼ä¸º <code>2~999</code>ï¼ŒBestEffort pod çš„å€¼ä¸º 1000ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç³»ç»Ÿ OOM æ—¶ï¼Œé¦–å…ˆä¼š kill æ‰ BestEffort pod çš„è¿›ç¨‹ï¼Œè‹¥ç³»ç»Ÿä¾ç„¶å¤„äº OOM çŠ¶æ€ï¼Œç„¶åæ‰ä¼š kill æ‰ Burstable podï¼Œæœ€åæ˜¯ Guaranteed podã€‚</p>
<p>Kubernetes æ˜¯é€šè¿‡ cgroup ç»™ pod è®¾ç½® QoS çº§åˆ«çš„ï¼Œkubelet ä¸­æœ‰ä¸€ä¸ª <code>--cgroups-per-qos</code> å‚æ•°ï¼ˆé»˜è®¤å¯ç”¨ï¼‰ï¼Œå¯ç”¨å kubelet ä¼šä¸ºä¸åŒ QoS åˆ›å»ºå¯¹åº”çš„ level cgroupsï¼Œåœ¨ Qos level cgroups ä¸‹ä¹Ÿä¼šä¸º pod ä¸‹çš„å®¹å™¨åˆ›å»ºå¯¹åº”çš„ level cgroupsï¼Œä» <code>Qos â€“&gt; pod â€“&gt; container</code>ï¼Œå±‚å±‚é™åˆ¶æ¯ä¸ª level cgroups çš„èµ„æºä½¿ç”¨é‡ã€‚</p>
<p>ç”±äºæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ containerd è¿™ç§å®¹å™¨è¿è¡Œæ—¶ï¼Œåˆ™ cgroup çš„è·¯å¾„ä¸ä¹‹å‰çš„ docker ä¸å¤ªä¸€æ ·ï¼š</p>
<ul>
<li>Guaranteed ç±»å‹çš„ cgroup level ä¼šç›´æ¥åˆ›å»ºåœ¨ <code>RootCgroup/system.slice/containerd.service/kubepods-pod&lt;uid&gt;.slice:cri-containerd:&lt;container-id&gt;</code> ä¸‹</li>
<li>Burstable çš„åˆ›å»ºåœ¨ <code>RootCgroup/system.slice/containerd.service/kubepods-burstable-pod&lt;uid&gt;.slice:cri-containerd:&lt;container-id&gt;</code> ä¸‹</li>
<li>BestEffort ç±»å‹çš„åˆ›å»ºåœ¨ <code>RootCgroup/system.slice/containerd.service/kubepods-besteffort-pod&lt;uid&gt;.slice:cri-containerd:&lt;container-id&gt;</code> ä¸‹</li>
</ul>
<p>:warning: è¿™é‡Œçš„è·¯å¾„å’Œåº•å±‚å®¹å™¨è¿è¡Œæ—¶åŠæ˜¯ä½¿ç”¨<code>systemd</code>è¿˜æ˜¯<code>cgroupfs</code>éƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šæˆ‘ä¸‹é¢çš„å®éªŒè·¯å¾„å’Œè€å¸ˆçš„æ˜¯æœ‰å‡ºå…¥æ¥ç€ï¼Œä½†æ˜¯æ€»ä½“é—®é¢˜ä¸å¤§ï¼›<br>ä¸€ä¸ªpauseå®¹å™¨+ä¸»å®¹å™¨ï¼›</p>
</blockquote>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220220102223206.png" alt="image-20220220102223206"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220220152022806.png" alt="image-20220220152022806"></p>
<table><tr><td bgcolor=yellow>ğŸ’˜ å®è·µï¼šQosè§£æ(æµ‹è¯•æˆåŠŸ)-2022.5.17</td></tr></table>

<ul>
<li>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>mount | grep cgroup</code> å‘½ä»¤æŸ¥çœ‹ RootCgroupï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ mount | grep cgroup</span><br><span class="line">tmpfs on /sys/fs/cgroup <span class="built_in">type</span> tmpfs (ro,nosuid,nodev,noexec,mode=755)</span><br><span class="line">cgroup on /sys/fs/cgroup/systemd <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd)</span><br><span class="line">cgroup on /sys/fs/cgroup/blkio <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,blkio)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu,cpuacct <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct,cpu)</span><br><span class="line">cgroup on /sys/fs/cgroup/memory <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,memory)</span><br><span class="line">cgroup on /sys/fs/cgroup/perf_event <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">cgroup on /sys/fs/cgroup/devices <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">cgroup on /sys/fs/cgroup/pids <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br><span class="line">cgroup on /sys/fs/cgroup/hugetlb <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">cgroup on /sys/fs/cgroup/net_cls,net_prio <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,net_prio,net_cls)</span><br><span class="line">cgroup on /sys/fs/cgroup/freezer <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,freezer)</span><br></pre></td></tr></table></figure>



<p>åœ¨ cgroup çš„æ¯ä¸ªå­ç³»ç»Ÿä¸‹éƒ½ä¼šåˆ›å»º QoS level cgroupsï¼Œ æ­¤å¤–åœ¨å¯¹åº”çš„ QoS level cgroups è¿˜ä¼šä¸º pod åˆ›å»º Pod level cgroupsã€‚</p>
<ul>
<li>æ¯”å¦‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ Podï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 01-qos-demo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">qos-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">2Gi</span></span><br></pre></td></tr></table></figure>

<p>ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå¯¹è±¡å³å¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f 01-qos-demo.yaml </span><br><span class="line">pod/qos-demo created</span><br><span class="line">$ kubectl get po qos-demo -owide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">qos-demo   1/1     Running   0          27s   10.244.1.241   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">$ kubectl get po qos-demo -owide -oyaml|grep qosClass</span><br><span class="line">  qosClass: Burstable</span><br><span class="line">$ kubectl get po qos-demo -owide -oyaml|grep uid</span><br><span class="line">  uid: 562d098f-8346-4e8f-b23d-9d8c24b75b6a</span><br></pre></td></tr></table></figure>

<p>ç”±äºè¯¥ pod çš„è®¾ç½®çš„èµ„æº requests != limitsï¼Œæ‰€ä»¥å…¶å±äº Burstable ç±»åˆ«çš„ podã€‚</p>
<p>kubelet ä¼šåœ¨å…¶æ‰€å± QoS ä¸‹åˆ›å»º <code>RootCgroup/system.slice/containerd.service/kubepods-burstable-pod&lt;uid&gt;.slice:cri-containerd:&lt;container-id&gt;</code> è¿™ä¸ª cgroup levelï¼Œæ¯”å¦‚æˆ‘ä»¬æŸ¥çœ‹å†…å­˜è¿™ä¸ªå­ç³»ç»Ÿçš„ cgroupï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿˜æœ‰ä¸€ä¸ª pause å®¹å™¨çš„ cgroup level</span></span><br><span class="line">âœ ls /sys/fs/cgroup/memory/system.slice/containerd.service/kubepods-burstable-pod489a19f2_8d75_474c_988f_5854b61b839f.slice:cri-containerd:4782243ba3260125513af20689fcea31b52eae1cbabeafeb1f7a52bcdcd5b44b</span><br><span class="line">cgroup.clone_children           memory.kmem.tcp.max_usage_in_bytes  memory.oom_control</span><br><span class="line">cgroup.event_control            memory.kmem.tcp.usage_in_bytes      memory.pressure_level</span><br><span class="line">cgroup.procs                    memory.kmem.usage_in_bytes          memory.soft_limit_in_bytes</span><br><span class="line">memory.failcnt                  memory.limit_in_bytes               memory.stat</span><br><span class="line">memory.force_empty              memory.max_usage_in_bytes           memory.swappiness</span><br><span class="line">memory.kmem.failcnt             memory.memsw.failcnt                memory.usage_in_bytes</span><br><span class="line">memory.kmem.limit_in_bytes      memory.memsw.limit_in_bytes         memory.use_hierarchy</span><br><span class="line">memory.kmem.max_usage_in_bytes  memory.memsw.max_usage_in_bytes     notify_on_release</span><br><span class="line">memory.kmem.slabinfo            memory.memsw.usage_in_bytes         tasks</span><br><span class="line">memory.kmem.tcp.failcnt         memory.move_charge_at_immigrate</span><br><span class="line">memory.kmem.tcp.limit_in_bytes  memory.numa_stat</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢åˆ›å»ºçš„åº”ç”¨å®¹å™¨è¿›ç¨‹ ID ä¼šè¢«å†™å…¥åˆ°ä¸Šé¢çš„ tasks æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">âœ cat tasks</span><br><span class="line">64133</span><br><span class="line">64170</span><br><span class="line">64171</span><br><span class="line">64172</span><br><span class="line">64173</span><br><span class="line">âœ ps -aux |grep nginx</span><br><span class="line">root      64133  0.0  0.0   8840  3488 ?        Ss   15:56   0:00 nginx: master process nginx -g daemon off;</span><br><span class="line">101       64170  0.0  0.0   9228  1532 ?        S    15:56   0:00 nginx: worker process</span><br><span class="line">101       64171  0.0  0.0   9228  1532 ?        S    15:56   0:00 nginx: worker process</span><br><span class="line">101       64172  0.0  0.0   9228  1532 ?        S    15:56   0:00 nginx: worker process</span><br><span class="line">101       64173  0.0  0.0   9228  1532 ?        S    15:56   0:00 nginx: worker process</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬çš„å®¹å™¨è¿›ç¨‹å°±ä¼šå—åˆ°è¯¥ cgroup çš„é™åˆ¶äº†ï¼Œåœ¨ pod çš„èµ„æºæ¸…å•ä¸­æˆ‘ä»¬è®¾ç½®äº† memory çš„ limits å€¼ä¸º 2Giï¼Œkubelet åˆ™ä¼šå°†è¯¥é™åˆ¶å€¼å†™å…¥åˆ° <code>memory.limit_in_bytes</code> ä¸­å»ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ cat memory.limit_in_bytes</span><br><span class="line">2147483648 <span class="comment"># 2147483648 / 1024 / 1024 / 1024 = 2</span></span><br></pre></td></tr></table></figure>



<ul>
<li>åŒæ ·å¯¹äº cpu èµ„æºä¸€æ ·å¯ä»¥åœ¨å¯¹åº”çš„å­ç³»ç»Ÿä¸­æ‰¾åˆ°åˆ›å»ºçš„å¯¹åº” cgroupï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">âœ ls /sys/fs/cgroup/cpu/system.slice/containerd.service/kubepods-burstable-pod489a19f2_8d75_474c_988f_5854b61b839f.slice:cri-containerd:4782243ba3260125513af20689fcea31b52eae1cbabeafeb1f7a52bcdcd5b44b</span><br><span class="line">cgroup.clone_children  cpuacct.stat          cpu.cfs_period_us  cpu.rt_runtime_us  notify_on_release</span><br><span class="line">cgroup.event_control   cpuacct.usage         cpu.cfs_quota_us   cpu.shares         tasks</span><br><span class="line">cgroup.procs           cpuacct.usage_percpu  cpu.rt_period_us   cpu.stat</span><br><span class="line">âœ cat tasks</span><br><span class="line">64133</span><br><span class="line">64170</span><br><span class="line">64171</span><br><span class="line">64172</span><br><span class="line">64173</span><br><span class="line">âœ cat cpu.cfs_quota_us</span><br><span class="line">50000  <span class="comment"># 500m</span></span><br></pre></td></tr></table></figure>



<p>:warning: æœ€åå…³äº QoS è¿˜æœ‰ä¸€ç‚¹å»ºè®®:</p>
<blockquote>
<p>å¦‚æœèµ„æºå……è¶³ï¼Œå¯å°† QoS pods ç±»å‹å‡è®¾ç½®ä¸º Guaranteedã€‚<strong>ç”¨è®¡ç®—èµ„æºæ¢ä¸šåŠ¡æ€§èƒ½å’Œç¨³å®šæ€§</strong>ï¼Œå‡å°‘æ’æŸ¥é—®é¢˜æ—¶é—´å’Œæˆæœ¬ã€‚</p>
<p>å¦‚æœæƒ³æ›´å¥½çš„æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œä¸šåŠ¡æœåŠ¡å¯ä»¥è®¾ç½®ä¸º Guaranteedï¼Œè€Œå…¶ä»–æœåŠ¡æ ¹æ®é‡è¦ç¨‹åº¦å¯åˆ†åˆ«è®¾ç½®ä¸º Burstable æˆ– Best-Effortã€‚</p>
</blockquote>
<p>å®éªŒç»“æŸã€‚ğŸ˜˜</p>
<h2 id="11ã€æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ"><a href="#11ã€æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ" class="headerlink" title="11ã€æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ"></a>11ã€æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ</h2><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220218152232851.png" alt="image-20220218152232851"></p>
<h3 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1.æ¦‚å¿µ"></a>1.æ¦‚å¿µ</h3><blockquote>
<p>:warning:<br>è¿™ä¸ªç†è§£èµ·æ¥ç¨å¾®æœ‰äº›å¤æ‚ï¼›<br>è¿™ä¸ªå¯èƒ½ç”¨çš„ä¸å¤šï¼Œä½†å¦‚æœä½ æƒ³è¿›è¡Œä¸€äº›ç»†ç²’åº¦çš„æ§åˆ¶çš„è¯ï¼Œç”¨è¿™ä¸ªè¿˜æ˜¯å¾ˆä¸é”™çš„ï¼›</p>
</blockquote>
<p>åœ¨ k8s é›†ç¾¤è°ƒåº¦ä¸­ï¼Œ<strong>äº²å’Œæ€§</strong>ç›¸å…³çš„æ¦‚å¿µæœ¬è´¨ä¸Šéƒ½æ˜¯æ§åˆ¶ Pod å¦‚ä½•è¢«è°ƒåº¦ â€“ <strong>å †å æˆ–æ‰“æ•£</strong>ã€‚</p>
<p><code>podAffinity</code> ä»¥åŠ <code>podAntiAffinity</code> ä¸¤ä¸ªç‰¹æ€§å¯¹ Pod åœ¨ä¸åŒæ‹“æ‰‘åŸŸçš„åˆ†å¸ƒè¿›è¡Œäº†ä¸€äº›æ§åˆ¶ã€‚</p>
<p><code>podAffinity</code> å¯ä»¥å°†æ— æ•°ä¸ª Pod è°ƒåº¦åˆ°ç‰¹å®šçš„æŸä¸€ä¸ªæ‹“æ‰‘åŸŸï¼Œè¿™æ˜¯<strong>å †å </strong>çš„ä½“ç°ï¼›</p>
<p><code>podAntiAffinity</code> åˆ™å¯ä»¥æ§åˆ¶ä¸€ä¸ªæ‹“æ‰‘åŸŸåªå­˜åœ¨ä¸€ä¸ª Podï¼Œè¿™æ˜¯<strong>æ‰“æ•£</strong>çš„ä½“ç°ï¼›</p>
<p>ä½†è¿™ä¸¤ç§æƒ…å†µéƒ½å¤ªæç«¯äº†ï¼Œåœ¨ä¸å°‘åœºæ™¯ä¸‹éƒ½æ— æ³•è¾¾åˆ°ç†æƒ³çš„æ•ˆæœï¼Œ<strong>ä¾‹å¦‚ä¸ºäº†å®ç°å®¹ç¾å’Œé«˜å¯ç”¨ï¼Œå°†ä¸šåŠ¡ Pod å°½å¯èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨ä¸åŒå¯ç”¨åŒºå°±å¾ˆéš¾å®ç°ã€‚</strong></p>
<p><code>PodTopologySpreadï¼ˆPod æ‹“æ‰‘åˆ†å¸ƒçº¦æŸï¼‰</code> ç‰¹æ€§çš„æå‡ºæ­£æ˜¯ä¸ºäº†å¯¹ Pod çš„è°ƒåº¦åˆ†å¸ƒæä¾›æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œä»¥æé«˜æœåŠ¡å¯ç”¨æ€§ä»¥åŠèµ„æºåˆ©ç”¨ç‡ã€‚<code>PodTopologySpread</code> ç”± <code>EvenPodsSpread</code> <strong>ç‰¹æ€§é—¨</strong>æ‰€æ§åˆ¶ï¼Œåœ¨ v1.16 ç‰ˆæœ¬ç¬¬ä¸€æ¬¡å‘å¸ƒï¼Œå¹¶åœ¨ v1.18 ç‰ˆæœ¬è¿›å…¥ beta é˜¶æ®µé»˜è®¤å¯ç”¨ã€‚</p>
<h3 id="2-ä½¿ç”¨è§„èŒƒ"><a href="#2-ä½¿ç”¨è§„èŒƒ" class="headerlink" title="2.ä½¿ç”¨è§„èŒƒ"></a>2.ä½¿ç”¨è§„èŒƒ</h3><p>åœ¨ Pod çš„ Spec è§„èŒƒä¸­æ–°å¢äº†ä¸€ä¸ª <code>topologySpreadConstraints</code> å­—æ®µå³å¯é…ç½®æ‹“æ‰‘åˆ†å¸ƒçº¦æŸï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="string">&lt;integer&gt;</span> <span class="comment">#è¿™ä¸ªå±æ€§ç†è§£èµ·æ¥ä¸æ˜¯é‚£ä¹ˆåœ°ç›´æ¥ã€‚ã€‚ã€‚ï¼›å€¾æ–œåº¦ï¼›</span></span><br><span class="line">    <span class="attr">topologyKey:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">whenUnsatisfiable:</span> <span class="string">&lt;string&gt;</span></span><br><span class="line">    <span class="attr">labelSelector:</span> <span class="string">&lt;object&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç”±äºè¿™ä¸ªæ–°å¢çš„å­—æ®µæ˜¯åœ¨ Pod spec å±‚é¢æ·»åŠ ï¼Œå› æ­¤æ›´é«˜å±‚çº§çš„æ§åˆ¶ (Deploymentã€DaemonSetã€StatefulSet) ä¹Ÿèƒ½ä½¿ç”¨ <code>PodTopologySpread</code> åŠŸèƒ½ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20210325152221.png" alt="Podæ‹“æ‰‘åˆ†å¸ƒçº¦æŸ"></p>
<p>è®©æˆ‘ä»¬ç»“åˆä¸Šå›¾æ¥ç†è§£ <code>topologySpreadConstraints</code> ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰å’Œä½œç”¨ï¼š</p>
<ul>
<li><code>labelSelector</code>: ç”¨æ¥æŸ¥æ‰¾åŒ¹é…çš„ Podï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®¡ç®—å‡ºæ¯ä¸ªæ‹“æ‰‘åŸŸä¸­åŒ¹é…è¯¥ label selector çš„ Pod æ•°é‡ï¼Œåœ¨ä¸Šå›¾ä¸­ï¼Œå‡å¦‚ label selector æ˜¯ <code>app:foo</code>ï¼Œé‚£ä¹ˆ zone1 çš„åŒ¹é…ä¸ªæ•°ä¸º 2ï¼Œ zone2 çš„åŒ¹é…ä¸ªæ•°ä¸º 0ã€‚</li>
<li><code>topologyKey</code>: æ˜¯ Node label çš„ keyï¼Œå¦‚æœä¸¤ä¸ª Node çš„ label åŒæ—¶å…·æœ‰è¯¥ key å¹¶ä¸”å€¼ç›¸åŒï¼Œå°±è¯´å®ƒä»¬åœ¨åŒä¸€ä¸ªæ‹“æ‰‘åŸŸã€‚åœ¨ä¸Šå›¾ä¸­ï¼ŒæŒ‡å®š <code>topologyKey</code> ä¸º zoneï¼Œ åˆ™å…·æœ‰ <code>zone=zone1</code> æ ‡ç­¾çš„ Node è¢«åˆ†åœ¨ä¸€ä¸ªæ‹“æ‰‘åŸŸï¼Œå…·æœ‰ <code>zone=zone2</code> æ ‡ç­¾çš„ Node è¢«åˆ†åœ¨å¦ä¸€ä¸ªæ‹“æ‰‘åŸŸã€‚</li>
<li>:warning: <code>maxSkew</code>: è¿™ä¸ªå±æ€§ç†è§£èµ·æ¥ä¸æ˜¯å¾ˆç›´æ¥ï¼Œ<strong>å®ƒæè¿°äº† Podåœ¨ä¸åŒæ‹“æ‰‘åŸŸä¸­ä¸å‡åŒ€åˆ†å¸ƒçš„æœ€å¤§ç¨‹åº¦</strong>ï¼ˆæŒ‡å®šæ‹“æ‰‘ç±»å‹ä¸­ä»»æ„ä¸¤ä¸ªæ‹“æ‰‘åŸŸä¸­åŒ¹é…çš„ Pod ä¹‹é—´çš„æœ€å¤§å…è®¸å·®å€¼ï¼‰ï¼Œ<strong>å®ƒå¿…é¡»å¤§äºé›¶</strong>ã€‚<strong>æ¯ä¸ªæ‹“æ‰‘åŸŸéƒ½æœ‰ä¸€ä¸ª skew å€¼</strong>ï¼Œè®¡ç®—çš„å…¬å¼æ˜¯:<code>skew[i] = æ‹“æ‰‘åŸŸ[i]ä¸­åŒ¹é…çš„ Pod ä¸ªæ•° - min&#123;å…¶ä»–æ‹“æ‰‘åŸŸä¸­åŒ¹é…çš„ Pod ä¸ªæ•°&#125;</code>ã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªå¸¦æœ‰<code>app=foo</code>æ ‡ç­¾çš„ Podï¼š<ul>
<li>å¦‚æœè¯¥ Pod è¢«è°ƒåº¦åˆ° zone1ï¼Œé‚£ä¹ˆ zone1 ä¸­ Node çš„ skew å€¼å˜ä¸º 3ï¼Œzone2 ä¸­ Node çš„ skew å€¼å˜ä¸º 0 (zone1 æœ‰ 3 ä¸ªåŒ¹é…çš„ Podï¼Œzone2 æœ‰ 0 ä¸ªåŒ¹é…çš„ Pod )</li>
<li>å¦‚æœè¯¥ Pod è¢«è°ƒåº¦åˆ° zone2ï¼Œé‚£ä¹ˆ zone1 ä¸­ Node çš„ skew å€¼å˜ä¸º 2ï¼Œzone2 ä¸­ Node çš„ skew å€¼å˜ä¸º 1(zone2 æœ‰ 1 ä¸ªåŒ¹é…çš„ Podï¼Œæ‹¥æœ‰å…¨å±€æœ€å°åŒ¹é… Pod æ•°çš„æ‹“æ‰‘åŸŸæ­£æ˜¯ zone2 è‡ªå·± )ï¼Œåˆ™å®ƒæ»¡è¶³<code>maxSkew: 1</code> çš„çº¦æŸï¼ˆå·®å€¼ä¸º1ï¼‰</li>
</ul>
</li>
<li><code>whenUnsatisfiable</code>: æè¿°äº†å¦‚æœ Pod ä¸æ»¡è¶³åˆ†å¸ƒçº¦æŸæ¡ä»¶è¯¥é‡‡å–ä½•ç§ç­–ç•¥ï¼š<ul>
<li><strong>DoNotSchedule</strong> (é»˜è®¤) å‘Šè¯‰è°ƒåº¦å™¨ä¸è¦è°ƒåº¦è¯¥ Podï¼Œå› æ­¤ä¹Ÿå¯ä»¥å«ä½œ<strong>ç¡¬ç­–ç•¥</strong>ï¼›</li>
<li><strong>ScheduleAnyway</strong> å‘Šè¯‰è°ƒåº¦å™¨æ ¹æ®æ¯ä¸ª Node çš„ skew å€¼æ‰“åˆ†æ’åºåä»ç„¶è°ƒåº¦ï¼Œå› æ­¤ä¹Ÿå¯ä»¥å«ä½œ<strong>è½¯ç­–ç•¥</strong>ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-å•ä¸ªæ‹“æ‰‘çº¦æŸ"><a href="#3-å•ä¸ªæ‹“æ‰‘çº¦æŸ" class="headerlink" title="3.å•ä¸ªæ‹“æ‰‘çº¦æŸ"></a>3.å•ä¸ªæ‹“æ‰‘çº¦æŸ</h3><p>å‡è®¾ä½ æ‹¥æœ‰ä¸€ä¸ª 4 èŠ‚ç‚¹é›†ç¾¤ï¼Œå…¶ä¸­æ ‡è®°ä¸º <code>foo:bar</code> çš„ 3 ä¸ª Pod åˆ†åˆ«ä½äº node1ã€node2 å’Œ node3 ä¸­ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20210325153609.png" alt="å•ä¸ª TopologySpreadConstraint"></p>
<p>å¦‚æœå¸Œæœ›æ–°æ¥çš„ Pod å‡åŒ€åˆ†å¸ƒåœ¨ç°æœ‰çš„å¯ç”¨åŒºåŸŸï¼Œåˆ™å¯ä»¥æŒ‰å¦‚ä¸‹è®¾ç½®å…¶çº¦æŸï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">topologyKey:</span> <span class="string">zone</span></span><br><span class="line">    <span class="attr">whenUnsatisfiable:</span> <span class="string">DoNotSchedule</span></span><br><span class="line">    <span class="attr">labelSelector:</span></span><br><span class="line">      <span class="attr">matchLabels:</span></span><br><span class="line">        <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pause</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/pause:3.1</span></span><br></pre></td></tr></table></figure>

<p><code>topologyKey: zone</code> æ„å‘³ç€å‡åŒ€åˆ†å¸ƒå°†åªåº”ç”¨äºå­˜åœ¨æ ‡ç­¾é”®å€¼å¯¹ä¸º <code>zone:&lt;any value&gt;</code> çš„èŠ‚ç‚¹ã€‚ <code>whenUnsatisfiable: DoNotSchedule</code> å‘Šè¯‰è°ƒåº¦å™¨å¦‚æœæ–°çš„ Pod ä¸æ»¡è¶³çº¦æŸï¼Œåˆ™ä¸å¯è°ƒåº¦ã€‚å¦‚æœè°ƒåº¦å™¨å°†æ–°çš„ Pod æ”¾å…¥ â€œzoneAâ€ï¼ŒPods åˆ†å¸ƒå°†å˜ä¸º <code>[3, 1]</code>ï¼Œå› æ­¤å®é™…çš„åå·®ä¸º <code>2(3 - 1)</code>ï¼Œè¿™è¿åäº† <code>maxSkew: 1</code> çš„çº¦å®šã€‚æ­¤ç¤ºä¾‹ä¸­ï¼Œæ–° Pod åªèƒ½æ”¾ç½®åœ¨ â€œzoneBâ€ ä¸Šï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20210325153809.png" alt="zoneB"></p>
<p>æˆ–è€…</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20210325153830.png" alt="zoneB"></p>
<p>ä½ å¯ä»¥è°ƒæ•´ Pod çº¦æŸä»¥æ»¡è¶³å„ç§è¦æ±‚ï¼š</p>
<ul>
<li>å°† <code>maxSkew</code> æ›´æ”¹ä¸ºæ›´å¤§çš„å€¼ï¼Œæ¯”å¦‚ â€œ2â€ï¼Œè¿™æ ·æ–°çš„ Pod ä¹Ÿå¯ä»¥æ”¾åœ¨ â€œzoneAâ€ ä¸Šã€‚</li>
<li>å°† <code>topologyKey</code> æ›´æ”¹ä¸º â€œnodeâ€ï¼Œä»¥ä¾¿å°† Pod å‡åŒ€åˆ†å¸ƒåœ¨èŠ‚ç‚¹ä¸Šè€Œä¸æ˜¯åŒºåŸŸä¸­ã€‚ åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœ <code>maxSkew</code> ä¿æŒä¸º â€œ1â€ï¼Œé‚£ä¹ˆä¼ å…¥çš„ Pod åªèƒ½æ”¾åœ¨ â€œnode4â€ ä¸Šã€‚</li>
<li>å°† <code>whenUnsatisfiable: DoNotSchedule</code> æ›´æ”¹ä¸º <code>whenUnsatisfiable: ScheduleAnyway</code>ï¼Œ ä»¥ç¡®ä¿æ–°çš„ Pod å¯ä»¥è¢«è°ƒåº¦ã€‚</li>
</ul>
<h3 id="4-å¤šä¸ªæ‹“æ‰‘çº¦æŸ"><a href="#4-å¤šä¸ªæ‹“æ‰‘çº¦æŸ" class="headerlink" title="4.å¤šä¸ªæ‹“æ‰‘çº¦æŸ"></a>4.å¤šä¸ªæ‹“æ‰‘çº¦æŸ</h3><p>ä¸Šé¢æ˜¯å•ä¸ª Pod æ‹“æ‰‘åˆ†å¸ƒçº¦æŸçš„æƒ…å†µï¼Œä¸‹é¢çš„ä¾‹å­å»ºç«‹åœ¨å‰é¢ä¾‹å­çš„åŸºç¡€ä¸Šæ¥å¯¹å¤šä¸ª Pod æ‹“æ‰‘åˆ†å¸ƒçº¦æŸè¿›è¡Œè¯´æ˜ã€‚å‡è®¾ä½ æ‹¥æœ‰ä¸€ä¸ª 4 èŠ‚ç‚¹é›†ç¾¤ï¼Œå…¶ä¸­ 3 ä¸ªæ ‡è®°ä¸º <code>foo:bar</code> çš„ Pod åˆ†åˆ«ä½äº node1ã€node2 å’Œ node3 ä¸Šï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20210325154130.png" alt="å¤šä¸ª TopologySpreadConstraint"></p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ 2 ä¸ª <code>TopologySpreadConstraint</code> æ¥æ§åˆ¶ Pod åœ¨åŒºåŸŸå’ŒèŠ‚ç‚¹ä¸¤ä¸ªç»´åº¦ä¸Šçš„åˆ†å¸ƒï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># two-constraints.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">topologyKey:</span> <span class="string">zone</span></span><br><span class="line">    <span class="attr">whenUnsatisfiable:</span> <span class="string">DoNotSchedule</span></span><br><span class="line">    <span class="attr">labelSelector:</span></span><br><span class="line">      <span class="attr">matchLabels:</span></span><br><span class="line">        <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">topologyKey:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">whenUnsatisfiable:</span> <span class="string">DoNotSchedule</span></span><br><span class="line">    <span class="attr">labelSelector:</span></span><br><span class="line">      <span class="attr">matchLabels:</span></span><br><span class="line">        <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pause</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">k8s.gcr.io/pause:3.1</span></span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºäº†åŒ¹é…ç¬¬ä¸€ä¸ªçº¦æŸï¼Œæ–°çš„ Pod åªèƒ½æ”¾ç½®åœ¨ â€œzoneBâ€ ä¸­ï¼›è€Œåœ¨ç¬¬äºŒä¸ªçº¦æŸä¸­ï¼Œ æ–°çš„ Pod åªèƒ½æ”¾ç½®åœ¨ â€œnode4â€ ä¸Šï¼Œæœ€åä¸¤ä¸ªçº¦æŸçš„ç»“æœåŠ åœ¨ä¸€èµ·ï¼Œå”¯ä¸€å¯è¡Œçš„é€‰æ‹©æ˜¯æ”¾ç½® åœ¨ â€œnode4â€ ä¸Šã€‚</p>
<p>ğŸ‚ <strong>å¤šä¸ªçº¦æŸä¹‹é—´æ˜¯å¯èƒ½å­˜åœ¨å†²çªçš„</strong>ï¼Œå‡è®¾æœ‰ä¸€ä¸ªè·¨è¶Š 2 ä¸ªåŒºåŸŸçš„ 3 èŠ‚ç‚¹é›†ç¾¤ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20210325154257.png" alt="å†²çª"></p>
<p>å¦‚æœå¯¹é›†ç¾¤åº”ç”¨ <code>two-constraints.yaml</code>ï¼Œä¼šå‘ç° â€œmypodâ€ å¤„äº <code>Pending</code> çŠ¶æ€ï¼Œè¿™æ˜¯å› ä¸ºä¸ºäº†æ»¡è¶³ç¬¬ä¸€ä¸ªçº¦æŸï¼Œâ€mypodâ€ åªèƒ½æ”¾åœ¨ â€œzoneBâ€ ä¸­ï¼Œè€Œç¬¬äºŒä¸ªçº¦æŸè¦æ±‚ â€œmypodâ€ åªèƒ½æ”¾åœ¨ â€œnode2â€ ä¸Šï¼ŒPod è°ƒåº¦æ— æ³•æ»¡è¶³è¿™ä¸¤ç§çº¦æŸï¼Œæ‰€ä»¥å°±å†²çªäº†ã€‚</p>
<p>ä¸ºäº†å…‹æœè¿™ç§æƒ…å†µï¼Œä½ å¯ä»¥å¢åŠ  <code>maxSkew</code> æˆ–ä¿®æ”¹å…¶ä¸­ä¸€ä¸ªçº¦æŸï¼Œè®©å…¶ä½¿ç”¨ <code>whenUnsatisfiable: ScheduleAnyway</code>ã€‚</p>
<h3 id="5-ä¸NodeSelector-NodeAffinityä¸€èµ·ä½¿ç”¨"><a href="#5-ä¸NodeSelector-NodeAffinityä¸€èµ·ä½¿ç”¨" class="headerlink" title="5.ä¸NodeSelector /NodeAffinityä¸€èµ·ä½¿ç”¨"></a>5.ä¸NodeSelector /NodeAffinityä¸€èµ·ä½¿ç”¨</h3><p>ä»”ç»†è§‚å¯Ÿå¯èƒ½ä½ ä¼šå‘ç°æˆ‘ä»¬<strong>å¹¶æ²¡æœ‰ç±»ä¼¼äº <code>topologyValues</code> çš„å­—æ®µæ¥é™åˆ¶ Pod å°†è¢«è°ƒåº¦åˆ°å“ªäº›æ‹“æ‰‘å»</strong>ï¼Œé»˜è®¤æƒ…å†µä¼šæœç´¢æ‰€æœ‰èŠ‚ç‚¹å¹¶æŒ‰ <code>topologyKey</code> å¯¹å…¶è¿›è¡Œåˆ†ç»„ã€‚æœ‰æ—¶è¿™å¯èƒ½ä¸æ˜¯ç†æƒ³çš„æƒ…å†µï¼Œæ¯”å¦‚å‡è®¾æœ‰ä¸€ä¸ªé›†ç¾¤ï¼Œå…¶èŠ‚ç‚¹æ ‡è®°ä¸º <code>env=prod</code>ã€<code>env=staging</code>å’Œ <code>env=qa</code>ï¼Œç°åœ¨ä½ æƒ³è·¨åŒºåŸŸå°† Pod å‡åŒ€åœ°æ”¾ç½®åˆ° <code>qa</code> ç¯å¢ƒä¸­ï¼Œæ˜¯å¦å¯è¡Œ?</p>
<p>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆ <code>NodeSelector</code> æˆ– <code>NodeAffinity</code> ä¸€èµ·ä½¿ç”¨ï¼Œ<code>PodTopologySpread</code> ä¼šè®¡ç®—æ»¡è¶³é€‰æ‹©å™¨çš„èŠ‚ç‚¹ä¹‹é—´çš„ä¼ æ’­çº¦æŸã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220119154229.png" alt="é«˜çº§ç”¨æ³•-1"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºæˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®š <code>spec.affinity.nodeAffinity</code> å°†<strong>æœç´¢èŒƒå›´</strong>é™åˆ¶ä¸º <code>qa</code> ç¯å¢ƒï¼Œåœ¨è¯¥èŒƒå›´å†… Pod å°†è¢«è°ƒåº¦åˆ°ä¸€ä¸ªæ»¡è¶³ <code>topologySpreadConstraints</code> çš„åŒºåŸŸï¼Œè¿™é‡Œå°±åªèƒ½è¢«è°ƒåº¦åˆ° <code>zone=zone2</code> çš„èŠ‚ç‚¹ä¸Šå»äº†ã€‚</p>
<h3 id="6-é›†ç¾¤é»˜è®¤çº¦æŸ"><a href="#6-é›†ç¾¤é»˜è®¤çº¦æŸ" class="headerlink" title="6.é›†ç¾¤é»˜è®¤çº¦æŸ"></a>6.é›†ç¾¤é»˜è®¤çº¦æŸ</h3><p>é™¤äº†ä¸ºå•ä¸ª Pod è®¾ç½®æ‹“æ‰‘åˆ†å¸ƒçº¦æŸï¼Œ<strong>ä¹Ÿå¯ä»¥ä¸ºé›†ç¾¤è®¾ç½®é»˜è®¤çš„æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ</strong>ï¼Œé»˜è®¤æ‹“æ‰‘åˆ†å¸ƒçº¦æŸåœ¨ä¸”ä»…åœ¨ä»¥ä¸‹æ¡ä»¶æ»¡è¶³ æ—¶æ‰ä¼šåº”ç”¨åˆ° Pod ä¸Šï¼š</p>
<ul>
<li>Pod æ²¡æœ‰åœ¨å…¶ <code>.spec.topologySpreadConstraints</code> è®¾ç½®ä»»ä½•çº¦æŸï¼›</li>
<li>Pod éš¶å±äºæŸä¸ªæœåŠ¡ã€å‰¯æœ¬æ§åˆ¶å™¨ã€ReplicaSet æˆ– StatefulSetã€‚</li>
</ul>
<p>ä½ å¯ä»¥åœ¨ <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/scheduling/config/#profiles">è°ƒåº¦æ–¹æ¡ˆï¼ˆSchedulingg Profileï¼‰</a>ä¸­å°†é»˜è®¤çº¦æŸä½œä¸º <code>PodTopologySpread</code> æ’ä»¶å‚æ•°çš„ä¸€éƒ¨åˆ†æ¥è¿›è¡Œè®¾ç½®ã€‚ çº¦æŸçš„è®¾ç½®é‡‡ç”¨å’Œå‰é¢ Pod ä¸­çš„è§„èŒƒä¸€è‡´ï¼Œåªæ˜¯ <code>labelSelector</code> å¿…é¡»ä¸ºç©ºã€‚é…ç½®çš„ç¤ºä¾‹å¯èƒ½çœ‹èµ·æ¥åƒä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeSchedulerConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="attr">profiles:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pluginConfig:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PodTopologySpread</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="attr">defaultConstraints:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">topology.kubernetes.io/zone</span></span><br><span class="line">              <span class="attr">whenUnsatisfiable:</span> <span class="string">ScheduleAnyway</span></span><br><span class="line">          <span class="attr">defaultingType:</span> <span class="string">List</span></span><br></pre></td></tr></table></figure>



<p>ğŸ‚ ä¸ç”¨ DaemonSetï¼Œå¦‚ä½•ä½¿ç”¨ Deployment æ˜¯å¦å®ç°åŒæ ·çš„åŠŸèƒ½ï¼Ÿ</p>
<p>æˆ‘ä»¬çŸ¥é“ DaemonSet æ§åˆ¶å™¨çš„åŠŸèƒ½å°±æ˜¯åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Podï¼Œå¦‚ä½•è¦ä½¿ç”¨ Deployment æ¥å®ç°ï¼Œé¦–å…ˆå°±è¦è®¾ç½®å‰¯æœ¬æ•°é‡ä¸ºèŠ‚ç‚¹æ•°ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡ŒåŠ ä¸Š master èŠ‚ç‚¹ä¸€å…±3ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è¦è®¾ç½®3ä¸ªå‰¯æœ¬ï¼Œè¦åœ¨ master èŠ‚ç‚¹ä¸Šæ‰§è¡Œè‡ªç„¶è¦æ·»åŠ å®¹å¿ï¼Œé‚£ä¹ˆè¦å¦‚ä½•ä¿è¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šåªè¿è¡Œä¸€ä¸ª Pod å‘¢ï¼Ÿæ˜¯ä¸æ˜¯å‰é¢çš„æåˆ°çš„ Pod åäº²å’Œæ€§å°±å¯ä»¥å®ç°ï¼Œ<strong>ä»¥è‡ªå·± Pod çš„æ ‡ç­¾æ¥è¿›è¡Œè¿‡æ»¤æ ¡éªŒå³å¯</strong>ï¼Œæ–°çš„ Pod ä¸èƒ½è¿è¡Œåœ¨ä¸€ä¸ªå·²ç»å…·æœ‰è¯¥ Pod çš„èŠ‚ç‚¹ä¸Šï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹åªèƒ½è¿è¡Œä¸€ä¸ªï¼Ÿ</p>
<ul>
<li>æ¨¡æ‹Ÿçš„èµ„æºæ¸…å•å¦‚ä¸‹æ‰€ç¤ºï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 06-daemonset-deployment.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: mock-ds-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mock-ds-demo</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mock-ds-demo</span><br><span class="line">    spec:</span><br><span class="line">      tolerations: <span class="comment">#åŠ ä¸Šå®¹å¿ï¼Œè¿™æ ·æ‰æœ‰æœºä¼šè¿è¡Œåœ¨masterèŠ‚ç‚¹ä¸Š</span></span><br><span class="line">      - key: <span class="string">&quot;node-role.kubernetes.io/master&quot;</span></span><br><span class="line">        operator: <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        effect: <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: ngpt</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:  <span class="comment"># podåäº²åˆæ€§</span></span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:  <span class="comment"># ç¡¬ç­–ç•¥</span></span><br><span class="line">          - labelSelector:</span><br><span class="line">              matchExpressions:</span><br><span class="line">              - key: app   <span class="comment"># Podçš„æ ‡ç­¾</span></span><br><span class="line">                operator: In</span><br><span class="line">                values: [<span class="string">&quot;mock-ds-demo&quot;</span>]</span><br><span class="line">            topologyKey: kubernetes.io/hostname  <span class="comment"># ä»¥hostnameä¸ºæ‹“æ‰‘åŸŸï¼Œç›¸å½“äºæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªæ‹“æ‰‘åŸŸ</span></span><br></pre></td></tr></table></figure>



<ul>
<li>åˆ›å»ºä¸Šé¢çš„èµ„æºæ¸…å•éªŒè¯ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f 06-daemonset-deployment.yaml </span><br><span class="line">deployment.apps/mock-ds-demo created</span><br><span class="line">$ kubectl get po -owide</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">mock-ds-demo-8694759c69-882fx   1/1     Running   0          18s   10.244.0.15    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">mock-ds-demo-8694759c69-frfhx   1/1     Running   0          18s   10.244.1.108   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">mock-ds-demo-8694759c69-p5cjw   1/1     Running   0          18s   10.244.2.235   node2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”¨ Deployment éƒ¨ç½²çš„æœåŠ¡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œäº†ä¸€ä¸ª Podï¼Œå®ç°çš„æ•ˆæœå’Œ DaemonSet æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>ğŸ‚ åŒæ ·çš„å¦‚æœæƒ³åœ¨æ¯ä¸ªèŠ‚ç‚¹ï¼ˆæˆ–æŒ‡å®šçš„ä¸€äº›èŠ‚ç‚¹ï¼‰ä¸Šè¿è¡Œ2ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰Pod å‰¯æœ¬ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</p>
<p>DaemonSet æ˜¯åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ1ä¸ª Pod å‰¯æœ¬ï¼Œ<strong>æ˜¾ç„¶æˆ‘ä»¬å»åˆ›å»º2ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰DaemonSet å³å¯å®ç°è¯¥ç›®æ ‡</strong>ï¼Œä½†æ˜¯è¿™ä¸æ˜¯ä¸€ä¸ªå¥½çš„æ¥è¿‘æ–¹æ¡ˆï¼Œ<strong>è€Œ <code>PodAntiAffinity</code> åªèƒ½å°†ä¸€ä¸ª Pod è°ƒåº¦åˆ°æŸä¸ªæ‹“æ‰‘åŸŸä¸­å»</strong>ï¼Œæ‰€ä»¥éƒ½ä¸èƒ½å¾ˆå¥½çš„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>è¦å®ç°è¿™ç§æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>è®¾ç½®æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ</strong>æ¥è¿›è¡Œè°ƒåº¦ï¼Œ<strong>è®¾ç½®æ‹“æ‰‘åˆ†å¸ƒçº¦æŸæ¥å°† Pod åˆ†å¸ƒåˆ°ä¸åŒçš„æ‹“æ‰‘åŸŸä¸‹</strong>ï¼Œä»è€Œå®ç°é«˜å¯ç”¨æ€§æˆ–èŠ‚çœæˆæœ¬ï¼Œå…·ä½“å®ç°æ–¹å¼è¯·çœ‹ä¸‹æ–‡ã€‚</p>
<table><tr><td bgcolor=yellow>ğŸ’˜ å®è·µï¼šç”¨æ‹“æ‰‘åˆ†å¸ƒçº¦æŸæ¥æ‰©å±•daemonsetåŠŸèƒ½(æµ‹è¯•æˆåŠŸ)-2022.5.17</td></tr></table>

<p>ç°åœ¨æˆ‘ä»¬å†å»è§£å†³ä¸ŠèŠ‚è¯¾ç•™ä¸‹çš„ä¸€ä¸ªé—®é¢˜ - <strong>å¦‚æœæƒ³åœ¨æ¯ä¸ªèŠ‚ç‚¹ï¼ˆæˆ–æŒ‡å®šçš„ä¸€äº›èŠ‚ç‚¹ï¼‰ä¸Šè¿è¡Œ2ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰Pod å‰¯æœ¬ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</strong></p>
<ul>
<li> è¿™é‡Œä»¥æˆ‘ä»¬çš„é›†ç¾¤ä¸ºä¾‹ï¼ŒåŠ ä¸Š master èŠ‚ç‚¹ä¸€å…±æœ‰3ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œ2ä¸ªå‰¯æœ¬ï¼Œæ€»å…±å°±éœ€è¦6ä¸ª Pod å‰¯æœ¬ï¼Œè¦åœ¨ master èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œåˆ™åŒæ ·éœ€è¦æ·»åŠ å®¹å¿ï¼Œå¦‚æœåªæƒ³åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ2ä¸ªå‰¯æœ¬ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„æ‹“æ‰‘åˆ†å¸ƒçº¦æŸæ¥è¿›è¡Œç»†ç²’åº¦æ§åˆ¶ï¼Œå¯¹åº”çš„èµ„æºæ¸…å•å¦‚ä¸‹æ‰€ç¤ºï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#01-daemonset2.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">topo-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">6</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">topo</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">topo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/master&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ngpt</span></span><br><span class="line">      <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">        <span class="attr">whenUnsatisfiable:</span> <span class="string">DoNotSchedule</span></span><br><span class="line">        <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">topo</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„å°±æ˜¯ <code>topologySpreadConstraints</code> éƒ¨åˆ†çš„é…ç½®ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>kubernetes.io/hostname</code> ä¸ºæ‹“æ‰‘åŸŸï¼Œç›¸å½“äºå°±æ˜¯3ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œ<code>maxSkew: 1</code> è¡¨ç¤ºæœ€å¤§çš„åˆ†å¸ƒä¸å‡åŒ€åº¦ä¸º1ï¼Œæ‰€ä»¥åªèƒ½å‡ºç°çš„è°ƒåº¦ç»“æœå°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œ2ä¸ª Podã€‚</p>
<p>maxSkew=2è¿™ä¸ªç›¸å½“äºæ˜¯è½¯ç­–ç•¥ï¼Œä¸å¯å–ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220219104104873.png" alt="image-20220219104104873"></p>
<p>maxSkew=1è¿™ä¸ªæ»¡è¶³éœ€æ±‚ã€‚</p>
<p>maxSkew=1ï¼Œè¿™ä¸ªæ˜¯ä¸€è½®è½®å¾€ä¸‹è°ƒåº¦çš„ï¼›(é‚£ä¹ˆä¸€èˆ¬æƒ…å†µï¼ŒmaxSkew=1åº”è¯¥æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„)</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220119162204.png" alt="è§£æ"></p>
<ul>
<li>ç›´æ¥åˆ›å»ºä¸Šé¢çš„èµ„æºå³å¯éªŒè¯ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f 01-daemonset2.yaml </span><br><span class="line">deployment.apps/topo-demo created</span><br><span class="line">$ kubectl get po -l app=topo -owide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">topo-demo-6bbf65d967-ctf66   1/1     Running   0          43s   10.244.1.110   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo-6bbf65d967-gkqpx   1/1     Running   0          43s   10.244.0.16    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo-6bbf65d967-jsj4h   1/1     Running   0          43s   10.244.2.236   node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo-6bbf65d967-kc9x8   1/1     Running   0          43s   10.244.2.237   node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo-6bbf65d967-nr9b9   1/1     Running   0          43s   10.244.1.109   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo-6bbf65d967-wfzmf   1/1     Running   0          43s   10.244.0.17    master1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œäº†2ä¸ª Pod å‰¯æœ¬ã€‚</p>
<ul>
<li>å¦‚æœæ˜¯è¦æ±‚æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ3ä¸ª Pod å‰¯æœ¬å‘¢ï¼Ÿå¤§å®¶ä¹Ÿå¯ä»¥å°è¯•å»ç»ƒä¹ ä¸‹ã€‚</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#02-daemonset.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">topo-demo2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">9</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">topo2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">topo2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/master&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ngpt1</span></span><br><span class="line">      <span class="attr">topologySpreadConstraints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">maxSkew:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">        <span class="attr">whenUnsatisfiable:</span> <span class="string">DoNotSchedule</span></span><br><span class="line">        <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchLabels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">topo2</span></span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹ç°è±¡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hg@LAPTOP-G8TUFE0T:/mnt/c/Users/hg/Desktop/yaml/2022.2.19-40.æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ-å®éªŒä»£ç $ kubectl apply -f 02-daemonset.yaml </span><br><span class="line">deployment.apps/topo-demo2 created</span><br><span class="line">hg@LAPTOP-G8TUFE0T:/mnt/c/Users/hg/Desktop/yaml/2022.2.19-40.æ‹“æ‰‘åˆ†å¸ƒçº¦æŸ-å®éªŒä»£ç $ kubectl get po -l app=topo2 -owide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">topo-demo2-87d77dbbd-25wbw   1/1     Running   0          53s   10.244.2.240   node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo2-87d77dbbd-77gm8   1/1     Running   0          53s   10.244.1.113   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo2-87d77dbbd-97npc   1/1     Running   0          53s   10.244.0.20    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo2-87d77dbbd-fspcq   1/1     Running   0          53s   10.244.1.111   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo2-87d77dbbd-k5llk   1/1     Running   0          53s   10.244.1.112   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo2-87d77dbbd-pc24x   1/1     Running   0          53s   10.244.2.238   node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo2-87d77dbbd-rdmwn   1/1     Running   0          53s   10.244.2.239   node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo2-87d77dbbd-s4rjp   1/1     Running   0          53s   10.244.0.18    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">topo-demo2-87d77dbbd-xrwmk   1/1     Running   0          53s   10.244.0.19    master1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>å®éªŒç»“æŸã€‚ğŸ˜˜</p>
<h2 id="12ã€Descheduler"><a href="#12ã€Descheduler" class="headerlink" title="12ã€Descheduler"></a>12ã€Descheduler</h2><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220219161107422.png" alt="image-20220219161107422"></p>
<h3 id="1ã€Descheduler"><a href="#1ã€Descheduler" class="headerlink" title="1ã€Descheduler"></a>1ã€Descheduler</h3><p>ä» kube-scheduler çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒæ˜¯é€šè¿‡ä¸€ç³»åˆ—ç®—æ³•è®¡ç®—å‡ºæœ€ä½³èŠ‚ç‚¹è¿è¡Œ Podï¼Œå½“å‡ºç°æ–°çš„ Pod è¿›è¡Œè°ƒåº¦æ—¶ï¼Œè°ƒåº¦ç¨‹åºä¼šæ ¹æ®å…¶å½“æ—¶å¯¹ Kubernetes é›†ç¾¤çš„èµ„æºæè¿°åšå‡ºæœ€ä½³è°ƒåº¦å†³å®šï¼Œä½†æ˜¯ <strong>Kubernetes é›†ç¾¤æ˜¯éå¸¸åŠ¨æ€çš„</strong>ï¼Œç”±äºæ•´ä¸ªé›†ç¾¤èŒƒå›´å†…çš„å˜åŒ–ï¼Œæ¯”å¦‚ä¸€ä¸ªèŠ‚ç‚¹ä¸ºäº†ç»´æŠ¤ï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œäº†é©±é€æ“ä½œï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Pod ä¼šè¢«é©±é€åˆ°å…¶ä»–èŠ‚ç‚¹å»ï¼Œä½†æ˜¯å½“æˆ‘ä»¬ç»´æŠ¤å®Œæˆåï¼Œä¹‹å‰çš„ Pod å¹¶ä¸ä¼šè‡ªåŠ¨å›åˆ°è¯¥èŠ‚ç‚¹ä¸Šæ¥ï¼Œå› ä¸º <strong>Pod ä¸€æ—¦è¢«ç»‘å®šäº†èŠ‚ç‚¹æ˜¯ä¸ä¼šè§¦å‘é‡æ–°è°ƒåº¦çš„</strong>ï¼Œç”±äºè¿™äº›å˜åŒ–ï¼Œ<strong>Kubernetes é›†ç¾¤åœ¨ä¸€æ®µæ—¶é—´å†…å°±å¯èƒ½ä¼šå‡ºç°ä¸å‡è¡¡çš„çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦å‡è¡¡å™¨æ¥é‡æ–°å¹³è¡¡é›†ç¾¤ã€‚</strong></p>
<p>å½“ç„¶æˆ‘ä»¬å¯ä»¥å»æ‰‹åŠ¨åšä¸€äº›é›†ç¾¤çš„å¹³è¡¡ï¼Œæ¯”å¦‚æ‰‹åŠ¨å»åˆ æ‰æŸäº› Podï¼Œè§¦å‘é‡æ–°è°ƒåº¦å°±å¯ä»¥äº†ï¼Œä½†æ˜¯æ˜¾ç„¶è¿™æ˜¯ä¸€ä¸ªç¹ççš„è¿‡ç¨‹ï¼Œä¹Ÿä¸æ˜¯è§£å†³é—®é¢˜çš„æ–¹å¼ã€‚<strong>ä¸ºäº†è§£å†³å®é™…è¿è¡Œä¸­é›†ç¾¤èµ„æºæ— æ³•å……åˆ†åˆ©ç”¨æˆ–æµªè´¹çš„é—®é¢˜</strong>ï¼Œå¯ä»¥ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/descheduler">descheduler</a> ç»„ä»¶å¯¹é›†ç¾¤çš„ Pod è¿›è¡Œè°ƒåº¦ä¼˜åŒ–ï¼Œ<code>descheduler</code> å¯ä»¥æ ¹æ®ä¸€äº›è§„åˆ™å’Œé…ç½®ç­–ç•¥æ¥å¸®åŠ©æˆ‘ä»¬é‡æ–°å¹³è¡¡é›†ç¾¤çŠ¶æ€ï¼Œå…¶æ ¸å¿ƒåŸç†æ˜¯æ ¹æ®å…¶ç­–ç•¥é…ç½®æ‰¾åˆ°å¯ä»¥è¢«ç§»é™¤çš„ Pod å¹¶é©±é€å®ƒä»¬ï¼Œ**<u>å…¶æœ¬èº«å¹¶ä¸ä¼šè¿›è¡Œè°ƒåº¦è¢«é©±é€çš„ Podï¼Œè€Œæ˜¯ä¾é é»˜è®¤çš„è°ƒåº¦å™¨æ¥å®ç°</u>**ï¼Œç›®å‰æ”¯æŒçš„ç­–ç•¥æœ‰ï¼š</p>
<ul>
<li>RemoveDuplicates</li>
<li>LowNodeUtilization</li>
<li>RemovePodsViolatingInterPodAntiAffinity</li>
<li>RemovePodsViolatingNodeAffinity</li>
<li>RemovePodsViolatingNodeTaints</li>
<li>RemovePodsViolatingTopologySpreadConstraint</li>
<li>RemovePodsHavingTooManyRestarts</li>
<li>PodLifeTime</li>
</ul>
<p>è¿™äº›ç­–ç•¥éƒ½æ˜¯å¯ä»¥å¯ç”¨æˆ–è€…ç¦ç”¨çš„ï¼Œä½œä¸ºç­–ç•¥çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥é…ç½®ä¸ç­–ç•¥ç›¸å…³çš„ä¸€äº›å‚æ•°ï¼Œ<strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ç­–ç•¥éƒ½æ˜¯å¯ç”¨çš„</strong>ã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€äº›é€šç”¨é…ç½®ï¼Œå¦‚ä¸‹ï¼š</p>
<ul>
<li><code>nodeSelector</code>ï¼šé™åˆ¶è¦å¤„ç†çš„èŠ‚ç‚¹</li>
<li><code>evictLocalStoragePods</code>: é©±é€ä½¿ç”¨ LocalStorage çš„ Pods</li>
<li><code>ignorePvcPods</code>: æ˜¯å¦å¿½ç•¥é…ç½® PVC çš„ Podsï¼Œé»˜è®¤æ˜¯ False</li>
<li><code>maxNoOfPodsToEvictPerNode</code>ï¼šèŠ‚ç‚¹å…è®¸çš„æœ€å¤§é©±é€ Pods æ•°</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ‰€ç¤ºçš„ <code>DeschedulerPolicy</code> æ¥é…ç½®ï¼š(<strong>è¿™é‡Œæ˜¯è¦ç”¨ä¸€ä¸ªconfigmapæ¥è¿›è¡Œä½¿ç”¨çš„ã€‚</strong>)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">nodeSelector:</span> <span class="string">prod=dev</span></span><br><span class="line"><span class="attr">evictLocalStoragePods:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">maxNoOfPodsToEvictPerNode:</span> <span class="number">40</span></span><br><span class="line"><span class="attr">ignorePvcPods:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">strategies:</span>  <span class="comment"># é…ç½®ç­–ç•¥</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>ğŸ‚ kubernetes-sigs/deschedulerå®˜æ–¹ç½‘ç«™</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/descheduler">https://github.com/kubernetes-sigs/descheduler</a></p>
<h3 id="2ã€å®‰è£…"><a href="#2ã€å®‰è£…" class="headerlink" title="2ã€å®‰è£…"></a>2ã€å®‰è£…</h3><table><tr><td bgcolor=yellow>ğŸ’˜ å®è·µï¼šdeschedulerå®‰è£…(æµ‹è¯•æˆåŠŸ)-2022.5.17</td></tr></table>

<ul>
<li> <code>descheduler</code> å¯ä»¥ä»¥ <code>Job</code>ã€<code>CronJob</code> æˆ–è€… <code>Deployment</code> çš„å½¢å¼è¿è¡Œåœ¨ k8s é›†ç¾¤å†…ï¼ŒåŒæ ·æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Helm Chart æ¥å®‰è£… <code>descheduler</code>ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#helm repo add descheduler https://kubernetes-sigs.github.io/descheduler/</span></span><br><span class="line"><span class="string">&quot;descheduler&quot;</span> has been added to your repositories</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment">#helm fetch descheduler/descheduler</span></span><br><span class="line">[root@master1 ~]<span class="comment">#tar xf descheduler-0.23.1.tgz </span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ Helm Chart æˆ‘ä»¬å¯ä»¥é…ç½® <code>descheduler</code> ä»¥ <code>CronJob</code> æˆ–è€… <code>Deployment</code> æ–¹å¼è¿è¡Œã€‚:warning: é»˜è®¤æƒ…å†µä¸‹ <code>descheduler</code> ä¼šä»¥ä¸€ä¸ª <code>critical pod</code> è¿è¡Œï¼Œä»¥é¿å…è¢«è‡ªå·±æˆ–è€… kubelet é©±é€äº†ï¼Œéœ€è¦ç¡®ä¿é›†ç¾¤ä¸­æœ‰ <code>system-cluster-critical</code> è¿™ä¸ª Priorityclassï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get priorityclass system-cluster-critical</span></span><br><span class="line">NAME                      VALUE        GLOBAL-DEFAULT   AGE</span><br><span class="line">system-cluster-critical   2000000000   <span class="literal">false</span>            111d</span><br></pre></td></tr></table></figure>

<p>:warning:  æ³¨æ„ï¼šdeschedulerå’Œk8sç‰ˆæœ¬é—®é¢˜</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/descheduler">https://github.com/kubernetes-sigs/descheduler</a></p>
<p>ä»€ä¹ˆæ ·çš„k8sé›†ç¾¤ç‰ˆæœ¬å°±æ˜¯ç”¨ä»€ä¹ˆæ ·çš„deschedulerï¼›</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220219223059197.png" alt="image-20220219223059197"></p>
<ul>
<li>ä½¿ç”¨ Helm Chart å®‰è£…é»˜è®¤æƒ…å†µä¸‹ä¼šä»¥ <code>CronJob</code> çš„å½¢å¼è¿è¡Œï¼Œæ‰§è¡Œå‘¨æœŸä¸º <code>schedule: &quot;*/2 * * * *&quot;</code>ï¼Œè¿™æ ·æ¯éš”ä¸¤åˆ†é’Ÿä¼šæ‰§è¡Œä¸€æ¬¡ <code>descheduler</code> ä»»åŠ¡ï¼Œé»˜è®¤çš„é…ç½®ç­–ç•¥å¦‚ä¸‹æ‰€ç¤ºï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">descheduler</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">policy.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    apiVersion: &quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="string">    kind: &quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="string">    strategies:</span></span><br><span class="line"><span class="string">      LowNodeUtilization:</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        params:</span></span><br><span class="line"><span class="string">          nodeResourceUtilizationThresholds:</span></span><br><span class="line"><span class="string">            targetThresholds:</span></span><br><span class="line"><span class="string">              cpu: 50</span></span><br><span class="line"><span class="string">              memory: 50</span></span><br><span class="line"><span class="string">              pods: 50</span></span><br><span class="line"><span class="string">            thresholds:</span></span><br><span class="line"><span class="string">              cpu: 20</span></span><br><span class="line"><span class="string">              memory: 20</span></span><br><span class="line"><span class="string">              pods: 20</span></span><br><span class="line"><span class="string">      RemoveDuplicates:</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">      RemovePodsViolatingInterPodAntiAffinity:</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">      RemovePodsViolatingNodeAffinity:</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br><span class="line"><span class="string">        params:</span></span><br><span class="line"><span class="string">          nodeAffinityType:</span></span><br><span class="line"><span class="string">          - requiredDuringSchedulingIgnoredDuringExecution</span></span><br><span class="line"><span class="string">      RemovePodsViolatingNodeTaints:</span></span><br><span class="line"><span class="string">        enabled: true</span></span><br></pre></td></tr></table></figure>



<ul>
<li>é€šè¿‡é…ç½® <code>DeschedulerPolicy</code> çš„ <code>strategies</code>ï¼Œå¯ä»¥æŒ‡å®š <code>descheduler</code> çš„æ‰§è¡Œç­–ç•¥ï¼Œè¿™äº›ç­–ç•¥éƒ½æ˜¯å¯ä»¥å¯ç”¨æˆ–ç¦ç”¨çš„ã€‚ä¸‹é¢æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤ç­–ç•¥å³å¯ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç›´æ¥å®‰è£…å³å¯ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#helm upgrade --install descheduler descheduler/descheduler --set image.repository=cnych/descheduler,podSecurityPolicy.create=false -n kube-system</span></span><br><span class="line">Release <span class="string">&quot;descheduler&quot;</span> does not exist. Installing it now.</span><br><span class="line">NAME: descheduler</span><br><span class="line">LAST DEPLOYED: Sat Feb 19 17:05:31 2022</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">NOTES:</span><br><span class="line">Descheduler installed as a CronJob .   </span><br></pre></td></tr></table></figure>



<ul>
<li>éƒ¨ç½²å®Œæˆåä¼šåˆ›å»ºä¸€ä¸ª <code>CronJob</code> èµ„æºå¯¹è±¡æ¥å¹³è¡¡é›†ç¾¤çŠ¶æ€ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get cronjob -n kube-system</span><br><span class="line">NAME          SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><br><span class="line">descheduler   */2 * * * *   False     1        27s             31s</span><br><span class="line">âœ kubectl get job -n kube-system</span><br><span class="line">NAME                   COMPLETIONS   DURATION   AGE</span><br><span class="line">descheduler-27378876   1/1           72s        79s</span><br><span class="line">âœ kubectl get pods -n kube-system -l job-name=descheduler-27378876</span><br><span class="line">NAME                            READY   STATUS      RESTARTS   AGE</span><br><span class="line">descheduler-27378876--1-btjmd   0/1     Completed   0          2m21s</span><br></pre></td></tr></table></figure>



<ul>
<li>æ­£å¸¸æƒ…å†µä¸‹å°±ä¼šåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ Job æ¥æ‰§è¡Œ <code>descheduler</code> ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹æ—¥å¿—å¯ä»¥äº†è§£åšäº†å“ªäº›å¹³è¡¡æ“ä½œï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl logs -f descheduler-27378876--1-btjmd -n kube-system</span><br><span class="line">I0121 02:37:10.127266       1 named_certificates.go:53] <span class="string">&quot;Loaded SNI cert&quot;</span> index=0 certName=<span class="string">&quot;self-signed loopback&quot;</span> certDetail=<span class="string">&quot;\&quot;apiserver-loopback-client@1642732630\&quot; [serving] validServingFor=[apiserver-loopback-client] issuer=\&quot;apiserver-loopback-client-ca@1642732629\&quot; (2022-01-21 01:37:09 +0000 UTC to 2023-01-21 01:37:09 +0000 UTC (now=2022-01-21 02:37:10.127237 +0000 UTC))&quot;</span></span><br><span class="line">I0121 02:37:10.127324       1 secure_serving.go:195] Serving securely on [::]:10258</span><br><span class="line">I0121 02:37:10.127363       1 tlsconfig.go:240] <span class="string">&quot;Starting DynamicServingCertificateController&quot;</span></span><br><span class="line">I0121 02:37:10.138724       1 node.go:46] <span class="string">&quot;Node lister returned empty list, now fetch directly&quot;</span></span><br><span class="line">I0121 02:37:10.172264       1 nodeutilization.go:167] <span class="string">&quot;Node is overutilized&quot;</span> node=<span class="string">&quot;master1&quot;</span> usage=map[cpu:1225m memory:565Mi pods:16] usagePercentage=map[cpu:61.25 memory:15.391786081415567 pods:14.545454545454545]</span><br><span class="line">I0121 02:37:10.172313       1 nodeutilization.go:164] <span class="string">&quot;Node is underutilized&quot;</span> node=<span class="string">&quot;node1&quot;</span> usage=map[cpu:675m memory:735Mi pods:16] usagePercentage=map[cpu:16.875 memory:9.542007959787252 pods:14.545454545454545]</span><br><span class="line">I0121 02:37:10.172328       1 nodeutilization.go:170] <span class="string">&quot;Node is appropriately utilized&quot;</span> node=<span class="string">&quot;node2&quot;</span> usage=map[cpu:975m memory:1515Mi pods:15] usagePercentage=map[cpu:24.375 memory:19.66820054018583 pods:13.636363636363637]</span><br><span class="line">I0121 02:37:10.172340       1 lownodeutilization.go:100] <span class="string">&quot;Criteria for a node under utilization&quot;</span> CPU=20 Mem=20 Pods=20</span><br><span class="line">I0121 02:37:10.172346       1 lownodeutilization.go:101] <span class="string">&quot;Number of underutilized nodes&quot;</span> totalNumber=1</span><br><span class="line">I0121 02:37:10.172355       1 lownodeutilization.go:114] <span class="string">&quot;Criteria for a node above target utilization&quot;</span> CPU=50 Mem=50 Pods=50</span><br><span class="line">I0121 02:37:10.172360       1 lownodeutilization.go:115] <span class="string">&quot;Number of overutilized nodes&quot;</span> totalNumber=1</span><br><span class="line">I0121 02:37:10.172374       1 nodeutilization.go:223] <span class="string">&quot;Total capacity to be moved&quot;</span> CPU=1325 Mem=3267772416 Pods=39</span><br><span class="line">I0121 02:37:10.172399       1 nodeutilization.go:226] <span class="string">&quot;Evicting pods from node&quot;</span> node=<span class="string">&quot;master1&quot;</span> usage=map[cpu:1225m memory:565Mi pods:16]</span><br><span class="line">I0121 02:37:10.172485       1 nodeutilization.go:229] <span class="string">&quot;Pods on node&quot;</span> node=<span class="string">&quot;master1&quot;</span> allPods=16 nonRemovablePods=13 removablePods=3</span><br><span class="line">I0121 02:37:10.172495       1 nodeutilization.go:236] <span class="string">&quot;Evicting pods based on priority, if they have same priority, they&#x27;ll be evicted based on QoS tiers&quot;</span></span><br><span class="line">I0121 02:37:10.180353       1 evictions.go:130] <span class="string">&quot;Evicted pod&quot;</span> pod=<span class="string">&quot;default/topo-demo-6bbf65d967-lzlfh&quot;</span> reason=<span class="string">&quot;LowNodeUtilization&quot;</span></span><br><span class="line">I0121 02:37:10.181506       1 nodeutilization.go:269] <span class="string">&quot;Evicted pods&quot;</span> pod=<span class="string">&quot;default/topo-demo-6bbf65d967-lzlfh&quot;</span> err=&lt;nil&gt;</span><br><span class="line">I0121 02:37:10.181541       1 nodeutilization.go:294] <span class="string">&quot;Updated node usage&quot;</span> node=<span class="string">&quot;master1&quot;</span> CPU=1225 Mem=592445440 Pods=15</span><br><span class="line">I0121 02:37:10.182496       1 event.go:291] <span class="string">&quot;Event occurred&quot;</span> object=<span class="string">&quot;default/topo-demo-6bbf65d967-lzlfh&quot;</span> kind=<span class="string">&quot;Pod&quot;</span> apiVersion=<span class="string">&quot;v1&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;Normal&quot;</span> reason=<span class="string">&quot;Descheduled&quot;</span> message=<span class="string">&quot;pod evicted by sigs.k8s.io/deschedulerLowNodeUtilization&quot;</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>ä»æ—¥å¿—ä¸­æˆ‘ä»¬å°±å¯ä»¥æ¸…æ™°çš„çŸ¥é“å› ä¸ºä»€ä¹ˆç­–ç•¥é©±é€äº†å“ªäº› Podsã€‚</p>
<ul>
<li>deschedulerå®‰è£…å‡ºç°çš„é—®é¢˜</li>
</ul>
<p>:warning: è¦æ³¨æ„è‡ªå·±helm chartç‰ˆæœ¬å’Œè€å¸ˆè½¬å­˜çš„é•œåƒæ˜¯å¦ä¸€è‡´ï¼Œå¦åˆ™å¯èƒ½æ‹‰å–é•œåƒå¤±è´¥ï¼š</p>
<p>values.yamlå†…å®¹ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220219185204895.png" alt="image-20220219185204895"></p>
<p>Chart.yamlæ–‡ä»¶å†…å®¹ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220219185509176.png" alt="image-20220219185509176"></p>
<p>è€å¸ˆè¿™é‡Œå·²ç»è½¬å­˜å¥½çš„é•œåƒå¦‚ä¸‹ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220219185903544.png" alt="image-20220219185903544"></p>
<p>å› æ­¤è¿™é‡Œéœ€è¦ç”¨å¦‚ä¸‹å‘½ä»¤æ¥æ‹‰å–ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install descheduler descheduler/descheduler --<span class="built_in">set</span> image.repository=cnych/descheduler,image.tag=v0.22.1,podSecurityPolicy.create=<span class="literal">false</span> -n kube-system</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment">#helm upgrade --install descheduler descheduler/descheduler --set image.repository=cnych/descheduler,image.tag=v0.22.1,podSecurityPolicy.create=false -n kube-system</span></span><br><span class="line">Release <span class="string">&quot;descheduler&quot;</span> does not exist. Installing it now.</span><br><span class="line">NAME: descheduler</span><br><span class="line">LAST DEPLOYED: Sat Feb 19 19:04:52 2022</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">NOTES:</span><br><span class="line">Descheduler installed as a CronJob .</span><br></pre></td></tr></table></figure>

<p>å®Œç¾ã€‚</p>
<h3 id="3ã€PDB"><a href="#3ã€PDB" class="headerlink" title="3ã€PDB"></a>3ã€PDB</h3><p>ç”±äºä½¿ç”¨ <code>descheduler</code> ä¼šå°† Pod é©±é€è¿›è¡Œé‡è°ƒåº¦ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰å‰¯æœ¬éƒ½è¢«é©±é€çš„è¯ï¼Œåˆ™å¯èƒ½å¯¼è‡´è¯¥æœåŠ¡ä¸å¯ç”¨ã€‚å¦‚æœæœåŠ¡æœ¬èº«å­˜åœ¨å•ç‚¹æ•…éšœï¼Œé©±é€çš„æ—¶å€™è‚¯å®šå°±ä¼šé€ æˆæœåŠ¡ä¸å¯ç”¨äº†ï¼Œ<strong>è¿™ç§æƒ…å†µæˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½¿ç”¨åäº²å’Œæ€§å’Œå¤šå‰¯æœ¬æ¥é¿å…å•ç‚¹æ•…éšœ</strong>ã€‚ä½†æ˜¯å¦‚æœæœåŠ¡æœ¬èº«å°±è¢«æ‰“æ•£åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œè¿™äº› Pod éƒ½è¢«é©±é€çš„è¯ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿä¼šé€ æˆæœåŠ¡ä¸å¯ç”¨äº†ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½® <code>PDBï¼ˆPodDisruptionBudgetï¼‰</code> <strong>å¯¹è±¡æ¥é¿å…æ‰€æœ‰å‰¯æœ¬åŒæ—¶è¢«åˆ é™¤ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥è®¾ç½®åœ¨é©±é€çš„æ—¶å€™æŸåº”ç”¨æœ€å¤šåªæœ‰ä¸€ä¸ªå‰¯æœ¬ä¸å¯ç”¨</strong>ï¼Œåˆ™åˆ›å»ºå¦‚ä¸‹æ‰€ç¤ºçš„èµ„æºæ¸…å•å³å¯ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pdb-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxUnavailable:</span> <span class="number">1</span>  <span class="comment"># è®¾ç½®æœ€å¤šä¸å¯ç”¨çš„å‰¯æœ¬æ•°é‡ï¼Œæˆ–è€…ä½¿ç”¨ minAvailableï¼Œå¯ä»¥ä½¿ç”¨æ•´æ•°æˆ–ç™¾åˆ†æ¯”</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span>    <span class="comment"># åŒ¹é…Podæ ‡ç­¾</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo</span></span><br></pre></td></tr></table></figure>

<p>å…³äº PDB çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/%E3%80%82">https://kubernetes.io/docs/tasks/run-application/configure-pdb/ã€‚</a></p>
<blockquote>
<p>:warning: æ‰€ä»¥å¦‚æœæˆ‘ä»¬ä½¿ç”¨ <code>descheduler</code> æ¥é‡æ–°å¹³è¡¡é›†ç¾¤çŠ¶æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼ºçƒˆå»ºè®®ç»™åº”ç”¨åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ <code>PodDisruptionBudget</code> å¯¹è±¡è¿›è¡Œä¿æŠ¤ã€‚</p>
</blockquote>
<h3 id="4ã€ç­–ç•¥"><a href="#4ã€ç­–ç•¥" class="headerlink" title="4ã€ç­–ç•¥"></a>4ã€ç­–ç•¥</h3><h4 id="1-PodLifeTime"><a href="#1-PodLifeTime" class="headerlink" title="1.PodLifeTime"></a>1.PodLifeTime</h4><p>è¯¥ç­–ç•¥ç”¨äºé©±é€æ¯” <code>maxPodLifeTimeSeconds</code> æ›´æ—§çš„ Podsï¼›å¯ä»¥é€šè¿‡ <code>podStatusPhases</code> æ¥é…ç½®å“ªç±»çŠ¶æ€çš„ Pods ä¼šè¢«é©±é€ã€‚å»ºè®®ä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ª PDBï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºçš„å¯ç”¨æ€§ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é…ç½®å¦‚ä¸‹æ‰€ç¤ºçš„ç­–ç•¥æ¥é©±é€è¿è¡Œè¶…è¿‡7å¤©çš„ Podï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;PodLifeTime&quot;:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">maxPodLifeTimeSeconds:</span> <span class="number">604800</span>  <span class="comment"># Pods è¿è¡Œæœ€å¤š7å¤©</span></span><br></pre></td></tr></table></figure>

<h4 id="2-RemoveDuplicates"><a href="#2-RemoveDuplicates" class="headerlink" title="2.RemoveDuplicates"></a>2.RemoveDuplicates</h4><p><strong>è¯¥ç­–ç•¥ç¡®ä¿åªæœ‰ä¸€ä¸ªå’Œ Pod å…³è”çš„ RSã€Deployment æˆ–è€… Job èµ„æºå¯¹è±¡è¿è¡Œåœ¨åŒä¸€èŠ‚ç‚¹ä¸Šã€‚</strong>å¦‚æœè¿˜æœ‰æ›´å¤šçš„ Pod åˆ™å°†è¿™äº›é‡å¤çš„ Pod è¿›è¡Œé©±é€ï¼Œä»¥ä¾¿æ›´å¥½åœ°åœ¨é›†ç¾¤ä¸­åˆ†æ•£ Podã€‚å¦‚æœæŸäº›èŠ‚ç‚¹ç”±äºæŸäº›åŸå› å´©æºƒäº†ï¼Œè¿™äº›èŠ‚ç‚¹ä¸Šçš„ Pod æ¼‚ç§»åˆ°äº†å…¶ä»–èŠ‚ç‚¹ï¼Œå¯¼è‡´å¤šä¸ªä¸ RS å…³è”çš„ Pod åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œä¸€æ—¦å‡ºç°æ•…éšœçš„èŠ‚ç‚¹å†æ¬¡å‡†å¤‡å°±ç»ªï¼Œå°±å¯ä»¥å¯ç”¨è¯¥ç­–ç•¥æ¥é©±é€è¿™äº›é‡å¤çš„ Podã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220124113540.png" alt="RemoveDuplicates"></p>
<p>é…ç½®ç­–ç•¥çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šå‚æ•° <code>excludeOwnerKinds</code> ç”¨äºæ’é™¤ç±»å‹ï¼Œè¿™äº›ç±»å‹ä¸‹çš„ Pod ä¸ä¼šè¢«é©±é€ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;RemoveDuplicates&quot;:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">params:</span></span><br><span class="line">       <span class="attr">removeDuplicates:</span></span><br><span class="line">         <span class="attr">excludeOwnerKinds:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;ReplicaSet&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-LowNodeUtilization"><a href="#3-LowNodeUtilization" class="headerlink" title="3.LowNodeUtilization"></a>3.LowNodeUtilization</h4><blockquote>
<p>è¿™ä¸ªç­–ç•¥ç”¨çš„æƒ³å¯¹æ¯”è¾ƒå¤šä¸€äº›ã€‚</p>
</blockquote>
<p>è¯¥ç­–ç•¥ä¸»è¦ç”¨äºæŸ¥æ‰¾æœªå……åˆ†åˆ©ç”¨çš„èŠ‚ç‚¹ï¼Œå¹¶ä»å…¶ä»–èŠ‚ç‚¹é©±é€ Podï¼Œä»¥ä¾¿ kube-scheudler é‡æ–°å°†å®ƒä»¬è°ƒåº¦åˆ°æœªå……åˆ†åˆ©ç”¨çš„èŠ‚ç‚¹ä¸Šã€‚è¯¥ç­–ç•¥çš„å‚æ•°å¯ä»¥é€šè¿‡å­—æ®µ <code>nodeResourceUtilizationThresholds</code> è¿›è¡Œé…ç½®ã€‚</p>
<p>èŠ‚ç‚¹çš„åˆ©ç”¨ç‡ä¸è¶³å¯ä»¥é€šè¿‡é…ç½® <code>thresholds</code> é˜ˆå€¼å‚æ•°æ¥ç¡®å®šï¼Œå¯ä»¥é€šè¿‡ CPUã€å†…å­˜å’Œ Pods æ•°é‡çš„ç™¾åˆ†æ¯”è¿›è¡Œé…ç½®ã€‚å¦‚æœèŠ‚ç‚¹çš„ä½¿ç”¨ç‡å‡ä½äºæ‰€æœ‰é˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºè¯¥èŠ‚ç‚¹æœªå……åˆ†åˆ©ç”¨ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220124112813.png" alt="LowNodeUtilization"></p>
<ul>
<li>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¯é…ç½®çš„é˜ˆå€¼ <code>targetThresholds</code>ï¼Œç”¨äºè®¡ç®—å¯èƒ½é©±é€ Pods çš„æ½œåœ¨èŠ‚ç‚¹ï¼Œè¯¥å‚æ•°ä¹Ÿå¯ä»¥é…ç½® CPUã€å†…å­˜ä»¥åŠ Pods æ•°é‡çš„ç™¾åˆ†æ¯”è¿›è¡Œé…ç½®ã€‚<code>thresholds</code> å’Œ <code>targetThresholds</code> å¯ä»¥æ ¹æ®ä½ çš„é›†ç¾¤éœ€æ±‚è¿›è¡ŒåŠ¨æ€è°ƒæ•´ï¼Œå¦‚ä¸‹æ‰€ç¤ºç¤ºä¾‹ï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;LowNodeUtilization&quot;:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">params:</span></span><br><span class="line">       <span class="attr">nodeResourceUtilizationThresholds:</span></span><br><span class="line">         <span class="attr">thresholds:</span> <span class="comment">#æ³¨æ„ï¼šè¿™ä¸ªæ˜¯æœªå……åˆ†åˆ©ç”¨èŠ‚ç‚¹</span></span><br><span class="line">           <span class="string">&quot;cpu&quot;</span> <span class="string">:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">&quot;memory&quot;:</span> <span class="number">20</span></span><br><span class="line">           <span class="attr">&quot;pods&quot;:</span> <span class="number">20</span></span><br><span class="line">         <span class="attr">targetThresholds:</span> <span class="comment">#æ³¨æ„ï¼šè¿™ä¸ªå¯èƒ½é©±é€ Pods çš„æ½œåœ¨èŠ‚ç‚¹</span></span><br><span class="line">           <span class="string">&quot;cpu&quot;</span> <span class="string">:</span> <span class="number">50</span></span><br><span class="line">           <span class="attr">&quot;memory&quot;:</span> <span class="number">50</span></span><br><span class="line">           <span class="attr">&quot;pods&quot;:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>:warning: æ³¨æ„ï¼šè¿™é‡Œå¯ä»¥è€ƒè™‘ä¸‹ç”¨p8sæ¥é‡‡é›†nodeçš„è´Ÿè½½æŒ‡æ ‡ç„¶åå†™åœ¨è¿™é‡Œè¿›è¡Œè‡ªå®šä¹‰ï¼›</p>
</blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>ä»…æ”¯æŒä»¥ä¸‹ä¸‰ç§èµ„æºç±»å‹ï¼šcpuã€memoryã€pods</li>
<li><code>thresholds</code> å’Œ <code>targetThresholds</code> å¿…é¡»é…ç½®ç›¸åŒçš„ç±»å‹</li>
<li>å‚æ•°å€¼çš„è®¿é—®æ˜¯0-100ï¼ˆç™¾åˆ†åˆ¶ï¼‰</li>
<li>ç›¸åŒçš„èµ„æºç±»å‹ï¼Œ<code>thresholds</code> çš„é…ç½®ä¸èƒ½é«˜äº <code>targetThresholds</code> çš„é…ç½®</li>
</ul>
<p>å¦‚æœæœªæŒ‡å®šä»»ä½•èµ„æºç±»å‹ï¼Œåˆ™é»˜è®¤æ˜¯100%ï¼Œä»¥é¿å…èŠ‚ç‚¹ä»æœªå……åˆ†åˆ©ç”¨å˜ä¸ºè¿‡åº¦åˆ©ç”¨ã€‚</p>
<p>å’Œ <code>LowNodeUtilization</code> ç­–ç•¥å…³è”çš„å¦ä¸€ä¸ªå‚æ•°æ˜¯ <code>numberOfNodes</code>ï¼Œåªæœ‰å½“æœªå……åˆ†åˆ©ç”¨çš„èŠ‚ç‚¹æ•°å¤§äºè¯¥é…ç½®å€¼çš„æ—¶å€™ï¼Œæ‰å¯ä»¥é…ç½®è¯¥å‚æ•°æ¥æ¿€æ´»è¯¥ç­–ç•¥ï¼Œ**<u>è¯¥å‚æ•°å¯¹äºå¤§å‹é›†ç¾¤éå¸¸æœ‰ç”¨</u>**ï¼Œå…¶ä¸­æœ‰ä¸€äº›èŠ‚ç‚¹å¯èƒ½ä¼šé¢‘ç¹ä½¿ç”¨æˆ–çŸ­æœŸä½¿ç”¨ä¸è¶³ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒnumberOfNodes ä¸º0ã€‚</p>
<h4 id="4-RemovePodsViolatingInterPodAntiAffinity"><a href="#4-RemovePodsViolatingInterPodAntiAffinity" class="headerlink" title="4.RemovePodsViolatingInterPodAntiAffinity"></a>4.RemovePodsViolatingInterPodAntiAffinity</h4><p>è¯¥ç­–ç•¥å¯ä»¥ç¡®ä¿ä»èŠ‚ç‚¹ä¸­åˆ é™¤è¿å Pod åäº²å’Œæ€§çš„ Podï¼Œæ¯”å¦‚æŸä¸ªèŠ‚ç‚¹ä¸Šæœ‰ podA è¿™ä¸ª Podï¼Œå¹¶ä¸” podB å’Œ podCï¼ˆåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œï¼‰å…·æœ‰ç¦æ­¢å®ƒä»¬åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„åäº²å’Œæ€§è§„åˆ™ï¼Œåˆ™ podA å°†è¢«ä»è¯¥èŠ‚ç‚¹ä¸Šé©±é€ï¼Œä»¥ä¾¿ podB å’Œ podC è¿è¡Œæ­£å¸¸è¿è¡Œã€‚å½“ podB å’Œ podC å·²ç»è¿è¡Œåœ¨èŠ‚ç‚¹ä¸Šåï¼Œåäº²å’Œæ€§è§„åˆ™è¢«åˆ›å»ºå°±ä¼šå‘é€è¿™æ ·çš„é—®é¢˜ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220124113908.png" alt="RemovePodsViolatingInterPodAntiAffinity"></p>
<p>è¦ç¦ç”¨è¯¥ç­–ç•¥ï¼Œç›´æ¥é…ç½®æˆ false å³å¯ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;RemovePodsViolatingInterPodAntiAffinity&quot;:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h4 id="5-RemovePodsViolatingNodeTaints"><a href="#5-RemovePodsViolatingNodeTaints" class="headerlink" title="5.RemovePodsViolatingNodeTaints"></a>5.RemovePodsViolatingNodeTaints</h4><p>è¯¥ç­–ç•¥å¯ä»¥ç¡®ä¿ä»èŠ‚ç‚¹ä¸­åˆ é™¤è¿å <code>NoSchedule</code> æ±¡ç‚¹çš„ Podï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ªåä¸º podA çš„ Podï¼Œé€šè¿‡é…ç½®å®¹å¿ <code>key=value:NoSchedule</code> å…è®¸è¢«è°ƒåº¦åˆ°æœ‰è¯¥æ±¡ç‚¹é…ç½®çš„èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœèŠ‚ç‚¹çš„æ±¡ç‚¹éšåè¢«æ›´æ–°æˆ–è€…åˆ é™¤äº†ï¼Œåˆ™æ±¡ç‚¹å°†ä¸å†è¢« Pods çš„å®¹å¿æ»¡è¶³ï¼Œç„¶åå°†è¢«é©±é€ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;RemovePodsViolatingNodeTaints&quot;:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="6-RemovePodsViolatingNodeAffinity"><a href="#6-RemovePodsViolatingNodeAffinity" class="headerlink" title="6.RemovePodsViolatingNodeAffinity"></a>6.RemovePodsViolatingNodeAffinity</h4><p>è¯¥ç­–ç•¥ç¡®ä¿ä»èŠ‚ç‚¹ä¸­åˆ é™¤è¿åèŠ‚ç‚¹äº²å’Œæ€§çš„ Podã€‚æ¯”å¦‚åä¸º podA çš„ Pod è¢«è°ƒåº¦åˆ°äº†èŠ‚ç‚¹ nodeAï¼ŒpodA åœ¨è°ƒåº¦çš„æ—¶å€™æ»¡è¶³äº†èŠ‚ç‚¹äº²å’Œæ€§è§„åˆ™ <code>requiredDuringSchedulingIgnoredDuringExecution</code>ï¼Œä½†æ˜¯éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒèŠ‚ç‚¹ nodeA ä¸å†æ»¡è¶³è¯¥è§„åˆ™äº†ï¼Œé‚£ä¹ˆå¦‚æœå¦ä¸€ä¸ªæ»¡è¶³èŠ‚ç‚¹äº²å’Œæ€§è§„åˆ™çš„èŠ‚ç‚¹ nodeB å¯ç”¨ï¼Œåˆ™ podA å°†è¢«ä»èŠ‚ç‚¹ nodeA é©±é€ï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„ç­–ç•¥é…ç½®ç¤ºä¾‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;RemovePodsViolatingNodeAffinity&quot;:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">nodeAffinityType:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;requiredDuringSchedulingIgnoredDuringExecution&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="7-RemovePodsViolatingTopologySpreadConstraint"><a href="#7-RemovePodsViolatingTopologySpreadConstraint" class="headerlink" title="7.RemovePodsViolatingTopologySpreadConstraint"></a>7.RemovePodsViolatingTopologySpreadConstraint</h4><p>è¯¥ç­–ç•¥ç¡®ä¿ä»èŠ‚ç‚¹é©±é€è¿åæ‹“æ‰‘åˆ†å¸ƒçº¦æŸçš„ Podsï¼Œå…·ä½“æ¥è¯´ï¼Œå®ƒè¯•å›¾é©±é€å°†æ‹“æ‰‘åŸŸå¹³è¡¡åˆ°æ¯ä¸ªçº¦æŸçš„ <code>maxSkew</code> å†…æ‰€éœ€çš„æœ€å° Pod æ•°ï¼Œä¸è¿‡è¯¥ç­–ç•¥éœ€è¦ k8s ç‰ˆæœ¬é«˜äº1.18æ‰èƒ½ä½¿ç”¨ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤ç­–ç•¥ä»…å¤„ç†ç¡¬çº¦æŸï¼Œå¦‚æœå°†å‚æ•° <code>includeSoftConstraints</code> è®¾ç½®ä¸º Trueï¼Œä¹Ÿå°†æ”¯æŒè½¯çº¦æŸã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;RemovePodsViolatingTopologySpreadConstraint&quot;:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">params:</span></span><br><span class="line">       <span class="attr">includeSoftConstraints:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h4 id="8-RemovePodsHavingTooManyRestarts"><a href="#8-RemovePodsHavingTooManyRestarts" class="headerlink" title="8.RemovePodsHavingTooManyRestarts"></a>8.RemovePodsHavingTooManyRestarts</h4><p>è¯¥ç­–ç•¥ç¡®ä¿ä»èŠ‚ç‚¹ä¸­åˆ é™¤é‡å¯æ¬¡æ•°è¿‡å¤šçš„ Podsï¼Œå®ƒçš„å‚æ•°åŒ…æ‹¬ <code>podRestartThreshold</code>ï¼ˆè¿™æ˜¯åº”å°† Pod é€å‡ºçš„é‡æ–°å¯åŠ¨æ¬¡æ•°ï¼‰ï¼Œä»¥åŠåŒ…æ‹¬<code>InitContainers</code>ï¼Œå®ƒç¡®å®šåœ¨è®¡ç®—ä¸­æ˜¯å¦åº”è€ƒè™‘åˆå§‹åŒ–å®¹å™¨çš„é‡æ–°å¯åŠ¨ï¼Œç­–ç•¥é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;RemovePodsHavingTooManyRestarts&quot;:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">params:</span></span><br><span class="line">       <span class="attr">podsHavingTooManyRestarts:</span></span><br><span class="line">         <span class="attr">podRestartThreshold:</span> <span class="number">100</span></span><br><span class="line">         <span class="attr">includingInitContainers:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="5ã€Filter-Pods"><a href="#5ã€Filter-Pods" class="headerlink" title="5ã€Filter Pods"></a>5ã€Filter Pods</h3><p>åœ¨é©±é€ Pods çš„æ—¶å€™ï¼Œæœ‰æ—¶å¹¶ä¸éœ€è¦æ‰€æœ‰ Pods éƒ½è¢«é©±é€ï¼Œ<code>descheduler</code> æä¾›äº†ä¸¤ç§ä¸»è¦çš„æ–¹å¼è¿›è¡Œè¿‡æ»¤ï¼šå‘½åç©ºé—´è¿‡æ»¤å’Œä¼˜å…ˆçº§è¿‡æ»¤ã€‚</p>
<h4 id="1-å‘½åç©ºé—´è¿‡æ»¤"><a href="#1-å‘½åç©ºé—´è¿‡æ»¤" class="headerlink" title="1.å‘½åç©ºé—´è¿‡æ»¤"></a>1.å‘½åç©ºé—´è¿‡æ»¤</h4><p>è¯¥ç­–ç•¥å¯ä»¥é…ç½®æ˜¯åŒ…å«è¿˜æ˜¯æ’é™¤æŸäº›åç§°ç©ºé—´ã€‚å¯ä»¥ä½¿ç”¨è¯¥ç­–ç•¥çš„æœ‰ï¼š</p>
<ul>
<li>PodLifeTime</li>
<li>RemovePodsHavingTooManyRestarts</li>
<li>RemovePodsViolatingNodeTaints</li>
<li>RemovePodsViolatingNodeAffinity</li>
<li>RemovePodsViolatingInterPodAntiAffinity</li>
<li>RemoveDuplicates</li>
<li>RemovePodsViolatingTopologySpreadConstraint</li>
</ul>
<p>æ¯”å¦‚åªé©±é€æŸäº›å‘½ä»¤ç©ºé—´ä¸‹çš„ Podsï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>include</code> å‚æ•°è¿›è¡Œé…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;PodLifeTime&quot;:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">params:</span></span><br><span class="line">        <span class="attr">podLifeTime:</span></span><br><span class="line">          <span class="attr">maxPodLifeTimeSeconds:</span> <span class="number">86400</span></span><br><span class="line">        <span class="attr">namespaces:</span></span><br><span class="line">          <span class="attr">include:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;namespace1&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;namespace2&quot;</span></span><br></pre></td></tr></table></figure>



<p>åˆæˆ–è€…è¦æ’é™¤æ‰æŸäº›å‘½ä»¤ç©ºé—´ä¸‹çš„ Podsï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>exclude</code> å‚æ•°é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;PodLifeTime&quot;:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">params:</span></span><br><span class="line">        <span class="attr">podLifeTime:</span></span><br><span class="line">          <span class="attr">maxPodLifeTimeSeconds:</span> <span class="number">86400</span></span><br><span class="line">        <span class="attr">namespaces:</span></span><br><span class="line">          <span class="attr">exclude:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;namespace1&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;namespace2&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-ä¼˜å…ˆçº§è¿‡æ»¤"><a href="#2-ä¼˜å…ˆçº§è¿‡æ»¤" class="headerlink" title="2.ä¼˜å…ˆçº§è¿‡æ»¤"></a>2.ä¼˜å…ˆçº§è¿‡æ»¤</h4><p>æ‰€æœ‰ç­–ç•¥éƒ½å¯ä»¥é…ç½®ä¼˜å…ˆçº§é˜ˆå€¼ï¼Œåªæœ‰åœ¨è¯¥é˜ˆå€¼ä»¥ä¸‹çš„ Pod æ‰ä¼šè¢«é©±é€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® <code>thresholdPriorityClassName</code>ï¼ˆå°†é˜ˆå€¼è®¾ç½®ä¸ºæŒ‡å®šä¼˜å…ˆçº§ç±»åˆ«çš„å€¼ï¼‰æˆ– <code>thresholdPriority</code>ï¼ˆç›´æ¥è®¾ç½®é˜ˆå€¼ï¼‰å‚æ•°æ¥æŒ‡å®šè¯¥é˜ˆå€¼ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥é˜ˆå€¼è®¾ç½®ä¸º <code>system-cluster-critical</code> è¿™ä¸ª PriorityClass ç±»çš„å€¼ã€‚</p>
<p>æ¯”å¦‚ä½¿ç”¨ <code>thresholdPriority</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;PodLifeTime&quot;:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">params:</span></span><br><span class="line">        <span class="attr">podLifeTime:</span></span><br><span class="line">          <span class="attr">maxPodLifeTimeSeconds:</span> <span class="number">86400</span></span><br><span class="line">        <span class="attr">thresholdPriority:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>



<p>æˆ–è€…ä½¿ç”¨ <code>thresholdPriorityClassName</code> è¿›è¡Œè¿‡æ»¤ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;descheduler/v1alpha1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">&quot;DeschedulerPolicy&quot;</span></span><br><span class="line"><span class="attr">strategies:</span></span><br><span class="line">  <span class="attr">&quot;PodLifeTime&quot;:</span></span><br><span class="line">     <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">     <span class="attr">params:</span></span><br><span class="line">        <span class="attr">podLifeTime:</span></span><br><span class="line">          <span class="attr">maxPodLifeTimeSeconds:</span> <span class="number">86400</span></span><br><span class="line">        <span class="attr">thresholdPriorityClassName:</span> <span class="string">&quot;priorityclass1&quot;</span></span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡éœ€è¦æ³¨æ„ä¸èƒ½åŒæ—¶é…ç½® <code>thresholdPriority</code> å’Œ <code>thresholdPriorityClassName</code>ï¼Œå¦‚æœæŒ‡å®šçš„ä¼˜å…ˆçº§ç±»ä¸å­˜åœ¨ï¼Œåˆ™ descheduler ä¸ä¼šåˆ›å»ºå®ƒï¼Œå¹¶ä¸”ä¼šå¼•å‘é”™è¯¯ã€‚</p>
<h3 id="6ã€æ³¨æ„äº‹é¡¹"><a href="#6ã€æ³¨æ„äº‹é¡¹" class="headerlink" title="6ã€æ³¨æ„äº‹é¡¹"></a>6ã€æ³¨æ„äº‹é¡¹</h3><p>å½“ä½¿ç”¨descheduleré©±é™¤Podsçš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li><p>å…³é”®æ€§ Pod ä¸ä¼šè¢«é©±é€ï¼Œæ¯”å¦‚ <code>priorityClassName</code> è®¾ç½®ä¸º <code>system-cluster-critical</code> æˆ– <code>system-node-critical</code> çš„ Pod</p>
</li>
<li><p>ä¸å±äº RSã€Deployment æˆ– Job ç®¡ç†çš„ Pods ä¸ä¼šè¢«é©±é€</p>
</li>
<li><p>DaemonSet åˆ›å»ºçš„ Pods ä¸ä¼šè¢«é©±é€</p>
</li>
<li><p>ä½¿ç”¨ <code>LocalStorage</code> çš„ Pod ä¸ä¼šè¢«é©±é€ï¼Œé™¤éè®¾ç½® <code>evictLocalStoragePods: true</code></p>
</li>
<li><p>å…·æœ‰ PVC çš„ Pods ä¸ä¼šè¢«é©±é€ï¼Œé™¤éè®¾ç½® <code>ignorePvcPods: true</code></p>
</li>
<li><p>åœ¨ <code>LowNodeUtilization</code> å’Œ <code>RemovePodsViolatingInterPodAntiAffinity</code> ç­–ç•¥ä¸‹ï¼ŒPods æŒ‰ä¼˜å…ˆçº§ä»ä½åˆ°é«˜è¿›è¡Œé©±é€ï¼Œå¦‚æœä¼˜å…ˆçº§ç›¸åŒï¼Œ<code>Besteffort</code> ç±»å‹çš„ Pod è¦å…ˆäº <u><code>Burstable</code> å’Œ <code>Guaranteed</code> ç±»å‹</u>è¢«é©±é€</p>
</li>
<li><p><code>annotations</code> ä¸­å¸¦æœ‰ <code>descheduler.alpha.kubernetes.io/evict</code> å­—æ®µçš„ Pod éƒ½å¯ä»¥è¢«é©±é€ï¼Œè¯¥æ³¨é‡Šç”¨äºè¦†ç›–é˜»æ­¢é©±é€çš„æ£€æŸ¥ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©é©±é€å“ªä¸ªPods</p>
</li>
<li><p>å¦‚æœ Pods é©±é€å¤±è´¥ï¼Œå¯ä»¥è®¾ç½® <code>--v=4</code> ä» <code>descheduler</code> æ—¥å¿—ä¸­æŸ¥æ‰¾åŸå› ï¼Œå¦‚æœé©±é€è¿å PDB çº¦æŸï¼Œåˆ™ä¸ä¼šé©±é€è¿™ç±» Pods</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220219222613564.png" alt="image-20220219222613564"></p>
</li>
</ul>
<h2 id="13ã€å¤šè°ƒåº¦å™¨"><a href="#13ã€å¤šè°ƒåº¦å™¨" class="headerlink" title="13ã€å¤šè°ƒåº¦å™¨"></a>13ã€å¤šè°ƒåº¦å™¨</h2><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514231504.png"></p>
<h2 id="14ã€åŠ¨æ€è°ƒåº¦å™¨"><a href="#14ã€åŠ¨æ€è°ƒåº¦å™¨" class="headerlink" title="14ã€åŠ¨æ€è°ƒåº¦å™¨"></a>14ã€åŠ¨æ€è°ƒåº¦å™¨</h2><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514231822.png"><br>ä»£ç çš„å®ç°è€Œæ˜¯å¾ˆç®€å•çš„ã€‚</p>
<p>ğŸ‚<br>docs.gorance.io</p>
<p>ğŸ‚<br><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220515101445.png"><br>p8såŸºæœ¬æ˜¯k8sçš„æ ‡é…ï¼<br>è¿™ä¸ªè°ƒåº¦æ’ä»¶åªä¸€ä¸ªé”¦ä¸Šæ·»èŠ±çš„èƒ½åŠ›ï¼Œè€Œä¸ä¼šå½±å“ä¸»è°ƒåº¦èƒ½åŠ›çš„ã€‚</p>
<p>ğŸ‚<br><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220515101723.png"><br>webhookï¼ŒèŠ‚ç‚¹è¶…å”®â€“å®é™…ç”Ÿäº§ä¸Šæœ‰å¤§è§„æ¨¡ä½¿ç”¨çš„ï¼  </p>
<p>ğŸ‚ åŠ¨æ€è°ƒåº¦æˆæ•ˆ</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220514231958.png"></p>
<h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘çš„åšå®¢ä¸»æ—¨ï¼š</p>
<ul>
<li>æ’ç‰ˆç¾è§‚ï¼Œè¯­è¨€ç²¾ç‚¼ï¼›</li>
<li>æ–‡æ¡£å³æ‰‹å†Œï¼Œæ­¥éª¤æ˜ç»†ï¼Œæ‹’ç»åŸ‹å‘ï¼Œæä¾›æºç ï¼›</li>
<li>æœ¬äººå®æˆ˜æ–‡æ¡£éƒ½æ˜¯äº²æµ‹æˆåŠŸçš„ï¼Œå„ä½å°ä¼™ä¼´åœ¨å®é™…æ“ä½œè¿‡ç¨‹ä¸­å¦‚æœ‰ä»€ä¹ˆç–‘é—®ï¼Œå¯éšæ—¶è”ç³»æœ¬äººå¸®æ‚¨è§£å†³é—®é¢˜ï¼Œè®©æˆ‘ä»¬ä¸€èµ·è¿›æ­¥ï¼</li>
</ul>
<ol>
<li><p>ä¸ªäººå¾®ä¿¡äºŒç»´ç ï¼šx2675263825 ï¼ˆèˆå¾—ï¼‰ï¼Œ qqï¼š2675263825ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144206.png" alt="image-20211002091450217"></p>
</li>
<li><p>ä¸ªäººå¾®ä¿¡å…¬ä¼—å·ï¼šã€Šäº‘åŸç”Ÿæ¶æ„å¸ˆå®æˆ˜ã€‹</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144224.png" alt="image-20211002141739664"></p>
</li>
<li><p>ä¸ªäººcsdn</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39246554?spm=1010.2135.3001.5421">https://blog.csdn.net/weixin_39246554?spm=1010.2135.3001.5421</a></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144230.png" alt="image-20211002092344616"></p>
</li>
<li><p>ä¸ªäººåšå®¢ï¼š(<a href="http://www.onlyyou520.com/">www.onlyyou520.com</a>)</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220513150311181.png" alt="image-20220513150311181"></p>
</li>
<li><p>å¼€æºå¹²è´§ğŸ˜˜</p>
<p>è¯­é›€ï¼š<a target="_blank" rel="noopener" href="https://www.yuque.com/go/doc/73723298#">https://www.yuque.com/go/doc/73723298?#</a></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220513150633944.png" alt="image-20220513150633944"></p>
</li>
</ol>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å¥½äº†ï¼Œå…³äºæœ¬æ¬¡å°±åˆ°è¿™é‡Œäº†ï¼Œæ„Ÿè°¢å¤§å®¶é˜…è¯»ï¼Œæœ€åè´´ä¸Šæˆ‘å¥³ç¥çš„photoï¼Œç¥å¤§å®¶ç”Ÿæ´»å¿«ä¹ï¼Œæ¯å¤©éƒ½è¿‡çš„æœ‰æ„ä¹‰å“¦ï¼Œæˆ‘ä»¬ä¸‹æœŸè§ï¼</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220217191118541.png" alt="image-20220217191118541"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">ä¸€ä¸ªäºº</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.onlyyou520.com/2022/05/17/157%20kubernetes%E8%B0%83%E5%BA%A6%E5%99%A8/">https://www.onlyyou520.com/2022/05/17/157%20kubernetes%E8%B0%83%E5%BA%A6%E5%99%A8/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="/about" target="_blank">ä¸€ä¸ªäºº</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/">
                                    <span class="chip bg-color">è°ƒåº¦å™¨</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2022/05/20/159%20%E8%BF%90%E7%AE%97%E7%AC%A6%EF%BC%88%E5%8D%9A%E5%AE%A2%E5%88%86%E4%BA%AB%EF%BC%89-2022.5.20/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="golang-è¿ç®—ç¬¦">
                        
                        <span class="card-title">golang-è¿ç®—ç¬¦</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-05-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" class="post-category">
                                    ç¼–ç¨‹è¯­è¨€
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/golang/">
                        <span class="chip bg-color">golang</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/05/17/158%20%E7%88%B1%E7%9A%84%E8%AA%93%E8%A8%80%E5%92%8C%E6%89%BF%E8%AF%BA/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="k8s">
                        
                        <span class="card-title">k8s</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-05-17
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%99%88%E6%9E%9C%E7%9A%84%E5%B9%B8%E7%A6%8F%E5%93%B2%E5%AD%A6%E8%AF%BE/" class="post-category">
                                    é™ˆæœçš„å¹¸ç¦å“²å­¦è¯¾
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E9%99%88%E6%9E%9C%E7%9A%84%E5%B9%B8%E7%A6%8F%E5%93%B2%E5%AD%A6%E8%AF%BE/">
                        <span class="chip bg-color">é™ˆæœçš„å¹¸ç¦å“²å­¦è¯¾</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">ä¸€ä¸ªäºº</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- è¿è¡Œå¤©æ•°æé†’. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/OnlyOnexl" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2675263825@qq.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2675263825" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 2675263825" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--è…¾è®¯å…”å°å·¢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
