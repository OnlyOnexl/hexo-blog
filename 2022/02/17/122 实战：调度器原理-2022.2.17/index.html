<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="å®æˆ˜ï¼šè°ƒåº¦å™¨åŸç†-2022.2.17, OnlyYou">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>å®æˆ˜ï¼šè°ƒåº¦å™¨åŸç†-2022.2.17 | OnlyYou</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">OnlyYou</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>ç•™è¨€æ¿</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>å‹æƒ…é“¾æ¥</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">OnlyYou</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			ç•™è¨€æ¿
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			å‹æƒ…é“¾æ¥
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">å®æˆ˜ï¼šè°ƒåº¦å™¨åŸç†-2022.2.17</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/k8s/">
                                <span class="chip bg-color">k8s</span>
                            </a>
                        
                            <a href="/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/">
                                <span class="chip bg-color">è°ƒåº¦å™¨</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/k8s/" class="post-category">
                                k8s
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2022-02-17
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="å®æˆ˜ï¼šè°ƒåº¦å™¨åŸç†-2022-2-17"><a href="#å®æˆ˜ï¼šè°ƒåº¦å™¨åŸç†-2022-2-17" class="headerlink" title="å®æˆ˜ï¼šè°ƒåº¦å™¨åŸç†-2022.2.17"></a>å®æˆ˜ï¼šè°ƒåº¦å™¨åŸç†-2022.2.17</h2><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220216084018744.png" alt="image-20220216084018744"></p>
<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><p>[TOC]</p>
<h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å®éªŒç¯å¢ƒï¼š</span><br><span class="line">1ã€win10,vmwrokstationè™šæœºï¼›</span><br><span class="line">2ã€k8sé›†ç¾¤ï¼š3å°centos7.6 1810è™šæœºï¼Œ1ä¸ªmasterèŠ‚ç‚¹,2ä¸ªnodeèŠ‚ç‚¹</span><br><span class="line">   k8s versionï¼šv1.22.2</span><br><span class="line">   containerd://1.5.5</span><br></pre></td></tr></table></figure>

<h2 id="å®éªŒè½¯ä»¶"><a href="#å®éªŒè½¯ä»¶" class="headerlink" title="å®éªŒè½¯ä»¶"></a>å®éªŒè½¯ä»¶</h2><p>æ— </p>
<h2 id="1ã€è°ƒåº¦å™¨"><a href="#1ã€è°ƒåº¦å™¨" class="headerlink" title="1ã€è°ƒåº¦å™¨"></a>1ã€è°ƒåº¦å™¨</h2><p><code>kube-scheduler</code> æ˜¯ kubernetes çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œä¸»è¦è´Ÿè´£æ•´ä¸ªé›†ç¾¤èµ„æºçš„è°ƒåº¦åŠŸèƒ½ï¼Œæ ¹æ®<strong>ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œç­–ç•¥</strong>ï¼Œå°† Pod è°ƒåº¦åˆ°æœ€ä¼˜çš„å·¥ä½œèŠ‚ç‚¹ä¸Šé¢å»ï¼Œä»è€Œæ›´åŠ åˆç†ã€æ›´åŠ å……åˆ†çš„åˆ©ç”¨é›†ç¾¤çš„èµ„æºï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ kubernetes ä¸€ä¸ªéå¸¸é‡è¦çš„ç†ç”±ã€‚å¦‚æœä¸€é—¨æ–°çš„æŠ€æœ¯ä¸èƒ½å¸®åŠ©ä¼ä¸šèŠ‚çº¦æˆæœ¬ã€æä¾›æ•ˆç‡ï¼Œæˆ‘ç›¸ä¿¡æ˜¯å¾ˆéš¾æ¨è¿›çš„ã€‚</p>
<h2 id="2ã€è°ƒåº¦æµç¨‹"><a href="#2ã€è°ƒåº¦æµç¨‹" class="headerlink" title="2ã€è°ƒåº¦æµç¨‹"></a>2ã€è°ƒåº¦æµç¨‹</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>kube-scheduler</code> æä¾›çš„é»˜è®¤è°ƒåº¦å™¨èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬ç»å¤§å¤šæ•°çš„è¦æ±‚ï¼Œæˆ‘ä»¬å‰é¢å’Œå¤§å®¶æ¥è§¦çš„ç¤ºä¾‹ä¹ŸåŸºæœ¬ä¸Šç”¨çš„<strong>é»˜è®¤çš„ç­–ç•¥</strong>ï¼Œéƒ½å¯ä»¥ä¿è¯æˆ‘ä»¬çš„ Pod å¯ä»¥è¢«åˆ†é…åˆ°èµ„æºå……è¶³çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä½†æ˜¯åœ¨å®é™…çš„çº¿ä¸Šé¡¹ç›®ä¸­ï¼Œå¯èƒ½æˆ‘ä»¬è‡ªå·±ä¼šæ¯” kubernetes æ›´åŠ äº†è§£æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ª Pod åªèƒ½è¿è¡Œåœ¨ç‰¹å®šçš„å‡ ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæˆ–è€…è¿™å‡ ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æ¥è¿è¡Œç‰¹å®šç±»å‹çš„åº”ç”¨ï¼Œè¿™å°±<strong>éœ€è¦æˆ‘ä»¬çš„è°ƒåº¦å™¨èƒ½å¤Ÿå¯æ§</strong>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ä¾‹å¦‚ï¼šéšä¾¿å¯¼å‡ºä¸€ä¸ªpodçš„yamlæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å…¶é»˜è®¤è°ƒåº¦å™¨å°±æ˜¯`default-scheduler`.</span><br><span class="line">$ kubectl get po apisix-etcd-0 -napisix -oyam</span><br><span class="line">â€¦â€¦</span><br><span class="line">schedulerName: default-scheduler</span><br><span class="line">â€¦â€¦</span><br><span class="line"></span><br><span class="line">ä¹Ÿå°±æ˜¯k8sé›†ç¾¤é»˜è®¤ä½¿ç”¨çš„ï¼š</span><br><span class="line">$ kubectl get po -A</span><br><span class="line">â€¦â€¦</span><br><span class="line">kube-system            kube-scheduler-master1                             1/1     Running    3 (27d ago)   108d</span><br></pre></td></tr></table></figure>

<p><code>kube-scheduler</code> çš„ä¸»è¦ä½œç”¨å°±æ˜¯æ ¹æ®ç‰¹å®šçš„<strong>è°ƒåº¦ç®—æ³•å’Œè°ƒåº¦ç­–ç•¥</strong>å°† Pod è°ƒåº¦åˆ°åˆé€‚çš„ Node èŠ‚ç‚¹ä¸Šå»ï¼Œ<strong>æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶ç¨‹åº</strong>ï¼Œ<strong>å¯åŠ¨ä¹‹åä¼šä¸€ç›´ç›‘å¬ API Serverï¼Œè·å–åˆ° <code>PodSpec.NodeName</code> ä¸ºç©ºçš„ Podï¼Œå¯¹æ¯ä¸ª Pod éƒ½ä¼šåˆ›å»ºä¸€ä¸ª bindingã€‚</strong></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220114165101.png" alt="kube-scheduler structrue"></p>
<p>è¿™ä¸ªè¿‡ç¨‹åœ¨æˆ‘ä»¬çœ‹æ¥å¥½åƒæ¯”è¾ƒç®€å•ï¼Œä½†åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜å°±æœ‰å¾ˆå¤šäº†ï¼š</p>
<ul>
<li>å¦‚ä½•ä¿è¯å…¨éƒ¨çš„èŠ‚ç‚¹è°ƒåº¦çš„å…¬å¹³æ€§ï¼Ÿè¦çŸ¥é“å¹¶ä¸æ˜¯æ‰€æœ‰èŠ‚ç‚¹èµ„æºé…ç½®ä¸€å®šéƒ½æ˜¯ä¸€æ ·çš„</li>
<li>å¦‚ä½•ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½èƒ½è¢«åˆ†é…èµ„æºï¼Ÿ</li>
<li>é›†ç¾¤èµ„æºå¦‚ä½•èƒ½å¤Ÿè¢«é«˜æ•ˆåˆ©ç”¨ï¼Ÿ</li>
<li>é›†ç¾¤èµ„æºå¦‚ä½•æ‰èƒ½è¢«æœ€å¤§åŒ–ä½¿ç”¨ï¼Ÿ</li>
<li><strong>å¦‚ä½•ä¿è¯ Pod è°ƒåº¦çš„æ€§èƒ½å’Œæ•ˆç‡ï¼Ÿ</strong>(å‡è®¾è¯´æœ‰1wä¸ªèŠ‚ç‚¹ï¼Œæˆ‘æ˜¯å¦å¯ä»¥åœ¨å…¶ä¸­1kä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œç­›é€‰å‘¢ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¹…åº¦æé«˜è°ƒåº¦æ•ˆç‡äº†ğŸ˜€)</li>
<li>ç”¨æˆ·æ˜¯å¦å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚å®šåˆ¶è‡ªå·±çš„è°ƒåº¦ç­–ç•¥ï¼Ÿ</li>
</ul>
<p>è€ƒè™‘åˆ°å®é™…ç¯å¢ƒä¸­çš„å„ç§å¤æ‚æƒ…å†µï¼Œ<strong>kubernetes çš„è°ƒåº¦å™¨é‡‡ç”¨æ’ä»¶åŒ–çš„å½¢å¼å®ç°</strong>ï¼Œå¯ä»¥æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œå®šåˆ¶æˆ–è€…äºŒæ¬¡å¼€å‘ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè°ƒåº¦å™¨å¹¶ä»¥æ’ä»¶å½¢å¼å’Œ kubernetes è¿›è¡Œé›†æˆã€‚</p>
<blockquote>
<p>å¼€å‘äººå‘˜æ³¨æ„å³å¯ï¼š</p>
<p>kubernetes è°ƒåº¦å™¨çš„æºç ä½äº <code>kubernetes/pkg/scheduler</code> ä¸­ï¼Œå…¶ä¸­ Scheduler åˆ›å»ºå’Œè¿è¡Œçš„æ ¸å¿ƒç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ <code>pkg/scheduler/scheduler.go</code>ï¼Œå¦‚æœè¦æŸ¥çœ‹ <code>kube-scheduler</code> çš„å…¥å£ç¨‹åºï¼Œå¯¹åº”çš„ä»£ç åœ¨ <code>cmd/kube-scheduler/scheduler.go</code>ã€‚</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github1s.com/kubernetes/kubernetes/tree/v1.22.5">https://github1s.com/kubernetes/kubernetes/tree/v1.22.5</a></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220216165230058.png" alt="image-20220216165230058"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220216165341841.png" alt="image-20220216165341841"></p>
<p>è°ƒåº¦ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>é¦–å…ˆæ˜¯<strong>é¢„é€‰è¿‡ç¨‹</strong>ï¼Œè¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º <code>Predicates</code>ï¼ˆè¿‡æ»¤ï¼‰</li>
<li>ç„¶åæ˜¯<strong>ä¼˜é€‰è¿‡ç¨‹</strong>ï¼Œå¯¹é€šè¿‡çš„èŠ‚ç‚¹æŒ‰ç…§ä¼˜å…ˆçº§æ’åºï¼Œç§°ä¹‹ä¸º <code>Priorities</code>ï¼ˆæ‰“åˆ†ï¼‰</li>
<li>æœ€åä»ä¸­é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹ï¼Œå¦‚æœä¸­é—´ä»»ä½•ä¸€æ­¥éª¤æœ‰é”™è¯¯ï¼Œå°±ç›´æ¥è¿”å›é”™è¯¯</li>
</ul>
<p><code>Predicates</code> é˜¶æ®µé¦–å…ˆéå†å…¨éƒ¨èŠ‚ç‚¹ï¼Œè¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œå±äº<code>å¼ºåˆ¶æ€§</code>è§„åˆ™ï¼Œè¿™ä¸€é˜¶æ®µè¾“å‡ºçš„æ‰€æœ‰æ»¡è¶³è¦æ±‚çš„èŠ‚ç‚¹å°†è¢«è®°å½•å¹¶ä½œä¸ºç¬¬äºŒé˜¶æ®µçš„è¾“å…¥ï¼Œ<strong>å¦‚æœæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¸æ»¡è¶³æ¡ä»¶ï¼Œé‚£ä¹ˆ Pod å°†ä¼šä¸€ç›´å¤„äº Pending çŠ¶æ€ï¼Œç›´åˆ°æœ‰èŠ‚ç‚¹æ»¡è¶³æ¡ä»¶ï¼Œåœ¨è¿™æœŸé—´è°ƒåº¦å™¨ä¼šä¸æ–­çš„é‡è¯•ã€‚</strong></p>
<p><u>æ‰€ä»¥æˆ‘ä»¬åœ¨éƒ¨ç½²åº”ç”¨çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°æœ‰ Pod ä¸€ç›´å¤„äº Pending çŠ¶æ€ï¼Œé‚£ä¹ˆå°±æ˜¯æ²¡æœ‰æ»¡è¶³è°ƒåº¦æ¡ä»¶çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å»æ£€æŸ¥ä¸‹èŠ‚ç‚¹èµ„æºæ˜¯å¦å¯ç”¨ã€‚</u></p>
<p><code>Priorities</code> é˜¶æ®µå³å†æ¬¡å¯¹èŠ‚ç‚¹è¿›è¡Œç­›é€‰ï¼Œå¦‚æœæœ‰å¤šä¸ªèŠ‚ç‚¹éƒ½æ»¡è¶³æ¡ä»¶çš„è¯ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šæŒ‰ç…§èŠ‚ç‚¹çš„ä¼˜å…ˆçº§(<code>priorites</code>)å¤§å°å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œæœ€åé€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„èŠ‚ç‚¹æ¥éƒ¨ç½² Pod åº”ç”¨ã€‚</p>
<blockquote>
<p>01ã€å¦‚æœä½ çš„podå¤„äºpendingçŠ¶æ€ï¼Œé‚£ä¹ˆä¸€å®šå°±æ˜¯è°ƒåº¦å™¨å‡ºç°äº†é—®é¢˜ï¼Œé‚£ä¹ˆåŸå› ä¼šå¾ˆå¤šï¼Œæœ‰å¯èƒ½æ˜¯ä½ çš„nodeèµ„æºä¸è¶³ï¼Œæœ‰å¯èƒ½æ˜¯ä½ çš„èŠ‚ç‚¹å·²ç»è¢«å ç”¨äº†â€¦â€¦(å› æ­¤éœ€è¦ä½¿ç”¨kubectl describle pod xxxæ¥æŸ¥çœ‹åŸå› )</p>
<p>02ã€æ‰€è°“çš„bingæ“ä½œå°±æ˜¯å¦‚ä¸‹ï¼š<br>$ kubectl get po apisix-etcd-0 -napisix -oyaml<br>â€¦â€¦<br>nodeName: node2 #å°†podçš„é…ç½®æ¸…å•çš„nodeNameå­—æ®µè¡¥å……å®Œæˆã€‚<br>â€¦â€¦</p>
</blockquote>
<p>ä¸‹é¢æ˜¯è°ƒåº¦è¿‡ç¨‹çš„ç®€å•ç¤ºæ„å›¾ï¼š</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220114165333.png" alt="kube-scheduler filter"></p>
<p>æ›´è¯¦ç»†çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li><p>é¦–å…ˆï¼Œå®¢æˆ·ç«¯é€šè¿‡ API Server çš„ REST API æˆ–è€… kubectl å·¥å…·åˆ›å»º Pod èµ„æº</p>
</li>
<li><p>API Server æ”¶åˆ°ç”¨æˆ·è¯·æ±‚åï¼Œå­˜å‚¨ç›¸å…³æ•°æ®åˆ° etcd æ•°æ®åº“ä¸­</p>
</li>
<li><p>è°ƒåº¦å™¨ç›‘å¬ API Server æŸ¥çœ‹åˆ°è¿˜æœªè¢«è°ƒåº¦(bind)çš„ Pod åˆ—è¡¨ï¼Œå¾ªç¯éå†åœ°ä¸ºæ¯ä¸ª Pod å°è¯•åˆ†é…èŠ‚ç‚¹ï¼Œè¿™ä¸ªåˆ†é…è¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ä¸¤ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>é¢„é€‰é˜¶æ®µ(Predicates)ï¼Œè¿‡æ»¤èŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨ç”¨<strong>ä¸€ç»„è§„åˆ™</strong>è¿‡æ»¤æ‰ä¸ç¬¦åˆè¦æ±‚çš„ Node èŠ‚ç‚¹ï¼Œæ¯”å¦‚ Pod è®¾ç½®äº†èµ„æºçš„ requestï¼Œé‚£ä¹ˆå¯ç”¨èµ„æºæ¯” Pod éœ€è¦çš„èµ„æºå°‘çš„ä¸»æœºæ˜¾ç„¶å°±ä¼šè¢«è¿‡æ»¤æ‰</li>
<li>ä¼˜é€‰é˜¶æ®µ(Priorities)ï¼Œä¸ºèŠ‚ç‚¹çš„ä¼˜å…ˆçº§æ‰“åˆ†ï¼Œå°†ä¸Šä¸€é˜¶æ®µè¿‡æ»¤å‡ºæ¥çš„ Node åˆ—è¡¨è¿›è¡Œæ‰“åˆ†ï¼Œ<strong>è°ƒåº¦å™¨ä¼šè€ƒè™‘ä¸€äº›æ•´ä½“çš„ä¼˜åŒ–ç­–ç•¥</strong>ï¼Œæ¯”å¦‚æŠŠ Deployment æ§åˆ¶çš„å¤šä¸ª Pod å‰¯æœ¬å°½é‡åˆ†å¸ƒåˆ°ä¸åŒçš„ä¸»æœºä¸Šï¼Œä½¿ç”¨æœ€ä½è´Ÿè½½çš„ä¸»æœºç­‰ç­‰ç­–ç•¥</li>
</ul>
</li>
<li><p>ç»è¿‡ä¸Šé¢çš„é˜¶æ®µè¿‡æ»¤åé€‰æ‹©æ‰“åˆ†æœ€é«˜çš„ Node èŠ‚ç‚¹å’Œ Pod è¿›è¡Œ <code>binding</code> æ“ä½œï¼Œç„¶åå°†ç»“æœå­˜å‚¨åˆ° etcd ä¸­ï¼Œ æœ€åè¢«é€‰æ‹©å‡ºæ¥çš„ Node èŠ‚ç‚¹å¯¹åº”çš„ kubelet å»æ‰§è¡Œåˆ›å»º Pod çš„ç›¸å…³æ“ä½œï¼ˆå½“ç„¶ä¹Ÿæ˜¯ watch APIServer å‘ç°çš„ï¼‰ã€‚</p>
</li>
</ul>
<p><strong>ç›®å‰è°ƒåº¦å™¨å·²ç»å…¨éƒ¨é€šè¿‡æ’ä»¶çš„æ–¹å¼å®ç°äº†è°ƒåº¦æ¡†æ¶</strong>ï¼Œé»˜è®¤å¼€å¯çš„è°ƒåº¦æ’ä»¶å¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pkg/scheduler/algorithmprovider/registry.go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDefaultConfig</span><span class="params">()</span> *<span class="title">schedulerapi</span>.<span class="title">Plugins</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;schedulerapi.Plugins&#123;</span><br><span class="line">        QueueSort: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: queuesort.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        PreFilter: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: noderesources.FitName&#125;,</span><br><span class="line">                &#123;Name: nodeports.Name&#125;,</span><br><span class="line">                &#123;Name: podtopologyspread.Name&#125;,</span><br><span class="line">                &#123;Name: interpodaffinity.Name&#125;,</span><br><span class="line">                &#123;Name: volumebinding.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        Filter: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: nodeunschedulable.Name&#125;,</span><br><span class="line">                &#123;Name: noderesources.FitName&#125;,</span><br><span class="line">                &#123;Name: nodename.Name&#125;,</span><br><span class="line">                &#123;Name: nodeports.Name&#125;,</span><br><span class="line">                &#123;Name: nodeaffinity.Name&#125;,</span><br><span class="line">                &#123;Name: volumerestrictions.Name&#125;,</span><br><span class="line">                &#123;Name: tainttoleration.Name&#125;,</span><br><span class="line">                &#123;Name: nodevolumelimits.EBSName&#125;,</span><br><span class="line">                &#123;Name: nodevolumelimits.GCEPDName&#125;,</span><br><span class="line">                &#123;Name: nodevolumelimits.CSIName&#125;,</span><br><span class="line">                &#123;Name: nodevolumelimits.AzureDiskName&#125;,</span><br><span class="line">                &#123;Name: volumebinding.Name&#125;,</span><br><span class="line">                &#123;Name: volumezone.Name&#125;,</span><br><span class="line">                &#123;Name: podtopologyspread.Name&#125;,</span><br><span class="line">                &#123;Name: interpodaffinity.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        PostFilter: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: defaultpreemption.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        PreScore: &amp;schedulerapi.PluginSet&#123; #æ‰“åˆ†</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: interpodaffinity.Name&#125;,</span><br><span class="line">                &#123;Name: podtopologyspread.Name&#125;,</span><br><span class="line">                &#123;Name: tainttoleration.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        Score: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: noderesources.BalancedAllocationName, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: imagelocality.Name, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: interpodaffinity.Name, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: noderesources.LeastAllocatedName, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: nodeaffinity.Name, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">                &#123;Name: nodepreferavoidpods.Name, Weight: <span class="number">10000</span>&#125;,</span><br><span class="line">                <span class="comment">// Weight is doubled because:</span></span><br><span class="line">                <span class="comment">// - This is a score coming from user preference.</span></span><br><span class="line">                <span class="comment">// - It makes its signal comparable to NodeResourcesLeastAllocated.</span></span><br><span class="line">                &#123;Name: podtopologyspread.Name, Weight: <span class="number">2</span>&#125;,</span><br><span class="line">                &#123;Name: tainttoleration.Name, Weight: <span class="number">1</span>&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        Reserve: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: volumebinding.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        PreBind: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: volumebinding.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        Bind: &amp;schedulerapi.PluginSet&#123;</span><br><span class="line">            Enabled: []schedulerapi.Plugin&#123;</span><br><span class="line">                &#123;Name: defaultbinder.Name&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè°ƒåº¦å™¨çš„ä¸€ç³»åˆ—ç®—æ³•ç”±å„ç§æ’ä»¶åœ¨è°ƒåº¦çš„ä¸åŒé˜¶æ®µæ¥å®Œæˆï¼Œä¸‹é¢æˆ‘ä»¬å°±å…ˆæ¥äº†è§£ä¸‹è°ƒåº¦æ¡†æ¶ã€‚</p>
<h3 id="1-è°ƒåº¦æ¡†æ¶"><a href="#1-è°ƒåº¦æ¡†æ¶" class="headerlink" title="1.è°ƒåº¦æ¡†æ¶"></a>1.è°ƒåº¦æ¡†æ¶</h3><p>è°ƒåº¦æ¡†æ¶å®šä¹‰äº†ä¸€ç»„æ‰©å±•ç‚¹ï¼Œç”¨æˆ·å¯ä»¥å®ç°æ‰©å±•ç‚¹å®šä¹‰çš„æ¥å£æ¥å®šä¹‰è‡ªå·±çš„è°ƒåº¦é€»è¾‘ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º<strong>æ‰©å±•</strong>ï¼‰ï¼Œå¹¶å°†æ‰©å±•æ³¨å†Œåˆ°æ‰©å±•ç‚¹ä¸Šï¼Œè°ƒåº¦æ¡†æ¶åœ¨æ‰§è¡Œè°ƒåº¦å·¥ä½œæµæ—¶ï¼Œé‡åˆ°å¯¹åº”çš„æ‰©å±•ç‚¹æ—¶ï¼Œå°†è°ƒç”¨ç”¨æˆ·æ³¨å†Œçš„æ‰©å±•ã€‚è°ƒåº¦æ¡†æ¶åœ¨é¢„ç•™æ‰©å±•ç‚¹æ—¶ï¼Œéƒ½æ˜¯æœ‰ç‰¹å®šçš„ç›®çš„ï¼Œæœ‰äº›æ‰©å±•ç‚¹ä¸Šçš„æ‰©å±•å¯ä»¥æ”¹å˜è°ƒåº¦ç¨‹åºçš„å†³ç­–æ–¹æ³•ï¼Œæœ‰äº›æ‰©å±•ç‚¹ä¸Šçš„æ‰©å±•åªæ˜¯å‘é€ä¸€ä¸ªé€šçŸ¥ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“æ¯å½“è°ƒåº¦ä¸€ä¸ª Pod æ—¶ï¼Œéƒ½ä¼šæŒ‰ç…§ä¸¤ä¸ªè¿‡ç¨‹æ¥æ‰§è¡Œï¼š<strong>è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹</strong>ã€‚</p>
<p>è°ƒåº¦è¿‡ç¨‹ä¸º Pod é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„èŠ‚ç‚¹ï¼Œç»‘å®šè¿‡ç¨‹åˆ™å°†è°ƒåº¦è¿‡ç¨‹çš„å†³ç­–åº”ç”¨åˆ°é›†ç¾¤ä¸­ï¼ˆä¹Ÿå°±æ˜¯åœ¨è¢«é€‰å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡Œ Podï¼‰ï¼Œå°†è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹åˆåœ¨ä¸€èµ·ï¼Œç§°ä¹‹ä¸º<strong>è°ƒåº¦ä¸Šä¸‹æ–‡ï¼ˆscheduling contextï¼‰</strong>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯**<u>è°ƒåº¦è¿‡ç¨‹æ˜¯<code>åŒæ­¥</code>è¿è¡Œçš„ï¼ˆåŒä¸€æ—¶é—´ç‚¹åªä¸ºä¸€ä¸ª Pod è¿›è¡Œè°ƒåº¦ï¼‰</u>**ï¼Œç»‘å®šè¿‡ç¨‹å¯å¼‚æ­¥è¿è¡Œï¼ˆåŒä¸€æ—¶é—´ç‚¹å¯å¹¶å‘ä¸ºå¤šä¸ª Pod æ‰§è¡Œç»‘å®šï¼‰ã€‚</p>
<p>è°ƒåº¦è¿‡ç¨‹å’Œç»‘å®šè¿‡ç¨‹é‡åˆ°å¦‚ä¸‹æƒ…å†µæ—¶ä¼šä¸­é€”é€€å‡ºï¼š</p>
<ul>
<li>è°ƒåº¦ç¨‹åºè®¤ä¸ºå½“å‰æ²¡æœ‰è¯¥ Pod çš„å¯é€‰èŠ‚ç‚¹</li>
<li>å†…éƒ¨é”™è¯¯</li>
</ul>
<p>è¿™ä¸ªæ—¶å€™ï¼Œè¯¥ Pod å°†è¢«æ”¾å›åˆ° <strong>å¾…è°ƒåº¦é˜Ÿåˆ—</strong>ï¼Œå¹¶ç­‰å¾…ä¸‹æ¬¡é‡è¯•ã€‚</p>
<h4 id="1-æ‰©å±•ç‚¹ï¼ˆExtension-Pointsï¼‰"><a href="#1-æ‰©å±•ç‚¹ï¼ˆExtension-Pointsï¼‰" class="headerlink" title="1.æ‰©å±•ç‚¹ï¼ˆExtension Pointsï¼‰"></a>1.æ‰©å±•ç‚¹ï¼ˆExtension Pointsï¼‰</h4><p>ä¸‹å›¾å±•ç¤ºäº†è°ƒåº¦æ¡†æ¶ä¸­çš„è°ƒåº¦ä¸Šä¸‹æ–‡åŠå…¶ä¸­çš„æ‰©å±•ç‚¹ï¼Œä¸€ä¸ªæ‰©å±•å¯ä»¥æ³¨å†Œå¤šä¸ªæ‰©å±•ç‚¹ï¼Œä»¥ä¾¿å¯ä»¥æ‰§è¡Œæ›´å¤æ‚çš„æœ‰çŠ¶æ€çš„ä»»åŠ¡ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20220114165454.png" alt="scheduling framework extensions"></p>
<ol>
<li><code>QueueSort</code> æ‰©å±•ç”¨äºå¯¹ Pod çš„å¾…è°ƒåº¦é˜Ÿåˆ—è¿›è¡Œæ’åºï¼Œä»¥å†³å®šå…ˆè°ƒåº¦å“ªä¸ª Podï¼Œ<code>QueueSort</code> æ‰©å±•æœ¬è´¨ä¸Šåªéœ€è¦å®ç°ä¸€ä¸ªæ–¹æ³• <code>Less(Pod1, Pod2)</code> ç”¨äºæ¯”è¾ƒä¸¤ä¸ª Pod è°æ›´ä¼˜å…ˆè·å¾—è°ƒåº¦å³å¯ï¼ŒåŒä¸€æ—¶é—´ç‚¹åªèƒ½æœ‰ä¸€ä¸ª <code>QueueSort</code> æ’ä»¶ç”Ÿæ•ˆã€‚</li>
<li><code>Pre-filter</code> æ‰©å±•ç”¨äºå¯¹ Pod çš„ä¿¡æ¯è¿›è¡Œé¢„å¤„ç†ï¼Œæˆ–è€…æ£€æŸ¥ä¸€äº›é›†ç¾¤æˆ– Pod å¿…é¡»æ»¡è¶³çš„å‰ææ¡ä»¶ï¼Œå¦‚æœ <code>pre-filter</code> è¿”å›äº† errorï¼Œåˆ™è°ƒåº¦è¿‡ç¨‹ç»ˆæ­¢ã€‚</li>
<li><code>Filter</code> æ‰©å±•ç”¨äºæ’é™¤é‚£äº›ä¸èƒ½è¿è¡Œè¯¥ Pod çš„èŠ‚ç‚¹ï¼Œå¯¹äºæ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨å°†æŒ‰é¡ºåºæ‰§è¡Œ <code>filter</code> æ‰©å±•ï¼›å¦‚æœä»»ä½•ä¸€ä¸ª <code>filter</code> å°†èŠ‚ç‚¹æ ‡è®°ä¸ºä¸å¯é€‰ï¼Œåˆ™ä½™ä¸‹çš„ <code>filter</code> æ‰©å±•å°†ä¸ä¼šè¢«æ‰§è¡Œã€‚<strong>è°ƒåº¦å™¨å¯ä»¥åŒæ—¶å¯¹å¤šä¸ªèŠ‚ç‚¹æ‰§è¡Œ <code>filter</code> æ‰©å±•ã€‚</strong></li>
<li><code>Post-filter</code> æ˜¯ä¸€ä¸ªé€šçŸ¥ç±»å‹çš„æ‰©å±•ç‚¹ï¼Œè°ƒç”¨è¯¥æ‰©å±•çš„å‚æ•°æ˜¯ <code>filter</code> é˜¶æ®µç»“æŸåè¢«ç­›é€‰ä¸º<strong>å¯é€‰èŠ‚ç‚¹</strong>çš„èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¯ä»¥åœ¨æ‰©å±•ä¸­ä½¿ç”¨è¿™äº›ä¿¡æ¯æ›´æ–°å†…éƒ¨çŠ¶æ€ï¼Œæˆ–è€…äº§ç”Ÿæ—¥å¿—æˆ– metrics ä¿¡æ¯ã€‚</li>
<li><code>Scoring</code> æ‰©å±•ç”¨äºä¸ºæ‰€æœ‰å¯é€‰èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ï¼Œè°ƒåº¦å™¨å°†é’ˆå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹è°ƒç”¨ <code>Soring</code> æ‰©å±•ï¼Œè¯„åˆ†ç»“æœæ˜¯ä¸€ä¸ªèŒƒå›´å†…çš„æ•´æ•°ã€‚åœ¨ <code>normalize scoring</code> é˜¶æ®µï¼Œè°ƒåº¦å™¨å°†ä¼šæŠŠæ¯ä¸ª <code>scoring</code> æ‰©å±•å¯¹å…·ä½“æŸä¸ªèŠ‚ç‚¹çš„è¯„åˆ†ç»“æœå’Œè¯¥æ‰©å±•çš„æƒé‡åˆå¹¶èµ·æ¥ï¼Œä½œä¸ºæœ€ç»ˆè¯„åˆ†ç»“æœã€‚</li>
<li><code>Normalize scoring</code> æ‰©å±•åœ¨è°ƒåº¦å™¨å¯¹èŠ‚ç‚¹è¿›è¡Œæœ€ç»ˆæ’åºä¹‹å‰ä¿®æ”¹æ¯ä¸ªèŠ‚ç‚¹çš„è¯„åˆ†ç»“æœï¼Œæ³¨å†Œåˆ°è¯¥æ‰©å±•ç‚¹çš„æ‰©å±•åœ¨è¢«è°ƒç”¨æ—¶ï¼Œå°†è·å¾—åŒä¸€ä¸ªæ’ä»¶ä¸­çš„ <code>scoring</code> æ‰©å±•çš„è¯„åˆ†ç»“æœä½œä¸ºå‚æ•°ï¼Œè°ƒåº¦æ¡†æ¶æ¯æ‰§è¡Œä¸€æ¬¡è°ƒåº¦ï¼Œéƒ½å°†è°ƒç”¨æ‰€æœ‰æ’ä»¶ä¸­çš„ä¸€ä¸ª <code>normalize scoring</code> æ‰©å±•ä¸€æ¬¡ã€‚</li>
<li><code>Reserve</code> æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ç‚¹ï¼Œæœ‰çŠ¶æ€çš„æ’ä»¶å¯ä»¥ä½¿ç”¨è¯¥æ‰©å±•ç‚¹æ¥è·å¾—èŠ‚ç‚¹ä¸Šä¸º Pod é¢„ç•™çš„èµ„æºï¼Œè¯¥äº‹ä»¶å‘ç”Ÿåœ¨è°ƒåº¦å™¨å°† Pod ç»‘å®šåˆ°èŠ‚ç‚¹ä¹‹å‰ï¼Œç›®çš„æ˜¯é¿å…è°ƒåº¦å™¨åœ¨ç­‰å¾… Pod ä¸èŠ‚ç‚¹ç»‘å®šçš„è¿‡ç¨‹ä¸­è°ƒåº¦æ–°çš„ Pod åˆ°èŠ‚ç‚¹ä¸Šæ—¶ï¼Œå‘ç”Ÿå®é™…ä½¿ç”¨èµ„æºè¶…å‡ºå¯ç”¨èµ„æºçš„æƒ…å†µï¼ˆå› ä¸ºç»‘å®š Pod åˆ°èŠ‚ç‚¹ä¸Šæ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼‰ã€‚è¿™æ˜¯è°ƒåº¦è¿‡ç¨‹çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼ŒPod è¿›å…¥ reserved çŠ¶æ€ä»¥åï¼Œè¦ä¹ˆåœ¨ç»‘å®šå¤±è´¥æ—¶è§¦å‘ Unreserve æ‰©å±•ï¼Œè¦ä¹ˆåœ¨ç»‘å®šæˆåŠŸæ—¶ï¼Œç”± Post-bind æ‰©å±•ç»“æŸç»‘å®šè¿‡ç¨‹ã€‚</li>
<li><code>Permit</code> æ‰©å±•ç”¨äºé˜»æ­¢æˆ–è€…å»¶è¿Ÿ Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šã€‚Permit æ‰©å±•å¯ä»¥åšä¸‹é¢ä¸‰ä»¶äº‹ä¸­çš„ä¸€é¡¹ï¼š<ul>
<li>approveï¼ˆæ‰¹å‡†ï¼‰ï¼šå½“æ‰€æœ‰çš„ permit æ‰©å±•éƒ½ approve äº† Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼Œè°ƒåº¦å™¨å°†ç»§ç»­æ‰§è¡Œç»‘å®šè¿‡ç¨‹</li>
<li>denyï¼ˆæ‹’ç»ï¼‰ï¼šå¦‚æœä»»ä½•ä¸€ä¸ª permit æ‰©å±• deny äº† Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ <code>Unreserve</code> æ‰©å±•</li>
<li>waitï¼ˆç­‰å¾…ï¼‰ï¼šå¦‚æœä¸€ä¸ª permit æ‰©å±•è¿”å›äº† waitï¼Œåˆ™ Pod å°†ä¿æŒåœ¨ permit é˜¶æ®µï¼Œç›´åˆ°è¢«å…¶ä»–æ‰©å±• approveï¼Œå¦‚æœè¶…æ—¶äº‹ä»¶å‘ç”Ÿï¼Œwait çŠ¶æ€å˜æˆ denyï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ Unreserve æ‰©å±•</li>
</ul>
</li>
<li><code>Pre-bind</code> æ‰©å±•ç”¨äºåœ¨ Pod ç»‘å®šä¹‹å‰æ‰§è¡ŒæŸäº›é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œpre-bind æ‰©å±•å¯ä»¥å°†ä¸€ä¸ªåŸºäºç½‘ç»œçš„æ•°æ®å·æŒ‚è½½åˆ°èŠ‚ç‚¹ä¸Šï¼Œä»¥ä¾¿ Pod å¯ä»¥ä½¿ç”¨ã€‚å¦‚æœä»»ä½•ä¸€ä¸ª <code>pre-bind</code> æ‰©å±•è¿”å›é”™è¯¯ï¼ŒPod å°†è¢«æ”¾å›åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ï¼Œæ­¤æ—¶å°†è§¦å‘ Unreserve æ‰©å±•ã€‚</li>
<li><code>Bind</code> æ‰©å±•ç”¨äºå°† Pod ç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šï¼š<ul>
<li>åªæœ‰æ‰€æœ‰çš„ pre-bind æ‰©å±•éƒ½æˆåŠŸæ‰§è¡Œäº†ï¼Œbind æ‰©å±•æ‰ä¼šæ‰§è¡Œ</li>
<li>è°ƒåº¦æ¡†æ¶æŒ‰ç…§ bind æ‰©å±•æ³¨å†Œçš„é¡ºåºé€ä¸ªè°ƒç”¨ bind æ‰©å±•</li>
<li>å…·ä½“æŸä¸ª bind æ‰©å±•å¯ä»¥é€‰æ‹©å¤„ç†æˆ–è€…ä¸å¤„ç†è¯¥ Pod</li>
<li>å¦‚æœæŸä¸ª bind æ‰©å±•å¤„ç†äº†è¯¥ Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šï¼Œä½™ä¸‹çš„ bind æ‰©å±•å°†è¢«å¿½ç•¥</li>
</ul>
</li>
<li><code>Post-bind</code> æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ï¼š<ul>
<li>Post-bind æ‰©å±•åœ¨ Pod æˆåŠŸç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šä¹‹åè¢«åŠ¨è°ƒç”¨</li>
<li>Post-bind æ‰©å±•æ˜¯ç»‘å®šè¿‡ç¨‹çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œèµ„æºæ¸…ç†çš„åŠ¨ä½œ</li>
</ul>
</li>
<li><code>Unreserve</code> æ˜¯ä¸€ä¸ªé€šçŸ¥æ€§è´¨çš„æ‰©å±•ï¼Œå¦‚æœä¸º Pod é¢„ç•™äº†èµ„æºï¼ŒPod åˆåœ¨è¢«ç»‘å®šè¿‡ç¨‹ä¸­è¢«æ‹’ç»ç»‘å®šï¼Œåˆ™ unreserve æ‰©å±•å°†è¢«è°ƒç”¨ã€‚Unreserve æ‰©å±•åº”è¯¥é‡Šæ”¾å·²ç»ä¸º Pod é¢„ç•™çš„èŠ‚ç‚¹ä¸Šçš„è®¡ç®—èµ„æºã€‚åœ¨ä¸€ä¸ªæ’ä»¶ä¸­ï¼Œreserve æ‰©å±•å’Œ unreserve æ‰©å±•åº”è¯¥æˆå¯¹å‡ºç°ã€‚</li>
</ol>
<p>å¦‚æœæˆ‘ä»¬è¦å®ç°è‡ªå·±çš„æ’ä»¶ï¼Œå¿…é¡»å‘è°ƒåº¦æ¡†æ¶æ³¨å†Œæ’ä»¶å¹¶å®Œæˆé…ç½®ï¼Œå¦å¤–è¿˜å¿…é¡»å®ç°<strong>æ‰©å±•ç‚¹æ¥å£</strong>ï¼Œå¯¹åº”çš„æ‰©å±•ç‚¹æ¥å£æˆ‘ä»¬å¯ä»¥åœ¨æºç  <code>pkg/scheduler/framework/v1alpha1/interface.go</code> æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Plugin is the parent type for all the scheduling framework plugins.</span></span><br><span class="line"><span class="keyword">type</span> Plugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Name() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> QueueSortPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Less(*PodInfo, *PodInfo) <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PreFilterPlugin is an interface that must be implemented by &quot;prefilter&quot; plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called at the beginning of the scheduling cycle.</span></span><br><span class="line"><span class="keyword">type</span> PreFilterPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    PreFilter(pc *PluginContext, p *v1.Pod) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FilterPlugin is an interface for Filter plugins. These plugins are called at the</span></span><br><span class="line"><span class="comment">// filter extension point for filtering out hosts that cannot run a pod.</span></span><br><span class="line"><span class="comment">// This concept used to be called &#x27;predicate&#x27; in the original scheduler.</span></span><br><span class="line"><span class="comment">// These plugins should return &quot;Success&quot;, &quot;Unschedulable&quot; or &quot;Error&quot; in Status.code.</span></span><br><span class="line"><span class="comment">// However, the scheduler accepts other valid codes as well.</span></span><br><span class="line"><span class="comment">// Anything other than &quot;Success&quot; will lead to exclusion of the given host from</span></span><br><span class="line"><span class="comment">// running the pod.</span></span><br><span class="line"><span class="keyword">type</span> FilterPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Filter(pc *PluginContext, pod *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PostFilterPlugin is an interface for Post-filter plugin. Post-filter is an</span></span><br><span class="line"><span class="comment">// informational extension point. Plugins will be called with a list of nodes</span></span><br><span class="line"><span class="comment">// that passed the filtering phase. A plugin may use this data to update internal</span></span><br><span class="line"><span class="comment">// state or to generate logs/metrics.</span></span><br><span class="line"><span class="keyword">type</span> PostFilterPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    PostFilter(pc *PluginContext, pod *v1.Pod, nodes []*v1.Node, filteredNodesStatuses NodeToStatusMap) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ScorePlugin is an interface that must be implemented by &quot;score&quot; plugins to rank</span></span><br><span class="line"><span class="comment">// nodes that passed the filtering phase.</span></span><br><span class="line"><span class="keyword">type</span> ScorePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Score(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) (<span class="keyword">int</span>, *Status)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ScoreWithNormalizePlugin is an interface that must be implemented by &quot;score&quot;</span></span><br><span class="line"><span class="comment">// plugins that also need to normalize the node scoring results produced by the same</span></span><br><span class="line"><span class="comment">// plugin&#x27;s &quot;Score&quot; method.</span></span><br><span class="line"><span class="keyword">type</span> ScoreWithNormalizePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    ScorePlugin</span><br><span class="line">    NormalizeScore(pc *PluginContext, p *v1.Pod, scores NodeScoreList) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReservePlugin is an interface for Reserve plugins. These plugins are called</span></span><br><span class="line"><span class="comment">// at the reservation point. These are meant to update the state of the plugin.</span></span><br><span class="line"><span class="comment">// This concept used to be called &#x27;assume&#x27; in the original scheduler.</span></span><br><span class="line"><span class="comment">// These plugins should return only Success or Error in Status.code. However,</span></span><br><span class="line"><span class="comment">// the scheduler accepts other valid codes as well. Anything other than Success</span></span><br><span class="line"><span class="comment">// will lead to rejection of the pod.</span></span><br><span class="line"><span class="keyword">type</span> ReservePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Reserve(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PreBindPlugin is an interface that must be implemented by &quot;prebind&quot; plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called before a pod being scheduled.</span></span><br><span class="line"><span class="keyword">type</span> PreBindPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    PreBind(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PostBindPlugin is an interface that must be implemented by &quot;postbind&quot; plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called after a pod is successfully bound to a node.</span></span><br><span class="line"><span class="keyword">type</span> PostBindPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    PostBind(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnreservePlugin is an interface for Unreserve plugins. This is an informational</span></span><br><span class="line"><span class="comment">// extension point. If a pod was reserved and then rejected in a later phase, then</span></span><br><span class="line"><span class="comment">// un-reserve plugins will be notified. Un-reserve plugins should clean up state</span></span><br><span class="line"><span class="comment">// associated with the reserved Pod.</span></span><br><span class="line"><span class="keyword">type</span> UnreservePlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Unreserve(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PermitPlugin is an interface that must be implemented by &quot;permit&quot; plugins.</span></span><br><span class="line"><span class="comment">// These plugins are called before a pod is bound to a node.</span></span><br><span class="line"><span class="keyword">type</span> PermitPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Permit(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) (*Status, time.Duration)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BindPlugin is an interface that must be implemented by &quot;bind&quot; plugins. Bind</span></span><br><span class="line"><span class="comment">// plugins are used to bind a pod to a Node.</span></span><br><span class="line"><span class="keyword">type</span> BindPlugin <span class="keyword">interface</span> &#123;</span><br><span class="line">    Plugin</span><br><span class="line">    Bind(pc *PluginContext, p *v1.Pod, nodeName <span class="keyword">string</span>) *Status</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºè°ƒåº¦æ¡†æ¶æ’ä»¶çš„å¯ç”¨æˆ–è€…ç¦ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®‰è£…é›†ç¾¤æ—¶çš„ <a target="_blank" rel="noopener" href="https://godoc.org/k8s.io/kubernetes/pkg/scheduler/apis/config#KubeSchedulerConfiguration">KubeSchedulerConfiguration</a> èµ„æºå¯¹è±¡æ¥è¿›è¡Œé…ç½®ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­çš„é…ç½®å¯ç”¨äº†ä¸€ä¸ªå®ç°äº† <code>reserve</code> å’Œ <code>preBind</code> æ‰©å±•ç‚¹çš„æ’ä»¶ï¼Œå¹¶ä¸”ç¦ç”¨äº†å¦å¤–ä¸€ä¸ªæ’ä»¶ï¼ŒåŒæ—¶ä¸ºæ’ä»¶ foo æä¾›äº†ä¸€äº›é…ç½®ä¿¡æ¯ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeSchedulerConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="attr">reserve:</span></span><br><span class="line">    <span class="attr">enabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">    <span class="attr">disabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">baz</span></span><br><span class="line">  <span class="attr">preBind:</span></span><br><span class="line">    <span class="attr">enabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">disabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">baz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pluginConfig:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">  <span class="attr">args:</span> <span class="string">&gt;</span></span><br><span class="line">    <span class="string">fooæ’ä»¶å¯ä»¥è§£æçš„ä»»æ„å†…å®¹</span></span><br></pre></td></tr></table></figure>



<p>æ‰©å±•çš„è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœæŸä¸ªæ‰©å±•ç‚¹æ²¡æœ‰é…ç½®å¯¹åº”çš„æ‰©å±•ï¼Œè°ƒåº¦æ¡†æ¶å°†ä½¿ç”¨é»˜è®¤æ’ä»¶ä¸­çš„æ‰©å±•</li>
<li>å¦‚æœä¸ºæŸä¸ªæ‰©å±•ç‚¹é…ç½®ä¸”æ¿€æ´»äº†æ‰©å±•ï¼Œåˆ™è°ƒåº¦æ¡†æ¶å°†å…ˆè°ƒç”¨é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œå†è°ƒç”¨é…ç½®ä¸­çš„æ‰©å±•</li>
<li>é»˜è®¤æ’ä»¶çš„æ‰©å±•å§‹ç»ˆè¢«æœ€å…ˆè°ƒç”¨ï¼Œç„¶åæŒ‰ç…§ <code>KubeSchedulerConfiguration</code> ä¸­æ‰©å±•çš„æ¿€æ´» <code>enabled</code> é¡ºåºé€ä¸ªè°ƒç”¨æ‰©å±•ç‚¹çš„æ‰©å±•</li>
<li>å¯ä»¥å…ˆç¦ç”¨é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œç„¶ååœ¨ <code>enabled</code> åˆ—è¡¨ä¸­çš„æŸä¸ªä½ç½®æ¿€æ´»é»˜è®¤æ’ä»¶çš„æ‰©å±•ï¼Œè¿™ç§åšæ³•å¯ä»¥æ”¹å˜é»˜è®¤æ’ä»¶çš„æ‰©å±•è¢«è°ƒç”¨æ—¶çš„é¡ºåº</li>
</ul>
<p>å‡è®¾é»˜è®¤æ’ä»¶ foo å®ç°äº† <code>reserve</code> æ‰©å±•ç‚¹ï¼Œæ­¤æ—¶æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªæ’ä»¶ barï¼Œæƒ³è¦åœ¨ foo ä¹‹å‰è¢«è°ƒç”¨ï¼Œåˆ™åº”è¯¥å…ˆç¦ç”¨ foo å†æŒ‰ç…§ bar foo çš„é¡ºåºæ¿€æ´»ã€‚ç¤ºä¾‹é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">KubeSchedulerConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span></span><br><span class="line">  <span class="attr">reserve:</span></span><br><span class="line">    <span class="attr">enabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">disabled:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br></pre></td></tr></table></figure>

<p>åœ¨æºç ç›®å½• <code>pkg/scheduler/framework/plugins/examples</code> ä¸­æœ‰å‡ ä¸ªç¤ºèŒƒæ’ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å‚ç…§å…¶å®ç°æ–¹å¼ã€‚</p>
<h4 id="2-ç¤ºä¾‹"><a href="#2-ç¤ºä¾‹" class="headerlink" title="2.ç¤ºä¾‹"></a>2.ç¤ºä¾‹</h4><blockquote>
<p>å› ä¸ºæ¶‰åŠåˆ°ä»£ç éƒ¨åˆ†ï¼Œæœ¬æ¬¡è¿™é‡Œä¸åšæ¼”ç¤ºï¼Œçœ‹ä¸‹å°±å¥½ã€‚</p>
</blockquote>
<p>å…¶å®è¦å®ç°ä¸€ä¸ªè°ƒåº¦æ¡†æ¶çš„æ’ä»¶ï¼Œå¹¶ä¸éš¾ï¼Œæˆ‘ä»¬åªè¦å®ç°å¯¹åº”çš„æ‰©å±•ç‚¹ï¼Œç„¶åå°†æ’ä»¶æ³¨å†Œåˆ°è°ƒåº¦å™¨ä¸­å³å¯ï¼Œä¸‹é¢æ˜¯é»˜è®¤è°ƒåº¦å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œçš„æ’ä»¶ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pkg/scheduler/algorithmprovider/registry.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRegistry</span><span class="params">()</span> <span class="title">Registry</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Registry&#123;</span><br><span class="line">        <span class="comment">// FactoryMap:</span></span><br><span class="line">        <span class="comment">// New plugins are registered here.</span></span><br><span class="line">        <span class="comment">// example:</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//  stateful_plugin.Name: stateful.NewStatefulMultipointExample,</span></span><br><span class="line">        <span class="comment">//  fooplugin.Name: fooplugin.New,</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¯ä»¥çœ‹åˆ°é»˜è®¤å¹¶æ²¡æœ‰æ³¨å†Œä¸€äº›æ’ä»¶ï¼Œæ‰€ä»¥è¦æƒ³è®©è°ƒåº¦å™¨èƒ½å¤Ÿè¯†åˆ«æˆ‘ä»¬çš„æ’ä»¶ä»£ç ï¼Œå°±éœ€è¦è‡ªå·±æ¥å®ç°ä¸€ä¸ªè°ƒåº¦å™¨äº†ï¼Œå½“ç„¶è¿™ä¸ªè°ƒåº¦å™¨æˆ‘ä»¬å®Œå…¨æ²¡å¿…è¦å®Œå…¨è‡ªå·±å®ç°ï¼Œç›´æ¥è°ƒç”¨é»˜è®¤çš„è°ƒåº¦å™¨ï¼Œç„¶ååœ¨ä¸Šé¢çš„ <code>NewRegistry()</code> å‡½æ•°ä¸­å°†æˆ‘ä»¬çš„æ’ä»¶æ³¨å†Œè¿›å»å³å¯ã€‚åœ¨ <code>kube-scheduler</code> çš„æºç æ–‡ä»¶ <code>kubernetes/cmd/kube-scheduler/app/server.go</code> ä¸­æœ‰ä¸€ä¸ª <code>NewSchedulerCommand</code> å…¥å£å‡½æ•°ï¼Œå…¶ä¸­çš„å‚æ•°æ˜¯ä¸€ä¸ªç±»å‹ä¸º <code>Option</code> çš„åˆ—è¡¨ï¼Œè€Œè¿™ä¸ª <code>Option</code> æ°å¥½å°±æ˜¯ä¸€ä¸ªæ’ä»¶é…ç½®çš„å®šä¹‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Option configures a framework.Registry.</span></span><br><span class="line"><span class="keyword">type</span> Option <span class="function"><span class="keyword">func</span><span class="params">(framework.Registry)</span> <span class="title">error</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NewSchedulerCommand creates a *cobra.Command object with default parameters and registryOptions</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSchedulerCommand</span><span class="params">(registryOptions ...Option)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬å®Œå…¨å°±å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥ä½œä¸ºæˆ‘ä»¬çš„å‡½æ•°å…¥å£ï¼Œå¹¶ä¸”ä¼ å…¥æˆ‘ä»¬è‡ªå·±å®ç°çš„æ’ä»¶ä½œä¸ºå‚æ•°å³å¯ï¼Œè€Œä¸”è¯¥æ–‡ä»¶ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªåä¸º <code>WithPlugin</code> çš„å‡½æ•°å¯ä»¥æ¥åˆ›å»ºä¸€ä¸ª <code>Option</code> å®ä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WithPlugin creates an Option based on plugin name and factory.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithPlugin</span><span class="params">(name <span class="keyword">string</span>, factory framework.PluginFactory)</span> <span class="title">Option</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(registry framework.Registry)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> registry.Register(name, factory)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬çš„å…¥å£å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    rand.Seed(time.Now().UTC().UnixNano())</span><br><span class="line"></span><br><span class="line">    command := app.NewSchedulerCommand(</span><br><span class="line">        app.WithPlugin(sample.Name, sample.New),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    logs.InitLogs()</span><br><span class="line">    <span class="keyword">defer</span> logs.FlushLogs()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := command.Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        _, _ = fmt.Fprintf(os.Stderr, <span class="string">&quot;%v\n&quot;</span>, err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>app.WithPlugin(sample.Name, sample.New)</code> å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦å®ç°çš„æ’ä»¶ï¼Œä» <code>WithPlugin</code> å‡½æ•°çš„å‚æ•°ä¹Ÿå¯ä»¥çœ‹å‡ºæˆ‘ä»¬è¿™é‡Œçš„ <code>sample.New</code> å¿…é¡»æ˜¯ä¸€ä¸ª <code>framework.PluginFactory</code> ç±»å‹çš„å€¼ï¼Œè€Œ <code>PluginFactory</code> çš„å®šä¹‰å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error)</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ <code>sample.New</code> å®é™…ä¸Šå°±æ˜¯ä¸Šé¢çš„è¿™ä¸ªå‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥è·å–åˆ°æ’ä»¶ä¸­çš„ä¸€äº›æ•°æ®ç„¶åè¿›è¡Œé€»è¾‘å¤„ç†å³å¯ï¼Œæ’ä»¶å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ç®€å•è·å–ä¸‹æ•°æ®æ‰“å°æ—¥å¿—ï¼Œå¦‚æœä½ æœ‰å®é™…éœ€æ±‚çš„å¯ä»¥æ ¹æ®è·å–çš„æ•°æ®å°±è¡Œå¤„ç†å³å¯ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯å®ç°äº† <code>PreFilter</code>ã€<code>Filter</code>ã€<code>PreBind</code> ä¸‰ä¸ªæ‰©å±•ç‚¹ï¼Œå…¶ä»–çš„å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼æ¥æ‰©å±•å³å¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ’ä»¶åç§°</span></span><br><span class="line"><span class="keyword">const</span> Name = <span class="string">&quot;sample-plugin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Args <span class="keyword">struct</span> &#123;</span><br><span class="line">    FavoriteColor  <span class="keyword">string</span> <span class="string">`json:&quot;favorite_color,omitempty&quot;`</span></span><br><span class="line">    FavoriteNumber <span class="keyword">int</span>    <span class="string">`json:&quot;favorite_number,omitempty&quot;`</span></span><br><span class="line">    ThanksTo       <span class="keyword">string</span> <span class="string">`json:&quot;thanks_to,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Sample <span class="keyword">struct</span> &#123;</span><br><span class="line">    args   *Args</span><br><span class="line">    handle framework.FrameworkHandle</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">Name</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">PreFilter</span><span class="params">(pc *framework.PluginContext, pod *v1.Pod)</span> *<span class="title">framework</span>.<span class="title">Status</span></span> &#123;</span><br><span class="line">    klog.V(<span class="number">3</span>).Infof(<span class="string">&quot;prefilter pod: %v&quot;</span>, pod.Name)</span><br><span class="line">    <span class="keyword">return</span> framework.NewStatus(framework.Success, <span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">Filter</span><span class="params">(pc *framework.PluginContext, pod *v1.Pod, nodeName <span class="keyword">string</span>)</span> *<span class="title">framework</span>.<span class="title">Status</span></span> &#123;</span><br><span class="line">    klog.V(<span class="number">3</span>).Infof(<span class="string">&quot;filter pod: %v, node: %v&quot;</span>, pod.Name, nodeName)</span><br><span class="line">    <span class="keyword">return</span> framework.NewStatus(framework.Success, <span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Sample)</span> <span class="title">PreBind</span><span class="params">(pc *framework.PluginContext, pod *v1.Pod, nodeName <span class="keyword">string</span>)</span> *<span class="title">framework</span>.<span class="title">Status</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> nodeInfo, ok := s.handle.NodeInfoSnapshot().NodeInfoMap[nodeName]; !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> framework.NewStatus(framework.Error, fmt.Sprintf(<span class="string">&quot;prebind get node info error: %+v&quot;</span>, nodeName))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        klog.V(<span class="number">3</span>).Infof(<span class="string">&quot;prebind node info: %+v&quot;</span>, nodeInfo.Node())</span><br><span class="line">        <span class="keyword">return</span> framework.NewStatus(framework.Success, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(configuration *runtime.Unknown, f framework.FrameworkHandle)</span> <span class="params">(framework.Plugin, error)</span></span> &#123;</span><br><span class="line">    args := &amp;Args&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> err := framework.DecodeInto(configuration, args); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    klog.V(<span class="number">3</span>).Infof(<span class="string">&quot;get plugin config args: %+v&quot;</span>, args)</span><br><span class="line">    <span class="keyword">return</span> &amp;Sample&#123;</span><br><span class="line">        args: args,</span><br><span class="line">        handle: f,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®Œæ•´ä»£ç å¯ä»¥å‰å¾€ä»“åº“ <a target="_blank" rel="noopener" href="https://github.com/cnych/sample-scheduler-framework">https://github.com/cnych/sample-scheduler-framework</a> è·å–ã€‚</p>
</blockquote>
<p>å®ç°å®Œæˆåï¼Œç¼–è¯‘æ‰“åŒ…æˆé•œåƒå³å¯ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å½“æˆæ™®é€šçš„åº”ç”¨ç”¨ä¸€ä¸ª <code>Deployment</code> æ§åˆ¶å™¨æ¥éƒ¨ç½²å³å¯ï¼Œç”±äºæˆ‘ä»¬éœ€è¦å»è·å–é›†ç¾¤ä¸­çš„ä¸€äº›èµ„æºå¯¹è±¡ï¼Œæ‰€ä»¥å½“ç„¶éœ€è¦ç”³è¯· RBAC æƒé™ï¼Œç„¶ååŒæ ·é€šè¿‡ <code>--config</code> å‚æ•°æ¥é…ç½®æˆ‘ä»¬çš„è°ƒåº¦å™¨ï¼ŒåŒæ ·è¿˜æ˜¯ä½¿ç”¨ä¸€ä¸ª <code>KubeSchedulerConfiguration</code> èµ„æºå¯¹è±¡é…ç½®ï¼Œå¯ä»¥é€šè¿‡ <code>plugins</code> æ¥å¯ç”¨æˆ–è€…ç¦ç”¨æˆ‘ä»¬å®ç°çš„æ’ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>pluginConfig</code> æ¥ä¼ é€’ä¸€äº›å‚æ•°å€¼ç»™æ’ä»¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-clusterrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bindings</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods/binding</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">replicationcontrollers</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">replicasets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">statefulsets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">policy</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">poddisruptionbudgets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">persistentvolumeclaims</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">persistentvolumes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;storage.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">storageclasses</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">csinodes</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;coordination.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">leases</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;events.k8s.io&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">events</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-sa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-clusterrolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-clusterrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler-sa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">scheduler-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">scheduler-config.yaml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    apiVersion: kubescheduler.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">    kind: KubeSchedulerConfiguration</span></span><br><span class="line"><span class="string">    leaderElection:</span></span><br><span class="line"><span class="string">      leaderElect: true</span></span><br><span class="line"><span class="string">      leaseDuration: 15s</span></span><br><span class="line"><span class="string">      renewDeadline: 10s</span></span><br><span class="line"><span class="string">      resourceLock: endpointsleases</span></span><br><span class="line"><span class="string">      resourceName: sample-scheduler</span></span><br><span class="line"><span class="string">      resourceNamespace: kube-system</span></span><br><span class="line"><span class="string">      retryPeriod: 2s</span></span><br><span class="line"><span class="string">    profiles:</span></span><br><span class="line"><span class="string">      - schedulerName: sample-scheduler</span></span><br><span class="line"><span class="string">        plugins:</span></span><br><span class="line"><span class="string">          preFilter:</span></span><br><span class="line"><span class="string">            enabled:</span></span><br><span class="line"><span class="string">              - name: &quot;sample-plugin&quot;</span></span><br><span class="line"><span class="string">          filter:</span></span><br><span class="line"><span class="string">            enabled:</span></span><br><span class="line"><span class="string">              - name: &quot;sample-plugin&quot;</span></span><br><span class="line"><span class="string">        pluginConfig:</span></span><br><span class="line"><span class="string">          - name: sample-plugin</span></span><br><span class="line"><span class="string">            args:  # runtime.Object</span></span><br><span class="line"><span class="string">              favorColor: &quot;#326CE5&quot;</span></span><br><span class="line"><span class="string">              favorNumber: 7</span></span><br><span class="line"><span class="string">              thanksTo: &quot;Kubernetes&quot;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sample-scheduler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">sample-scheduler</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">sample-scheduler</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">sample-scheduler</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">sample-scheduler-sa</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">scheduler-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">scheduler-config</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">scheduler</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">cnych/sample-scheduler:v0.2.4</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sample-scheduler</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--config=/etc/kubernetes/scheduler-config.yaml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--v=3</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">scheduler-config</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes</span></span><br><span class="line"><span class="comment">#          livenessProbe:</span></span><br><span class="line"><span class="comment">#            httpGet:</span></span><br><span class="line"><span class="comment">#              path: /healthz</span></span><br><span class="line"><span class="comment">#              port: 10251</span></span><br><span class="line"><span class="comment">#            initialDelaySeconds: 15</span></span><br><span class="line"><span class="comment">#          readinessProbe:</span></span><br><span class="line"><span class="comment">#            httpGet:</span></span><br><span class="line"><span class="comment">#              path: /healthz</span></span><br><span class="line"><span class="comment">#              port: 10251</span></span><br></pre></td></tr></table></figure>

<p>ç›´æ¥éƒ¨ç½²ä¸Šé¢çš„èµ„æºå¯¹è±¡å³å¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±éƒ¨ç½²äº†ä¸€ä¸ªåä¸º <code>sample-scheduler</code> çš„è°ƒåº¦å™¨äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥éƒ¨ç½²ä¸€ä¸ªåº”ç”¨æ¥ä½¿ç”¨è¿™ä¸ªè°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-scheduler</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test-scheduler</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test-scheduler</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">sample-scheduler</span>  <span class="comment"># æŒ‡å®šä½¿ç”¨çš„è°ƒåº¦å™¨ï¼Œä¸æŒ‡å®šä½¿ç”¨é»˜è®¤çš„default-scheduler</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ç°åœ¨æ‰‹åŠ¨æŒ‡å®šäº†ä¸€ä¸ª <code>schedulerName</code> çš„å­—æ®µï¼Œå°†å…¶è®¾ç½®æˆä¸Šé¢æˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨åç§° <code>sample-scheduler</code>ã€‚</p>
<p>æˆ‘ä»¬ç›´æ¥åˆ›å»ºè¿™ä¸ªèµ„æºå¯¹è±¡ï¼Œåˆ›å»ºå®ŒæˆåæŸ¥çœ‹æˆ‘ä»¬è‡ªå®šä¹‰è°ƒåº¦å™¨çš„æ—¥å¿—ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get pods -n kube-system -l component=sample-scheduler</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">sample-scheduler-896658cd7-k7vcl   1/1     Running   0          57s</span><br><span class="line">âœ kubectl logs -f sample-scheduler-896658cd7-k7vcl -n kube-system</span><br><span class="line">I0114 09:14:18.878613       1 eventhandlers.go:173] add event <span class="keyword">for</span> unscheduled pod default/test-scheduler-6486fd49fc-zjhcx</span><br><span class="line">I0114 09:14:18.878670       1 scheduler.go:464] Attempting to schedule pod: default/test-scheduler-6486fd49fc-zjhcx</span><br><span class="line">I0114 09:14:18.878706       1 sample.go:77] <span class="string">&quot;Start PreFilter Pod&quot;</span> pod=<span class="string">&quot;test-scheduler-6486fd49fc-zjhcx&quot;</span></span><br><span class="line">I0114 09:14:18.878802       1 sample.go:93] <span class="string">&quot;Start Filter Pod&quot;</span> pod=<span class="string">&quot;test-scheduler-6486fd49fc-zjhcx&quot;</span> node=<span class="string">&quot;node2&quot;</span> preFilterState=&amp;&#123;Resource:&#123;MilliCPU:0 Memory:0 EphemeralStorage:0 AllowedPodNumber:0 ScalarResources:map[]&#125;&#125;</span><br><span class="line">I0114 09:14:18.878835       1 sample.go:93] <span class="string">&quot;Start Filter Pod&quot;</span> pod=<span class="string">&quot;test-scheduler-6486fd49fc-zjhcx&quot;</span> node=<span class="string">&quot;node1&quot;</span> preFilterState=&amp;&#123;Resource:&#123;MilliCPU:0 Memory:0 EphemeralStorage:0 AllowedPodNumber:0 ScalarResources:map[]&#125;&#125;</span><br><span class="line">I0114 09:14:18.879043       1 default_binder.go:51] Attempting to <span class="built_in">bind</span> default/test-scheduler-6486fd49fc-zjhcx to node1</span><br><span class="line">I0114 09:14:18.886360       1 scheduler.go:609] <span class="string">&quot;Successfully bound pod to node&quot;</span> pod=<span class="string">&quot;default/test-scheduler-6486fd49fc-zjhcx&quot;</span> node=<span class="string">&quot;node1&quot;</span> evaluatedNodes=3 feasibleNodes=2</span><br><span class="line">I0114 09:14:18.887426       1 eventhandlers.go:205] delete event <span class="keyword">for</span> unscheduled pod default/test-scheduler-6486fd49fc-zjhcx</span><br><span class="line">I0114 09:14:18.887475       1 eventhandlers.go:225] add event <span class="keyword">for</span> scheduled pod default/test-scheduler-6486fd49fc-zjhcx</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å½“æˆ‘ä»¬åˆ›å»ºå®Œ Pod åï¼Œåœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„è°ƒåº¦å™¨ä¸­å°±å‡ºç°äº†å¯¹åº”çš„æ—¥å¿—ï¼Œå¹¶ä¸”åœ¨æˆ‘ä»¬å®šä¹‰çš„æ‰©å±•ç‚¹ä¸Šé¢éƒ½å‡ºç°äº†å¯¹åº”çš„æ—¥å¿—ï¼Œè¯æ˜æˆ‘ä»¬çš„ç¤ºä¾‹æˆåŠŸäº†ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹ Pod çš„ <code>schedulerName</code> æ¥éªŒè¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">âœ kubectl get pods</span><br><span class="line">NAME                              READY   STATUS    RESTARTS       AGE</span><br><span class="line">test-scheduler-6486fd49fc-zjhcx   1/1     Running   0              35s</span><br><span class="line">âœ kubectl get pod test-scheduler-6486fd49fc-zjhcx -o yaml</span><br><span class="line">......</span><br><span class="line">restartPolicy: Always</span><br><span class="line">schedulerName: sample-scheduler</span><br><span class="line">securityContext: &#123;&#125;</span><br><span class="line">serviceAccount: default</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>ä» Kubernetes v1.17 ç‰ˆæœ¬å¼€å§‹ï¼Œ<code>Scheduler Framework</code> å†…ç½®çš„é¢„é€‰å’Œä¼˜é€‰å‡½æ•°å·²ç»å…¨éƒ¨æ’ä»¶åŒ–ï¼Œæ‰€ä»¥è¦æ‰©å±•è°ƒåº¦å™¨æˆ‘ä»¬åº”è¯¥æŒæ¡å¹¶ç†è§£è°ƒåº¦æ¡†æ¶è¿™ç§æ–¹å¼ã€‚</p>
<h2 id="3ã€è°ƒåº¦å™¨è°ƒä¼˜"><a href="#3ã€è°ƒåº¦å™¨è°ƒä¼˜" class="headerlink" title="3ã€è°ƒåº¦å™¨è°ƒä¼˜"></a>3ã€è°ƒåº¦å™¨è°ƒä¼˜</h2><p>ä½œä¸º kubernetes é›†ç¾¤çš„é»˜è®¤è°ƒåº¦å™¨ï¼Œkube-scheduler ä¸»è¦è´Ÿè´£å°† Pod è°ƒåº¦åˆ°é›†ç¾¤çš„ Node ä¸Šã€‚åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œæ»¡è¶³ä¸€ä¸ª Pod è°ƒåº¦è¯·æ±‚çš„æ‰€æœ‰èŠ‚ç‚¹ç§°ä¹‹ä¸º <code>å¯è°ƒåº¦ Node</code>ï¼Œè°ƒåº¦å™¨å…ˆåœ¨é›†ç¾¤ä¸­æ‰¾åˆ°ä¸€ä¸ª Pod çš„å¯è°ƒåº¦ Nodeï¼Œç„¶åæ ¹æ®ä¸€ç³»åˆ—å‡½æ•°å¯¹è¿™äº›å¯è°ƒåº¦ Node è¿›è¡Œæ‰“åˆ†ï¼Œä¹‹åé€‰å‡ºå…¶ä¸­å¾—åˆ†æœ€é«˜çš„ Node æ¥è¿è¡Œ Podï¼Œæœ€åï¼Œè°ƒåº¦å™¨å°†è¿™ä¸ªè°ƒåº¦å†³å®šå‘ŠçŸ¥ <code>kube-apiserver</code>ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš<strong>ç»‘å®š</strong>ã€‚</p>
<p>åœ¨ Kubernetes 1.12 ç‰ˆæœ¬ä¹‹å‰ï¼Œkube-scheduler ä¼šæ£€æŸ¥é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„å¯è°ƒåº¦æ€§ï¼Œå¹¶ä¸”ç»™å¯è°ƒåº¦èŠ‚ç‚¹æ‰“åˆ†ã€‚Kubernetes 1.12 ç‰ˆæœ¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„åŠŸèƒ½ï¼Œ<strong>å…è®¸è°ƒåº¦å™¨åœ¨æ‰¾åˆ°ä¸€å®šæ•°é‡çš„å¯è°ƒåº¦èŠ‚ç‚¹ä¹‹åå°±åœæ­¢ç»§ç»­å¯»æ‰¾å¯è°ƒåº¦èŠ‚ç‚¹</strong>ã€‚è¯¥åŠŸèƒ½èƒ½æé«˜è°ƒåº¦å™¨åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸‹çš„è°ƒåº¦æ€§èƒ½ï¼Œè¿™ä¸ªæ•°å€¼æ˜¯é›†ç¾¤è§„æ¨¡çš„ç™¾åˆ†æ¯”ï¼Œè¿™ä¸ªç™¾åˆ†æ¯”é€šè¿‡ <code>percentageOfNodesToScore</code> å‚æ•°æ¥è¿›è¡Œé…ç½®ï¼Œå…¶å€¼çš„èŒƒå›´åœ¨ 1 åˆ° 100 ä¹‹é—´ï¼Œæœ€å¤§å€¼å°±æ˜¯ 100%ï¼Œå¦‚æœè®¾ç½®ä¸º 0 å°±ä»£è¡¨æ²¡æœ‰æä¾›è¿™ä¸ªå‚æ•°é…ç½®ã€‚Kubernetes 1.14 ç‰ˆæœ¬åˆåŠ å…¥äº†ä¸€ä¸ªç‰¹æ€§ï¼Œåœ¨è¯¥å‚æ•°æ²¡æœ‰è¢«ç”¨æˆ·é…ç½®çš„æƒ…å†µä¸‹ï¼Œè°ƒåº¦å™¨ä¼šæ ¹æ®é›†ç¾¤çš„è§„æ¨¡è‡ªåŠ¨è®¾ç½®ä¸€ä¸ªé›†ç¾¤æ¯”ä¾‹ï¼Œç„¶åé€šè¿‡è¿™ä¸ªæ¯”ä¾‹ç­›é€‰ä¸€å®šæ•°é‡çš„å¯è°ƒåº¦èŠ‚ç‚¹è¿›å…¥æ‰“åˆ†é˜¶æ®µã€‚è¯¥ç‰¹æ€§ä½¿ç”¨<strong>çº¿æ€§å…¬å¼</strong>è®¡ç®—å‡ºé›†ç¾¤æ¯”ä¾‹ï¼Œæ¯”å¦‚100ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸‹ä¼šå– 50%ï¼Œåœ¨ 5000èŠ‚ç‚¹çš„é›†ç¾¤ä¸‹å– 10%ï¼Œè¿™ä¸ªè‡ªåŠ¨è®¾ç½®çš„å‚æ•°çš„æœ€ä½å€¼æ˜¯ 5%ï¼Œæ¢å¥è¯è¯´ï¼Œ<strong>è°ƒåº¦å™¨è‡³å°‘ä¼šå¯¹é›†ç¾¤ä¸­ 5% çš„èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†</strong>ï¼Œé™¤éç”¨æˆ·å°†è¯¥å‚æ•°è®¾ç½®çš„ä½äº 5ã€‚</p>
<p>æ³¨æ„</p>
<blockquote>
<p>å½“é›†ç¾¤ä¸­çš„å¯è°ƒåº¦èŠ‚ç‚¹å°‘äº 50 ä¸ªæ—¶ï¼Œè°ƒåº¦å™¨ä»ç„¶ä¼šå»æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹ï¼Œå› ä¸ºå¯è°ƒåº¦èŠ‚ç‚¹å¤ªå°‘ï¼Œä¸è¶³ä»¥åœæ­¢è°ƒåº¦å™¨æœ€åˆçš„è¿‡æ»¤é€‰æ‹©ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å…³æ‰è¿™ä¸ªèŒƒå›´å‚æ•°ï¼Œå¯ä»¥å°† <code>percentageOfNodesToScore</code> å€¼è®¾ç½®æˆ 100ã€‚</p>
</blockquote>
<p><code>percentageOfNodesToScore</code> çš„å€¼å¿…é¡»åœ¨ 1 åˆ° 100 ä¹‹é—´ï¼Œè€Œä¸”å…¶é»˜è®¤å€¼æ˜¯é€šè¿‡é›†ç¾¤çš„è§„æ¨¡è®¡ç®—å¾—æ¥çš„ï¼Œå¦å¤– <strong>50</strong> ä¸ª Node çš„æ•°å€¼æ˜¯ç¡¬ç¼–ç åœ¨ç¨‹åºé‡Œé¢çš„ï¼Œè®¾ç½®è¿™ä¸ªå€¼çš„ä½œç”¨åœ¨äºï¼š<strong>å½“é›†ç¾¤çš„è§„æ¨¡æ˜¯æ•°ç™¾ä¸ªèŠ‚ç‚¹å¹¶ä¸” percentageOfNodesToScore å‚æ•°è®¾ç½®çš„è¿‡ä½çš„æ—¶å€™ï¼Œè°ƒåº¦å™¨ç­›é€‰åˆ°çš„å¯è°ƒåº¦èŠ‚ç‚¹æ•°ç›®åŸºæœ¬ä¸ä¼šå—åˆ°è¯¥å‚æ•°å½±å“</strong>ã€‚å½“é›†ç¾¤è§„æ¨¡è¾ƒå°æ—¶ï¼Œè¿™ä¸ªè®¾ç½®å¯¹è°ƒåº¦å™¨æ€§èƒ½æå‡å¹¶ä¸æ˜æ˜¾ï¼Œä½†æ˜¯åœ¨è¶…è¿‡ 1000 ä¸ª Node çš„é›†ç¾¤ä¸­ï¼Œå°†è°ƒä¼˜å‚æ•°è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒä½çš„å€¼å¯ä»¥å¾ˆæ˜æ˜¾çš„æå‡è°ƒåº¦å™¨æ€§èƒ½ã€‚</p>
<p>ä¸è¿‡å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¯¥å‚æ•°è®¾ç½®åå¯èƒ½ä¼šå¯¼è‡´åªæœ‰é›†ç¾¤ä¸­å°‘æ•°èŠ‚ç‚¹è¢«é€‰ä¸ºå¯è°ƒåº¦èŠ‚ç‚¹ï¼Œå¾ˆå¤š Node éƒ½æ²¡æœ‰è¿›å…¥åˆ°æ‰“åˆ†é˜¶æ®µï¼Œè¿™æ ·å°±ä¼šé€ æˆä¸€ç§åæœï¼Œä¸€ä¸ªæœ¬æ¥å¯ä»¥åœ¨æ‰“åˆ†é˜¶æ®µå¾—åˆ†å¾ˆé«˜çš„ Node ç”šè‡³éƒ½ä¸èƒ½è¿›å…¥æ‰“åˆ†é˜¶æ®µï¼Œç”±äºè¿™ä¸ªåŸå› ï¼Œæ‰€ä»¥è¿™ä¸ªå‚æ•°ä¸åº”è¯¥è¢«è®¾ç½®æˆä¸€ä¸ªå¾ˆä½çš„å€¼ï¼Œ<strong>é€šå¸¸çš„åšæ³•æ˜¯ä¸ä¼šå°†è¿™ä¸ªå‚æ•°çš„å€¼è®¾ç½®çš„ä½äº 10</strong>ï¼Œå¾ˆä½çš„å‚æ•°å€¼ä¸€èˆ¬åœ¨è°ƒåº¦å™¨çš„ååé‡å¾ˆé«˜ä¸”å¯¹ Node çš„æ‰“åˆ†ä¸é‡è¦çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨ã€‚<strong>æ¢å¥è¯è¯´ï¼Œåªæœ‰å½“ä½ æ›´å€¾å‘äºåœ¨å¯è°ƒåº¦èŠ‚ç‚¹ä¸­ä»»æ„é€‰æ‹©ä¸€ä¸ª Node æ¥è¿è¡Œè¿™ä¸ª Pod æ—¶ï¼Œæ‰ä½¿ç”¨å¾ˆä½çš„å‚æ•°è®¾ç½®ã€‚</strong></p>
<p><strong>å¦‚æœä½ çš„é›†ç¾¤è§„æ¨¡åªæœ‰æ•°ç™¾ä¸ªèŠ‚ç‚¹æˆ–è€…æ›´å°‘ï¼Œå®é™…ä¸Šå¹¶ä¸æ¨èä½ å°†è¿™ä¸ªå‚æ•°è®¾ç½®å¾—æ¯”é»˜è®¤å€¼æ›´ä½ï¼Œå› ä¸ºè¿™ç§æƒ…å†µä¸‹ä¸å¤ªä¼šæœ‰æ•ˆçš„æé«˜è°ƒåº¦å™¨æ€§èƒ½ã€‚</strong></p>
<h2 id="4ã€ä¼˜å…ˆçº§è°ƒåº¦"><a href="#4ã€ä¼˜å…ˆçº§è°ƒåº¦" class="headerlink" title="4ã€ä¼˜å…ˆçº§è°ƒåº¦"></a>4ã€ä¼˜å…ˆçº§è°ƒåº¦</h2><p>ä¸å‰é¢æ‰€è®²çš„è°ƒåº¦ä¼˜é€‰ç­–ç•¥ä¸­çš„ä¼˜å…ˆçº§ï¼ˆPrioritiesï¼‰ä¸åŒï¼Œå‰é¢æ‰€è®²çš„ä¼˜å…ˆçº§æŒ‡çš„æ˜¯èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„ä¼˜å…ˆçº§æŒ‡çš„æ˜¯ <strong>Pod çš„ä¼˜å…ˆçº§</strong>ï¼Œé«˜ä¼˜å…ˆçº§çš„ Pod ä¼šä¼˜å…ˆè¢«è°ƒåº¦ï¼Œæˆ–è€…åœ¨èµ„æºä¸è¶³çš„æƒ…å†µç‰ºç‰²ä½ä¼˜å…ˆçº§çš„ Podï¼Œä»¥ä¾¿äºé‡è¦çš„ Pod èƒ½å¤Ÿå¾—åˆ°èµ„æºéƒ¨ç½²ã€‚</p>
<p>è¦å®šä¹‰ Pod ä¼˜å…ˆçº§ï¼Œå°±éœ€è¦å…ˆå®šä¹‰ <code>PriorityClass</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ²¡æœ‰ Namespace çš„é™åˆ¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">high-priority</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">1000000</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">&quot;This priority class should be used for XYZ service pods only.&quot;</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼š</p>
<ul>
<li>value ä¸º 32 ä½æ•´æ•°çš„ä¼˜å…ˆçº§ï¼Œè¯¥å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜</li>
<li>globalDefault ç”¨äºæœªé…ç½® PriorityClassName çš„ Podï¼Œæ•´ä¸ªé›†ç¾¤ä¸­åº”è¯¥åªæœ‰ä¸€ä¸ª <code>PriorityClass</code> å°†å…¶è®¾ç½®ä¸º true</li>
</ul>
<p>ç„¶åé€šè¿‡åœ¨ Pod çš„ <code>spec.priorityClassName</code> ä¸­æŒ‡å®šå·²å®šä¹‰çš„ <code>PriorityClass</code> åç§°å³å¯ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">high-priority</span></span><br></pre></td></tr></table></figure>

<p>å¦å¤–ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ˜¯å½“èŠ‚ç‚¹æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºä¾›è°ƒåº¦å™¨è°ƒåº¦ Podï¼Œå¯¼è‡´ Pod å¤„äº pending æ—¶ï¼Œ<strong>æŠ¢å ï¼ˆpreemptionï¼‰é€»è¾‘å°±ä¼šè¢«è§¦å‘</strong>ï¼ŒæŠ¢å ä¼šå°è¯•ä»ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤ä½ä¼˜å…ˆçº§çš„ Podï¼Œä»è€Œé‡Šæ”¾èµ„æºä½¿é«˜ä¼˜å…ˆçº§çš„ Pod å¾—åˆ°èŠ‚ç‚¹èµ„æºè¿›è¡Œéƒ¨ç½²ã€‚</p>
<h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘çš„åšå®¢ä¸»æ—¨ï¼šæˆ‘å¸Œæœ›æ¯ä¸€ä¸ªäººæ‹¿ç€æˆ‘çš„åšå®¢éƒ½å¯ä»¥åšå‡ºå®éªŒç°è±¡ï¼Œå…ˆæŠŠå®éªŒåšå‡ºæ¥ï¼Œç„¶åå†ç»“åˆç†è®ºçŸ¥è¯†æ›´æ·±å±‚æ¬¡å»ç†è§£æŠ€æœ¯ç‚¹ï¼Œè¿™æ ·å­¦ä¹ èµ·æ¥æ‰æœ‰ä¹è¶£å’ŒåŠ¨åŠ›ã€‚å¹¶ä¸”ï¼Œæˆ‘çš„åšå®¢å†…å®¹æ­¥éª¤æ˜¯å¾ˆå®Œæ•´çš„ï¼Œä¹Ÿåˆ†äº«æºç å’Œå®éªŒç”¨åˆ°çš„è½¯ä»¶ï¼Œå¸Œæœ›èƒ½å’Œå¤§å®¶ä¸€èµ·å…±åŒè¿›æ­¥ï¼</p>
<p>å„ä½å°ä¼™ä¼´åœ¨å®é™…æ“ä½œè¿‡ç¨‹ä¸­å¦‚æœ‰ä»€ä¹ˆç–‘é—®ï¼Œå¯éšæ—¶è”ç³»æœ¬äººå…è´¹å¸®æ‚¨è§£å†³é—®é¢˜ï¼š</p>
<ol>
<li><p>ä¸ªäººå¾®ä¿¡äºŒç»´ç ï¼šx2675263825 ï¼ˆèˆå¾—ï¼‰ï¼Œ qqï¼š2675263825ã€‚</p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144206.png" alt="image-20211002091450217"></p>
</li>
<li><p>ä¸ªäººåšå®¢åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://www.onlyonexl.cn/">www.onlyonexl.cn</a></p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144213.png" alt="image-20211002092057988"></p>
</li>
<li><p>ä¸ªäººå¾®ä¿¡å…¬ä¼—å·ï¼šäº‘åŸç”Ÿæ¶æ„å¸ˆå®æˆ˜</p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144224.png" alt="image-20211002141739664"></p>
</li>
<li><p>ä¸ªäººcsdn</p>
<p> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39246554?spm=1010.2135.3001.5421">https://blog.csdn.net/weixin_39246554?spm=1010.2135.3001.5421</a></p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144230.png" alt="image-20211002092344616"></p>
</li>
<li><p>ä¸ªäººå·²å¼€æºå¹²è´§ğŸ˜˜</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>é“¾æ¥</th>
</tr>
</thead>
<tbody><tr>
<td>01 å®æˆ˜ï¼šæ‰“é€ ä¸€æ¬¾ç‹è€…äº‘ç¬”è®°ï¼štypora+åšæœäº‘+é˜¿é‡Œäº‘oss</td>
<td><a target="_blank" rel="noopener" href="https://www.jianguoyun.com/p/DXS6qiIQvPWVCRiS0qoE">https://www.jianguoyun.com/p/DXS6qiIQvPWVCRiS0qoE</a></td>
</tr>
<tr>
<td>02 å®æˆ˜ï¼šå®šåˆ¶å®‡å®™ä¸­æœ€ç¾çš„typoraä¸»é¢˜çš®è‚¤</td>
<td><a target="_blank" rel="noopener" href="https://www.jianguoyun.com/p/DeUK9u0QvPWVCRib0qoE">https://www.jianguoyun.com/p/DeUK9u0QvPWVCRib0qoE</a></td>
</tr>
<tr>
<td>03 ç©è½¬vscode</td>
<td><a target="_blank" rel="noopener" href="https://www.jianguoyun.com/p/DZe8gmsQvPWVCRid0qoE">https://www.jianguoyun.com/p/DZe8gmsQvPWVCRid0qoE</a></td>
</tr>
<tr>
<td>04 é™ˆæœçš„å¹¸ç¦å“²å­¦è¯¾</td>
<td><a target="_blank" rel="noopener" href="https://www.jianguoyun.com/p/Db0kM7gQvPWVCRj2q6YE">https://www.jianguoyun.com/p/Db0kM7gQvPWVCRj2q6YE</a></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
<li><p>x</p>
</li>
</ol>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>â€‹    å¥½äº†ï¼Œå…³äºè°ƒåº¦å™¨éƒ¨åˆ†å°±åˆ°è¿™é‡Œäº†ï¼Œæ„Ÿè°¢å¤§å®¶é˜…è¯»ï¼Œæœ€åè´´ä¸Šæˆ‘å¥³ç¥çš„photoï¼Œç¥å¤§å®¶ç”Ÿæ´»å¿«ä¹ï¼Œæ¯å¤©éƒ½è¿‡çš„æœ‰æ„ä¹‰å“¦ï¼Œæˆ‘ä»¬ä¸‹æœŸè§ï¼</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220217191118541.png" alt="image-20220217191118541"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">ä¸€ä¸ªäºº</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.onlyyou520.com/2022/02/17/122%20%E5%AE%9E%E6%88%98%EF%BC%9A%E8%B0%83%E5%BA%A6%E5%99%A8%E5%8E%9F%E7%90%86-2022.2.17/">https://www.onlyyou520.com/2022/02/17/122%20%E5%AE%9E%E6%88%98%EF%BC%9A%E8%B0%83%E5%BA%A6%E5%99%A8%E5%8E%9F%E7%90%86-2022.2.17/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="/about" target="_blank">ä¸€ä¸ªäºº</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/k8s/">
                                    <span class="chip bg-color">k8s</span>
                                </a>
                            
                                <a href="/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/">
                                    <span class="chip bg-color">è°ƒåº¦å™¨</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2022/02/18/123%20%E5%AE%9E%E6%88%98%EF%BC%9Ak8s%E4%B9%8B%E4%BA%B2%E5%90%88%E6%80%A7%E8%B0%83%E5%BA%A6-2022.2.18/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="å®æˆ˜ï¼šk8sä¹‹äº²åˆæ€§è°ƒåº¦-2022.2.18">
                        
                        <span class="card-title">å®æˆ˜ï¼šk8sä¹‹äº²åˆæ€§è°ƒåº¦-2022.2.18</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-02-18
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/k8s/" class="post-category">
                                    k8s
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/k8s/">
                        <span class="chip bg-color">k8s</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/02/13/121%20%E5%AE%9E%E6%88%98%EF%BC%9AGateway%20API-2022.2.13/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="å®æˆ˜ï¼šGateway API-2022.2.13.md">
                        
                        <span class="card-title">å®æˆ˜ï¼šGateway API-2022.2.13.md</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-02-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/k8s/" class="post-category">
                                    k8s
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/k8s/">
                        <span class="chip bg-color">k8s</span>
                    </a>
                    
                    <a href="/tags/gateway-api/">
                        <span class="chip bg-color">gateway api</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">ä¸€ä¸ªäºº</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- è¿è¡Œå¤©æ•°æé†’. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/OnlyOnexl" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2675263825@qq.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2675263825" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 2675263825" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--è…¾è®¯å…”å°å·¢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
