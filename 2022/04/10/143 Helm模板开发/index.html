<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Helm模板开发, love">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Helm模板开发 | love</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">love</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">love</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Helm模板开发</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/k8s/">
                                <span class="chip bg-color">k8s</span>
                            </a>
                        
                            <a href="/tags/helm/">
                                <span class="chip bg-color">helm</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/k8s/" class="post-category">
                                k8s
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-04-10
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="Helm模板开发"><a href="#Helm模板开发" class="headerlink" title="Helm模板开发"></a>Helm模板开发</h2><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220405193525884.png" alt="image-20220405193525884"></p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>[TOC]</p>
<h2 id="1、内置对象"><a href="#1、内置对象" class="headerlink" title="1、内置对象"></a>1、内置对象</h2><p>前面我们介绍了 Helm Chart 的一些基本概念和使用，接下来我们重点介绍下 Chart 模板的编写。模板会渲染成 Kubernetes 的资源清单文件，下面我们将来学习下模板的结构，如何使用它们，如何编写 Go 模板以及如何调试。</p>
<p>对象从<strong>模板引擎</strong>传递到模板中，在代码中可以传递对象。也有一种方法可以在模板宏创建新的对象，比如 <code>tuple</code> 函数。对象可以很简单，也可以包含其他对象或函数，例如，Release 对象就包含几个对象（比如 Release.Name），Files 对象就包含几个函数。</p>
<p>前面提到过我们可以在模板中使用 <code>&#123;&#123; .Release.Name &#125;&#125;</code> 获取 release 的名称，Release 是我们可以在模板中访问的几个顶级对象之一：</p>
<ul>
<li><code>Release</code>：该对象描述了 release 本身的相关信息，它内部有几个对象：<ul>
<li><code>Release.Name</code>：release 名称</li>
<li><code>Release.Namespace</code>：release 安装到的命名空间</li>
<li><code>Release.IsUpgrade</code>：如果当前操作是升级或回滚，则该值为 true</li>
<li><code>Release.IsInstall</code>：如果当前操作是安装，则将其设置为 true</li>
<li><code>Release.Revision</code>：release 的 revision 版本号，在安装的时候，值为1，每次升级或回滚都会增加</li>
<li><code>Reelase.Service</code>：<strong>渲染当前模板的服务，在 Helm 上，实际上该值始终为 Helm</strong></li>
</ul>
</li>
<li><code>Values</code>：从 <code>values.yaml</code> 文件和用户提供的 values 文件传递到模板的 Values 值，默认情况下，Values 是空的。</li>
<li><code>Chart</code>：获取 <code>Chart.yaml</code> 文件的内容，该文件中的任何数据都可以访问，例如 <code>&#123;&#123; .Chart.Name &#125;&#125;-&#123;&#123; .Chart.Version&#125;&#125;</code> 可以渲染成 <code>mychart-0.1.0</code>，该对象下面可用的字段前面我们已经提到过了。</li>
<li><code>Files</code>：可以访问 chart 中的所有非特殊文件，虽然无法使用它来访问模板文件，但是可以来访问 chart 中的其他文件。<ul>
<li><code>Files.Get</code>：用于根据名称获取文件（比如 <code>.Files.Get config.ini</code>）</li>
<li><code>Files.GetBytes</code>：用于以 bytes 数组而不是字符串的形式来获取文件内容的函数，这对于类似于图片之类的东西很有用</li>
<li><code>Files.Glob</code>：用于返回名称于给定的 shell glob 模式匹配的文件列表</li>
<li><code>Files.Lines</code>：可以逐行读取文件的函数，对于遍历文件中的每行内容很有用</li>
<li><code>Files.AsSecrets</code>：将文件内容以 Base64 编码的字符串返回的函数</li>
<li><code>Files.AsConfig</code>：将文件正文作为 YAML 字典返回的函数</li>
</ul>
</li>
<li><code>Capabilities</code>：提供了获取有关 Kubernetes 集群支持功能的信息的对象<ul>
<li><code>Capabilities.APIVersions</code>：支持的版本集合</li>
<li><code>Capabilities.APIVersions.Has $version</code>：判断一个版本（比如 <code>batch/v1</code>）或资源（比如 <code>apps/v1/Deployment</code>）是否可用</li>
<li><code>Capabilities.Kube.Version</code>：Kubernetes 的版本</li>
<li><code>Capabilities.Kube</code>：是 Kubernetes 版本的缩写</li>
<li><code>Capabilities.Kube.Major</code>：Kubernetes 主版本</li>
<li><code>Capabilities.Kube.Minor</code>：Kubernetes 的次版本</li>
</ul>
</li>
<li><code>Template</code>：包含当前正在执行的模板的相关信息<ul>
<li><code>Name</code>：当前模板的命名空间文件路径（比如 <code>mychart/templates/mytemplate.yaml</code>）</li>
<li><code>BaePath</code>：当前 chart 的模板目录的命名空间路径（比如 <code>mychart/templates</code>）</li>
</ul>
</li>
</ul>
<blockquote>
<p>需要注意的是内置的对象始终是以大写字母开头的，这也是符合 Go 的命名约定的。创建自己的名称的时候，可以自由使用适合你团队的约定，一些团队，比如 Kubernetes Charts 团队，选择仅使用首字母小写，以区分本地名称和内置名称，这里我们也会遵循该约定。</p>
</blockquote>
<h2 id="2、Values-文件"><a href="#2、Values-文件" class="headerlink" title="2、Values 文件"></a>2、Values 文件</h2><p>前面我们介绍了 Helm 模板提供的内置对象，其中就有一个内置对象 <code>Values</code>，该对象提供对传递到 chart 中的 values 值的访问，其内容主要有4个来源：</p>
<ul>
<li>chart 文件中的 <code>values.yaml</code> 文件</li>
<li>如果这是子 chart，父 chart 的 <code>values.yaml</code> 文件</li>
<li>用 <code>-f</code> 参数传递给 <code>helm install</code> 或 <code>helm upgrade</code> 的 values 值文件（例如 <code>helm install -f myvals.yaml ./mychart</code>）</li>
<li>用 <code>--set</code> 传递的各个参数（例如 <code>helm install --set foo=bar ./mychart</code>）</li>
</ul>
<p><code>values.yaml</code> 文件是默认值，可以被父 chart 的 <code>values.yaml</code> 文件覆盖，而后者又可以由用户提供的 values 值文件覆盖，而该文件又可以被 <code>--set</code> 参数覆盖。</p>
<h3 id="1-chart模板编写"><a href="#1-chart模板编写" class="headerlink" title="1.chart模板编写"></a>1.chart模板编写</h3><table><tr><td bgcolor=yellow>💘 演示：chart模板编写-2022.4.5(测试成功)</td></tr></table>

<p>1️⃣ 创建charts包</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220405200123037.png" alt="image-20220405200123037"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ helm create mychart</span><br><span class="line">Creating mychart</span><br><span class="line"></span><br><span class="line">➜  ~ tree mychart </span><br><span class="line">mychart</span><br><span class="line">├── charts</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── hpa.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── serviceaccount.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   └── tests</span><br><span class="line">│       └── test-connection.yaml</span><br><span class="line">└── values.yaml</span><br><span class="line"></span><br><span class="line">3 directories, 10 files</span><br></pre></td></tr></table></figure>

<p>我们清空<code>values.yaml</code>文件内容，删除<code>templates目录</code>下内容：</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220405200709182.png" alt="image-20220405200709182"></p>
<p>2️⃣ 创建模板文件</p>
<p>常规yaml文件如下：</p>
<p>在<code>mychart/templates目录</code>下创建<code>ConfigMap.yaml文件</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myconfigmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">test:</span> <span class="string">helm-chart</span></span><br></pre></td></tr></table></figure>

<p>然后直接使用<code>helm template mychart1 ./mychart</code>命令直接渲染，我们看下结果：</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220405201646775.png" alt="image-20220405201646775"></p>
<p>3️⃣ 编辑模板文件</p>
<ul>
<li>values 值文件是纯 YAML 文件，我们可以来编辑 <code>mychart/values.yaml</code> 文件然后编辑 <code>ConfigMap</code> 模板。删除 <code>values.yaml</code> 中的默认设置后，我们将只设置一个参数：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">favoriteDrink:</span> <span class="string">coffee</span></span><br></pre></td></tr></table></figure>



<ul>
<li>现在我们可以在模板中直接使用它，这里编辑下<code>ConfigMap.yaml文件</code>：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favoriteDrink</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在最后一行我们将 <code>favoriteDrink</code> 作为 <code>Values</code> 的属性进行访问：<code>&#123;&#123; .Values.favoriteDrink &#125;&#125;</code>。</p>
<ul>
<li>我们可以来看看是如何渲染的：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#➜ helm install --generate-name --dry-run --debug ./mychart</span></span><br><span class="line">➜  helm install --generate-name --dry-run ./mychart <span class="comment">#注意这里的--dry-run参数：simulate an install</span></span><br><span class="line">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">NAME: mychart-1649168183</span><br><span class="line">LAST DEPLOYED: Tue Apr  5 22:16:24 2022</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: pending-install</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mychart-1649168183-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  drink: coffee</span><br></pre></td></tr></table></figure>

<p>:warning: 注意：这里如果使用<code>template命令</code>的话，同时使用<code>--generate-name</code>选项，会没有效果，建议直接使用<code>--dry-run</code>选项；</p>
<p>因为<code>--dry-run</code>是模拟安装，而<code>template命令</code>只渲染，可能会有点问题！</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220406083704283.png" alt="image-20220406083704283"></p>
<p>4️⃣ 使用<code>--set</code> 参数来覆盖默认vaulues值</p>
<ul>
<li>由于在默认的 <code>values.yaml</code> 文件中将 favoriteDrink 设置为了 coffee，所以这就是模板中显示的值，我们可以通过在调用 <code>helm install</code> 的过程中添加 <code>--set</code> 参数来覆盖它：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看下values.yaml文件内容</span></span><br><span class="line">favoriteDrink: coffee</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用`--set` 参数来覆盖默认vaulues值</span></span><br><span class="line">➜ helm install --generate-name --<span class="built_in">set</span> favoriteDrink=xyy --dry-run ./mychart </span><br><span class="line">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">NAME: mychart-1649205876</span><br><span class="line">LAST DEPLOYED: Wed Apr  6 08:44:37 2022</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: pending-install</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mychart-1649205876-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  drink: xyy</span><br></pre></td></tr></table></figure>

<p>因为 <code>--set</code> 的优先级高于默认的 <code>values.yaml</code> 文件，所以我们的模板会生成 <code>drink: slurm</code>。</p>
<p>5️⃣ Values 值文件也可以包含更多结构化的内容</p>
<ul>
<li>Values 值文件也可以包含更多结构化的内容，例如我们可以在 <code>values.yaml</code> 文件中创建一个 favorite 的部分，然后在其中添加几个 keys：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br></pre></td></tr></table></figure>



<ul>
<li>现在我们再去修改下我们的模板<code>ConfigMap.yanl</code>：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> &#125;&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>验证</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  local-vscode helm install --generate-name --<span class="built_in">set</span> favoriteDrink=xyy --dry-run ./mychart </span><br><span class="line">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">NAME: mychart-1649206046</span><br><span class="line">LAST DEPLOYED: Wed Apr  6 08:47:27 2022</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: pending-install</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mychart-1649206046-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  drink: coffee</span><br><span class="line">  food: pizza</span><br></pre></td></tr></table></figure>

<p>虽然我们可以通过这种方式来构造数据，但是还是建议你将 values 树保持更浅，这样在使用的时候更加简单。<strong>当我们考虑为子 chart 分配 values 值的时候，我们就可以看到如何使用树形结构来命名 values 值了</strong>。</p>
<p>测试结束。😋</p>
<h3 id="2-删除默认-KEY"><a href="#2-删除默认-KEY" class="headerlink" title="2.删除默认 KEY"></a>2.删除默认 KEY</h3><p>如果你需要从默认值中删除 key，则可以将该 key 的值覆盖为 null，在这种情况下，Helm 将从覆盖的 values 中删除该 key。例如，在 Drupal chart 中配置一个 liveness 探针:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/user/login</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">120</span></span><br></pre></td></tr></table></figure>

<p>如果你想使用 <code>--set livenessProbe.exec.command=[cat, docroot/CHANGELOG.txt]</code> 将 livenessProbe 的处理程序覆盖为 <code>exec</code> 而不是 <code>httpGet</code>，则 Helm 会将默认键和覆盖键合并在一起，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/user/login</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">exec:</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docroot/CHANGELOG.txt</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">120</span></span><br></pre></td></tr></table></figure>



<p>但是，这样却有一个问题，因为你不能声明多个 livenessProbe 处理程序，为了解决这个问题，你可以让 Helm 通过将 <code>livenessProbe.httpGet</code> 设置为 null 来删除它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜ helm install stable/drupal --<span class="built_in">set</span> image=my-registry/drupal:0.1.0 --<span class="built_in">set</span> livenessProbe.exec.command=[cat, docroot/CHANGELOG.txt] --<span class="built_in">set</span> livenessProbe.httpGet=null</span><br></pre></td></tr></table></figure>

<p>到这里我们已经了解到了几个内置对象，并利用它们将信息注入到了模板中，现在我们来看看模板引擎的另外方面：<strong>函数和管道</strong>。</p>
<h2 id="3、函数和管道"><a href="#3、函数和管道" class="headerlink" title="3、函数和管道"></a>3、函数和管道</h2><p>现在我们已经了解了如何将信息加入到模板中，但是这些信息都是直接原样的放置过去的，有时候，<strong>我们希望以一种对我们更有用的方式来转换提供的数据</strong>。</p>
<p>下面让我们从一个最佳实践开始：将 <code>.Values</code> 对象中的字符串注入模板时，我们应该引用这些字符串，我们可以通过在 template 指令中调用 <code>quote</code> 函数来实现，比如：</p>
<table><tr><td bgcolor=yellow>💘 演示：测试quote函数-2022.4.5(测试成功)</td></tr></table>

<ol>
<li><p>编辑<code>ConfigMap.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">quote</span> <span class="string">.Values.favorite.drink</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>模板函数遵循的语法规则是 <code>functionName arg1 arg2...</code>，在上面的代码片段中，<code>quote .Values.favorite.drink</code> 会调用 <code>quote</code> 函数并传递一个单个参数。</p>
</li>
<li><p>测试</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">local-vscode</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="attr">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location:</span> <span class="string">/home/hg/.kube/config</span></span><br><span class="line"><span class="attr">WARNING: Kubernetes configuration file is world-readable. This is insecure. Location:</span> <span class="string">/home/hg/.kube/config</span></span><br><span class="line"><span class="attr">NAME:</span> <span class="string">mychart-1649221072</span></span><br><span class="line"><span class="attr">LAST DEPLOYED:</span> <span class="string">Wed</span> <span class="string">Apr</span>  <span class="number">6</span> <span class="number">12</span><span class="string">:57:53</span> <span class="number">2022</span></span><br><span class="line"><span class="attr">NAMESPACE:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">STATUS:</span> <span class="string">pending-install</span></span><br><span class="line"><span class="attr">REVISION:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">TEST SUITE:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">HOOKS:</span></span><br><span class="line"><span class="attr">MANIFEST:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649221072-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看到<code>quote</code>函数就是给后面加上一对<code>&quot;</code>符号。</p>
</blockquote>
</li>
</ol>
<p>测试结束。😘</p>
<p>🍀 <code>Helm模板语言</code></p>
<p>Helm 有60多种可用的函数，其中一些是由 <a target="_blank" rel="noopener" href="https://godoc.org/text/template">Go 模板语言</a>本身定义的，其他大多数都是 <a target="_blank" rel="noopener" href="https://masterminds.github.io/sprig/">Sprig 模板库</a>提供的，接下来我们会通过部分示例来逐步介绍其中的一些功能函数。</p>
<blockquote>
<p>:warning: Helm 模板</p>
<p>当我们谈论 <code>Helm 模板语言</code> 的时候，就好像是特定于 Helm 一样，但实际上它是 Go 模板语言加上一些额外的函数以及各种封装程序的组合，以将某些对象暴露给模板。当我们需要学习模板的时候，Go 模板上有许多资源会对我们有所帮助的。</p>
</blockquote>
<h3 id="1-管道"><a href="#1-管道" class="headerlink" title="1.管道"></a>1.管道</h3><p>模板语言有一个强大的功能就是<strong>管道（Pipeline）</strong>概念，管道利用 UNIX 的概念，将一系列模板命令链接在一起，一起对外提供服务，换句话说，<strong>管道是按顺序完成多项工作的有效方式</strong>。</p>
<table><tr><td bgcolor=yellow>💘 演示：测试管道-2022.4.5(测试成功)</td></tr></table>

<p>1️⃣ 我们来使用管道重写上面的示例模板：编辑<code>ConfigMap.yaml</code>文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br></pre></td></tr></table></figure>



<p>2️⃣ 在这里我们没有调用 <code>quote ARGUMENT</code> 函数，而是颠倒了下顺序，我们使用管道符（|）将参数<strong>发送</strong>给函数：<code>.Values.favorite.drink | quote</code>，使用管道，我们可以将多个功能链接在一起：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>管道顺序</p>
<blockquote>
<p>反转顺序是模板中常见的做法，我们会看到 <code>.val | quote</code> 比 <code>quote .val</code> 用法更多，虽然两种方法都是可以的。</p>
</blockquote>
<p>3️⃣ 最后，模板渲染后，会产生如下所示的结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">local-vscode</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="attr">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location:</span> <span class="string">/home/hg/.kube/config</span></span><br><span class="line"><span class="attr">WARNING: Kubernetes configuration file is world-readable. This is insecure. Location:</span> <span class="string">/home/hg/.kube/config</span></span><br><span class="line"><span class="attr">NAME:</span> <span class="string">mychart-1649225993</span></span><br><span class="line"><span class="attr">LAST DEPLOYED:</span> <span class="string">Wed</span> <span class="string">Apr</span>  <span class="number">6</span> <span class="number">14</span><span class="string">:19:54</span> <span class="number">2022</span></span><br><span class="line"><span class="attr">NAMESPACE:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">STATUS:</span> <span class="string">pending-install</span></span><br><span class="line"><span class="attr">REVISION:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">TEST SUITE:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">HOOKS:</span></span><br><span class="line"><span class="attr">MANIFEST:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649225993-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到 values 中的 <code>pizza</code> 值已经被转换成了 <code>&quot;PIZZA&quot;</code>。当这样传递参数的时候，第一个求值结果（<code>.Values.favorite.drink</code>）会作为一个参数发送给函数。</p>
<p>4️⃣ 我们可以修改上面的 <code>drink</code> 示例，用一个带有两个参数的函数进行说明：<code>repeat COUNT STRING</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">repeat</span> <span class="number">5</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><code>repeat</code> 函数将重复字符串给定的次数，渲染后我们可以得到如下的输出结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">local-vscode</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649226152-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffeecoffeecoffeecoffeecoffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br></pre></td></tr></table></figure>

<p>:warning: 这里需要注意下：这个<code>repeat 5</code>要放在前面吗，不会会报错，放在后面的话，因为是不满足yaml格式的。</p>
<img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220406142658814.png" alt="image-20220406142658814"  />

<p>测试结束。😘</p>
<h3 id="2-default-函数"><a href="#2-default-函数" class="headerlink" title="2.default 函数"></a>2.default 函数</h3><p>在模板中经常会使用到的一个函数是 <code>default</code> 函数：<code>default DEFAULT_VALUE GIVEN_VALUE</code>，该函数允许你在模板内部指定默认值。</p>
<table><tr><td bgcolor=yellow>💘 演示：测试default函数-2022.4.5(测试成功)</td></tr></table>

<p>1️⃣ 我们来修改上面示例中的模板：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这里添加deafult &quot;rice&quot;</span></span><br><span class="line"><span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;rice&quot;</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#完整ConfigMap.yaml内容如下</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">repeat</span> <span class="number">5</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125; </span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;rice&quot;</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span>&#125;&#125;</span><br></pre></td></tr></table></figure>



<p>2️⃣ 正常运行，我们还是可以得到 <code>values.yaml</code> 文件中定义的 pizza：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">local-vscode</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649226682-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffeecoffeecoffeecoffeecoffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br></pre></td></tr></table></figure>



<p>3️⃣ 现在我们从 <code>values.yaml</code> 文件中移除 food 的定义：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="comment"># food: pizza</span></span><br></pre></td></tr></table></figure>



<p>4️⃣ 现在我们重新运行 <code>helm install --generate-name --dry-run --debug ./mychart</code> 将渲染成如下的 YAML 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">local-vscode</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649226830-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffeecoffeecoffeecoffeecoffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;RICE&quot;</span></span><br></pre></td></tr></table></figure>



<p>5️⃣ :warning: 注意</p>
<p>在一个真实的 chart 模板中，所有的静态默认值都应位于 <code>values.yaml</code> 文件中，并且不应该重复使用 <code>default</code> 函数，但是，默认命令非常适合计算不能在 <code>values.yaml</code> 文件中声明的 values 值，例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">default</span> <span class="string">(printf</span> <span class="string">&quot;%s-rice&quot;</span> <span class="string">(include</span> <span class="string">&quot;fullname&quot;</span> <span class="string">.))</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>不过在有些地方，<code>if</code> 条件语句可能比 default 函数更合适，我们会在后面了解到。</p>
<p>模板函数和管道是将数据转换后然后将其插入到 YAML 文件中的一种强大方法，但是有的时候有必要添加一些<strong>模板逻辑</strong>，这些逻辑比仅仅插入字符串要复杂得多，下面我们将来了解模板语言中提供的控制流程。</p>
<p>测试结束。😘</p>
<h3 id="3-运算符函数"><a href="#3-运算符函数" class="headerlink" title="3.运算符函数"></a>3.运算符函数</h3><p>另外需要注意的是在模板中，运算符（eq、ne、lt、gt、and、or 等等）均实现为函数；在管道中，运算符可以用括号<code>（）</code>进行分割。</p>
<p>接下来我们可以去了解控制流程条件语句、循环和作用域修饰符的使用。</p>
<h2 id="4、流程控制"><a href="#4、流程控制" class="headerlink" title="4、流程控制"></a>4、流程控制</h2><p>控制流程为模板作者提供了控制模板生成流程的功能，Helm 的模板语言提供了以下一些流程控制：</p>
<ul>
<li><code>if/else</code> 条件语句</li>
<li><code>with</code> 指定一个作用域范围</li>
<li><code>range</code> 提供类似于 <code>for each</code> 这样的循环样式</li>
</ul>
<p>除此之外，还提供了一些<strong>声明和使用命名模板</strong>的操作：</p>
<ul>
<li><code>define</code> 在模板内部声明一个新的命名模板</li>
<li><code>template</code> 导入一个命名模板</li>
<li><code>block</code> 声明了一种特殊的可填充模板区域。</li>
</ul>
<p>这里我们先来了解 <code>if</code>、<code>with</code>、<code>range</code> 语句的使用，其他将在后面的<code>命名模板</code>部分介绍。</p>
<h3 id="1-if-else"><a href="#1-if-else" class="headerlink" title="1.if/else"></a>1.if/else</h3><p>首先我们先来了解下有条件地在模板中包含一个文本区域，就是 <code>if/else</code> ，这个条件判断的基本结构如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">if</span> <span class="string">PIPELINE</span> &#125;&#125; <span class="comment">#PIPLINE可以认为是一个表达式！</span></span><br><span class="line">  <span class="comment"># Do something </span></span><br><span class="line">&#123;&#123; <span class="string">else</span> <span class="string">if</span> <span class="string">OTHER</span> <span class="string">PIPELINE</span> &#125;&#125;</span><br><span class="line">  <span class="comment"># Do something else</span></span><br><span class="line">&#123;&#123; <span class="string">else</span> &#125;&#125;</span><br><span class="line">  <span class="comment"># Default case</span></span><br><span class="line">&#123;&#123; <span class="string">end</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意：if和else一定是成对存在的。</span></span><br></pre></td></tr></table></figure>

<p>可以看到<strong>我们这里判断的是管道而不是一个 values 值</strong>，这是因为控制结构可以执行整个管道，而不仅仅是判断值。如果值为以下的一些内容，则将管道判断为 false：</p>
<ul>
<li>布尔 false</li>
<li>数字零</li>
<li>一个空字符串</li>
<li>nil（empty 或者 null）</li>
<li>一个空集合（map、slice、tuple、dict、array）</li>
</ul>
<p>在其他条件下，条件都为真。</p>
<table><tr><td bgcolor=yellow>💘 示例：if/else测试-2022.4.6(测试成功)</td></tr></table>

<p>1️⃣ 现在我们在上面的示例模板 <code>ConfigMap.yaml</code> 中添加一个简单的条件，如果 drink 设置为 coffee，我们就添加另外一个设置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;coffee&quot;</span> &#125;&#125;<span class="attr">mug:</span> <span class="literal">true</span>&#123;&#123; <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>我们把 values.yaml 文件内容设置成下面的样子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="comment"># drink: coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br></pre></td></tr></table></figure>



<p>2️⃣ 由于我们注释掉了 <code>drink: coffee</code>，所以渲染后输出不会包含 <code>mug: true</code> 的标志。</p>
<p>这里需要注意下：:warning: (用于比较的不兼容类型)</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220406185156744.png" alt="image-20220406185156744"></p>
<p>但是如果我们把注释取消掉，则应该输出如下所示的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="string">➜</span>  <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649242370-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br><span class="line">  <span class="attr">mug:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>这是因为上面模板中我们添加了 <code>if eq .Values.favorite.drink &quot;coffee&quot;</code> 这样的条件判断，相当于是判断 <code>.Values.favorite.drink</code> 值是否等于 <code>&quot;coffee&quot;</code>，如果相等则渲染 <code>mug: true</code>。</p>
<p>3️⃣ 这里我们再很关注一下细节问题</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br></pre></td></tr></table></figure>

<p>思考：这个模板里<code>if流程控制语句</code>为什么不可以竖着写，而要写在一行上？不会不感觉可读性不好！</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220406185607717.png" alt="image-20220406185607717"></p>
<p>我们这里尝试这竖着写看下有什么效果：</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220406185801088.png" alt="image-20220406185801088"></p>
<p>竖着写，当模板被渲染之后，这里会多出2个空行！</p>
<p>那么，我们可以使用如下方式来解决这个问题：这里添加2个<code>-</code>即可。</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220406190058348.png" alt="image-20220406190058348"></p>
<p>4️⃣ 接下来，我们再使用下<code>if…… esle if ……else</code>，看下效果</p>
<p>配置文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;coffee&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line">  <span class="attr">condiition:</span> <span class="literal">true</span></span><br><span class="line">  &#123;&#123; <span class="string">else</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;water&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line">  <span class="attr">elsecondition:</span> <span class="literal">true</span></span><br><span class="line">  &#123;&#123; <span class="string">else</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line">  <span class="attr">defaultcase:</span> <span class="literal">true</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;  </span><br></pre></td></tr></table></figure>

<p>我们渲染下，查看效果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">local-vscode</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">--set</span> <span class="string">favorite.drink=water</span> <span class="string">./mychart</span></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649243095-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;water&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br><span class="line">  <span class="attr">elsecondition:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="string">➜</span>  <span class="string">local-vscode</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">--set</span> <span class="string">favorite.drink=waterxxx</span> <span class="string">./mychart</span></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649243172-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;waterxxx&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br><span class="line">  <span class="attr">defaultcase:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>测试结束。😘</p>
<h3 id="2-空格控制"><a href="#2-空格控制" class="headerlink" title="2.空格控制"></a>2.空格控制</h3><p>还有一个非常重要的功能点就是关于空格的控制，因为空格对于 YAML 文件非常重要的，不是说任意缩进就可以。</p>
<table><tr><td bgcolor=yellow>💘 示例：空格控制测试-2022.4.7(测试成功)</td></tr></table>

<p>:warning: 关于空格控制，其实上面那个示例有测试过了，这里我们再次做下实验。</p>
<p>1️⃣ 依然还是以前面的例子为例，我们来格式化下模板格式以更易于阅读：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;coffee&quot;</span> &#125;&#125;</span><br><span class="line">    <span class="attr">mug:</span> <span class="literal">true</span></span><br><span class="line">  &#123;&#123; <span class="string">end</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br></pre></td></tr></table></figure>

<p>现在我们的模板看上去更易于阅读了，但是我们通过模板引擎来渲染下，却会得到如下的错误信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  helm install --generate-name --dry-run ./mychart</span><br><span class="line">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">Error: INSTALLATION FAILED: YAML parse error on mychart/templates/ConfigMap.yaml: error converting YAML to JSON: yaml: line 9: did not find expected key</span><br></pre></td></tr></table></figure>

<p>这是因为我们在模板中添加了空格，生成了不正确的 YAML 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1575970308-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br><span class="line">    <span class="attr">mug:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到 <code>mug: true</code> 的缩进是有问题的，不符合 YAML 文件格式，现在我们将缩进去掉试看看：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;coffee&quot;</span> &#125;&#125;</span><br><span class="line">  <span class="attr">mug:</span> <span class="literal">true</span></span><br><span class="line">  &#123;&#123; <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>重新渲染模板，然后可以发现已经可以正常通过了，但是渲染出来的 YAML 文件格式看上去还是有点奇怪：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="attr">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location:</span> <span class="string">/home/hg/.kube/config</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649321939-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mug:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们可以看到得到的 YAML 文件中多了一些空行，这是因为模板引擎渲染的时候它会删除 <code>&#123;&#123;` 和 `&#125;&#125;</code> 之间的内容，<strong>但是会完全保留其余的空格</strong>。我们知道在 YAML 文件中空格是有意义的，所以管理空格就变得非常重要了，不过 <strong>Helm 模板也提供了一些工具来帮助我们管理空格</strong>。</p>
<p>首先可以使用特殊字符修改模板声明的花括号语法，以告诉模板引擎去掉空格。<code>&#123;&#123;-` 添加了破折号和空格表示应将左边的空格移除，`-&#125;&#125;</code>表示将右边的空格移除，<code>另外也需要注意的是，换行符也是空格</code>。</p>
<p>空格</p>
<p>需要注意的时候要确保 <code>-</code> 和指令的其余部分之间要有空格，<code>&#123;&#123;- 3 &#125;&#125;</code> 表示删除左边的空格并打印3，但是 <code>&#123;&#123;-3 &#125;&#125;</code>表示打印<code>-3</code>。</p>
<p>2️⃣ 使用这个语法，我们可以修改上面的模板来移除多余的空行：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;coffee&quot;</span> &#125;&#125;</span><br><span class="line">  <span class="attr">mug:</span> <span class="literal">true</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>渲染后可以看到空行被移除掉了：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1575972373-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br><span class="line">  <span class="attr">mug:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>3️⃣ 为了更加清楚地说明这个问题，我们用<code>*</code>来代替将要删除的每个空格，行尾的<code>*</code>表示被删除的换行符：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;<span class="string">*</span></span><br><span class="line"><span class="string">**&#123;&#123;-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;coffee&quot;</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">mug:</span> <span class="literal">true</span><span class="string">*</span></span><br><span class="line"><span class="string">**&#123;&#123;-</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>:warning: 所以我们这里用 <code>&#123;&#123;-` 表示的就是删除本行开头的两个空格以及上一行的换行符，这样是不是就将空行都删除了啊。



4️⃣ 在使用移除空格的时候还需要小心，比如下面的操作：

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;coffee&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line"><span class="attr">mug:</span> <span class="literal">true</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> <span class="string">-</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

我们依然还是可以用 `*` 来代替空格进行分析，如下所示：

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;<span class="string">*</span></span><br><span class="line"><span class="string">**&#123;&#123;-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;coffee&quot;</span> <span class="string">-&#125;&#125;*</span></span><br><span class="line">  <span class="attr">mug:</span> <span class="literal">true</span><span class="string">*</span></span><br><span class="line"><span class="string">**&#123;&#123;-</span> <span class="string">end</span> <span class="string">-&#125;&#125;</span></span><br></pre></td></tr></table></figure>

第一个 `&#123;&#123;-` 会删除前面的空格和前面的换行符，然后后面的 `-&#125;&#125;</code> 会删除当前行的换行符，这样就会把 <code>mug: true</code> 移动到 <code>food: &quot;PIZZA&quot;</code> 后面去了，最终渲染过后就会变成：<code>food: &quot;PIZZA&quot;mug: true</code>，因为在两侧都去掉换行符。</p>
<blockquote>
<p>有关模板中空格控制的详细信息，可以查看 <a target="_blank" rel="noopener" href="https://godoc.org/text/template">Go 模板官方文档</a>介绍。</p>
</blockquote>
<p>5️⃣ 缩进函数（<code>&#123;&#123; indent 2 "mug: true" &#125;&#125;</code>）使用</p>
<p>:warning: 不过有时候告诉模板系统如何缩进比起去控制模板指令的间距更加容易，所以，有时候你会发现缩进函数（<code>&#123;&#123; indent 2 "mug: true" &#125;&#125;</code>）更有用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.Values.favorite.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.Values.favorite.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">indent</span> <span class="number">2</span> <span class="string">&quot;indent: 2&quot;</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">eq</span> <span class="string">.Values.favorite.drink</span> <span class="string">&quot;coffee&quot;</span> &#125;&#125;</span><br><span class="line">  <span class="attr">mug:</span> <span class="literal">true</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br></pre></td></tr></table></figure>

<p>我们渲染下，结果是报错的：</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220407170527766.png" alt="image-20220407170527766"></p>
<p>因为<code>&#123;&#123; indent 2 "indent: 2" &#125;&#125;</code>这个需要顶格写：</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220407170954402.png" alt="image-20220407170954402"></p>
<p>测试结束。😘</p>
<h3 id="3-使用-with-修改作用域"><a href="#3-使用-with-修改作用域" class="headerlink" title="3.使用 with 修改作用域"></a>3.使用 with 修改作用域</h3><p>接下来需要了解的是 <code>with</code> 操作，它可以控制变量的作用域，然后重新用 <code>.</code> 调用就表示对当前作用域的引用。所以，<u><code>.Values</code> 是告诉模板引擎在当前作用域下内查找 Values 对象。</u></p>
<p><code>with</code> 语句的语法和 <code>if</code> 语句比较类似：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">with</span> <span class="string">PIPELINE</span> &#125;&#125;</span><br><span class="line">  <span class="comment"># 限制范围</span></span><br><span class="line">&#123;&#123; <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>



<table><tr><td bgcolor=yellow>💘 示例：使用with修改作用域-2022.4.7(测试成功)</td></tr></table>

<p>1️⃣ 范围可以更改，可以让你将当前范围 <code>.</code> 设置为特定的对象。例如，我们一直在使用 <code>.Values.favorites</code>，让我们重写下模板文件 ConfigMap 来更改 <code>.</code> 的范围指向 <code>.Values.favorites</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br></pre></td></tr></table></figure>

<p>我们这里将前面练习的 <code>if</code> 条件语句删除了，在模板中我们添加了一个 <code>&#123;&#123;- with .Values.favorite &#125;&#125;</code> 的语句，意思就是说在 <code>with</code> 语句的作用范围内可以用 <code>.</code> 表示 <code>.Values.favorite</code> 了，所以我们可以引用 <code>.drink</code> 和 <code>.food</code> 了，但是在 <code>&#123;&#123; end &#125;&#125;</code> 之后就会重置为之前的作用域了。</p>
<p>渲染结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649331891-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br></pre></td></tr></table></figure>



<p>2️⃣ 不过需要注意得是，**<u>在受限的作用域范围内，你无法从父级范围访问到其他对象</u>**，比如，下面得模板会失败：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line"><span class="attr">drink:</span> &#123;&#123; <span class="string">.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line"><span class="attr">food:</span> &#123;&#123; <span class="string">.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line"><span class="attr">release:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220407195648061.png" alt="image-20220407195648061"></p>
<p>因为 <code>Release.Name</code> 并不在 <code>.</code> 的限制范围内，所以会产生错误。但是，如果我们交换最后两行，则就可以正常工作了，因为 <code>&#123;&#123; end &#125;&#125;</code> 之后会重置作用域。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line"><span class="attr">drink:</span> &#123;&#123; <span class="string">.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line"><span class="attr">food:</span> &#123;&#123; <span class="string">.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"><span class="attr">release:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220407195730184.png" alt="image-20220407195730184"></p>
<p>测试结束。😘</p>
<p>下面我先来了解下 <code>range</code>，然后我们再去了解下模板变量，它可以为上面得这个范围问题提供一种解决方案。</p>
<h3 id="4-range-循环操作"><a href="#4-range-循环操作" class="headerlink" title="4.range 循环操作"></a>4.range 循环操作</h3><p>我们知道许多编程语言都支持使用 <code>for</code> 循环、<code>foreach</code> 循环或者类似功能机制进行循环迭代。在 Helm 得模板语言中，迭代集合得方法是使用 <code>range</code> 运算符。</p>
<table><tr><td bgcolor=yellow>💘 示例：range循环操作-2022.4.7(测试成功)</td></tr></table>

<p>1️⃣ 比如首先我们在 <code>values.yaml</code> 文件中添加一份 pizza 馅料列表：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br><span class="line"><span class="attr">pizzaToppings:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mushrooms</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cheese</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">peppers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">onions</span></span><br></pre></td></tr></table></figure>

<p>现在我们有了 <code>pizzaToppings</code> 列表（在模板中称为切片），我们可以来修改下模板将列表打印到 ConfigMap 中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">  <span class="attr">toppings:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    &#123;&#123;- range .Values.pizzaToppings &#125;&#125;</span></span><br><span class="line"><span class="string">    - &#123;&#123; . | title | quote &#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123;- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们仔细观察下模板中的 <code>toppings:</code> 列表，<code>range</code> 函数将遍历 <code>Values.pizzaToppings</code> 列表，我们看到里面使用了一个 <code>.</code>，类似于上面我们用 <code>with</code> 设置范围一样，运算符也是这样的，每次循环，<code>.</code> 都会被设置为当前的 <code>pizzaTopping</code>，也就是说第一次设置为<code>mushrooms</code>，第二次迭代设置为<code>cheese</code>，依次类推。</p>
<p>我们可以直接传递 <code>.</code> 这个值到管道上，所以我们这里 <code>&#123;&#123; . | title | quote &#125;&#125;</code> 就相当于发送 <code>.</code> 给 <code>title</code>（标题大小写函数）函数，然后发送给 <code>quote</code> 函数。</p>
<p>2️⃣ 我们渲染这个模板，会输出如下的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1575975849-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br><span class="line">  <span class="attr">toppings:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    - &quot;Mushrooms&quot;</span></span><br><span class="line"><span class="string">    - &quot;Cheese&quot;</span></span><br><span class="line"><span class="string">    - &quot;Peppers&quot;</span></span><br><span class="line"><span class="string">    - &quot;Onions&quot;</span></span><br></pre></td></tr></table></figure>

<p>在上面模板中，我们做了一些小小的特殊处理，<code>toppings: |-</code> 行表示声明一个多行字符串，所以其实我们的 <code>toppings</code> 列表不是一个 YAML 列表，而是一个比较大的字符串，这是因为 ConfigMap 中的数据由 <code>key/value</code> 对组成，所有 key 和 value 都是简单的字符串，要了解为什么是这样的，可以查看 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/user-guide/configmap/">Kubernetes ConfigMap 文档</a>，不过这个细节对我们这里不重要。</p>
<p>:warning: 需要注意下：这里如果不跟上<code>|</code>的话，会报错的！(属于 yaml部分内容)</p>
<p>这里加不加<code>-</code>号都是可以渲染成功的。</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220407202106197.png" alt="image-20220407202106197"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220407202201169.png" alt="image-20220407202201169"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220407202226179.png" alt="image-20220407202226179"></p>
<p>3️⃣ YAML部分内容</p>
<p>(1)多行字符串可以使用 <code>|</code> 保留换行符，也可以使用 <code>&gt;</code> 折叠换行，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">this: |</span><br><span class="line"> Foo</span><br><span class="line"> Bar</span><br><span class="line">that: &gt;</span><br><span class="line"> Foo</span><br><span class="line"> Bar</span><br></pre></td></tr></table></figure>

<p>对应的意思就是：<code>&#123;this: &#39;Foo\nBar\n&#39;, that: &#39;Foo Bar\n&#39;&#125;</code></p>
<p>(2)<code>+</code> 表示保留文字块末尾的换行，<code>-</code> 表示删除字符串末尾的换行，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s1: |</span><br><span class="line">Foo</span><br><span class="line"></span><br><span class="line">s2: |+</span><br><span class="line">Foo</span><br><span class="line"></span><br><span class="line">s3: |-</span><br><span class="line">Foo</span><br></pre></td></tr></table></figure>

<p>对应的意思就是：<code>&#123;s1: &#39;Foo\n&#39;, s2: &#39;Foo\n\n\n&#39;, s3: &#39;Foo&#39;&#125;</code></p>
<p>4️⃣ 有时候，在模板中快速创建一个列表，然后遍历该列表很有用，Helm 模板具有简化该功能的函数：<code>tuple</code>。元组是固定大小的列表集合，但是具有任意数据类型，下面是元组的大概使用方法：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sizes:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">  &#123;&#123;- range tuple &quot;small&quot; &quot;medium&quot; &quot;large&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">  - &#123;&#123; . &#125;&#125;</span></span><br><span class="line"><span class="string">  &#123;&#123;- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面的模板最终会被渲染成如下的 YAML：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sizes: |-</span><br><span class="line">  - small</span><br><span class="line">  - medium</span><br><span class="line">  - large</span><br></pre></td></tr></table></figure>

<p>除了列表和元组之外，<code>range</code> 还可以用于遍历字典，我们在下一节介绍模板变量的时候再来了解这个用法吧。</p>
<h2 id="5、变量"><a href="#5、变量" class="headerlink" title="5、变量"></a>5、变量</h2><p>有了函数、管道、对象以及控制结构，我们可以想象下大多数编程语言中更基本的思想之一：<code>变量</code>。在模板中，变量的使用频率较低，但是，我们还是可以使用他们来简化代码，以及更好地使用 <code>with</code> 和 <code>range</code>。</p>
<table><tr><td bgcolor=yellow>💘 示例：变量测试-2022.4.7(测试成功)</td></tr></table>

<p>在前面的示例中，我们知道下面的模板渲染会出错：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line"><span class="attr">drink:</span> &#123;&#123; <span class="string">.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line"><span class="attr">food:</span> &#123;&#123; <span class="string">.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line"><span class="attr">release:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>因为 <code>Release.Name</code> 不在 <code>with</code> 语句块限制的范围之内，<strong>解决作用域问题的一种方法是将对象分配给在不考虑当前作用域情况下访问的变量</strong>。</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220408084600276.png" alt="image-20220408084600276"></p>
<p>1️⃣ 在 Helm 模板中，变量是对另外一个对象的命名引用。它遵循 <code>$name</code> 格式，变量使用特殊的赋值运算符进行赋值 <code>:=</code>，我们可以修改上面的模板，为 <code>Release.Name</code> 声明一个变量：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">$relname</span> <span class="string">:=</span> <span class="string">.Release.Name</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">with</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  <span class="attr">drink:</span> &#123;&#123; <span class="string">.drink</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;tea&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">food:</span> &#123;&#123; <span class="string">.food</span> <span class="string">|</span> <span class="string">upper</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">release:</span> &#123;&#123; <span class="string">$relname</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br></pre></td></tr></table></figure>

<p>注意在 <code>with</code> 语句之前，我们先分配了 <code>$relname := .Release.Name</code>，然后在 <code>with</code> 语句块中，<code>$relname</code> 变量仍然表示 release 的名称，我们渲染该模板，可以得到如下的正确结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>   <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649378928-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;PIZZA&quot;</span></span><br><span class="line">  <span class="attr">release:</span> <span class="string">mychart-1649378928</span></span><br></pre></td></tr></table></figure>

<p>:warning: 注意：这个变量的位置可以放在最上面，是没问题的，但是不能放在with里面。</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220408085509475.png" alt="image-20220408085509475"></p>
<p>2️⃣ 变量在 <code>range</code> 循环里面非常有用，它们可以用于类似于列表的对象来捕获索引和 value 值：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">toppings:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">  &#123;&#123;- range $index, $topping := .Values.pizzaToppings &#125;&#125;</span></span><br><span class="line"><span class="string">  &#123;&#123; $index &#125;&#125;: &#123;&#123; $topping &#125;&#125;</span></span><br><span class="line"><span class="string">  &#123;&#123;- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>注意 <code>range</code> 在前面，然后是变量，然后是赋值运算符，然后才是列表，这会将整数索引（从0开始）分配给 <code>$index</code>，并将 value 值分配给 <code>$topping</code>，上面的内容会被渲染成如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">toppings:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">  0: mushrooms</span></span><br><span class="line"><span class="string">  1: cheese</span></span><br><span class="line"><span class="string">  2: peppers</span></span><br><span class="line"><span class="string">  3: onions</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220408221206423.png" alt="image-20220408221206423"></p>
<p>对于同时具有 key 和 value 的数据结构，我们也可以使用 <code>range</code> 来获得 key、value 的值，比如，我们可以像这样循环遍历 <code>.Values.favorite</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">$key</span>, <span class="string">$val</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">$key</span> &#125;&#125;<span class="string">:</span> &#123;&#123; <span class="string">$val</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br><span class="line"><span class="attr">pizzaToppings:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mushrooms</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cheese</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">peppers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">onions</span></span><br></pre></td></tr></table></figure>

<p>在第一次迭代中，<code>$key</code> 是 <code>drink</code>，<code>$val</code> 是 <code>coffee</code>，在第二次迭代中，<code>$key</code> 是 <code>food</code>，<code>$val</code> 是 <code>pizza</code>。运行上面的命令将生成下面的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649427327-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;pizza&quot;</span></span><br></pre></td></tr></table></figure>



<p>3️⃣ 一般来说变量不是全局的，它们的作用域是声明它们的块区域。之前，我们在模板的顶层分配了 <code>$relname</code>，该变量将在整个模板的范围内，但是在我们上面的示例中，<code>$key</code> 和 <code>$val</code> 作用域只在 <code>&#123;&#123; range... &#125;&#125;&#123;&#123; end &#125;&#125;</code> 区域内。</p>
<p>但是，<strong>有一个始终是全局变量的 <code>$</code> 始终指向顶层根上下文</strong>，当我们在 <code>range</code> 循环内需要知道 chart 包的 release 名称的时候，该功能就非常有用了，比如下面的模板文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">.Values.tlsSecrets</span> &#125;&#125;</span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.name</span> &#125;&#125;</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># helm 模板经常使用 `.`，但是这里是无效的，用 `$` 是可以生效的。</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> &#123;&#123; <span class="string">template</span> <span class="string">&quot;fullname&quot;</span> <span class="string">$</span> &#125;&#125;</span><br><span class="line">    <span class="comment"># 这里不能引用 `.Chart.Name`，但是可用使用 `$.Chart.Name`</span></span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $.Chart.Name &#125;&#125;</span>-<span class="template-variable">&#123;&#123; $.Chart.Version &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $.Release.Name &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># 值来自于 Chart.yaml 文件中的 appVersion</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $.Chart.AppVersion &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; $.Release.Service &#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> &#123;&#123; <span class="string">.certificate</span> &#125;&#125;</span><br><span class="line">  <span class="attr">tls.key:</span> &#123;&#123; <span class="string">.key</span> &#125;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>



<p>我们这里继续用上面案例进行测试：这里我们先使用<code>变量方式</code>测试。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">$relname</span> <span class="string">:=</span> <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">$chartName</span> <span class="string">:=</span> <span class="string">.Chart.Name</span>&#125;&#125;</span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">$key</span>, <span class="string">$val</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">$key</span> &#125;&#125;<span class="string">:</span> &#123;&#123; <span class="string">$val</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">chartName:</span> &#123;&#123; <span class="string">$chartName</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br><span class="line"><span class="attr">pizzaToppings:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mushrooms</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cheese</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">peppers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">onions</span></span><br></pre></td></tr></table></figure>

<p>渲染后可以得到正确结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649431829-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">chartName:</span> <span class="string">mychart</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;pizza&quot;</span></span><br><span class="line">  <span class="attr">chartName:</span> <span class="string">mychart</span></span><br></pre></td></tr></table></figure>



<p>我们再次使用<code>全局变量的 $</code>来进行测试：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">$relname</span> <span class="string">:=</span> <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">$key</span>, <span class="string">$val</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">$key</span> &#125;&#125;<span class="string">:</span> &#123;&#123; <span class="string">$val</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">chartName:</span> &#123;&#123; <span class="string">$.Chart.Name</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">#values.yaml</span></span><br><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br><span class="line"><span class="attr">pizzaToppings:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mushrooms</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cheese</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">peppers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">onions</span></span><br></pre></td></tr></table></figure>

<p>同样渲染后可以得到正确结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649432089-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">chartName:</span> <span class="string">mychart</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;pizza&quot;</span></span><br><span class="line">  <span class="attr">chartName:</span> <span class="string">mychart</span></span><br></pre></td></tr></table></figure>

<p>测试结束。😘</p>
<p>到现在为止，我们只研究了在一个文件中声明的一个模板，但是，<strong>Helm 模板语言的强大功能之一是它能够声明多个模板并将其一起使用</strong>。我们将在下面的章节中来讨论这一点。</p>
<h2 id="6、命名模板"><a href="#6、命名模板" class="headerlink" title="6、命名模板"></a>6、命名模板</h2><p>前面我们都是只操作的一个模板，现在我们来尝试使用多个模板文件。在本节中，我们可以了解到<strong>如何在一个文件中定义命名模板</strong>，然后在其他地方使用它们。命名模板（有时也叫<strong>子模板</strong>）只是在文件内部定义的有名称的模板。主要有两种创建方式以及几种不同的使用方式。</p>
<p>当使用命名模板的时候有几个重要细节：模板名称是<strong>全局</strong>的，<strong>如果声明两个具有相同名称的模板，则会使用最后被加载的模板</strong>。由于子 chart 中的模板是与顶级模板一起编译的，所以需要谨慎命名。</p>
<p>一种流行的命名约定是在每个定义的模板前添加 chart 名称：<code>&#123;&#123; define "mychart.labels" &#125;&#125;</code>，通过使用特定的 chart 名作为前缀，我们可以避免由于两个不同的 chart 实现了相同名称的模板而引起的冲突。</p>
<h3 id="1-partials-和-文件"><a href="#1-partials-和-文件" class="headerlink" title="1.partials 和 _ 文件"></a>1.partials 和 _ 文件</h3><p>到目前为止，我们只使用了一个模板文件，但是 Helm 的模板语言允许我们创建命名的嵌入式模板，可以在其他位置进行访问。在编写这些模板之前，有一些值得一提的命名约定：</p>
<ul>
<li><code>templates/</code> 中的大多数文件都被视为 Kubernetes 资源清单文件（NOTES.txt 除外）</li>
<li>以 <code>_</code> 开头命名的文件也不会被当做 Kubernetes 资源清单文件</li>
<li>下划线开头的文件不会被当做资源清单之外，还可以被其他 chart 模板调用</li>
</ul>
<p><code>_</code> 开头的这些文件其实就是 Helm 中的 <code>partials</code> 文件，所以其实我们完全可以将命名模板定义在这些 <code>partials</code> 文件中，默认就是 <code>_helpers.tpl</code> 文件，其实在前面我们创建的 <code>mychart</code> 包中也可以找到这个文件。</p>
<h3 id="2-define-和-template"><a href="#2-define-和-template" class="headerlink" title="2.define 和 template"></a>2.<code>define</code> 和 <code>template</code></h3><table><tr><td bgcolor=yellow>💘 示例：define和template测试-2022.4.9(测试成功)</td></tr></table>

<p><code>define</code> 关键字可以让我们在模板文件中创建命名模板，它的语法如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">define</span> <span class="string">&quot;MY.NAME&quot;</span> &#125;&#125;</span><br><span class="line">  <span class="comment"># 模板内容区域</span></span><br><span class="line">&#123;&#123; <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>



<p>1️⃣ <code>将命名模板放在模板文件里</code></p>
<p>比如我们可以定义一个模板来封装下 Kubernetes 的 labels 标签：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;mychart.labels&quot;</span> &#125;&#125;</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">generator:</span> <span class="string">helm</span></span><br><span class="line">    <span class="attr">date:</span> &#123;&#123; <span class="string">now</span> <span class="string">|</span> <span class="string">htmlDate</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们可以将该模板嵌入到前面的 ConfigMap 模板中，然后将其包含在模板中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;mychart.labels&quot;</span> &#125;&#125;</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">generator:</span> <span class="string">helm</span></span><br><span class="line">    <span class="attr">date:</span> &#123;&#123; <span class="string">now</span> <span class="string">|</span> <span class="string">htmlDate</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">template</span> <span class="string">&quot;mychart.labels&quot;</span> &#125;&#125;</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">$key</span>, <span class="string">$val</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">$key</span> &#125;&#125;<span class="string">:</span> &#123;&#123; <span class="string">$val</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>当模板引擎读取这个文件的时候，它会存储 <code>mychart.labels</code> 的引用，直到该模板被调用，然后会内联渲染该模板。我们渲染这个模板可以都到如下所示的结果（记得先删掉默认生成的 <code>_helpers.tpl</code> 文件）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">helm</span> <span class="string">install</span> <span class="string">--generate-name</span> <span class="string">--dry-run</span> <span class="string">./mychart</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649491252-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">     <span class="attr">generator:</span> <span class="string">helm</span></span><br><span class="line">     <span class="attr">date:</span> <span class="number">2022-04-09</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">chartName:</span> <span class="string">mychart</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;pizza&quot;</span></span><br><span class="line">  <span class="attr">chartName:</span> <span class="string">mychart</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>2️⃣ <code>将命名模板放在_helpers.tpl里</code></p>
<p>一般来说，Helm 中约定将这些模板统一放到一个 partials 文件中，通常就是 <code>_helpers.tpl</code> 文件中，我们将上面的命名模板移动到该文件（<code>templates/_helpers.tpl</code>）中去：</p>
<p>这里，我们先创建下这个<code>_helpers.tpl</code>文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">/*</span> <span class="string">生成基本的</span> <span class="string">Label</span> <span class="string">标签</span> <span class="string">*/</span>&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;mychart.labels&quot;</span> &#125;&#125;</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">generator:</span> <span class="string">helm</span></span><br><span class="line">    <span class="attr">date:</span> &#123;&#123; <span class="string">now</span> <span class="string">|</span> <span class="string">htmlDate</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>一般来说，我们也会用一个简单的块（<code>&#123;&#123;/*...*/&#125;&#125;</code>）来注释这个命名模板的作用。</p>
<p>现在虽然我们把命名模板放到了 <code>_helpers.tpl</code> 文件中，但是我们在 <code>configmap.yaml</code> 模板中还是可以访问，因为命名模板是全局的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">template</span> <span class="string">&quot;mychart.labels&quot;</span> &#125;&#125;</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">$key</span>, <span class="string">$val</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">$key</span> &#125;&#125;<span class="string">:</span> &#123;&#123; <span class="string">$val</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>因为上面我们提到过命名模板是全局的，我们可以再渲染下上面的模板可以得到正确的结果。</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220409160431607.png" alt="image-20220409160431607"></p>
<p>测试结束。😘</p>
<h3 id="3-设置模板范围"><a href="#3-设置模板范围" class="headerlink" title="3.设置模板范围"></a>3.设置模板范围</h3><table><tr><td bgcolor=yellow>💘 示例：设置模板范围-2022.4.9(测试成功)</td></tr></table>

<p>1️⃣ 上面我们定义的模板中，还没有使用到任何对象，只使用了函数，现在我们来修改下定义的命名模板，包含 chart 的名称和版本：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _heplers.tpl</span></span><br><span class="line">&#123;&#123;<span class="string">/*</span> <span class="string">生成基本的</span> <span class="string">Label</span> <span class="string">标签</span> <span class="string">*/</span>&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;mychart.labels&quot;</span> &#125;&#125;</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">generator:</span> <span class="string">helm</span></span><br><span class="line">    <span class="attr">date:</span> &#123;&#123; <span class="string">now</span> <span class="string">|</span> <span class="string">htmlDate</span> &#125;&#125;</span><br><span class="line">    <span class="attr">chartName:</span> &#123;&#123; <span class="string">.Chart.Name</span> &#125;&#125;</span><br><span class="line">    <span class="attr">chartVersion:</span> &#123;&#123; <span class="string">.Chart.Version</span> &#125;&#125;</span><br><span class="line">    <span class="attr">releaseName:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们来渲染下模板，会出现下面的错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  helm install --generate-name --dry-run ./mychart</span><br><span class="line">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">Error: INSTALLATION FAILED: unable to build kubernetes objects from release manifest: error validating <span class="string">&quot;&quot;</span>: error validating data: [unknown object <span class="built_in">type</span> <span class="string">&quot;nil&quot;</span> <span class="keyword">in</span> ConfigMap.metadata.labels.chartName, unknown object <span class="built_in">type</span> <span class="string">&quot;nil&quot;</span> <span class="keyword">in</span> ConfigMap.metadata.labels.chartVersion, unknown object <span class="built_in">type</span> <span class="string">&quot;nil&quot;</span> <span class="keyword">in</span> ConfigMap.metadata.labels.releaseName]</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>我们可以看到提示 <code>labels.chart</code> 为 <code>nil</code>，这是因为我们使用的 <code>.Chart.Name</code> 不在定义的这个模板的作用域范围内，当渲染命名模板（使用 <code>define</code> 定义）的时候，它将接收模板调用传递的作用域。在我们这个示例中，我们是这样引用这个模板的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">template</span> <span class="string">&quot;mychart.labels&quot;</span> &#125;&#125;</span><br></pre></td></tr></table></figure>



<p>2️⃣ 没有传入任何作用域，所以在模板内我们无法访问 <code>.</code> 中的任何内容，当然要解决很简单，我们只需要把作用域范围传递给模板即可：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">$relname</span> <span class="string">:=</span> <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">template</span> <span class="string">&quot;mychart.labels&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">$key</span>, <span class="string">$val</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">$key</span> &#125;&#125;<span class="string">:</span> &#123;&#123; <span class="string">$val</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  <span class="attr">chartName:</span> &#123;&#123; <span class="string">$.Chart.Name</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>我们这里在使用 <code>template</code> 调用模板的时候传递了 <code>.</code>，我们可以很容易传递 <code>.Values</code> 或者 <code>.Values.favorite</code> 或者我们想要的任何范围，但是这里我们想要的是顶级作用域，所以我们传递的是 <code>.</code>。</p>
<p>现在我们再来重新渲染我们的模板，可以得到如下所示的结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649492314-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">generator:</span> <span class="string">helm</span></span><br><span class="line">    <span class="attr">date:</span> <span class="number">2022-04-09</span></span><br><span class="line">    <span class="attr">chartName:</span> <span class="string">mychart</span></span><br><span class="line">    <span class="attr">chartVersion:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">releaseName:</span> <span class="string">mychart-1649492314</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">chartName:</span> <span class="string">mychart</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;pizza&quot;</span></span><br><span class="line">  <span class="attr">chartName:</span> <span class="string">mychart</span></span><br></pre></td></tr></table></figure>

<p>现在 <code>&#123;&#123; .Chart.Name &#125;&#125;</code> 解析为了 mychart，而 <code>&#123;&#123; .Chart.Version &#125;&#125;</code> 解析为了 <code>0.1.0</code>。</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220409162002848.png" alt="image-20220409162002848"></p>
<p>测试结束。😘</p>
<h3 id="4-include-函数"><a href="#4-include-函数" class="headerlink" title="4.include 函数"></a>4.include 函数</h3><table><tr><td bgcolor=yellow>💘 示例：include函数-2022.4.9(测试成功)</td></tr></table>

<p>1️⃣ 假设我们定义了一个如下所示的简单模板：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _helpers.tpl</span></span><br><span class="line">&#123;&#123;<span class="string">/*</span> <span class="string">定义一个简单的chart</span> <span class="string">app模板*/</span>&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;mychart.app&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line"><span class="attr">app_name:</span> &#123;&#123; <span class="string">.Chart.Name</span> &#125;&#125;</span><br><span class="line"><span class="attr">app_version:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Chart.Version &#125;&#125;</span>&quot;</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> <span class="string">-</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们想把上面的内容插入到模板的 <code>labels</code> 部分，在 <code>data</code> 部分也想要这个内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    &#123;&#123; <span class="string">template</span> <span class="string">&quot;mychart.app&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">$key</span>, <span class="string">$val</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">$key</span> &#125;&#125;<span class="string">:</span> &#123;&#123; <span class="string">$val</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">template</span> <span class="string">&quot;mychart.app&quot;</span> <span class="string">.</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们直接渲染上面的模板还是会有错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  helm install --generate-name --dry-run ./mychart</span><br><span class="line">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">Error: INSTALLATION FAILED: unable to build kubernetes objects from release manifest: error validating <span class="string">&quot;&quot;</span>: error validating data: ValidationError(ConfigMap): unknown field <span class="string">&quot;app_version&quot;</span> <span class="keyword">in</span> io.k8s.api.core.v1.ConfigMap</span><br><span class="line">➜  local-vscode</span><br></pre></td></tr></table></figure>

<p>因为 <code>template</code> 只是一个动作，而不是一个函数，所以无法将模板调用的输出传递给其他函数，只是内联插入，相当于渲染的结果是这样的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">measly-whippet-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app_name:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">app_version:</span> <span class="string">&quot;0.1.0+1478129847&quot;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;pizza&quot;</span></span><br><span class="line">  <span class="attr">app_name:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">app_version:</span> <span class="string">&quot;0.1.0+1478129847&quot;</span></span><br></pre></td></tr></table></figure>



<p>:warning: 需要注意：</p>
<p>2️⃣ 很明显上面的 YAML 文件是不符合 ConfigMap 资源对象的格式要求的，所以报错了。为解决这个问题，Helm 提供了代替 <code>template</code> 的函数 <code>include</code>，可以将模板的内容导入到当前的管道中，这样就可以在管道中传递给其他函数进行处理了，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">&#123;&#123; <span class="string">include</span> <span class="string">&quot;mychart.app&quot;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">indent</span> <span class="number">4</span> &#125;&#125;</span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">$key</span>, <span class="string">$val</span> <span class="string">:=</span> <span class="string">.Values.favorite</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">$key</span> &#125;&#125;<span class="string">:</span> &#123;&#123; <span class="string">$val</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">include</span> <span class="string">&quot;mychart.app&quot;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">indent</span> <span class="number">2</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们重新渲染就可以得到正确的结果了，这是因为我们用 <code>include</code> 函数得到模板内容后通过管道传给了后面的 <code>indent</code> 函数来保证了缩进：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attr">Source:</span> <span class="string">mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1576036671-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app_name:</span> <span class="string">mychart</span></span><br><span class="line">    <span class="attr">app_version:</span> <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">&quot;coffee&quot;</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">&quot;pizza&quot;</span></span><br><span class="line">  <span class="attr">app_name:</span> <span class="string">mychart</span></span><br><span class="line">  <span class="attr">app_version:</span> <span class="string">&quot;0.1.0&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220409171721036.png" alt="image-20220409171721036"></p>
<p>:warning: 建议</p>
<blockquote>
<p>在 Helm 模板中最好使用 <code>include</code> 而不是 <code>template</code>，这样可以更好地处理 YAML 文档的输出格式。</p>
<p>有时候如果我们只想导入内容而不是模板，这个时候我们可以通过下面描述的 <code>.Files</code> 对象来访问文件实现。</p>
</blockquote>
<p>测试结束。😘</p>
<h2 id="7、访问文件"><a href="#7、访问文件" class="headerlink" title="7、访问文件"></a>7、访问文件</h2><p>在上一节中我们介绍了几种创建和访问命名模板的方法，这使得从另一个模板中导入一个模板变得很容易，但是有时候需要导入一个不是模板的文件并注入其内容，而不通过模板渲染器获得内容。</p>
<p>Helm 提供了一个 <code>.Files</code> 对象对文件的访问，但是在模板中使用这个对象之前，还有几个需要注意的事项值得一提：</p>
<ul>
<li><p>可以在 Helm chart 中添加额外的文件，这些文件也会被打包，不过需要注意，由于 Kubernetes 对象的存储限制，<strong>Charts 必须小于 1M</strong></p>
</li>
<li><p>由于一些安全原因，通过 <code>.Files</code> 对象无法访问某些文件</p>
<ul>
<li>无法访问 <code>templates/</code> 下面的文件</li>
<li>无法访问使用 <code>.helmignore</code> 排除的文件</li>
</ul>
</li>
<li><p>Chart 不会保留 UNIX 模式的信息，所以，当使用 <code>.Files</code> 对象时，文件级别的权限不会对文件的可用性产生影响。😥</p>
</li>
</ul>
<h3 id="1-基本示例"><a href="#1-基本示例" class="headerlink" title="1.基本示例"></a>1.基本示例</h3><table><tr><td bgcolor=yellow>💘 示例：访问文件基本示例-2022.4.9(测试成功)</td></tr></table>

<p>1️⃣ 现在我们来编写一个模板，将3个文件读入到 <code>ConfigMap</code> 模板中，首先我们在 chart 中添加3个文件，将3个文件都直接放置在 <code>mychart/</code> 目录中。</p>
<p><code>config1.toml</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">message = Hello from config 1</span><br></pre></td></tr></table></figure>

<p><code>config2.toml</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">message = Hello from config 2</span><br></pre></td></tr></table></figure>

<p><code>config3.toml</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">message = Hello from config 3</span><br></pre></td></tr></table></figure>



<p>2️⃣ 3个文件都是简单的 TOML 文件，我们知道这些文件的名称，所以我们可以使用 <code>range</code> 函数来遍历它们，并将其内容注入到 <code>ConfigMap</code> 中去。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">$files</span> <span class="string">:=</span> <span class="string">.Files</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">range</span> <span class="string">tuple</span> <span class="string">&quot;config1.toml&quot;</span> <span class="string">&quot;config2.toml&quot;</span> <span class="string">&quot;config3.toml&quot;</span> &#125;&#125;</span><br><span class="line">  &#123;&#123; <span class="string">.</span> &#125;&#125;<span class="string">:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    &#123;&#123; $files.Get . &#125;&#125;</span></span><br><span class="line"><span class="string"></span>  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们声明了一个 <code>$files</code> 的变量来保存 <code>.Files</code> 对象的引用，还使用了 <code>tuple</code> 函数来循环文件列表，然后我们打印每个文件夹 <code>&#123;&#123; . &#125;&#125;: |-</code>，后面使用 <code>&#123;&#123; $files.Get . &#125;&#125;</code> 获取文件内容。</p>
<p>现在我们渲染这个模板会产生包含3个文件内容的单个 ConfigMap：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Source: mychart/templates/ConfigMap.yaml</span></span><br><span class="line"><span class="comment">#ConfigMap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1649497695-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config1.toml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    message = Hello from config 1</span></span><br><span class="line"><span class="string"></span>  <span class="attr">config2.toml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    message = Hello from config 2</span></span><br><span class="line"><span class="string"></span>  <span class="attr">config3.toml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">message</span> <span class="string">=</span> <span class="string">Hello</span> <span class="string">from</span> <span class="string">config</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220409174907397.png" alt="image-20220409174907397"></p>
<p>:warning: 注意：</p>
<p>另外在处理文件的时候，对文件路径本身执行一些标准操作可能非常有用，为了解决这个问题，Helm 从 Go 的路径包中导入了许多功能供你使用，它们都可以使用与 Go 包中相同的相同名称来访问，但是首字母需要小写，比如 Base 需要变成 base，导入的函数有：- Base - Dir - Ext - IsAbs - Clean。</p>
<p>测试结束。😘</p>
<h3 id="2-Glob-模式"><a href="#2-Glob-模式" class="headerlink" title="2.Glob 模式"></a>2.Glob 模式</h3><p>随着 chart 的增长，你可能需要更多地组织文件，因此 Helm 提供了 <code>Files.Glob</code> 的方法来帮助我们获取具有 <code>glob</code> 模式的文件。</p>
<p><code>.Glob</code> 返回 <code>Files</code> 类型，所以你可以在返回的对象上调用任何 <code>Files</code> 方法。比如，我们的文件目录结构如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">foo/:</span></span><br><span class="line">  <span class="string">foo.txt</span> <span class="string">foo.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">bar/:</span></span><br><span class="line">  <span class="string">bar.go</span> <span class="string">bar.conf</span> <span class="string">baz.yaml</span></span><br></pre></td></tr></table></figure>

<p>我们可以用 <code>Glob</code> 进行多种选择：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">range</span> <span class="string">$path</span> <span class="string">:=</span> <span class="string">.Files.Glob</span> <span class="string">&quot;**.yaml&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">$path</span> &#125;&#125;<span class="string">:</span> <span class="string">|</span></span><br><span class="line">&#123;&#123; <span class="string">.Files.Get</span> <span class="string">$path</span> &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">range</span> <span class="string">$path</span>, <span class="string">$bytes</span> <span class="string">:=</span> <span class="string">.Files.Glob</span> <span class="string">&quot;foo/*&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">$path</span> &#125;&#125;<span class="string">:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; b64enc $bytes &#125;&#125;</span>&#x27;</span></span><br><span class="line">&#123;&#123; <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-ConfigMap-和-Secrets"><a href="#3-ConfigMap-和-Secrets" class="headerlink" title="3.ConfigMap 和 Secrets"></a>3.ConfigMap 和 Secrets</h3><p>想要将文件内容同时放入 ConfigMap 和 Secrets 中，以便在运行时安装到 Pod 中，这种需求很常见，为了解决这个问题，Helm 在 <code>Files</code> 类型上添加了一个实用的方法。</p>
<p>根据上面的目录结构，我们可以按照如下的方式进行处理：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">&#123;&#123; <span class="string">(.Files.Glob</span> <span class="string">&quot;foo/*&quot;</span><span class="string">).AsConfig</span> <span class="string">|</span> <span class="string">indent</span> <span class="number">2</span> &#125;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">very-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">&#123;&#123; <span class="string">(.Files.Glob</span> <span class="string">&quot;bar/*&quot;</span><span class="string">).AsSecrets</span> <span class="string">|</span> <span class="string">indent</span> <span class="number">2</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-编码"><a href="#4-编码" class="headerlink" title="4.编码"></a>4.编码</h3><table><tr><td bgcolor=yellow>💘 示例：编码-2022.4.9(测试成功)</td></tr></table>

<p>1️⃣ 我们也可以导入一个文件并用 <code>base64</code> 编码进行编码：</p>
<p>我们来创建一个<code>templates/secret.yaml</code>模板文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">|-</span></span><br><span class="line">    &#123;&#123; <span class="string">.Files.Get</span> <span class="string">&quot;config1.toml&quot;</span> <span class="string">|</span> <span class="string">b64enc</span> &#125;&#125;</span><br></pre></td></tr></table></figure>



<p>2️⃣ 上面将采用我们上面的 <code>config1.toml</code> 文件并对其内容进行 <code>base64</code> 编码，渲染会得到如下所示的结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ helm install --generate-name --dry-run ./mychart</span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: mychart-1576048287-secret</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  token: |-</span><br><span class="line">    bWVzc2FnZSA9IEhlbGxvIGZyb20gY29uZmlnIDEK</span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220409180156098.png" alt="image-20220409180156098"></p>
<p>测试结束。😘</p>
<h3 id="5-Lines"><a href="#5-Lines" class="headerlink" title="5.Lines"></a>5.Lines</h3><p>有时，需要访问模板中文件的每一行内容，Helm 也提供了方法的 <code>Lines</code> 方法，我们可以使用 <code>range</code> 函数遍历每行内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">some-file.txt:</span> &#123;&#123; <span class="string">range</span> <span class="string">.Files.Lines</span> <span class="string">&quot;foo/bar.txt&quot;</span> &#125;&#125;</span><br><span class="line">    &#123;&#123; <span class="string">.</span> &#125;&#125;&#123;&#123; <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>在 Helm 安装的时候无法将文件传递到 chart 外部，所以，如果你要求用户提供数据的话，则必须使用 <code>helm install -f</code> 或者 <code>helm install --set</code> 来获取。</p>
<h2 id="8、NOTES-txt-文件"><a href="#8、NOTES-txt-文件" class="headerlink" title="8、NOTES.txt 文件"></a>8、NOTES.txt 文件</h2><p>在本节中我们将来了解为 chart 用户提供说明的一个 <code>NOTES.txt</code> 文件，在 chart 安装或者升级结束时，Helm 可以为用户打印出一些有用的信息，使用模板也可以自定义这些信息。</p>
<p>要将安装说明添加到 chart 中，只需要创建一个 <code>templates/NOTES.txt</code> 文件，该文件纯文本的，但是可以像模板一样进行处理，并具有所有常规模板的功能和可用对象。</p>
<table><tr><td bgcolor=yellow>💘 示例：NOTES.txt-2022.4.9(测试成功)</td></tr></table>

<p>1️⃣ 现在让我们来创建一个简单的 <code>templates/NOTES.txt</code> 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Thank</span> <span class="string">you</span> <span class="string">for</span> <span class="string">installing</span> &#123;&#123; <span class="string">.Chart.Name</span> &#125;&#125;<span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Your</span> <span class="string">release</span> <span class="string">is</span> <span class="string">named</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">To</span> <span class="string">learn</span> <span class="string">more</span> <span class="string">about</span> <span class="string">the</span> <span class="string">release,</span> <span class="attr">try:</span></span><br><span class="line"></span><br><span class="line">  <span class="string">$</span> <span class="string">helm</span> <span class="string">status</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line">  <span class="string">$</span> <span class="string">helm</span> <span class="string">get</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br></pre></td></tr></table></figure>



<p>2️⃣ 现在我们运行 <code>helm install ./mychart</code>，我们就可以在底部看到这样的消息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Secret</span><br><span class="line">NAME                   TYPE      DATA      AGE</span><br><span class="line">rude-cardinal-secret   Opaque    1         0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME                      DATA      AGE</span><br><span class="line">rude-cardinal-configmap   3         0s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">Thank you <span class="keyword">for</span> installing mychart.</span><br><span class="line"></span><br><span class="line">Your release is named rude-cardinal.</span><br><span class="line"></span><br><span class="line">To learn more about the release, try:</span><br><span class="line"></span><br><span class="line">  $ helm status rude-cardinal</span><br><span class="line">  $ helm get rude-cardinal</span><br></pre></td></tr></table></figure>

<p>用这种方式可以向用户提供一个有关如何使用其新安装的 chart 的详细信息，强烈建议创建 <code>NOTES.txt</code> 文件，虽然这不是必须的。</p>
<p>测试结束。😘</p>
<h2 id="9、Subcharts-和-Global-Values"><a href="#9、Subcharts-和-Global-Values" class="headerlink" title="9、Subcharts 和 Global Values"></a>9、Subcharts 和 Global Values</h2><p>到现在为止，我们从单一模板，到多个模板文件，但是都仅仅是处理的一个 chart 包，但是 charts 可能具有一些依赖项，我们称为 <code>subcharts（子 chart）</code>，接下来我们将创建一个子 chart。</p>
<p>同样在深入了解之前，我们需要了解下子 chart 相关的一些信息。</p>
<ul>
<li>子 chart 是<strong>独立</strong>的，这意味着子 chart 不能显示依赖其父 chart</li>
<li>所以子 chart 无法访问其父级的值</li>
<li>父 chart 可以覆盖子 chart 的值</li>
<li>Helm 中有可以被所有 charts 访问的全局值的概念</li>
</ul>
<table><tr><td bgcolor=yellow>💘 示例：Subcharts和Clobal Values-2022.4.9(测试成功)</td></tr></table>

<h3 id="1-创建子chart"><a href="#1-创建子chart" class="headerlink" title="1.创建子chart"></a>1.创建子chart</h3><p>同样还是在之前操作的 <code>mychart/</code> 这个 chart 包中，我们来尝试添加一些新的子 chart：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜ <span class="built_in">cd</span> mychart/charts</span><br><span class="line">➜ helm create mysubchart</span><br><span class="line">Creating mysubchart</span><br><span class="line">➜ rm -rf mysubchart/templates/*.*</span><br><span class="line">➜ <span class="built_in">echo</span> &gt; mysubchart/values.yaml</span><br></pre></td></tr></table></figure>

<p>和前面一样，我们删除了所有的基本模板，这样我们可以从头开始。</p>
<h3 id="2-添加-values-和-模板"><a href="#2-添加-values-和-模板" class="headerlink" title="2.添加 values 和 模板"></a>2.添加 values 和 模板</h3><p>接下来我们为 mysubchart 这个子 chart 创建一个简单的模板和 values 值文件，<code>mychart/charts/mysubchart</code> 中已经有一个 <code>values.yaml</code> 文件了，在文件中添加下面的 values：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dessert:</span> <span class="string">cake</span></span><br></pre></td></tr></table></figure>

<p>下面我们再创建一个新的 ConfigMap 模板 <code>mychart/charts/mysubchart/templates/configmap.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-cfgmap2</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">dessert:</span> &#123;&#123; <span class="string">.Values.dessert</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>因为每个子 chart 都是独立的 chart，所以我们可以单独测试 <code>mysubchart</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜  helm install --generate-name --dry-run ./mychart/charts/mysubchart </span><br><span class="line">WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/hg/.kube/config</span><br><span class="line">NAME: mysubchart-1649500624</span><br><span class="line">LAST DEPLOYED: Sat Apr  9 18:37:05 2022</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: pending-install</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"><span class="comment"># Source: mysubchart/templates/configmap.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mysubchart-1649500624-cfgmap2</span><br><span class="line">data:</span><br><span class="line">  dessert: cake</span><br></pre></td></tr></table></figure>

<h3 id="3-从父-chart-覆盖-values"><a href="#3-从父-chart-覆盖-values" class="headerlink" title="3.从父 chart 覆盖 values"></a>3.从父 chart 覆盖 values</h3><p>我们原来的 chart - mychart 现在是 mysubchart 的父级 chart 了。由于 mychart 是父级，所以我们可以在 mychart 中指定配置，并将该配置发送到 mysubchart 中去，比如，我们可以这样修改 <code>mychart/values.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br><span class="line"><span class="attr">pizzaToppings:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mushrooms</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cheese</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">peppers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">onions</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysubchart:</span></span><br><span class="line">  <span class="attr">dessert:</span> <span class="string">ice</span> <span class="string">cream</span></span><br></pre></td></tr></table></figure>

<p>最后两行，<code>mysubchart</code> 部分中的所有指令都会被发送到 <code>mysubchart</code> 子 chart 中，所以，如果我们现在渲染模板，我们可以看到 <code>mysubchart</code> 的 ConfigMap 会被渲染成如下的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜   helm install --generate-name --dry-run ./mychart <span class="comment">#注意：本次是直接渲染父charts目录的</span></span><br><span class="line"><span class="comment"># Source: mychart/charts/mysubchart/templates/configmap.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: mychart-1649500768-cfgmap2</span><br><span class="line">data:</span><br><span class="line">  dessert: ice cream</span><br></pre></td></tr></table></figure>

<p>我们可以看到顶层的 values 值覆盖了子 chart 中的值。这里有一个细节需要注意，我们没有将 <code>mychart/charts/mysubchart/templates/configmap.yaml</code> 模板更改为指向 <code>.Values.mysubchart.dessert</code>，因为从该模板的角度来看，该值仍然位于 <code>.Values.dessert</code>，当模板引擎传递 values 值的时候，它会设置这个作用域，所以，对于 <code>mysubchart</code> 模板，<code>.Values</code> 中仅仅提供用于该子 chart 的值。</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220409184138057.png" alt="image-20220409184138057"></p>
<p>但是有时候如果我们确实希望某些值可以用于所有模板，这个时候就可以使用全局 chart values 值来完成了。</p>
<h3 id="4-全局值"><a href="#4-全局值" class="headerlink" title="4.全局值"></a>4.全局值</h3><p>全局值是可以从任何 chart 或子 chart 中都可以访问的值，全局值需要显示的声明，<strong>不能将现有的非全局对象当作全局对象使用</strong>。</p>
<p>Values 数据类型具有一个名为 <code>Values.global</code> 的保留部分，可以在其中设置全局值，我们在 <code>mychart/values.yaml</code> 文件中添加一个全局值：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">favorite:</span></span><br><span class="line">  <span class="attr">drink:</span> <span class="string">coffee</span></span><br><span class="line">  <span class="attr">food:</span> <span class="string">pizza</span></span><br><span class="line"><span class="attr">pizzaToppings:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mushrooms</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cheese</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">peppers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">onions</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysubchart:</span></span><br><span class="line">  <span class="attr">dessert:</span> <span class="string">ice</span> <span class="string">cream</span></span><br><span class="line"></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">salad:</span> <span class="string">caesar</span></span><br></pre></td></tr></table></figure>

<p>由于全局值的原因，在 <code>mychart/templates/configmap.yaml</code> 和 <code>mysubchart/templates/configmap.yaml</code> 下面都应该可以以 <code>&#123;&#123; .Values.global.salad &#125;&#125;</code> 的形式来访问这个值。</p>
<p><code>mychart/templates/configmap.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">salad:</span> &#123;&#123; <span class="string">.Values.global.salad</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p><code>mysubchart/templates/configmap.yaml</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;<span class="string">-cfgmap2</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">dessert:</span> &#123;&#123; <span class="string">.Values.dessert</span> &#125;&#125;</span><br><span class="line">  <span class="attr">salad:</span> &#123;&#123; <span class="string">.Values.global.salad</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们渲染这个模板，可以得到如下所示的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/charts/mysubchart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1576053485-cfgmap2</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">dessert:</span> <span class="string">ice</span> <span class="string">cream</span></span><br><span class="line">  <span class="attr">salad:</span> <span class="string">caesar</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-1576053485-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">salad:</span> <span class="string">caesar</span></span><br></pre></td></tr></table></figure>

<p>全局值对于传递这样的数据比较有用。</p>
<h3 id="5-共享模板"><a href="#5-共享模板" class="headerlink" title="5.共享模板"></a>5.共享模板</h3><p>父级 chart 和子 chart 可以共享模板，任何 chart 中已定义的块都可以用于其他 chart。比如，我们可以定义一个简单的模板，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;labels&quot;</span> &#125;&#125;<span class="attr">from:</span> <span class="string">mychart&#123;&#123;</span> <span class="string">end</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>前面我们提到过可以使用在模板中使用 <code>include</code> 和 <code>template</code>，但是使用 <code>include</code> 的一个优点是可以动态引入模板的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; <span class="string">include</span> <span class="string">$mytemplate</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>一般情况下，我们不会去使用共享模板，容易冲突。</p>
</blockquote>
<p>测试结束。😘</p>
<h2 id="10、模板调试"><a href="#10、模板调试" class="headerlink" title="10、模板调试"></a>10、模板调试</h2><p>调试模板可能比较麻烦，因为渲染的模板会发送到 Kubernetes API server，而 API server 可能会因为格式以外的一些原因而拒绝 YAML 文件。</p>
<p>下面这些命令可以帮助你调试一些问题：</p>
<ul>
<li><p><code>helm lint</code> 是验证 chart 是否遵循最佳实践的首选工具</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220409190403340.png" alt="image-20220409190403340"></p>
</li>
<li><p><code>helm install --dry-run --debug</code> 或者 <code>helm template --debug</code>：前面我们已经使用了这个技巧，这个是让服务器渲染模板，然后返回生成的资源清单文件的好方法，而且不会真正的去安装这些资源</p>
</li>
<li><p><code>helm get manifest</code>：这是查看服务器上安装了哪些模板的好方法</p>
</li>
</ul>
<p>当你的 YAML 文件无法解析的时候，但你想要查看生成的内容的时候，检索 YAML 的一种简单方法是注释掉模板中的问题部分，然后重新运行 <code>helm install --dry-run --debug</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="comment"># some: problem section</span></span><br><span class="line"><span class="comment"># &#123;&#123; .Values.foo | quote &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面的内容将呈现并返回完整的注释：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="comment"># some: problem section</span></span><br><span class="line"><span class="comment">#  &quot;bar&quot;</span></span><br></pre></td></tr></table></figure>

<p>这提供了一种查看生成的内容的快速方法。</p>
<h2 id="11、Chart-Hooks"><a href="#11、Chart-Hooks" class="headerlink" title="11、Chart Hooks"></a>11、Chart Hooks</h2><p>Helm 也提供了一种 Hook 机制，可以允许 chart 开发人员在 release 生命周期的某些时间点进行干预。比如，可以使用 hook 来进行下面的操作：</p>
<ul>
<li>在加载任何 charts 之前，在安装的时候加载 ConfigMap 或者 Secret</li>
<li>在安装新的 chart 之前，执行一个 Job 来备份数据库，然后在升级后执行第二个 Job 还原数据</li>
<li>在删除 release 之前运行一个 JOb，以在删除 release 之前适当地取消相关服务</li>
</ul>
<p>Hooks 的工作方式类似于普通的模板，但是他们具有特殊的注解，这些注解使 Helm 可以用不同的方式来使用他们。</p>
<h3 id="1-Hooks"><a href="#1-Hooks" class="headerlink" title="1.Hooks"></a>1.Hooks</h3><p>在 Helm 中定义了如下一些可供我们使用的 Hooks：</p>
<ul>
<li>预安装<code>pre-install</code>：在模板渲染后，kubernetes 创建任何资源之前执行</li>
<li>安装后<code>post-install</code>：在所有 kubernetes 资源安装到集群后执行</li>
<li>预删除<code>pre-delete</code>：在从 kubernetes 删除任何资源之前执行删除请求</li>
<li>删除后<code>post-delete</code>：删除所有 release 的资源后执行</li>
<li>升级前<code>pre-upgrade</code>：在模板渲染后，但在任何资源升级之前执行</li>
<li>升级后<code>post-upgrade</code>：在所有资源升级后执行</li>
<li>预回滚<code>pre-rollback</code>：在模板渲染后，在任何资源回滚之前执行</li>
<li>回滚后<code>post-rollback</code>：在修改所有资源后执行回滚请求</li>
<li>测试<code>test</code>：在调用 Helm <code>test</code> 子命令的时候执行（可以查看<a target="_blank" rel="noopener" href="https://helm.sh/docs/chart_tests/">测试文档</a>）</li>
</ul>
<h3 id="2-生命周期"><a href="#2-生命周期" class="headerlink" title="2.生命周期"></a>2.生命周期</h3><p>Hooks 允许开发人员在 release 的生命周期中的一些关键节点执行一些钩子函数，我们正常安装一个 chart 包的时候的生命周期如下所示：</p>
<ol>
<li>用户运行 <code>helm install foo</code></li>
<li>Helm 库文件调用安装 API</li>
<li>经过一些验证，Helm 库渲染 <code>foo</code> 模板</li>
<li>Helm 库将产生的资源加载到 kubernetes 中去</li>
<li>Helm 库将 release 对象和其他数据返回给客户端</li>
<li>Helm 客户端退出</li>
</ol>
<p>如果开发人员在 <code>install</code> 的生命周期中定义了两个 hook：<code>pre-install</code>和<code>post-install</code>，那么我们安装一个 chart 包的生命周期就会多一些步骤了：</p>
<ol>
<li>用户运行<code>helm install foo</code></li>
<li>Helm 库文件调用安装 API</li>
<li>在 <code>crds/</code> 目录下面的 CRDs 被安装</li>
<li>经过一些验证，Helm 库渲染 <code>foo</code> 模板</li>
<li>Helm 库将 hook 资源加载到 kubernetes 中，准备执行<code>pre-install</code> hooks</li>
<li>Helm 库会根据权重对 hooks 进行排序（默认分配权重0，权重相同的 hook 按升序排序）</li>
<li>Helm 库然后加载最低权重的 hook</li>
<li>Helm 库会等待，直到 hook 准备就绪</li>
<li>Helm 库将产生的资源加载到 kubernetes 中，注意如果添加了 <code>--wait</code> 参数，Helm 库会等待所有资源都准备好，在这之前不会运行 <code>post-install</code> hook</li>
<li>Helm 库执行 <code>post-install</code> hook（加载 hook 资源）</li>
<li>Helm 库等待，直到 hook 准备就绪</li>
<li>Helm 库将 release 对象和其他数据返回给客户端</li>
<li>Helm 客户端退出</li>
</ol>
<p>等待 hook 准备就绪，这是一个阻塞的操作，如果 hook 中声明的是一个 Job 资源，Helm 将等待 Job 成功完成，如果失败，则发布失败，在这个期间，Helm 客户端是处于暂停状态的。</p>
<p>对于所有其他类型，只要 kubernetes 将资源标记为加载（添加或更新），资源就被视为就绪状态，当一个 hook 声明了很多资源是，这些资源是被串行执行的。</p>
<p>另外需要注意的是 hook 创建的资源不会作为 release 的一部分进行跟踪和管理，一旦 Helm 验证了 hook 已经达到了就绪状态，它就不会去管它了。</p>
<p>所以，如果我们在 hook 中创建了资源，那么不能依赖 <code>helm uninstall</code> 去删除资源，因为 hook 创建的资源已经不受控制了，要销毁这些资源，你需要将 <code>helm.sh/hook-delete-policy</code> 这个 annotation 添加到 hook 模板文件中，或者设置 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/ttlafterfinished/">Job 资源的生存（TTL）字段</a>。</p>
<h3 id="3-编写-Hook"><a href="#3-编写-Hook" class="headerlink" title="3.编写 Hook"></a>3.编写 Hook</h3><table><tr><td bgcolor=yellow>💘 示例：编写hook-2022.4.10(测试成功)</td></tr></table>

<p>Hooks 就是 Kubernetes 资源清单文件，在元数据部分带有一些特殊的注解，因为他们是模板文件，所以你可以使用普通模板所有的功能，包括读取 <code>.Values</code>、<code>.Release</code> 和 <code>.Template</code>。</p>
<p>1️⃣ 例如，在 <code>templates/post-install-job.yaml</code> 文件中声明一个 post-install 的 hook：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Release.Name &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> &#123;&#123; <span class="string">.Release.Service</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">    <span class="attr">app.kubernetes.io/instance:</span> &#123;&#123; <span class="string">.Release.Name</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> &#123;&#123; <span class="string">.Chart.AppVersion</span> &#125;&#125;</span><br><span class="line">    <span class="attr">helm.sh/chart:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Chart.Name &#125;&#125;</span>-<span class="template-variable">&#123;&#123; .Chart.Version &#125;&#125;</span>&quot;</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># 因为添加了这个 hook，所以我们这个资源被定义为了 hook</span></span><br><span class="line">    <span class="comment"># 如果没有这行，则当前这个 Job 会被当成 release 的一部分内容。</span></span><br><span class="line">    <span class="attr">&quot;helm.sh/hook&quot;:</span> <span class="string">post-install</span></span><br><span class="line">    <span class="attr">&quot;helm.sh/hook-weight&quot;:</span> <span class="string">&quot;-5&quot;</span></span><br><span class="line">    <span class="comment">#&quot;helm.sh/hook-delete-policy&quot;: hook-succeeded</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Release.Name &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/managed-by:</span> &#123;&#123; <span class="string">.Release.Service</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">        <span class="attr">app.kubernetes.io/instance:</span> &#123;&#123; <span class="string">.Release.Name</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">        <span class="attr">helm.sh/chart:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Chart.Name &#125;&#125;</span>-<span class="template-variable">&#123;&#123; .Chart.Version &#125;&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">post-install-job</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">&quot;alpine:3.3&quot;</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/sleep&quot;</span>,<span class="string">&quot;<span class="template-variable">&#123;&#123; default &quot;10&quot; .Values.sleepyTime &#125;&#125;</span>&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>当前这个模板成为 hook 的原因就是添加这个注解：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">&quot;helm.sh/hook&quot;:</span> <span class="string">post-install</span></span><br></pre></td></tr></table></figure>



<p>2️⃣ 给values.yaml添加如下内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#values.yaml</span></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="attr">sleepyTime:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>



<p>3️⃣ 安装并测试</p>
<p><code>➜  local-vscode helm install test ./mychart</code></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220410084241719.png" alt="image-20220410084241719"></p>
<p>4️⃣ 一种资源也可以实现多个 hooks：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">&quot;helm.sh/hook&quot;:</span> <span class="string">post-install,post-upgrade</span></span><br></pre></td></tr></table></figure>

<p>类似的，实现给定 hook 的资源数量也没有限制，比如可以将 secret 和一个 configmap 都声明为 <code>pre-install</code> hook。</p>
<p>当子 chart 声明 hooks 的时候，也会对其进行调用，顶层的 chart 无法禁用子 chart 所声明的 hooks。可以为 hooks 定义权重，这将有助于确定 hooks 的执行顺序：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">&quot;helm.sh/hook-weight&quot;:</span> <span class="string">&quot;5&quot;</span></span><br></pre></td></tr></table></figure>

<p>hook 权重可以是正数也可以是负数，但是必须用字符串表示，当 Helm 开始执行特定种类的 hooks 的时候，它将以升序的方式对这些 hooks 进行排序。</p>
<h3 id="4-Hook-删除策略"><a href="#4-Hook-删除策略" class="headerlink" title="4.Hook 删除策略"></a>4.Hook 删除策略</h3><p>我们还可以定义确定何时删除相应 hook 资源的策略，hook 删除策略可以使用下面的注解进行定义：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">  <span class="attr">&quot;helm.sh/hook-delete-policy&quot;:</span> <span class="string">before-hook-creation,hook-succeeded</span></span><br></pre></td></tr></table></figure>

<p>我们也可以选择一个或多个已定义的注解：</p>
<ul>
<li><code>before-hook-creation</code>：运行一个新的 hook 之前删除前面的资源（默认）</li>
<li><code>hook-succeeded</code>：hook 成功执行后删除资源</li>
<li><code>hook-failed</code>：hook 如果执行失败则删除资源</li>
</ul>
<p>如果未指定任何 hook 删除策略注解，则默认情况下会使用 <code>before-hook-creation</code> 策略。</p>
<h2 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h2><p>我的博客主旨：我希望每一个人拿着我的博客都可以做出实验现象，先把实验做出来，然后再结合理论知识更深层次去理解技术点，这样学习起来才有乐趣和动力。并且，我的博客内容步骤是很完整的，也分享源码和实验用到的软件，希望能和大家一起共同进步！</p>
<p>各位小伙伴在实际操作过程中如有什么疑问，可随时联系本人免费帮您解决问题：</p>
<ol>
<li><p>个人微信二维码：x2675263825 （舍得）， qq：2675263825。</p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144206.png" alt="image-20211002091450217"></p>
</li>
<li><p>个人微信公众号：云原生架构师实战</p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144224.png" alt="image-20211002141739664"></p>
</li>
<li><p>个人博客地址：<a target="_blank" rel="noopener" href="http://www.onlyonexl.cn/">www.onlyonexl.cn</a></p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144213.png" alt="image-20211002092057988"></p>
</li>
<li><p>个人csdn</p>
<p> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39246554?spm=1010.2135.3001.5421">https://blog.csdn.net/weixin_39246554?spm=1010.2135.3001.5421</a></p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144230.png" alt="image-20211002092344616"></p>
</li>
<li><p>个人已开源干货😘</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">链接</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><font color=red><strong>实战：打造一款王者云笔记：typora+坚果云+阿里云oss &amp; 定制宇宙中最美的typora主题皮肤 &amp; 玩转vscode</strong></font>(永久开源)</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.jianguoyun.com/p/DXS6qiIQvPWVCRiS0qoE">https://www.jianguoyun.com/p/DXS6qiIQvPWVCRiS0qoE</a></td>
</tr>
</tbody></table>
</li>
</ol>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>好了，关于helm模板开发就到这里了，感谢大家阅读，最后贴上我女神的photo，祝大家生活快乐，每天都过的有意义哦，我们下期见！</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20220410084957142.png" alt="image-20220410084957142"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">一个人</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.onlyyou520.com/2022/04/10/143%20Helm%E6%A8%A1%E6%9D%BF%E5%BC%80%E5%8F%91/">https://www.onlyyou520.com/2022/04/10/143%20Helm%E6%A8%A1%E6%9D%BF%E5%BC%80%E5%8F%91/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">一个人</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/k8s/">
                                    <span class="chip bg-color">k8s</span>
                                </a>
                            
                                <a href="/tags/helm/">
                                    <span class="chip bg-color">helm</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/04/16/144%20Devops%E7%90%86%E8%AE%BA%E4%B8%8E%E5%9F%BA%E7%A1%80-2022.4.15(%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B8%83)/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="Devops理论与基础">
                        
                        <span class="card-title">Devops理论与基础</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-04-16
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/devops/" class="post-category">
                                    devops
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/devops/">
                        <span class="chip bg-color">devops</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/04/07/142%20%E5%A6%82%E4%BD%95%E5%B0%86Git%E4%BB%93%E5%BA%93%E5%A4%87%E4%BB%BD%E5%88%B0%E6%9C%AC%E5%9C%B0%EF%BC%9F/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="如何将Git仓库备份到本地">
                        
                        <span class="card-title">如何将Git仓库备份到本地</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-04-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/git/" class="post-category">
                                    git
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/git/">
                        <span class="chip bg-color">git</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">一个人</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/OnlyOnexl" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2675263825@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2675263825" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2675263825" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
