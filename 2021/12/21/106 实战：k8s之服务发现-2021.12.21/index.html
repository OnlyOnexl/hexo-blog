<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="å®æˆ˜ï¼šk8sä¹‹æœåŠ¡å‘ç°-2021.12.21, Love">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>å®æˆ˜ï¼šk8sä¹‹æœåŠ¡å‘ç°-2021.12.21 | Love</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Love</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>ç•™è¨€æ¿</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>å‹æƒ…é“¾æ¥</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Love</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			ç•™è¨€æ¿
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			å‹æƒ…é“¾æ¥
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">å®æˆ˜ï¼šk8sä¹‹æœåŠ¡å‘ç°-2021.12.21</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/k8s/">
                                <span class="chip bg-color">k8s</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/k8s/" class="post-category">
                                k8s
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2021-12-21
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="å®æˆ˜ï¼šk8sä¹‹æœåŠ¡å‘ç°-2021-12-21"><a href="#å®æˆ˜ï¼šk8sä¹‹æœåŠ¡å‘ç°-2021-12-21" class="headerlink" title="å®æˆ˜ï¼šk8sä¹‹æœåŠ¡å‘ç°-2021.12.21"></a>å®æˆ˜ï¼šk8sä¹‹æœåŠ¡å‘ç°-2021.12.21</h2><p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20211212152405943.png" alt="image-20211212152405943"></p>
<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><p>[TOC]</p>
<h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å®éªŒç¯å¢ƒï¼š</span><br><span class="line">1ã€win10,vmwrokstationè™šæœºï¼›</span><br><span class="line">2ã€k8sé›†ç¾¤ï¼š3å°centos7.6 1810è™šæœºï¼Œ1ä¸ªmasterèŠ‚ç‚¹,2ä¸ªnodeèŠ‚ç‚¹</span><br><span class="line">   k8s versionï¼šv1.22.2</span><br><span class="line">   containerd://1.5.5</span><br></pre></td></tr></table></figure>

<h2 id="å®éªŒè½¯ä»¶"><a href="#å®éªŒè½¯ä»¶" class="headerlink" title="å®éªŒè½¯ä»¶"></a>å®éªŒè½¯ä»¶</h2><p>æ— </p>
<h2 id="1ã€æœåŠ¡å‘ç°"><a href="#1ã€æœåŠ¡å‘ç°" class="headerlink" title="1ã€æœåŠ¡å‘ç°"></a>1ã€æœåŠ¡å‘ç°</h2><p>ä¸Šé¢æˆ‘ä»¬è®²è§£äº† Service çš„ç”¨æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Service ç”Ÿæˆçš„ <strong>ClusterIP(VIP)</strong> æ¥è®¿é—® Pod æä¾›çš„æœåŠ¡ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼š<strong>æˆ‘ä»¬æ€ä¹ˆçŸ¥é“æŸä¸ªåº”ç”¨çš„ VIP å‘¢ï¼Ÿ</strong>æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªåº”ç”¨ï¼Œä¸€ä¸ªæ˜¯ api åº”ç”¨ï¼Œä¸€ä¸ªæ˜¯ db åº”ç”¨ï¼Œä¸¤ä¸ªåº”ç”¨éƒ½æ˜¯é€šè¿‡ Deployment è¿›è¡Œç®¡ç†çš„ï¼Œå¹¶ä¸”éƒ½é€šè¿‡ Service æš´éœ²å‡ºäº†ç«¯å£æä¾›æœåŠ¡ã€‚api éœ€è¦è¿æ¥åˆ° db è¿™ä¸ªåº”ç”¨ï¼Œæˆ‘ä»¬åªçŸ¥é“ db åº”ç”¨çš„åç§°å’Œ db å¯¹åº”çš„ Service çš„åç§°ï¼Œä½†æ˜¯å¹¶ä¸çŸ¥é“å®ƒçš„ VIP åœ°å€ï¼Œæˆ‘ä»¬å‰é¢çš„ Service è¯¾ç¨‹ä¸­æ˜¯ä¸æ˜¯å­¦ä¹ åˆ°<strong>æˆ‘ä»¬é€šè¿‡ ClusterIP å°±å¯ä»¥è®¿é—®åˆ°åé¢çš„ Pod æœåŠ¡</strong>ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“äº† VIP çš„åœ°å€æ˜¯ä¸æ˜¯å°±è¡Œäº†ï¼Ÿ</p>
<blockquote>
<p>:warning: æ³¨æ„ï¼šåœ¨å®é™…å·¥ä½œåº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¾ˆå°‘å»æŠŠè®¿é—®åœ°å€ç”¨ipå›ºå®šä¸‹æ¥ã€‚æˆ‘ä»¬è¦è§£å†³è¿™ç§é—®é¢˜ï¼Œä¸€èˆ¬æœ‰2ç§æ–¹æ³•ã€‚<br>ç¬¬ä¸€ç§ï¼šç¯å¢ƒå˜é‡ã€‚<br>ç¬¬äºŒç§ï¼šDNSã€‚</p>
</blockquote>
<h3 id="1-1-ç¯å¢ƒå˜é‡"><a href="#1-1-ç¯å¢ƒå˜é‡" class="headerlink" title="1.1 ç¯å¢ƒå˜é‡"></a>1.1 ç¯å¢ƒå˜é‡</h3><p>ä¸ºäº†è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œåœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼ŒKubernetes é‡‡ç”¨äº†ç¯å¢ƒå˜é‡çš„æ–¹æ³•ï¼Œæ¯ä¸ª Pod å¯åŠ¨çš„æ—¶å€™ï¼Œ<strong>ä¼šé€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®æ‰€æœ‰æœåŠ¡çš„ IP å’Œ port ä¿¡æ¯</strong>ï¼Œè¿™æ · Pod ä¸­çš„åº”ç”¨å¯ä»¥é€šè¿‡è¯»å–ç¯å¢ƒå˜é‡æ¥è·å–ä¾èµ–æœåŠ¡çš„åœ°å€ä¿¡æ¯ï¼Œè¿™ç§æ–¹æ³•ä½¿ç”¨èµ·æ¥ç›¸å¯¹ç®€å•ï¼Œ<strong>ä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜å°±æ˜¯ä¾èµ–çš„æœåŠ¡å¿…é¡»åœ¨ Pod å¯åŠ¨ä¹‹å‰å°±å­˜åœ¨</strong>ï¼Œä¸ç„¶æ˜¯ä¸ä¼šè¢«æ³¨å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­çš„ã€‚</p>
<p>ğŸ“ æ¡ˆä¾‹æµ‹è¯•</p>
<p>æ¯”å¦‚æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ª Nginx æœåŠ¡ï¼š(test-nginx.yaml)</p>
<p>[root@master1 ~]#vim test-nginx.yaml </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deploy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸Šé¢çš„æœåŠ¡å¹¶æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f test-nginx.yaml </span></span><br><span class="line">deployment.apps/nginx-deploy created</span><br><span class="line">service/nginx-service created</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get po,deploy,svc -owide</span></span><br><span class="line">NAME                                READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/nginx-deploy-5d59d67564-7bzf7   1/1     Running   0          51s   10.244.2.210   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/nginx-deploy-5d59d67564-rdglk   1/1     Running   0          51s   10.244.1.89    node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES        SELECTOR</span><br><span class="line">deployment.apps/nginx-deploy   2/2     2            2           51s   nginx        nginx:1.7.9   app=nginx</span><br><span class="line"></span><br><span class="line">NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE   SELECTOR</span><br><span class="line">service/kubernetes      ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    42d   &lt;none&gt;</span><br><span class="line">service/nginx-service   ClusterIP   10.105.30.147   &lt;none&gt;        5000/TCP   51s   app=nginx</span><br><span class="line">[root@master1 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ä¸ª Pod å’Œä¸€ä¸ªåä¸º nginx-service çš„æœåŠ¡åˆ›å»ºæˆåŠŸäº†ï¼Œè¯¥ Service ç›‘å¬çš„ç«¯å£æ˜¯ 5000ï¼ŒåŒæ—¶å®ƒä¼šæŠŠæµé‡è½¬å‘ç»™å®ƒä»£ç†çš„æ‰€æœ‰ Podï¼ˆæˆ‘ä»¬è¿™é‡Œå°±æ˜¯æ‹¥æœ‰ <code>app: nginx</code> æ ‡ç­¾çš„ä¸¤ä¸ª Podï¼‰ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å†æ¥åˆ›å»ºä¸€ä¸ªæ™®é€šçš„ Podï¼Œè§‚å¯Ÿä¸‹è¯¥ Pod ä¸­çš„ç¯å¢ƒå˜é‡æ˜¯å¦åŒ…å«ä¸Šé¢çš„ <code>nginx-service</code> çš„æœåŠ¡ä¿¡æ¯ï¼šï¼ˆtest-pod.yamlï¼‰</p>
<p>[root@master1 ~]#vim test-pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-service-pod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.28.3</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆ›å»ºè¯¥æµ‹è¯•çš„ Podï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f test-pod.yaml </span></span><br><span class="line">pod/test-pod created</span><br></pre></td></tr></table></figure>

<p>ç­‰ Pod åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl logs test-pod </span></span><br><span class="line">KUBERNETES_PORT=tcp://10.96.0.1:443</span><br><span class="line">KUBERNETES_SERVICE_PORT=443</span><br><span class="line">HOSTNAME=test-pod</span><br><span class="line">SHLVL=1</span><br><span class="line">HOME=/root</span><br><span class="line">NGINX_SERVICE_PORT_5000_TCP_ADDR=10.105.30.147</span><br><span class="line">NGINX_SERVICE_PORT_5000_TCP_PORT=5000</span><br><span class="line">NGINX_SERVICE_PORT_5000_TCP_PROTO=tcp</span><br><span class="line">KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">NGINX_SERVICE_SERVICE_HOST=10.105.30.147</span><br><span class="line">NGINX_SERVICE_PORT_5000_TCP=tcp://10.105.30.147:5000</span><br><span class="line">KUBERNETES_PORT_443_TCP_PORT=443</span><br><span class="line">KUBERNETES_PORT_443_TCP_PROTO=tcp</span><br><span class="line">NGINX_SERVICE_SERVICE_PORT=5000</span><br><span class="line">NGINX_SERVICE_PORT=tcp://10.105.30.147:5000</span><br><span class="line">KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443</span><br><span class="line">KUBERNETES_SERVICE_PORT_HTTPS=443</span><br><span class="line">KUBERNETES_SERVICE_HOST=10.96.0.1</span><br><span class="line">PWD=/</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰“å°äº†å¾ˆå¤šç¯å¢ƒå˜é‡ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…æ‹¬æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ nginx-service è¿™ä¸ªæœåŠ¡ï¼Œæœ‰ HOSTã€PORTã€PROTOã€ADDR ç­‰ï¼Œä¹ŸåŒ…æ‹¬å…¶ä»–å·²ç»å­˜åœ¨çš„ Service çš„ç¯å¢ƒå˜é‡ï¼Œç°åœ¨å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨è¿™ä¸ª Pod é‡Œé¢è®¿é—® nginx-service çš„æœåŠ¡ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ç›´æ¥é€šè¿‡ <code>NGINX_SERVICE_SERVICE_HOST</code> å’Œ <code>NGINX_SERVICE_SERVICE_PORT</code> å°±å¯ä»¥äº†ï¼Œ<strong>ä½†æ˜¯å¦‚æœè¿™ä¸ª Pod å¯åŠ¨èµ·æ¥çš„æ—¶å€™ nginx-service æœåŠ¡è¿˜æ²¡å¯åŠ¨èµ·æ¥ï¼Œåœ¨ç¯å¢ƒå˜é‡ä¸­æˆ‘ä»¬æ˜¯æ— æ³•è·å–åˆ°è¿™äº›ä¿¡æ¯çš„</strong>ï¼Œ<strong>å½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>initContainer</code> ä¹‹ç±»çš„æ–¹æ³•æ¥ç¡®ä¿ nginx-service å¯åŠ¨åå†å¯åŠ¨ Pod</strong>ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•æ¯•ç«Ÿå¢åŠ äº† Pod å¯åŠ¨çš„å¤æ‚æ€§ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯æœ€ä¼˜çš„æ–¹æ³•ï¼Œå±€é™æ€§å¤ªå¤šäº†ã€‚</p>
<blockquote>
<p>:warning: æ³¨æ„ï¼škubernetesè¿™ä¸ªserviceè¿™ä¸ªæ˜¯è°åˆ›å»ºçš„ï¼Ÿ</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get svc</span></span><br><span class="line">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kubernetes      ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP    42d</span><br><span class="line">nginx-service   ClusterIP   10.98.166.23   &lt;none&gt;        5000/TCP   5m57s</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª<code>kubernetes</code>ä¸»æœåŠ¡(service)æ˜¯ç³»ç»Ÿè‡ªå·±åˆ›å»ºçš„ï¼Œè¿™ä¸ªserviceæ˜¯å¿…é¡»è¦æœ‰çš„ï¼Œä¸èƒ½éšä¾¿è¢«åˆ é™¤çš„ã€‚ç›¸å½“ä¸æ˜¯æˆ‘ä»¬é›†ç¾¤å†…éƒ¨çš„ä¸€äº›åº”ç”¨ï¼Œä»–ä»¬è¦é€šè¿‡è¿™ä¸ªserviceå»è®¿é—®apiserverã€‚è¿™ä¸ªå…¶å®å°±æ˜¯å»å…³è”åˆ°æˆ‘ä»¬çš„apiserverè€Œå·²ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å»describeçœ‹ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl describe svc kubernetes </span></span><br><span class="line">Name:              kubernetes</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            component=apiserver</span><br><span class="line">                   provider=kubernetes</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          &lt;none&gt;</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP Family Policy:  SingleStack</span><br><span class="line">IP Families:       IPv4</span><br><span class="line">IP:                10.96.0.1</span><br><span class="line">IPs:               10.96.0.1</span><br><span class="line">Port:              https  443/TCP</span><br><span class="line">TargetPort:        6443/TCP</span><br><span class="line">Endpoints:         172.29.9.51:6443 <span class="comment">#care</span></span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„Endpointsï¼Œå…¶å®å°±æ˜¯åˆ°æˆ‘ä»¬çš„apiserveré‚£é‡Œå»çš„ã€‚</p>
<p>å…¶å®å°±æ˜¯ç»™æˆ‘ä»¬é›†ç¾¤å†…éƒ¨çš„ä¸€äº›podå»ä½¿ç”¨è¿™ä¸ªapiserverçš„ï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´ æˆ‘ä»¬ä¸å¤ªå¯èƒ½åœ¨é›†ç¾¤å†…éƒ¨å»å†™ä¸Šè¿™ä¸ª<code>172.29.9.51:6443</code>åœ°å€ã€‚</p>
<p>å®éªŒç»“æŸã€‚ğŸ˜˜ğŸ˜˜</p>
<h3 id="1-2-DNS"><a href="#1-2-DNS" class="headerlink" title="1.2 DNS"></a>1.2 DNS</h3><p>ç”±äºä¸Šé¢ç¯å¢ƒå˜é‡è¿™ç§æ–¹å¼çš„å±€é™æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´åŠ æ™ºèƒ½çš„æ–¹æ¡ˆï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥è‡ªå·±æ€è€ƒä¸€ç§æ¯”è¾ƒç†æƒ³çš„æ–¹æ¡ˆï¼š<strong>é‚£å°±æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ Service çš„åç§°</strong>ï¼Œ<strong>å› ä¸º Service çš„åç§°ä¸ä¼šå˜åŒ–</strong>(æˆ‘ä»¬å½“ç„¶ä¸ä¼šåœ¨çº¿ä¸Šéšæ„æ›´æ”¹è¿™ä¸ªåç§°äº†å“ˆå“ˆğŸ¤£)ï¼Œæˆ‘ä»¬ä¸éœ€è¦å»å…³å¿ƒåˆ†é…çš„ ClusterIP çš„åœ°å€ï¼Œå› ä¸ºè¿™ä¸ªåœ°å€å¹¶ä¸æ˜¯å›ºå®šä¸å˜çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Service çš„åå­—ï¼Œç„¶åå¯¹åº”çš„ ClusterIP åœ°å€çš„è½¬æ¢èƒ½å¤Ÿè‡ªåŠ¨å®Œæˆå°±å¾ˆå¥½äº†ã€‚æˆ‘ä»¬çŸ¥é“åå­—å’Œ IP ç›´æ¥çš„è½¬æ¢æ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬å¹³æ—¶è®¿é—®çš„ç½‘ç«™éå¸¸ç±»ä¼¼å•Šï¼Ÿä»–ä»¬ä¹‹é—´çš„è½¬æ¢åŠŸèƒ½é€šè¿‡ DNS å°±å¯ä»¥è§£å†³äº†ï¼ŒåŒæ ·çš„ï¼Œ<strong>Kubernetes ä¹Ÿæä¾›äº† DNS çš„æ–¹æ¡ˆæ¥è§£å†³ä¸Šé¢çš„æœåŠ¡å‘ç°çš„é—®é¢˜</strong>ã€‚</p>
<p><strong>DNS æœåŠ¡ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç³»ç»ŸæœåŠ¡ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ç§ addon æ’ä»¶è€Œå­˜åœ¨</strong>ï¼Œç°åœ¨æ¯”è¾ƒæ¨èçš„ä¸¤ä¸ªæ’ä»¶ï¼škube-dns å’Œ CoreDNSï¼Œ<strong>å®é™…ä¸Šåœ¨æ¯”è¾ƒæ–°ç‚¹çš„ç‰ˆæœ¬ä¸­å·²ç»é»˜è®¤æ˜¯ CoreDNS äº†</strong>ï¼Œ<strong>å› ä¸º kube-dns é»˜è®¤ä¸€ä¸ª Pod ä¸­éœ€è¦3ä¸ªå®¹å™¨é…åˆä½¿ç”¨ï¼ŒCoreDNS åªéœ€è¦ä¸€ä¸ªå®¹å™¨å³å¯</strong>ï¼Œæˆ‘ä»¬åœ¨å‰é¢ä½¿ç”¨ kubeadm æ­å»ºé›†ç¾¤çš„æ—¶å€™ç›´æ¥å®‰è£…çš„å°±æ˜¯ CoreDNS æ’ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get po -A -l k8s-app=kube-dns -owide</span></span><br><span class="line">NAMESPACE     NAME                       READY   STATUS    RESTARTS     AGE   IP           NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   coredns-7568f67dbd-2ztgw   1/1     Running   1 (8d ago)   17d   10.244.0.9   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-7568f67dbd-9dls5   1/1     Running   1 (8d ago)   38d   10.244.0.8   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„ï¼šè¿™2ä¸ªpodéƒ½æ˜¯è¢«è°ƒåº¦åˆ°masterèŠ‚ç‚¹ä¸Šçš„ã€‚</span></span><br></pre></td></tr></table></figure>

<p><strong>CoreDns æ˜¯ç”¨ GO å†™çš„é«˜æ€§èƒ½ï¼Œé«˜æ‰©å±•æ€§çš„ DNS æœåŠ¡ï¼ŒåŸºäº HTTP/2 Web æœåŠ¡ Caddy è¿›è¡Œç¼–å†™çš„</strong>ã€‚CoreDns å†…éƒ¨é‡‡ç”¨<strong>æ’ä»¶æœºåˆ¶</strong>ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯æ’ä»¶å½¢å¼ç¼–å†™ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥æ‰©å±•è‡ªå·±çš„æ’ä»¶ï¼Œä»¥ä¸‹æ˜¯ Kubernetes éƒ¨ç½² CoreDns æ—¶çš„é»˜è®¤é…ç½®ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ kubectl get cm coredns -n kube-system -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  Corefile: | <span class="comment">#æ³¨æ„ï¼šä½ å¯ä»¥è®¤ä¸ºï¼Œä¸‹é¢&#123;&#125;é‡Œçš„æ¯ä¸€è¡Œç›¸å½“äºä¸€ä¸ªæ’ä»¶ï¼ï¼ï¼</span></span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors  <span class="comment"># å¯ç”¨é”™è¯¯è®°å½•</span></span><br><span class="line">        health  <span class="comment"># å¯ç”¨å¥åº·æ£€æŸ¥æ£€æŸ¥ç«¯ç‚¹ï¼Œ8080:health</span></span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;  <span class="comment"># å¤„ç† k8s åŸŸåè§£æ</span></span><br><span class="line">           pods insecure</span><br><span class="line">           fallthrough in-addr.arpa ip6.arpa</span><br><span class="line">           ttl 30</span><br><span class="line">        &#125;</span><br><span class="line">        prometheus :9153  <span class="comment"># å¯ç”¨ metrics æŒ‡æ ‡ï¼Œ9153:metrics</span></span><br><span class="line">        forward . /etc/resolv.conf  <span class="comment"># é€šè¿‡ resolv.conf å†…çš„ nameservers è§£æ</span></span><br><span class="line">        cache 30  <span class="comment"># å¯ç”¨ç¼“å­˜ï¼Œæ‰€æœ‰å†…å®¹é™åˆ¶ä¸º 30s çš„TTL (allçš„è§£æéƒ½æœ‰ä¸€ä¸ªç¼“å­˜çš„)</span></span><br><span class="line">        loop  <span class="comment"># æ£€æŸ¥ç®€å•çš„è½¬å‘å¾ªç¯å¹¶åœæ­¢æœåŠ¡</span></span><br><span class="line">        reload  <span class="comment"># è¿è¡Œè‡ªåŠ¨é‡æ–°åŠ è½½ corefileï¼Œçƒ­æ›´æ–°</span></span><br><span class="line">        loadbalance  <span class="comment"># è´Ÿè½½å‡è¡¡ï¼Œé»˜è®¤ round_robin</span></span><br><span class="line">    &#125;</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2019-11-08T11:59:49Z&quot;</span></span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  resourceVersion: <span class="string">&quot;188&quot;</span></span><br><span class="line">  selfLink: /api/v1/namespaces/kube-system/configmaps/coredns</span><br><span class="line">  uid: 21966186-c2d9-467a-b87f-d061c5c9e4d7</span><br></pre></td></tr></table></figure>

<ul>
<li><p>æ¯ä¸ª <code>&#123;&#125;</code> ä»£è¡¨ä¸€ä¸ª zone,æ ¼å¼æ˜¯ <code>â€œZone:port&#123;&#125;â€</code>, å…¶ä¸­<code>&quot;.&quot;</code>ä»£è¡¨é»˜è®¤zone</p>
</li>
<li><p><code>&#123;&#125;</code> å†…çš„æ¯ä¸ªåç§°ä»£è¡¨æ’ä»¶çš„åç§°ï¼Œåªæœ‰é…ç½®çš„æ’ä»¶æ‰ä¼šå¯ç”¨ï¼Œå½“è§£æåŸŸåæ—¶ï¼Œä¼šå…ˆåŒ¹é… zoneï¼ˆéƒ½æœªåŒ¹é…ä¼šæ‰§è¡Œé»˜è®¤ zoneï¼‰ï¼Œç„¶å zone å†…çš„æ’ä»¶ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ‰§è¡Œ(è¿™ä¸ªé¡ºåºå¹¶ä¸æ˜¯é…ç½®æ–‡ä»¶å†…è°åœ¨å‰é¢çš„é¡ºåºï¼Œè€Œæ˜¯<code>core/dnsserver/zdirectives.go</code>å†…çš„é¡ºåº)ï¼ŒåŒ¹é…åè¿”å›å¤„ç†ï¼ˆ<strong>æ‰§è¡Œè¿‡çš„æ’ä»¶ä»ä¸‹åˆ°ä¸Šä¾æ¬¡å¤„ç†è¿”å›é€»è¾‘</strong>ï¼‰ï¼Œä¸å†æ‰§è¡Œä¸‹ä¸€ä¸ªæ’ä»¶</p>
</li>
</ul>
<p>CoreDNS çš„ Service åœ°å€ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯å›ºå®šçš„ï¼Œç±»ä¼¼äº kubernetes è¿™ä¸ª Service åœ°å€ä¸€èˆ¬å°±æ˜¯ç¬¬ä¸€ä¸ª IP åœ°å€ <code>10.96.0.1</code>ï¼ŒCoreDNS çš„ Service åœ°å€å°±æ˜¯ <code>10.96.0.10</code>ã€‚è¯¥ IP è¢«åˆ†é…åï¼Œkubelet ä¼šå°†ä½¿ç”¨ <code>--cluster-dns=&lt;dns-service-ip&gt;</code> å‚æ•°é…ç½®çš„ DNS ä¼ é€’ç»™æ¯ä¸ªå®¹å™¨ã€‚<strong>DNS åç§°ä¹Ÿéœ€è¦åŸŸå</strong>ï¼Œæœ¬åœ°åŸŸå¯ä»¥ä½¿ç”¨å‚æ•°<code>--cluster-domain = &lt;default-local-domain&gt;</code> åœ¨ kubelet ä¸­é…ç½®ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ cat /var/lib/kubelet/config.yaml</span><br><span class="line">......</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local <span class="comment">#å½“ç„¶ï¼Œè¿™ä¸ªå¯ä»¥æ”¹ï¼Œä½†ä¸€èˆ¬æ˜¯ä¸ä¼šå»ä¿®æ”¹çš„ï¼Œæ˜¯çº¦å®šä¿—æˆçš„ã€‚</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>:warning:æ³¨æ„ï¼šè¿™é‡Œçš„è§£é‡Šå¦‚ä¸‹ã€‚(è¿™é‡Œçš„2ç‚¹æœ‰ç‚¹æ™¦æ¶©)</p>
<p><strong>æ³¨æ„ç‚¹1ï¼š</strong></p>
<p>å½“æˆ‘ä»¬å»å¯åŠ¨ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™ï¼Œå®ƒä¼šæŠŠè¿™é‡Œçš„<code>clusterDNSåœ°å€</code>ç»™å†™å…¥åˆ°æˆ‘ä»¬å®¹å™¨çš„nameserveré‡Œé¢å»ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å®¹å™¨é‡Œé¢çš„namesrveræ˜¯è¿™ä¸ªåœ°å€ï¼Œç„¶åå»åšåŸŸåè§£æçš„æ—¶å€™ï¼Œæ˜¯ä¸æ˜¯éƒ½ä¼šè¿›å…¥åˆ°è¿™ä¸ª<code>10.96.0.10</code>é‡Œé¢å»ï¼Œè€Œè¿™ä¸ªåœ°å€åˆšå¥½æ˜¯æˆ‘ä»¬<code>core dns</code>çš„åœ°å€ã€‚æ‰€ä»¥æœ€ç»ˆè§£æï¼Œè¿˜æ˜¯è¿›å…¥åˆ°è¿™ä¸ªcorednsé‡Œé¢æ¥åšçš„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get svc -nkube-system</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns         ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   49d</span><br><span class="line">metrics-server   ClusterIP   10.106.125.106   &lt;none&gt;        443/TCP                  27d</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ç‚¹2ï¼š</strong></p>
<p>æ–‡ä»¶<code>/var/lib/kubelet/config.yaml</code>é‡Œçš„<code>clusterDomain: cluster.local</code>å°±ç›¸å½“äºåœ¨æˆ‘ä»¬k8sé›†ç¾¤é‡Œé¢ï¼Œå°±æ˜¯æˆ‘ä»¬serviceçš„ä¸€ä¸ªåŸŸååç¼€ã€‚allçš„ä»¥dnsçš„å½¢å¼è®¿é—®serviceçš„æ—¶å€™ï¼Œå®ƒçš„ä¸€ä¸ªåç¼€éƒ½æ˜¯<code>cluster.local</code>ã€‚</p>
<p>æˆ‘ä»¬å‰é¢è¯´äº†å¦‚æœæˆ‘ä»¬å»ºç«‹çš„ Service å¦‚æœæ”¯æŒåŸŸåå½¢å¼è¿›è¡Œè§£æï¼Œå°±å¯ä»¥è§£å†³æˆ‘ä»¬çš„æœåŠ¡å‘ç°çš„åŠŸèƒ½ï¼Œ<strong>é‚£ä¹ˆåˆ©ç”¨ kubedns å¯ä»¥å°† Service ç”Ÿæˆæ€æ ·çš„ DNS è®°å½•å‘¢ï¼Ÿ</strong></p>
<ul>
<li><p><strong>æ™®é€šçš„ Service</strong>ï¼šä¼šç”Ÿæˆ <code>servicename.namespace.svc.cluster.local</code> çš„åŸŸåï¼Œä¼šè§£æåˆ° Service å¯¹åº”çš„ ClusterIP ä¸Šï¼Œåœ¨ Pod ä¹‹é—´çš„è°ƒç”¨å¯ä»¥ç®€å†™æˆ <code>servicename.namespace</code>ï¼Œå¦‚æœå¤„äºåŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹é¢ï¼Œç”šè‡³å¯ä»¥åªå†™æˆ <code>servicename</code> å³å¯è®¿é—®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å‡å¦‚è¯´æˆ‘ä»¬æœ‰ä¸ªsvcå«åšnginx-serviceï¼š</span><br><span class="line">é‚£ä¹ˆï¼Œè¯¥serviceåœ¨dnsé‡Œçš„åŸŸåå¯ä»¥æŒ‰å¦‚ä¸‹æ¥å†™ï¼š</span><br><span class="line">	nginx-service.default.svc.cluster.local</span><br><span class="line">	nginx-service.default.svc</span><br><span class="line">	nginx-service.default</span><br><span class="line">å¦‚æœä½ çš„Podå’Œnigx-serviceåœ¨åŒä¸€ä¸ªnamesapceï¼Œä¹Ÿå¯ä»¥å†™æˆnginx-service</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Headless Service</strong>ï¼šæ— å¤´æœåŠ¡ï¼Œå°±æ˜¯æŠŠ clusterIP è®¾ç½®ä¸º None çš„ï¼Œä¼šè¢«è§£æä¸ºæŒ‡å®š Pod çš„ IP åˆ—è¡¨ï¼ŒåŒæ ·è¿˜å¯ä»¥é€šè¿‡ <code>podname.servicename.namespace.svc.cluster.local</code> è®¿é—®åˆ°å…·ä½“çš„æŸä¸€ä¸ª Podã€‚</p>
</li>
</ul>
<p>ğŸ“ æ¡ˆä¾‹æµ‹è¯•</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä½¿ç”¨ä¸€ä¸ªç®€å• Pod æ¥æµ‹è¯•ä¸‹ Service çš„åŸŸåè®¿é—®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment">#kubectl run -it --image busybox:1.28.3 test-dns --restart=Never --rm /bin/sh</span></span><br><span class="line"><span class="string">If</span> <span class="string">you</span> <span class="string">don&#x27;t</span> <span class="string">see</span> <span class="string">a</span> <span class="string">command</span> <span class="string">prompt,</span> <span class="string">try</span> <span class="string">pressing</span> <span class="string">enter.</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># cat /etc/resolv.conf</span></span><br><span class="line"><span class="string">search</span> <span class="string">default.svc.cluster.local</span> <span class="string">svc.cluster.local</span> <span class="string">cluster.local</span></span><br><span class="line"><span class="string">nameserver</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.10</span></span><br><span class="line"><span class="string">options</span> <span class="string">ndots:5</span></span><br><span class="line"><span class="string">/</span> <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿›å…¥åˆ° Pod ä¸­ï¼ŒæŸ¥çœ‹ <code>/etc/resolv.conf</code> ä¸­çš„å†…å®¹ï¼Œå¯ä»¥çœ‹åˆ° <code>nameserver</code> çš„åœ°å€ <code>10.96.0.10</code>ï¼Œè¯¥ IP åœ°å€å³æ˜¯åœ¨å®‰è£… CoreDNS æ’ä»¶çš„æ—¶å€™é›†ç¾¤åˆ†é…çš„ä¸€ä¸ªå›ºå®šçš„é™æ€ IP åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get svc -nkube-system</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns         ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   50d</span><br><span class="line">metrics-server   ClusterIP   10.106.125.106   &lt;none&gt;        443/TCP                  28d</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¿™ä¸ª Pod ç°åœ¨é»˜è®¤çš„ <code>nameserver</code> å°±æ˜¯ <code>kube-dns</code> çš„åœ°å€ï¼Œç°åœ¨æˆ‘ä»¬æ¥è®¿é—®ä¸‹å‰é¢æˆ‘ä»¬åˆ›å»ºçš„ nginx-service æœåŠ¡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># wget -q -O- nginx-service.default.svc.cluster.local</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨ wget å‘½ä»¤å»è®¿é—® nginx-service æœåŠ¡çš„åŸŸåçš„æ—¶å€™è¢« hang ä½äº†ï¼Œæ²¡æœ‰å¾—åˆ°æœŸæœ›çš„ç»“æœï¼Œè¿™æ˜¯å› ä¸ºä¸Šé¢æˆ‘ä»¬å»ºç«‹ Service çš„æ—¶å€™æš´éœ²çš„ç«¯å£æ˜¯ 5000ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># wget -q -O- nginx-service.default.svc.cluster.local:5000</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>åŠ ä¸Š 5000 ç«¯å£ï¼Œå°±æ­£å¸¸è®¿é—®åˆ°æœåŠ¡ï¼Œå†è¯•ä¸€è¯•è®¿é—®ï¼š<code>nginx-service.default.svc</code>ã€<code>nginx-service.default</code>ã€<code>nginx-service</code>ï¼Œä¸å‡ºæ„å¤–è¿™äº›åŸŸåéƒ½å¯ä»¥æ­£å¸¸è®¿é—®åˆ°æœŸæœ›çš„ç»“æœã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å°±<strong>å®ç°äº†åœ¨é›†ç¾¤å†…éƒ¨é€šè¿‡ Service çš„åŸŸåå½¢å¼è¿›è¡Œäº’ç›¸é€šä¿¡äº†</strong>ï¼Œå¤§å®¶ä¸‹å»è¯•ç€çœ‹çœ‹è®¿é—®ä¸åŒ namespace ä¸‹é¢çš„æœåŠ¡å‘¢ï¼Ÿ</p>
<p>æµ‹è¯•ç»“æŸã€‚ğŸ˜‹</p>
<p>:warning: æ³¨æ„ï¼šæˆ‘è¿™é‡Œçš„ç°è±¡å’Œè€å¸ˆçš„æœ‰äº›ä¸åŒï¼šæµ‹è¯•è¿‡ç¨‹å¦‚ä¸‹</p>
<p>ä¸åŠ Portç›´æ¥ä¼šæŠ¥é”™çš„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># wget -q -O- nginx-service.default.svc.cluster.local</span></span><br><span class="line">wget: can<span class="string">&#x27;t connect to remote host (10.98.166.23): Connection refused</span></span><br></pre></td></tr></table></figure>

<p>å¥‡æ€ªçš„æ˜¯ï¼šä½¿ç”¨wgetå‘½ä»¤æµ‹è¯•çš„æ—¶å€™ï¼Œç¬¬ä¸€æ¬¡å¯ä»¥ï¼Œä½†ç¬¬äºŒæ¬¡å°±å¡ä¸»äº†ï¼Œå¾ˆå¥‡æ€ªã€‚è€å¸ˆå½“æ—¶æ˜¯ç›´æ¥å¡ä¸»äº†çš„ã€‚ã€‚ã€‚ğŸ˜¥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># wget -q -O- nginx-service.default.svc.cluster.local:5000</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">/ <span class="comment"># wget -q -O- nginx-service.default.svc.cluster.local:5000</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•åŸŸåï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># nslookup nginx-service.default.svc.cluster.local</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-service.default.svc.cluster.local</span><br><span class="line">Address 1: 10.98.166.23 nginx-service.default.svc.cluster.local</span><br><span class="line">/ <span class="comment"># nslookup nginx-service.default.svc</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-service.default.svc</span><br><span class="line">Address 1: 10.98.166.23 nginx-service.default.svc.cluster.local</span><br><span class="line">/ <span class="comment"># nslookup nslookup nginx-service.default</span></span><br><span class="line">Server:    10.98.166.23</span><br><span class="line">Address 1: 10.98.166.23</span><br><span class="line"></span><br><span class="line">/ <span class="comment"># nslookup nginx-service.default</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-service.default</span><br><span class="line">Address 1: 10.98.166.23 nginx-service.default.svc.cluster.local</span><br><span class="line">/ <span class="comment"># nslookup nginx-service</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-service</span><br><span class="line">Address 1: 10.98.166.23 nginx-service.default.svc.cluster.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æˆ–ä½¿ç”¨pingæµ‹è¯•ï¼š</span><br><span class="line">/ <span class="comment"># ping nginx-service</span></span><br><span class="line">PING nginx-service (10.98.166.23): 56 data bytes</span><br><span class="line">64 bytes from 10.98.166.23: seq=0 ttl=64 time=0.134 ms</span><br><span class="line">64 bytes from 10.98.166.23: seq=1 ttl=64 time=0.141 ms</span><br><span class="line">^C</span><br><span class="line">--- nginx-service ping statistics ---</span><br><span class="line">2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.134/0.137/0.141 ms</span><br><span class="line">/ <span class="comment"># ping nginx-service.default</span></span><br><span class="line">PING nginx-service.default (10.98.166.23): 56 data bytes</span><br><span class="line">64 bytes from 10.98.166.23: seq=0 ttl=64 time=0.101 ms</span><br><span class="line">^C</span><br><span class="line">--- nginx-service.default ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.101/0.101/0.101 ms</span><br><span class="line">/ <span class="comment"># ping nginx-service.default.svc</span></span><br><span class="line">PING nginx-service.default.svc (10.98.166.23): 56 data bytes</span><br><span class="line">64 bytes from 10.98.166.23: seq=0 ttl=64 time=0.108 ms</span><br><span class="line">^C</span><br><span class="line">--- nginx-service.default.svc ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.108/0.108/0.108 ms</span><br><span class="line">/ <span class="comment"># ping nginx-service.default.svc.cluster.local</span></span><br><span class="line">PING nginx-service.default.svc.cluster.local (10.98.166.23): 56 data bytes</span><br><span class="line">64 bytes from 10.98.166.23: seq=0 ttl=64 time=0.146 ms</span><br><span class="line">^C</span><br><span class="line">--- nginx-service.default.svc.cluster.local ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.146/0.146/0.146 ms</span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>å½“ç„¶åœ¨èŠ‚ç‚¹ç›´æ¥æµ‹è¯•ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get svc</span></span><br><span class="line">NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">kubernetes      ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP    50d</span><br><span class="line">nginx-service   ClusterIP   10.98.166.23   &lt;none&gt;        5000/TCP   8d</span><br><span class="line">[root@master1 ~]<span class="comment">#curl 10.98.166.23:5000</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@master1 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>å®éªŒç»“æŸã€‚ğŸ˜˜ğŸ˜˜</p>
<h2 id="2ã€ç»™-Pod-æ·»åŠ -DNS-è®°å½•"><a href="#2ã€ç»™-Pod-æ·»åŠ -DNS-è®°å½•" class="headerlink" title="2ã€ç»™ Pod æ·»åŠ  DNS è®°å½•"></a>2ã€ç»™ Pod æ·»åŠ  DNS è®°å½•</h2><p><strong>æˆ‘ä»¬éƒ½çŸ¥é“ StatefulSet ä¸­çš„ Pod æ˜¯æ‹¥æœ‰å•ç‹¬çš„ DNS è®°å½•çš„</strong>ï¼Œæ¯”å¦‚ä¸€ä¸ª StatefulSet åç§°ä¸º etcdï¼Œè€Œå®ƒå…³è”çš„ Headless SVC åç§°ä¸º etcd-headlessï¼Œé‚£ä¹ˆ CoreDNS å°±ä¼šä¸ºå®ƒçš„æ¯ä¸ª Pod è§£æå¦‚ä¸‹çš„è®°å½•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etcd-0.etcd-headless.default.svc.cluster.local</span><br><span class="line">etcd-1.etcd-headless.default.svc.cluster.local</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆé™¤äº† StatefulSet ç®¡ç†çš„ Pod ä¹‹å¤–ï¼Œå…¶ä»–çš„ Pod æ˜¯å¦ä¹Ÿå¯ä»¥ç”Ÿæˆ DNS è®°å½•å‘¢ï¼Ÿ</p>
<p>å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬è¿™é‡Œåªæœ‰ä¸€ä¸ª Headless çš„ SVCï¼Œå¹¶æ²¡æœ‰ StatefulSet ç®¡ç†çš„ Podï¼Œè€Œæ˜¯ ReplicaSet ç®¡ç†çš„ Podï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è²Œä¼¼ä¹Ÿç”Ÿæˆäº†ç±»ä¼¼äº StatefulSet ä¸­çš„è§£æè®°å½•ã€‚</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20201203165518.png" alt="è§£æè®°å½•"></p>
<p>è¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼ŸæŒ‰ç…§æˆ‘ä»¬å¸¸è§„çš„ç†è§£ä¼šè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª StatefulSet ç®¡ç†çš„ Podï¼Œä½†å…¶å®è¿™é‡Œæ˜¯ä¸åŒçš„ ReplicaSet è€Œå·²ã€‚è¿™é‡Œçš„å®ç°å…¶å®æ˜¯å› ä¸º <strong>Pod è‡ªå·±æœ¬èº«ä¹Ÿæ˜¯å¯ä»¥æœ‰è‡ªå·±çš„ DNS è®°å½•çš„</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯å¯ä»¥å»å®ç°ä¸€ä¸ªç±»ä¼¼äº StatefulSet çš„ Pod é‚£æ ·çš„è§£æè®°å½•çš„ã€‚</p>
<p>ğŸ“ æ¡ˆä¾‹æµ‹è¯•</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥éƒ¨ç½²ä¸€ä¸ª Deployment ç®¡ç†çš„æ™®é€šåº”ç”¨ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>[root@master1 ~]#vim nginx.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>éƒ¨ç½²ååˆ›å»ºäº†ä¸¤ä¸ª Podï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f nginx.yaml</span></span><br><span class="line">deployment.apps/nginx created</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get po -l app=nginx -owide                                                                  </span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-5d59d67564-lcjw8   1/1     Running   0          29s   10.244.2.215   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-5d59d67564-nxnbv   1/1     Running   0          29s   10.244.2.216   node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå®šä¹‰å¦‚ä¸‹çš„ Headless Service:</p>
<p>[root@master1 ~]#vim service.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºè¯¥ serviceï¼Œå¹¶å°è¯•è§£æ service DNSï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f service.yaml </span></span><br><span class="line">service/nginx created</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get svc</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   51d</span><br><span class="line">nginx        ClusterIP   None         &lt;none&gt;        80/TCP    10s</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment">#dig @10.96.0.10 nginx.default.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.8 &lt;&lt;&gt;&gt; @10.96.0.10 nginx.default.svc.cluster.local</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .<span class="built_in">local</span> is reserved <span class="keyword">for</span> Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 41513</span></span><br><span class="line"><span class="string">;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class="line"><span class="string">;; WARNING: recursion requested but not available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;nginx.default.svc.cluster.local. IN    A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">nginx.default.svc.cluster.local. 30 IN  A       10.244.2.215</span></span><br><span class="line"><span class="string">nginx.default.svc.cluster.local. 30 IN  A       10.244.2.216</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 1 msec</span></span><br><span class="line"><span class="string">;; SERVER: 10.96.0.10#53(10.96.0.10)</span></span><br><span class="line"><span class="string">;; WHEN: Tue Dec 21 19:43:55 CST 2021</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 154</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@master1 ~]#</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å¯¹ nginx çš„ <strong>FQDN åŸŸå</strong>è¿›è¡Œ dig æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°è¿”å›äº†å¤šæ¡ <strong>A è®°å½•</strong>ï¼Œæ¯ä¸€æ¡å¯¹åº”ä¸€ä¸ª Podã€‚ä¸Šé¢ dig å‘½ä»¤ä¸­ä½¿ç”¨çš„ 10.96.0.10 å°±æ˜¯ kube-dns çš„ cluster IPï¼Œå¯ä»¥åœ¨ kube-system namespace ä¸­æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl get svc kube-dns -nkube-system</span></span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   51d</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯•è¯•åœ¨ service åå­—å‰é¢åŠ ä¸Š Pod åå­—äº¤ç»™ kube-dns åšè§£æï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#dig @10.96.0.10 nginx-5d59d67564-lcjw8.nginx.default.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.8 &lt;&lt;&gt;&gt; @10.96.0.10 nginx-5d59d67564-lcjw8.nginx.default.svc.cluster.local</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .<span class="built_in">local</span> is reserved <span class="keyword">for</span> Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NXDOMAIN, id: 48912</span></span><br><span class="line"><span class="string">;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1</span></span><br><span class="line"><span class="string">;; WARNING: recursion requested but not available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;nginx-5d59d67564-lcjw8.nginx.default.svc.cluster.local.        IN A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; AUTHORITY SECTION:</span></span><br><span class="line"><span class="string">cluster.local.          30      IN      SOA     ns.dns.cluster.local. hostmaster.cluster.local. 1640086465 7200 1800 86400 30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 2 msec</span></span><br><span class="line"><span class="string">;; SERVER: 10.96.0.10#53(10.96.0.10)</span></span><br><span class="line"><span class="string">;; WHEN: Tue Dec 21 19:47:33 CST 2021</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 176</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@master1 ~]#</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰å¾—åˆ°è§£æç»“æœã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£ä¸­æœ‰ä¸€æ®µ <code>Podâ€™s hostname and subdomain fields</code> è¯´æ˜ï¼š</p>
<blockquote>
<p>1.Pod è§„èŒƒä¸­åŒ…å«ä¸€ä¸ªå¯é€‰çš„ hostname å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æŒ‡å®š Pod çš„ä¸»æœºåã€‚å½“è¿™ä¸ªå­—æ®µè¢«è®¾ç½®æ—¶ï¼Œå®ƒå°†ä¼˜å…ˆäº Pod çš„åå­—æˆä¸ºè¯¥ Pod çš„ä¸»æœºåã€‚ä¸¾ä¸ªä¾‹å­ï¼Œç»™å®šä¸€ä¸ª hostname è®¾ç½®ä¸º â€œmy-hostâ€ çš„ Podï¼Œ è¯¥ Pod çš„ä¸»æœºåå°†è¢«è®¾ç½®ä¸º â€œmy-hostâ€ã€‚<br>2.Pod è§„çº¦è¿˜æœ‰ä¸€ä¸ªå¯é€‰çš„ subdomain å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æŒ‡å®š <strong>Pod çš„å­åŸŸå</strong>ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼ŒæŸ Pod çš„ hostname è®¾ç½®ä¸º â€œfooâ€ï¼Œsubdomain è®¾ç½®ä¸º â€œbarâ€ï¼Œ åœ¨åå­—ç©ºé—´ â€œmy-namespaceâ€ ä¸­å¯¹åº”çš„å®Œå…¨é™å®šåŸŸåä¸º â€œfoo.bar.my-namespace.svc.cluster-domain.exampleâ€ã€‚</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬ç¼–è¾‘ä¸€ä¸‹ nginx.yaml åŠ ä¸Š subdomain æµ‹è¯•ä¸‹çœ‹çœ‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">subdomain:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>æ›´æ–°éƒ¨ç½²å†å°è¯•è§£æ Pod DNSï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f nginx.yaml</span></span><br><span class="line">deployment.apps/nginx configured</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get po -l app=nginx -owide</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-78f58d8bcb-498sp   1/1     Running   0          15s   10.244.1.91    node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-78f58d8bcb-4pfxk   1/1     Running   0          14s   10.244.2.217   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@master1 ~]<span class="comment">#dig @10.96.0.10 nginx-78f58d8bcb-498sp.nginx.default.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.8 &lt;&lt;&gt;&gt; @10.96.0.10 nginx-78f58d8bcb-498sp.nginx.default.svc.cluster.local</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .<span class="built_in">local</span> is reserved <span class="keyword">for</span> Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NXDOMAIN, id: 12912</span></span><br><span class="line"><span class="string">;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1</span></span><br><span class="line"><span class="string">;; WARNING: recursion requested but not available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;nginx-78f58d8bcb-498sp.nginx.default.svc.cluster.local.        IN A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; AUTHORITY SECTION:</span></span><br><span class="line"><span class="string">cluster.local.          30      IN      SOA     ns.dns.cluster.local. hostmaster.cluster.local. 1640088249 7200 1800 86400 30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 0 msec</span></span><br><span class="line"><span class="string">;; SERVER: 10.96.0.10#53(10.96.0.10)</span></span><br><span class="line"><span class="string">;; WHEN: Tue Dec 21 20:04:54 CST 2021</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 176</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@master1 ~]#</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¾ç„¶ä¸èƒ½è§£æã€‚</p>
<p>é‚£å°±è¯•è¯•å®˜æ–¹æ–‡æ¡£ä¸­çš„ä¾‹å­ ï¼Œä¸ç”¨ Deployment ç›´æ¥åˆ›å»º Pod å§ã€‚</p>
<p>[root@master1 ~]#vim individual-pods-example.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># individual-pods-example.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-subdomain</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span> <span class="comment"># Actually, no port is needed.</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">1234</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">1234</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">busybox-1</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">default-subdomain</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">busybox-2</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">default-subdomain</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br></pre></td></tr></table></figure>

<p>éƒ¨ç½²ç„¶åå°è¯•è§£æ Pod DNS (æ³¨æ„è¿™é‡Œ hostname å’Œ pod çš„åå­—æœ‰åŒºåˆ«ï¼Œä¸­é—´å¤šäº†å‡å·)ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f individual-pods-example.yaml</span></span><br><span class="line">service/default-subdomain created</span><br><span class="line">pod/busybox1 created</span><br><span class="line">pod/busybox2 created</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get po -l name=busybox -owide</span></span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">busybox1   1/1     Running   0          79s   10.244.2.218   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">busybox2   1/1     Running   0          79s   10.244.1.92    node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment">#dig @10.96.0.10 busybox-1.default-subdomain.default.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.8 &lt;&lt;&gt;&gt; @10.96.0.10 busybox-1.default-subdomain.default.svc.cluster.local</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .<span class="built_in">local</span> is reserved <span class="keyword">for</span> Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 33058</span></span><br><span class="line"><span class="string">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class="line"><span class="string">;; WARNING: recursion requested but not available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;busybox-1.default-subdomain.default.svc.cluster.local. IN A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">busybox-1.default-subdomain.default.svc.cluster.local. 30 IN A 10.244.2.218</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 0 msec</span></span><br><span class="line"><span class="string">;; SERVER: 10.96.0.10#53(10.96.0.10)</span></span><br><span class="line"><span class="string">;; WHEN: Tue Dec 21 20:10:23 CST 2021</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 151</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@master1 ~]#</span></span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æˆ‘ä»¬çœ‹åˆ°æœ‰ ANSWER è®°å½•å›æ¥äº†ï¼Œ<strong>hostname å’Œ subdomain äºŒè€…éƒ½å¿…é¡»æ˜¾å¼æŒ‡å®šï¼Œç¼ºä¸€ä¸å¯</strong>ã€‚ä¸€å¼€å§‹æˆ‘ä»¬çš„æˆªå›¾ä¸­çš„å®ç°æ–¹å¼å…¶å®ä¹Ÿæ˜¯è¿™ç§æ–¹å¼ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„ nginx deployment åŠ ä¸Š hostnameï¼Œé‡æ–°è§£æï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#vim nginx.yaml</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      subdomain: nginx</span><br><span class="line">      hostname: nginx</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f nginx.yaml</span></span><br><span class="line">deployment.apps/nginx configured</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get po -owide</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-6ffdd87d4d-42m7q   1/1     Running   0          13s   10.244.2.223   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-6ffdd87d4d-5cdh2   1/1     Running   0          11s   10.244.2.224   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ~]<span class="comment">#dig @10.96.0.10 nginx.nginx.default.svc.cluster.local</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.8 &lt;&lt;&gt;&gt; @10.96.0.10 nginx.nginx.default.svc.cluster.local</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; WARNING: .<span class="built_in">local</span> is reserved <span class="keyword">for</span> Multicast DNS</span><br><span class="line">;; You are currently testing what happens when an mDNS query is leaked to DNS</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 46249</span></span><br><span class="line"><span class="string">;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class="line"><span class="string">;; WARNING: recursion requested but not available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 4096</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;nginx.nginx.default.svc.cluster.local. IN A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">nginx.nginx.default.svc.cluster.local. 30 IN A  10.244.2.223</span></span><br><span class="line"><span class="string">nginx.nginx.default.svc.cluster.local. 30 IN A  10.244.2.224</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 0 msec</span></span><br><span class="line"><span class="string">;; SERVER: 10.96.0.10#53(10.96.0.10)</span></span><br><span class="line"><span class="string">;; WHEN: Tue Dec 21 20:19:11 CST 2021</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 172</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@master1 ~]#</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è§£ææˆåŠŸäº†ï¼Œä½†æ˜¯å› ä¸º Deployment ä¸­æ— æ³•ç»™æ¯ä¸ª Pod æŒ‡å®šä¸åŒçš„ hostnameï¼Œæ‰€ä»¥ä¸¤ä¸ª Pod æœ‰åŒæ ·çš„ hostnameï¼Œè§£æå‡ºæ¥ä¸¤ä¸ª IPï¼Œè·Ÿæˆ‘ä»¬çš„æœ¬æ„å°±ä¸ç¬¦åˆäº†ã€‚ä¸è¿‡çŸ¥é“äº†è¿™ç§æ–¹å¼è¿‡å<strong>æˆ‘ä»¬å°±å¯ä»¥è‡ªå·±å»å†™ä¸€ä¸ª Operator å»ç›´æ¥ç®¡ç† Pod äº†</strong>ï¼Œ<strong>ç»™æ¯ä¸ª Pod è®¾ç½®ä¸åŒçš„ hostname å’Œä¸€ä¸ª Headless SVC åç§°çš„ subdomainï¼Œè¿™æ ·å°±ç›¸å½“äºå®ç°äº† StatefulSet ä¸­çš„ Pod è§£æã€‚</strong>ğŸ˜‹</p>
<ul>
<li>æ³¨æ„ï¼šæˆ‘ä»¬æ¥çœ‹ä¸‹æ³¨é‡Š</li>
</ul>
<p>[root@master1 ~]#kubectl explain pod.spec</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hostname     &lt;string&gt;</span><br><span class="line">  Specifies the hostname of the Pod If not specified, the pod<span class="string">&#x27;s hostname will</span></span><br><span class="line"><span class="string">  be set to a system-defined value.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">subdomain    &lt;string&gt;</span></span><br><span class="line"><span class="string">  If specified, the fully qualified Pod hostname will be</span></span><br><span class="line"><span class="string">  &quot;&lt;hostname&gt;.&lt;subdomain&gt;.&lt;pod namespace&gt;.svc.&lt;cluster domain&gt;&quot;. If not</span></span><br><span class="line"><span class="string">  specified, the pod will not have a domainname at all.</span></span><br></pre></td></tr></table></figure>

<p>å®éªŒç»“æŸã€‚ğŸ˜˜ğŸ˜˜</p>
<h2 id="3ã€Pod-çš„-DNS-ç­–ç•¥"><a href="#3ã€Pod-çš„-DNS-ç­–ç•¥" class="headerlink" title="3ã€Pod çš„ DNS ç­–ç•¥"></a>3ã€Pod çš„ DNS ç­–ç•¥</h2><p><strong>DNS ç­–ç•¥å¯ä»¥å•ç‹¬å¯¹ Pod è¿›è¡Œè®¾å®š</strong>ï¼Œç›®å‰ Kubernetes æ”¯æŒä»¥ä¸‹ç‰¹å®š Pod çš„ DNS ç­–ç•¥ã€‚è¿™äº›ç­–ç•¥å¯ä»¥åœ¨ Pod è§„èŒƒä¸­çš„ <code>dnsPolicy</code> å­—æ®µè®¾ç½®ï¼š</p>
<ul>
<li><p><strong>Default</strong>: æœ‰äººè¯´ Default çš„æ–¹å¼ï¼Œæ˜¯ä½¿ç”¨å®¿ä¸»æœºçš„æ–¹å¼ï¼Œè¿™ç§è¯´æ³•å¹¶ä¸å‡†ç¡®ã€‚<strong>è¿™ç§æ–¹å¼å…¶å®æ˜¯è®© kubelet æ¥å†³å®šä½¿ç”¨ä½•ç§ DNS ç­–ç•¥</strong>ã€‚è€Œ kubelet é»˜è®¤çš„æ–¹å¼ï¼Œå°±æ˜¯ä½¿ç”¨å®¿ä¸»æœºçš„ <code>/etc/resolv.conf</code>ï¼ˆå¯èƒ½è¿™å°±æ˜¯æœ‰äººè¯´ä½¿ç”¨å®¿ä¸»æœºçš„ DNS ç­–ç•¥çš„æ–¹å¼å§ï¼‰ï¼Œä½†æ˜¯ï¼Œ<strong>kubelet æ˜¯å¯ä»¥çµæ´»æ¥é…ç½®ä½¿ç”¨ä»€ä¹ˆæ–‡ä»¶æ¥è¿›è¡ŒDNSç­–ç•¥çš„</strong>ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨ kubelet çš„å‚æ•° <code>â€“resolv-conf=/etc/resolv.conf</code> æ¥å†³å®šä½ çš„ DNS è§£ææ–‡ä»¶åœ°å€ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubelet --help|grep resolv</span></span><br><span class="line">      --resolv-conf string                                       Resolver configuration file used as the basis <span class="keyword">for</span> the container DNS resolution configuration. (default <span class="string">&quot;/etc/resolv.conf&quot;</span>) (DEPRECATED: This parameter should be <span class="built_in">set</span> via the config file specified by the Kubelet<span class="string">&#x27;s --config flag. See https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/ for more information.)</span></span><br><span class="line"><span class="string">[root@master1 ~]#</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>ClusterFirst</strong>: è¿™ç§æ–¹å¼ï¼Œè¡¨ç¤º Pod å†…çš„ DNS ä½¿ç”¨é›†ç¾¤ä¸­é…ç½®çš„ DNS æœåŠ¡ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä½¿ç”¨ Kubernetes ä¸­ kubedns æˆ– coredns æœåŠ¡è¿›è¡ŒåŸŸåè§£æã€‚<strong>å¦‚æœè§£æä¸æˆåŠŸï¼Œæ‰ä¼šä½¿ç”¨å®¿ä¸»æœºçš„ DNS é…ç½®è¿›è¡Œè§£æã€‚</strong></p>
</li>
<li><p><strong>ClusterFirstWithHostNet</strong>ï¼šåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬çš„ Pod æ˜¯ç”¨ HostNetwork æ¨¡å¼å¯åŠ¨çš„ï¼Œä¸€æ—¦ç”¨ HostNetwork æ¨¡å¼ï¼Œè¡¨ç¤ºè¿™ä¸ª Pod ä¸­çš„æ‰€æœ‰å®¹å™¨ï¼Œéƒ½è¦ä½¿ç”¨å®¿ä¸»æœºçš„ <code>/etc/resolv.conf</code> é…ç½®è¿›è¡Œ DNS æŸ¥è¯¢ï¼Œä½†å¦‚æœä½ è¿˜æƒ³ç»§ç»­ä½¿ç”¨ Kubernetes çš„DNSæœåŠ¡ï¼Œé‚£å°±å°† dnsPolicy è®¾ç½®ä¸º <code>ClusterFirstWithHostNet</code>ã€‚</p>
</li>
<li><p><strong>None</strong>: è¡¨ç¤ºç©ºçš„ DNS è®¾ç½®ï¼Œè¿™ç§æ–¹å¼ä¸€èˆ¬ç”¨äºæƒ³è¦è‡ªå®šä¹‰ DNS é…ç½®çš„åœºæ™¯ï¼Œå¾€å¾€éœ€è¦å’Œ <code>dnsConfig</code> é…åˆä¸€èµ·ä½¿ç”¨è¾¾åˆ°è‡ªå®šä¹‰ DNS çš„ç›®çš„ã€‚(ä¸‹é¢ä¼šè®²åˆ°çš„)</p>
</li>
</ul>
<blockquote>
<p>:warning: æ³¨æ„ï¼š </p>
<p><code>Default</code> å¹¶ä¸æ˜¯é»˜è®¤çš„ DNS ç­–ç•¥ï¼Œå¦‚æœæœªæ˜ç¡®æŒ‡å®š dnsPolicyï¼Œåˆ™ä½¿ç”¨ <code>ClusterFirst</code>ã€‚</p>
</blockquote>
<p>æ³¨æ„ï¼š[root@master1 ~]#kubectl explain pod.spec</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dnsPolicy    &lt;string&gt;</span><br><span class="line">  Set DNS policy <span class="keyword">for</span> the pod. Defaults to <span class="string">&quot;ClusterFirst&quot;</span>. Valid values are</span><br><span class="line">  <span class="string">&#x27;ClusterFirstWithHostNet&#x27;</span>, <span class="string">&#x27;ClusterFirst&#x27;</span>, <span class="string">&#x27;Default&#x27;</span> or <span class="string">&#x27;None&#x27;</span>. DNS</span><br><span class="line">  parameters given <span class="keyword">in</span> DNSConfig will be merged with the policy selected with</span><br><span class="line">  DNSPolicy. To have DNS options <span class="built_in">set</span> along with hostNetwork, you have to</span><br><span class="line">  specify DNS policy explicitly to <span class="string">&#x27;ClusterFirstWithHostNet&#x27;</span>.</span><br></pre></td></tr></table></figure>



<p>ğŸ“ æ¡ˆä¾‹æµ‹è¯•</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸€ä¸ª Podï¼Œå…¶ DNS ç­–ç•¥è®¾ç½®ä¸º <code>ClusterFirstWithHostNet</code>ï¼Œå› ä¸ºå®ƒå·²å°† hostNetwork è®¾ç½®ä¸º trueã€‚</p>
<p>ç¼–å†™èµ„æºæ¸…å•æ–‡ä»¶ï¼š</p>
<p>[root@master1 ~]#vim pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox:1.28.3</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br></pre></td></tr></table></figure>

<p>éƒ¨ç½²å¹¶è¿›å…¥åˆ°podæŸ¥çœ‹nameserverï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f pod.yaml</span></span><br><span class="line">pod/busybox created</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get po</span></span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox   1/1     Running   0          7s</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl exec busybox -- cat /etc/resolv.conf</span></span><br><span class="line">search default.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">options ndots:5</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get svc kube-dns -nkube-system</span></span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   51d</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“podé‡Œä½¿ç”¨äº†<code>hostNetwork</code>æ¨¡å¼ï¼Œä¸”dnsPolicyé…ç½®ä¸º<code>ClusterFirstWithHostNet</code>çš„ä¹‹åï¼Œæ­¤æ—¶å®¹å™¨é‡Œçš„nameserverä½¿ç”¨çš„æ˜¯Kubernetes çš„DNSæœåŠ¡ã€‚</p>
<p>ä½†æ­¤æ—¶ï¼Œè‹¥æŠŠdnsPolicyé…ç½®ä¸º<code>ClusterFirst</code>ï¼ŒæŒ‰ç†è¯´ï¼Œæ­¤æ—¶çš„å®¹å™¨é‡Œçš„nameserveråº”è¯¥ä½¿ç”¨çš„æ˜¯å®¿ä¸»æœºçš„<code>/etc/resolv.conf</code> é…ç½®è¿›è¡Œ DNS æŸ¥è¯¢ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#vim pod.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox1 <span class="comment">#è¿™é‡Œæ”¹ä¸ªåç§°ï¼</span></span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: busybox:1.28.3</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - sleep</span><br><span class="line">      - <span class="string">&quot;3600&quot;</span></span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    name: busybox</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">  hostNetwork: <span class="literal">true</span></span><br><span class="line">  dnsPolicy: ClusterFirst <span class="comment">#å°†ä¸Šé¢çš„ClusterFirstWithHostNetä¿®æ”¹ä¸ºClusterFirstã€‚ </span></span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹å®Œåï¼Œé‡æ–°éƒ¨ç½²å¹¶è§‚å¯Ÿç°è±¡ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f pod.yaml</span></span><br><span class="line">pod/busybox1 created</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get po busybox1</span></span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox1   1/1     Running   0          7s</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl exec busybox1 -- cat /etc/resolv.conf</span></span><br><span class="line">nameserver 223.6.6.6</span><br><span class="line">[root@master1 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ï¼Œæ­¤æ—¶çš„å®¹å™¨é‡Œçš„nameserveråº”è¯¥ä½¿ç”¨çš„æ˜¯å®¿ä¸»æœºçš„<code>/etc/resolv.conf</code> é…ç½®è¿›è¡Œ DNS æŸ¥è¯¢ï¼Œç¬¦åˆé¢„æœŸæ•ˆæœï¼Œæµ‹è¯•ç»“æŸã€‚</p>
<p>å®éªŒç»“æŸã€‚ğŸ˜˜ğŸ˜˜</p>
<ul>
<li>æ³¨æ„</li>
</ul>
<p>æˆ‘ä»¬çš„k8sé›†ç¾¤çš„<code>kube-proxy</code>ç»„ä»¶ï¼Œå®ƒå¼€å¯äº†<code>hostNetwork:true</code>ï¼Œä½†æ˜¯å®ƒçš„çš„<code>dnsPolicy</code>å´æ˜¯<code>ClusterFirst</code>ï¼Œéš¾é“è¿™é‡Œçš„kube-proxy podä¸ä½¿ç”¨corednsæœåŠ¡å—ï¼Ÿè€Œæ˜¯ç›´æ¥ä½¿ç”¨çš„å®¿ä¸»æœºçš„dnsæœåŠ¡ï¼Œè¿™ä¸ªè‡ªå·±æœ‰äº›ç–‘é—®ï¼Ÿï¼ŸğŸ˜¢ğŸ˜¢</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20211220214007658.png" alt="image-20211220214007658"></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20211220213834796.png" alt="image-20211220213834796"></p>
<h2 id="4ã€Pod-çš„-DNS-é…ç½®"><a href="#4ã€Pod-çš„-DNS-é…ç½®" class="headerlink" title="4ã€Pod çš„ DNS é…ç½®"></a>4ã€Pod çš„ DNS é…ç½®</h2><p>Pod çš„ DNS é…ç½®å¯è®©ç”¨æˆ·å¯¹ Pod çš„ DNS è®¾ç½®è¿›è¡Œæ›´å¤šæ§åˆ¶ã€‚<code>dnsConfig</code> å­—æ®µæ˜¯å¯é€‰çš„ï¼Œå®ƒå¯ä»¥ä¸ä»»ä½• <code>dnsPolicy</code> è®¾ç½®ä¸€èµ·ä½¿ç”¨ã€‚ ä½†æ˜¯ï¼Œ<strong>å½“ Pod çš„ dnsPolicy è®¾ç½®ä¸º â€œNoneâ€ æ—¶ï¼Œå¿…é¡»æŒ‡å®š dnsConfig å­—æ®µ</strong>ã€‚</p>
<p>ç”¨æˆ·å¯ä»¥åœ¨ dnsConfig å­—æ®µä¸­æŒ‡å®šä»¥ä¸‹å±æ€§ï¼š</p>
<ul>
<li>nameserversï¼šå°†ç”¨ä½œäº Pod çš„ DNS æœåŠ¡å™¨çš„ IP åœ°å€åˆ—è¡¨ã€‚ æœ€å¤šå¯ä»¥æŒ‡å®š 3 ä¸ª IP åœ°å€ã€‚å½“ Pod çš„ dnsPolicy è®¾ç½®ä¸º â€œNoneâ€ æ—¶ï¼Œåˆ—è¡¨å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ª IP åœ°å€ï¼Œå¦åˆ™æ­¤å±æ€§æ˜¯å¯é€‰çš„ã€‚<strong>æ‰€åˆ—å‡ºçš„æœåŠ¡å™¨å°†åˆå¹¶åˆ°ä»æŒ‡å®šçš„ DNS ç­–ç•¥ç”Ÿæˆçš„åŸºæœ¬åç§°æœåŠ¡å™¨</strong>ï¼Œå¹¶åˆ é™¤é‡å¤çš„åœ°å€ã€‚</li>
<li>searchesï¼šç”¨äºåœ¨ Pod ä¸­æŸ¥æ‰¾ä¸»æœºåçš„ <strong>DNS æœç´¢åŸŸ</strong>çš„åˆ—è¡¨ã€‚æ­¤å±æ€§æ˜¯å¯é€‰çš„ã€‚ æŒ‡å®šæ­¤å±æ€§æ—¶ï¼Œæ‰€æä¾›çš„åˆ—è¡¨å°†åˆå¹¶åˆ°æ ¹æ®æ‰€é€‰ DNS ç­–ç•¥ç”Ÿæˆçš„åŸºæœ¬æœç´¢åŸŸåä¸­ã€‚é‡å¤çš„åŸŸåå°†è¢«åˆ é™¤ï¼Œ<strong>Kubernetes æœ€å¤šå…è®¸ 6 ä¸ªæœç´¢åŸŸ</strong>ã€‚</li>
<li>optionsï¼šå¯é€‰çš„å¯¹è±¡åˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªå¯¹è±¡å¯èƒ½å…·æœ‰ <strong>name å±æ€§ï¼ˆå¿…éœ€ï¼‰</strong>å’Œ value å±æ€§ï¼ˆå¯é€‰ï¼‰ã€‚æ­¤å±æ€§ä¸­çš„å†…å®¹å°†åˆå¹¶åˆ°ä»æŒ‡å®šçš„ DNS ç­–ç•¥ç”Ÿæˆçš„é€‰é¡¹ã€‚é‡å¤çš„æ¡ç›®å°†è¢«åˆ é™¤ã€‚</li>
</ul>
<p>ğŸ“ æ¡ˆä¾‹æµ‹è¯•</p>
<p>ä»¥ä¸‹æ˜¯å…·æœ‰è‡ªå®šä¹‰ DNS è®¾ç½®çš„ Pod ç¤ºä¾‹ï¼š</p>
<p>[root@master1 ~]#vim dnsconfig.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dns-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">&quot;None&quot;</span></span><br><span class="line">  <span class="attr">dnsConfig:</span></span><br><span class="line">    <span class="attr">nameservers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">searches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ns1.svc.cluster-domain.example</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my.dns.search.suffix</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ndots</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">edns0</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸Šé¢çš„ Pod åï¼Œå®¹å™¨ test ä¼šåœ¨å…¶ <code>/etc/resolv.conf</code> æ–‡ä»¶ä¸­è·å–ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl apply -f dnsconfig.yaml </span></span><br><span class="line">pod/dns-example created</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl get po</span></span><br><span class="line">]NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">dns-example   1/1     Running   0          40s</span><br><span class="line">[root@master1 ~]<span class="comment">#kubectl exec dns-example -- cat /etc/resolv.conf</span></span><br><span class="line">search ns1.svc.cluster-domain.example my.dns.search.suffix</span><br><span class="line">nameserver 1.2.3.4</span><br><span class="line">options ndots:2 edns0</span><br><span class="line">[root@master1 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>ç¬¦åˆé¢„æœŸæ•ˆæœã€‚</p>
<p>å®éªŒç»“æŸã€‚ğŸ˜˜</p>
<ul>
<li>æ³¨æ„ï¼šå¯ä»¥çœ‹ä¸‹<code>dnsConfig</code>çš„å¸®åŠ©ä¿¡æ¯ã€‚</li>
</ul>
<p>[root@master1 ~]#kubectl explain pod.spec</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dnsConfig    &lt;Object&gt;</span><br><span class="line">  Specifies the DNS parameters of a pod. Parameters specified here will be</span><br><span class="line">  merged to the generated DNS configuration based on DNSPolicy.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment">#kubectl explain pod.spec.dnsConfig</span></span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: dnsConfig &lt;Object&gt;:</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Specifies the DNS parameters of a pod. Parameters specified here will be</span><br><span class="line">     merged to the generated DNS configuration based on DNSPolicy.</span><br><span class="line"></span><br><span class="line">     PodDNSConfig defines the DNS parameters of a pod <span class="keyword">in</span> addition to those</span><br><span class="line">     generated from DNSPolicy.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   nameservers  &lt;[]string&gt;</span><br><span class="line">     A list of DNS name server IP addresses. This will be appended to the base</span><br><span class="line">     nameservers generated from DNSPolicy. Duplicated nameservers will be</span><br><span class="line">     removed.</span><br><span class="line"></span><br><span class="line">   options      &lt;[]Object&gt;</span><br><span class="line">     A list of DNS resolver options. This will be merged with the base options</span><br><span class="line">     generated from DNSPolicy. Duplicated entries will be removed. Resolution</span><br><span class="line">     options given <span class="keyword">in</span> Options will override those that appear <span class="keyword">in</span> the base</span><br><span class="line">     DNSPolicy.</span><br><span class="line"></span><br><span class="line">   searches     &lt;[]string&gt;</span><br><span class="line">     A list of DNS search domains <span class="keyword">for</span> host-name lookup. This will be appended to</span><br><span class="line">     the base search paths generated from DNSPolicy. Duplicated search paths</span><br><span class="line">     will be removed.</span><br></pre></td></tr></table></figure>

<h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><h3 id="1-podçš„é•œåƒæ‹‰å–ç­–ç•¥"><a href="#1-podçš„é•œåƒæ‹‰å–ç­–ç•¥" class="headerlink" title="1.podçš„é•œåƒæ‹‰å–ç­–ç•¥"></a>1.podçš„é•œåƒæ‹‰å–ç­–ç•¥</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/containers/images/">https://kubernetes.io/zh/docs/concepts/containers/images/</a></p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20211220225729159.png" alt="image-20211220225729159"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> [root@master1 ~]<span class="comment">#kubectl explain pod.spec.containers</span></span><br><span class="line"> â€¦â€¦</span><br><span class="line"> imagePullPolicy      &lt;string&gt;</span><br><span class="line">     Image pull policy. One of Always, Never, IfNotPresent. Defaults to Always</span><br><span class="line">     <span class="keyword">if</span> :latest tag is specified, or IfNotPresent otherwise. Cannot be updated.</span><br><span class="line">     More info:</span><br><span class="line">     https://kubernetes.io/docs/concepts/containers/images<span class="comment">#updating-images</span></span><br><span class="line">â€¦â€¦     </span><br></pre></td></tr></table></figure>

<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20211221204818374.png" alt="image-20211221204818374"></p>
<h2 id="å…³äºæˆ‘"><a href="#å…³äºæˆ‘" class="headerlink" title="å…³äºæˆ‘"></a>å…³äºæˆ‘</h2><p>æˆ‘çš„åšå®¢ä¸»æ—¨ï¼šæˆ‘å¸Œæœ›æ¯ä¸€ä¸ªäººæ‹¿ç€æˆ‘çš„åšå®¢éƒ½å¯ä»¥åšå‡ºå®éªŒç°è±¡ï¼Œå…ˆæŠŠå®éªŒåšå‡ºæ¥ï¼Œç„¶åå†ç»“åˆç†è®ºçŸ¥è¯†æ›´æ·±å±‚æ¬¡å»ç†è§£æŠ€æœ¯ç‚¹ï¼Œè¿™æ ·å­¦ä¹ èµ·æ¥æ‰æœ‰ä¹è¶£å’ŒåŠ¨åŠ›ã€‚å¹¶ä¸”ï¼Œæˆ‘çš„åšå®¢å†…å®¹æ­¥éª¤æ˜¯å¾ˆå®Œæ•´çš„ï¼Œä¹Ÿåˆ†äº«æºç å’Œå®éªŒç”¨åˆ°çš„è½¯ä»¶ï¼Œå¸Œæœ›èƒ½å’Œå¤§å®¶ä¸€èµ·å…±åŒè¿›æ­¥ï¼</p>
<p>å„ä½å°ä¼™ä¼´åœ¨å®é™…æ“ä½œè¿‡ç¨‹ä¸­å¦‚æœ‰ä»€ä¹ˆç–‘é—®ï¼Œå¯éšæ—¶è”ç³»æœ¬äººå…è´¹å¸®æ‚¨è§£å†³é—®é¢˜ï¼š</p>
<ol>
<li><p>ä¸ªäººå¾®ä¿¡äºŒç»´ç ï¼šx2675263825 ï¼ˆèˆå¾—ï¼‰ï¼Œ qqï¼š2675263825ã€‚</p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144206.png" alt="image-20211002091450217"></p>
</li>
<li><p>ä¸ªäººåšå®¢åœ°å€ï¼š<a href="http://www.onlyonexl.cn/">www.onlyonexl.cn</a></p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144213.png" alt="image-20211002092057988"></p>
</li>
<li><p>ä¸ªäººå¾®ä¿¡å…¬ä¼—å·ï¼šäº‘åŸç”Ÿæ¶æ„å¸ˆå®æˆ˜</p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144224.png" alt="image-20211002141739664"></p>
</li>
<li><p>ä¸ªäººcsdn</p>
<p> <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39246554?spm=1010.2135.3001.5421">https://blog.csdn.net/weixin_39246554?spm=1010.2135.3001.5421</a></p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/20211106144230.png" alt="image-20211002092344616"></p>
</li>
<li><p>ä¸ªäººgithubä¸»é¡µï¼š<a target="_blank" rel="noopener" href="https://github.com/OnlyOnexl">https://github.com/OnlyOnexl</a></p>
<p> <img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20211208201714773.png" alt="image-20211208201714773"></p>
</li>
</ol>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>â€‹    å¥½äº†ï¼Œå…³äºæœåŠ¡å‘ç°å®éªŒå°±åˆ°è¿™é‡Œäº†ï¼Œæ„Ÿè°¢å¤§å®¶é˜…è¯»ï¼Œæœ€åè´´ä¸Šæˆ‘å¥³ç¥çš„photoï¼Œç¥å¤§å®¶ç”Ÿæ´»å¿«ä¹ï¼Œæ¯å¤©éƒ½è¿‡çš„æœ‰æ„ä¹‰å“¦ï¼Œæˆ‘ä»¬ä¸‹æœŸè§ï¼</p>
<p><img src="https://bucket-hg.oss-cn-shanghai.aliyuncs.com/img/image-20211221204956715.png" alt="image-20211221204956715"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">ä¸€ä¸ªäºº</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.onlyonexl.cn/2021/12/21/106%20%E5%AE%9E%E6%88%98%EF%BC%9Ak8s%E4%B9%8B%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-2021.12.21/">https://www.onlyonexl.cn/2021/12/21/106%20%E5%AE%9E%E6%88%98%EF%BC%9Ak8s%E4%B9%8B%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-2021.12.21/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="/about" target="_blank">ä¸€ä¸ªäºº</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/k8s/">
                                    <span class="chip bg-color">k8s</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;æœ¬ç¯‡
            </div>
            <div class="card">
                <a href="/2021/12/21/106%20%E5%AE%9E%E6%88%98%EF%BC%9Ak8s%E4%B9%8B%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-2021.12.21/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="å®æˆ˜ï¼šk8sä¹‹æœåŠ¡å‘ç°-2021.12.21">
                        
                        <span class="card-title">å®æˆ˜ï¼šk8sä¹‹æœåŠ¡å‘ç°-2021.12.21</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-12-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/k8s/" class="post-category">
                                    k8s
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/k8s/">
                        <span class="chip bg-color">k8s</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/12/17/105%20k8s%E4%B9%8BService-2021.12.17/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="k8sä¹‹Service-2021.12.17">
                        
                        <span class="card-title">k8sä¹‹Service-2021.12.17</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-12-17
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/k8s/" class="post-category">
                                    k8s
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/k8s/">
                        <span class="chip bg-color">k8s</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">ä¸€ä¸ªäºº</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- è¿è¡Œå¤©æ•°æé†’. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/OnlyOnexl" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2675263825@qq.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2675263825" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 2675263825" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--è…¾è®¯å…”å°å·¢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
